<% profile = current_user.profile %>
<% paid_plan = profile&.paid? %>
<% has_subscription_history = profile&.ever_paid? %>
<% raw_status = profile&.paddle_subscription_status.to_s.downcase %>
<% status_active = raw_status.blank? ? paid_plan : %w[active trialing].include?(raw_status) %>
<% status_label = if status_active
  t('subscription_page.status_active')
elsif raw_status.present?
  t('subscription_page.status_inactive')
else
  t('subscription_page.status_unknown')
end %>
<% plan_label = paid_plan ? t('subscription_page.plan_pro') : t('subscription_page.plan_free') %>
<% plan_price_label = paid_plan ? (ENV['PADDLE_PLAN_PRICE_LABEL'].presence || t('modal.pro_price')) : '$0/month' %>
<% next_billing_value = if profile&.paddle_next_bill_at.present?
  l(profile.paddle_next_bill_at, format: :long)
elsif paid_plan
  t('subscription_page.no_scheduled_billing')
else
  t('subscription_page.not_available')
end %>
<% next_charge_value = if profile&.paddle_next_bill_at.present? && paid_plan
  plan_price_label
elsif paid_plan
  t('subscription_page.no_scheduled_charge')
else
  t('subscription_page.not_available')
end %>
<% show_manage_billing = paid_plan || has_subscription_history %>
<% billing_email = profile&.paddle_customer_email.presence || current_user.email || t('subscription_page.not_available') %>
<% month_range = Time.current.beginning_of_month..Time.current.end_of_month %>
<% invoices_generated = current_user.logs.kept.where(created_at: month_range).count %>
<% invoice_limit = paid_plan ? nil : 150 %>
<% invoice_progress = invoice_limit.present? ? [ ((invoices_generated.to_f / invoice_limit) * 100).round, 100 ].min : 22 %>
<% recordings_completed = TrackingEvent.where(user_id: current_user.id, event_name: 'recording_completed').where(created_at: month_range).count %>
<% estimated_voice_minutes = ((recordings_completed * (profile&.audio_limit || 0)) / 60.0).round(1) %>
<% voice_limit_minutes = paid_plan ? nil : 300.0 %>
<% voice_progress = voice_limit_minutes.present? ? [ ((estimated_voice_minutes / voice_limit_minutes) * 100).round, 100 ].min : 18 %>
<% invoice_meter_text = invoice_limit.present? ? "#{invoices_generated} / #{invoice_limit}" : "#{invoices_generated} / Unlimited" %>
<% voice_meter_text = voice_limit_minutes.present? ? "#{estimated_voice_minutes} / #{voice_limit_minutes.to_i} min" : "#{estimated_voice_minutes} min / Unlimited" %>

<style>
  .subscription-page {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0a0a0a;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Keep background language consistent with pricing page */
  .pricing-bg {
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(249,115,22,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(99,102,241,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .pricing-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .pricing-particle {
    position: fixed;
    background: rgba(249,115,22,0.4);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: pricingFloat linear infinite;
  }

  @keyframes pricingFloat {
    0%   { transform: translateY(0) scale(1); opacity: 0; }
    10%  { opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
  }

  .subscription-content {
    position: relative;
    z-index: 1;
    max-width: 980px;
    margin: 0 auto;
    padding: 2rem 1.2rem 4rem;
    color: #f8fafc;
    font-family: "Sora", "Segoe UI", sans-serif;
  }

  .sub-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.72);
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-decoration: none;
    border-radius: 999px;
    padding: 11px 15px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.14);
    transition: all 0.2s ease;
  }

  .sub-back svg {
    width: 13px;
    height: 13px;
  }

  .sub-back:hover {
    color: #ffffff;
    border-color: rgba(249,115,22,0.45);
    background: rgba(249,115,22,0.15);
  }

  .subscription-header {
    margin: 1.2rem 0 1.4rem;
  }

  .subscription-title {
    margin: 0;
    font-size: clamp(2rem, 5.7vw, 3.4rem);
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: -0.01em;
  }

  .subscription-title .onb-accent {
    color: #f97316;
  }

  .subscription-subtitle {
    margin: 0.8rem 0 0;
    max-width: 700px;
    font-size: 14px;
    color: rgba(255,255,255,0.66);
    line-height: 1.6;
  }

  .sub-section {
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(4,6,12,0.72);
    backdrop-filter: blur(8px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    padding: 1.15rem;
  }

  .sub-section + .sub-section {
    margin-top: 0.95rem;
  }

  .sub-section-title {
    margin: 0 0 0.9rem;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.11em;
    color: rgba(255,255,255,0.75);
  }

  .sub-plan-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 0.8rem;
  }

  .sub-surface {
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    padding: 0.9rem;
  }

  .sub-key {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.54);
    margin-bottom: 0.3rem;
  }

  .sub-value {
    font-size: 14px;
    font-weight: 700;
    color: #f8fafc;
    word-break: break-word;
  }

  .sub-status-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.07em;
  }

  .sub-status-chip::before {
    content: "";
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: currentColor;
  }

  .sub-status-chip.active {
    color: #4ade80;
    border: 1px solid rgba(74,222,128,0.34);
    background: rgba(74,222,128,0.14);
  }

  .sub-status-chip.inactive {
    color: #f87171;
    border: 1px solid rgba(248,113,113,0.35);
    background: rgba(248,113,113,0.14);
  }

  .sub-feature-list {
    margin: 0;
    padding-left: 1rem;
    display: grid;
    gap: 0.28rem;
    color: rgba(255,255,255,0.8);
    font-size: 12px;
    line-height: 1.45;
  }

  .sub-actions {
    margin-top: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
  }

  .sub-btn-form {
    margin: 0;
  }

  .sub-btn {
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.05);
    color: #f8fafc;
    text-decoration: none;
    padding: 9px 12px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .sub-btn:hover {
    color: #ffffff;
    border-color: rgba(249,115,22,0.55);
    background: rgba(249,115,22,0.18);
  }

  .sub-btn.primary {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    border-color: transparent;
    box-shadow: 0 8px 20px rgba(249,115,22,0.33);
  }

  .sub-btn.danger {
    border-color: rgba(248,113,113,0.45);
    background: rgba(248,113,113,0.15);
  }

  .sub-btn.danger:hover {
    border-color: rgba(248,113,113,0.75);
    background: rgba(248,113,113,0.25);
  }

  .usage-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.7rem;
  }

  .usage-progress {
    margin-top: 0.55rem;
    height: 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.12);
    overflow: hidden;
  }

  .usage-fill {
    height: 100%;
    background: linear-gradient(90deg, #f97316 0%, #fb923c 100%);
  }

  .usage-note {
    margin-top: 0.65rem;
    font-size: 11px;
    color: rgba(255,255,255,0.62);
  }

  .billing-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.7rem;
  }

  .plan-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.8rem;
  }

  .plan-option-card {
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.03);
    padding: 0.95rem;
  }

  .plan-option-card.current {
    border-color: rgba(249,115,22,0.6);
    box-shadow: inset 0 0 0 1px rgba(249,115,22,0.35);
  }

  .plan-option-title {
    margin: 0;
    font-size: 15px;
    font-weight: 800;
  }

  .plan-option-price {
    margin-top: 0.25rem;
    font-size: 12px;
    color: rgba(255,255,255,0.72);
  }

  .plan-option-badge {
    display: inline-flex;
    margin-top: 0.55rem;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-weight: 800;
    color: #fed7aa;
    border: 1px solid rgba(249,115,22,0.5);
    border-radius: 999px;
    padding: 4px 9px;
    background: rgba(249,115,22,0.14);
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    overflow: hidden;
  }

  .history-table th,
  .history-table td {
    padding: 0.7rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-align: left;
    font-size: 12px;
  }

  .history-table th {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 10px;
    color: rgba(255,255,255,0.7);
    background: rgba(255,255,255,0.04);
  }

  .history-table tr:last-child td {
    border-bottom: none;
  }

  .history-empty {
    color: rgba(255,255,255,0.68);
  }

  .danger-zone {
    border-color: rgba(248,113,113,0.5);
    background: rgba(248,113,113,0.08);
  }

  .danger-copy {
    font-size: 12px;
    color: rgba(255,255,255,0.78);
    line-height: 1.55;
  }

  @media (max-width: 880px) {
    .sub-plan-grid,
    .usage-grid,
    .billing-grid,
    .plan-options {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 640px) {
    .subscription-content {
      padding: 1.45rem 0.85rem 3rem;
    }

    .history-table {
      display: block;
      overflow-x: auto;
    }
  }
</style>

<div class="subscription-page">
  <div class="pricing-bg"></div>
  <div class="pricing-grid"></div>

  <% 12.times do %>
    <div class="pricing-particle" style="left:<%= rand(5..95) %>%; bottom:-2%; animation-duration:<%= rand(8..16) %>s; animation-delay:<%= (rand(0..60) / 10.0) %>s; width:<%= rand(1..3) %>px; height:<%= rand(1..3) %>px; opacity:<%= rand(2..5) / 10.0 %>;"></div>
  <% end %>

  <div class="subscription-content">
    <%= link_to root_path, class: 'sub-back' do %>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
      </svg>
      <%= t('subscription_page.back_home') %>
    <% end %>

    <header class="subscription-header">
      <h1 class="subscription-title"><%= raw t('subscription_page.title_html') %></h1>
      <p class="subscription-subtitle"><%= t('subscription_page.subtitle') %></p>
    </header>

    <section class="sub-section">
      <h2 class="sub-section-title">Current Plan</h2>
      <div class="sub-plan-grid">
        <div class="sub-surface">
          <div class="sub-key">Plan Name</div>
          <div class="sub-value"><%= plan_label %></div>

          <div class="sub-key" style="margin-top:0.7rem;">Price</div>
          <div class="sub-value"><%= plan_price_label %></div>

          <div class="sub-key" style="margin-top:0.7rem;">Plan Features</div>
          <ul class="sub-feature-list">
            <% if paid_plan %>
              <li>10,000 transcript characters</li>
              <li>Up to 300 voice seconds per recording</li>
              <li>Unlimited previews and exports</li>
              <li>Priority AI and support</li>
            <% else %>
              <li>300 transcript characters</li>
              <li>Up to 60 voice seconds per recording</li>
              <li>5 exports per day</li>
              <li>Upgrade to unlock Pro features</li>
            <% end %>
          </ul>
        </div>

        <div class="sub-surface">
          <div class="sub-key">Status</div>
          <div class="sub-status-chip <%= status_active ? 'active' : 'inactive' %>"><%= status_label %></div>

          <div class="sub-key" style="margin-top:0.7rem;"><%= t('subscription_page.next_billing') %></div>
          <div class="sub-value"><%= next_billing_value %></div>

          <div class="sub-key" style="margin-top:0.7rem;">Next Charge Amount</div>
          <div class="sub-value"><%= next_charge_value %></div>

          <div class="sub-actions">
            <%= link_to pricing_path, class: 'sub-btn' do %>
              Change Plan
            <% end %>
            <% if show_manage_billing %>
              <%= button_to 'Cancel Subscription', subscription_billing_portal_path, method: :post, class: 'sub-btn danger', form: { class: 'sub-btn-form' } %>
            <% else %>
              <%= link_to contact_path, class: 'sub-btn danger' do %>
                Cancel Subscription
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title">Usage</h2>
      <div class="usage-grid">
        <div class="sub-surface">
          <div class="sub-key">Invoices Generated This Month</div>
          <div class="sub-value"><%= invoice_meter_text %></div>
          <div class="usage-progress">
            <div class="usage-fill" style="width:<%= invoice_progress %>%;"></div>
          </div>
        </div>

        <div class="sub-surface">
          <div class="sub-key">Voice Minutes Used (Estimated)</div>
          <div class="sub-value"><%= voice_meter_text %></div>
          <div class="usage-progress">
            <div class="usage-fill" style="width:<%= voice_progress %>%;"></div>
          </div>
        </div>
      </div>
      <p class="usage-note">Usage is shown early to keep limits transparent and avoid surprises.</p>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title">Billing Information</h2>
      <div class="billing-grid">
        <div class="sub-surface">
          <div class="sub-key">Payment Method</div>
          <div class="sub-value">Managed securely in Paddle billing portal</div>
        </div>
        <div class="sub-surface">
          <div class="sub-key"><%= t('subscription_page.customer_email') %></div>
          <div class="sub-value"><%= billing_email %></div>
        </div>
        <div class="sub-surface">
          <div class="sub-key">Last Payment</div>
          <div class="sub-value"><%= t('subscription_page.not_available') %></div>
        </div>
      </div>
      <div class="sub-actions">
        <% if show_manage_billing %>
          <%= button_to 'Update Payment Method', subscription_billing_portal_path, method: :post, class: 'sub-btn', form: { class: 'sub-btn-form' } %>
          <%= button_to 'Download Invoices / Receipts', subscription_billing_portal_path, method: :post, class: 'sub-btn', form: { class: 'sub-btn-form' } %>
        <% else %>
          <%= link_to contact_path, class: 'sub-btn' do %>
            Contact Support
          <% end %>
        <% end %>
      </div>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title">Plan Options</h2>
      <div class="plan-options">
        <article class="plan-option-card <%= paid_plan ? '' : 'current' %>">
          <h3 class="plan-option-title">Free</h3>
          <div class="plan-option-price">$0/month</div>
          <ul class="sub-feature-list" style="margin-top:0.7rem;">
            <li>300 transcript characters</li>
            <li>60 voice seconds per recording</li>
            <li>5 exports per day</li>
          </ul>
          <% unless paid_plan %>
            <div class="plan-option-badge">Current Plan</div>
          <% end %>
        </article>

        <article class="plan-option-card <%= paid_plan ? 'current' : '' %>">
          <h3 class="plan-option-title">Pro</h3>
          <div class="plan-option-price"><%= ENV['PADDLE_PLAN_PRICE_LABEL'].presence || t('modal.pro_price') %></div>
          <ul class="sub-feature-list" style="margin-top:0.7rem;">
            <li>10,000 transcript characters</li>
            <li>300 voice seconds per recording</li>
            <li>Unlimited previews and exports</li>
            <li>Priority AI and support</li>
          </ul>
          <% if paid_plan %>
            <div class="plan-option-badge">Current Plan</div>
          <% else %>
            <div class="sub-actions" style="margin-top:0.75rem;">
              <%= link_to checkout_path, class: 'sub-btn primary' do %>
                <%= t('subscription_page.upgrade_now') %>
              <% end %>
            </div>
          <% end %>
        </article>
      </div>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title">Billing History</h2>
      <table class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Receipt</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="history-empty">No synced billing transactions yet. Open billing portal to view and download official receipts.</td>
          </tr>
        </tbody>
      </table>
      <% if show_manage_billing %>
        <div class="sub-actions">
          <%= button_to 'Open Billing Portal', subscription_billing_portal_path, method: :post, class: 'sub-btn', form: { class: 'sub-btn-form' } %>
        </div>
      <% end %>
    </section>

    <section class="sub-section danger-zone">
      <h2 class="sub-section-title">Cancel Subscription</h2>
      <p class="danger-copy">If you cancel, you keep access until the end of your current billing period. No hidden steps. No hidden pricing.</p>
      <div class="sub-actions">
        <% if show_manage_billing %>
          <%= button_to 'Cancel in Billing Portal', subscription_billing_portal_path, method: :post, class: 'sub-btn danger', form: { class: 'sub-btn-form' } %>
        <% else %>
          <%= link_to contact_path, class: 'sub-btn danger' do %>
            Contact Support to Cancel
          <% end %>
        <% end %>
      </div>
    </section>
  </div>
</div>
