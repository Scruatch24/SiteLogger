<% profile = current_user.profile %>
<% paid_plan = profile&.paid? %>
<% has_subscription_history = profile&.ever_paid? %>
<% raw_status = profile&.paddle_subscription_status.to_s.downcase %>
<% sub_canceled = raw_status == 'canceled' %>
<% status_active = paid_plan && %w[active trialing].include?(raw_status) || (paid_plan && raw_status.blank?) %>
<% status_label = if sub_canceled
  t('subscription_page.status_canceled')
elsif status_active
  t('subscription_page.status_active')
elsif raw_status.present?
  t('subscription_page.status_inactive')
else
  t('subscription_page.status_unknown')
end %>
<% plan_label = paid_plan ? t('subscription_page.plan_pro') : t('subscription_page.plan_free') %>
<% plan_price_label = paid_plan ? (ENV['PADDLE_PLAN_PRICE_LABEL'].presence || t('modal.pro_price')) : t('subscription_page.free_price') %>
<% next_billing_value = if sub_canceled
  t('subscription_page.next_billing_canceled')
elsif @billing_next_billing_label.present?
  @billing_next_billing_label
elsif profile&.paddle_next_bill_at.present?
  l(profile.paddle_next_bill_at, format: :long)
elsif paid_plan && status_active
  t('subscription_page.pending_billing_sync')
elsif paid_plan
  t('subscription_page.no_scheduled_billing')
else
  t('subscription_page.not_applicable')
end %>
<% next_charge_value = if sub_canceled
  t('subscription_page.next_charge_canceled')
elsif @billing_next_charge_label.present?
  @billing_next_charge_label
elsif paid_plan && status_active
  t('subscription_page.pending_billing_sync')
elsif paid_plan
  t('subscription_page.no_scheduled_charge')
else
  t('subscription_page.not_applicable')
end %>
<% show_manage_billing = paid_plan || has_subscription_history %>
<% billing_email = profile&.paddle_customer_email.presence || current_user.email || t('subscription_page.not_available') %>
<% billing_payment_method = @billing_payment_method_label.presence || t('subscription_page.not_available') %>
<% billing_last_payment = @billing_last_payment_label.presence || t('subscription_page.not_available') %>
<% billing_history_rows = Array(@billing_history_rows) %>

<style>
  .subscription-page {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0a0a0a;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Keep background language consistent with pricing page */
  .pricing-bg {
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(249,115,22,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(99,102,241,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .pricing-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .pricing-particle {
    position: fixed;
    background: rgba(249,115,22,0.4);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: pricingFloat linear infinite;
  }

  @keyframes pricingFloat {
    0%   { transform: translateY(0) scale(1); opacity: 0; }
    10%  { opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
  }

  .subscription-content {
    position: relative;
    z-index: 1;
    max-width: 980px;
    margin: 0 auto;
    padding: 2rem 1.2rem 4rem;
    color: #f8fafc;
    font-family: "Sora", "Segoe UI", sans-serif;
  }

  .sub-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.72);
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-decoration: none;
    border-radius: 999px;
    padding: 11px 15px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.14);
    transition: all 0.2s ease;
  }

  .sub-back svg {
    width: 13px;
    height: 13px;
  }

  .sub-back:hover {
    color: #ffffff;
    border-color: rgba(249,115,22,0.45);
    background: rgba(249,115,22,0.15);
  }

  .subscription-header {
    margin: 1.2rem 0 1.4rem;
  }

  .subscription-title {
    margin: 0;
    font-size: clamp(2rem, 5.7vw, 3.4rem);
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: -0.01em;
  }

  .subscription-title .onb-accent {
    color: #f97316;
  }

  .subscription-page .pricing-headline {
    font-size: clamp(2rem, 6vw, 3.5rem);
    font-weight: 900;
    color: white;
    text-transform: uppercase;
    letter-spacing: -0.02em;
    line-height: 1.05;
    margin-bottom: 1rem;
  }

  .subscription-page .pricing-headline .onb-accent {
    color: #f97316;
  }

  .subscription-subtitle {
    margin: 0.8rem 0 0;
    max-width: 700px;
    font-size: 14px;
    color: rgba(255,255,255,0.66);
    line-height: 1.6;
  }

  .sub-section {
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(4,6,12,0.72);
    backdrop-filter: blur(8px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    padding: 1.15rem;
  }

  .sub-section + .sub-section {
    margin-top: 0.95rem;
  }

  .sub-section-card-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(249,115,22,0.75);
    margin-bottom: 0.6rem;
  }

  .sub-section-title {
    margin: 0 0 0.9rem;
    font-size: 19px;
    line-height: 1.2;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #fff7ed;
    text-shadow: 0 10px 28px rgba(249,115,22,0.28);
    position: relative;
    padding-bottom: 0.45rem;
  }

  .sub-section-title::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 64px;
    height: 2px;
    border-radius: 999px;
    background: linear-gradient(90deg, #fb923c, rgba(251,146,60,0.08));
  }

  .sub-plan-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 0.8rem;
  }

  .sub-surface {
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    padding: 0.9rem;
  }

  .sub-key {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.54);
    margin-bottom: 0.3rem;
  }

  .sub-value {
    font-size: 14px;
    font-weight: 700;
    color: #f8fafc;
    word-break: break-word;
  }

  .sub-status-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.07em;
  }

  .sub-status-chip::before {
    content: "";
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: currentColor;
  }

  .sub-status-chip.active {
    color: #4ade80;
    border: 1px solid rgba(74,222,128,0.34);
    background: rgba(74,222,128,0.14);
  }

  .sub-status-chip.canceled {
    color: #fb923c;
    border: 1px solid rgba(251,146,60,0.4);
    background: rgba(251,146,60,0.14);
  }

  .sub-status-chip.inactive {
    color: #f87171;
    border: 1px solid rgba(248,113,113,0.35);
    background: rgba(248,113,113,0.14);
  }

  .sub-feature-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 0.4rem;
    color: rgba(255,255,255,0.8);
    font-size: 12px;
    line-height: 1.45;
  }

  .sub-feature-item {
    display: flex;
    align-items: center;
    gap: 0.55rem;
  }

  .sub-feature-icon {
    width: 24px;
    height: 24px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(249,115,22,0.2);
    border: 1px solid rgba(249,115,22,0.35);
    color: #f97316;
    flex-shrink: 0;
  }

  .sub-feature-icon svg {
    width: 13px;
    height: 13px;
  }

  .sub-actions {
    margin-top: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
  }

  .sub-btn-form {
    margin: 0;
  }

  .sub-btn {
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.05);
    color: #f8fafc;
    text-decoration: none;
    padding: 9px 12px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .sub-btn:hover {
    color: #ffffff;
    border-color: rgba(249,115,22,0.55);
    background: rgba(249,115,22,0.18);
  }

  .sub-btn.primary {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    border-color: transparent;
    box-shadow: 0 8px 20px rgba(249,115,22,0.33);
  }

  .sub-btn.danger {
    border-color: rgba(248,113,113,0.45);
    background: rgba(248,113,113,0.15);
  }

  .sub-btn.danger:hover {
    border-color: rgba(248,113,113,0.75);
    background: rgba(248,113,113,0.25);
  }

  .sub-note {
    margin-top: 0.65rem;
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    line-height: 1.45;
  }

  .billing-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.7rem;
  }

  .plan-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.8rem;
  }

  .plan-option-card {
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.03);
    padding: 0.95rem;
  }

  .plan-option-card.current {
    border-color: rgba(249,115,22,0.6);
    box-shadow: inset 0 0 0 1px rgba(249,115,22,0.35);
  }

  .plan-option-title {
    margin: 0;
    font-size: 15px;
    font-weight: 800;
  }

  .plan-option-price {
    margin-top: 0.25rem;
    font-size: 12px;
    color: rgba(255,255,255,0.72);
  }

  .plan-option-badge {
    display: inline-flex;
    margin-top: 0.55rem;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-weight: 800;
    color: #fed7aa;
    border: 1px solid rgba(249,115,22,0.5);
    border-radius: 999px;
    padding: 4px 9px;
    background: rgba(249,115,22,0.14);
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    overflow: hidden;
  }

  .history-table th,
  .history-table td {
    padding: 0.7rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-align: left;
    font-size: 12px;
  }

  .history-table th {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 10px;
    color: rgba(255,255,255,0.7);
    background: rgba(255,255,255,0.04);
  }

  .history-table tr:last-child td {
    border-bottom: none;
  }

  .history-empty {
    color: rgba(255,255,255,0.68);
  }

  .history-status {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 900;
  }

  .history-status.completed {
    color: #4ade80;
    border: 1px solid rgba(74,222,128,0.35);
    background: rgba(74,222,128,0.14);
  }

  .history-status.failed {
    color: #f87171;
    border: 1px solid rgba(248,113,113,0.42);
    background: rgba(248,113,113,0.14);
  }

  .danger-zone {
    border-color: rgba(248,113,113,0.5);
    background: rgba(248,113,113,0.08);
  }

  .danger-copy {
    font-size: 12px;
    color: rgba(255,255,255,0.78);
    line-height: 1.55;
  }

  @media (max-width: 880px) {
    .sub-plan-grid,
    .billing-grid,
    .plan-options {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 640px) {
    .subscription-content {
      padding: 1.45rem 0.85rem 3rem;
    }

    .subscription-header {
      text-align: center !important;
    }

    .subscription-subtitle {
      margin-left: auto;
      margin-right: auto;
    }

    .history-table {
      display: block;
      overflow-x: auto;
    }

    .history-table .txn-col {
      display: none;
    }
  }
</style>

<div class="subscription-page">
  <div class="pricing-bg"></div>
  <div class="pricing-grid"></div>

  <% 12.times do %>
    <div class="pricing-particle" style="left:<%= rand(5..95) %>%; bottom:-2%; animation-duration:<%= rand(8..16) %>s; animation-delay:<%= (rand(0..60) / 10.0) %>s; width:<%= rand(1..3) %>px; height:<%= rand(1..3) %>px; opacity:<%= rand(2..5) / 10.0 %>;"></div>
  <% end %>

  <div class="subscription-content">
    <%= link_to root_path, class: 'sub-back' do %>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
      </svg>
      <%= t('subscription_page.back_home') %>
    <% end %>

    <header class="subscription-header" style="text-align:left;">
      <h1 class="pricing-headline" style="margin-bottom:0.5rem;"><%= raw t('subscription_page.title_html') %></h1>
      <p class="subscription-subtitle"><%= t('subscription_page.subtitle') %></p>
    </header>

    <section class="sub-section">
      <h2 class="sub-section-title"><%= t('subscription_page.current_plan') %></h2>
      <div class="sub-plan-grid">
        <div class="sub-surface">
          <div class="sub-key"><%= t('subscription_page.plan_name') %></div>
          <div class="sub-value"><%= plan_label %></div>

          <div class="sub-key" style="margin-top:0.7rem;"><%= t('subscription_page.price') %></div>
          <div class="sub-value"><%= plan_price_label %></div>

          <div class="sub-key" style="margin-top:0.7rem;"><%= t('subscription_page.plan_features') %></div>
          <ul class="sub-feature-list">
            <% if paid_plan %>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h8m-8 6h16" stroke-width="2.5" stroke-linecap="round"/></svg>
                </span>
                <span><%= t('subscription_page.pro_transcript') %></span>
              </li>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11a7 7 0 0 1-7 7m0 0a7 7 0 0 1-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 0 1-3-3V5a3 3 0 1 1 6 0v6a3 3 0 0 1-3 3z"/></svg>
                </span>
                <span><%= t('subscription_page.pro_voice') %></span>
              </li>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1"/><path d="m12 15 4-4m-4 4-4-4m4 4V4"/></svg>
                </span>
                <span><%= t('subscription_page.pro_exports') %></span>
              </li>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"/></svg>
                </span>
                <span><%= t('subscription_page.pro_ai') %></span>
              </li>
            <% else %>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h8m-8 6h16" stroke-width="2.5" stroke-linecap="round"/></svg>
                </span>
                <span><%= t('subscription_page.free_transcript') %></span>
              </li>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11a7 7 0 0 1-7 7m0 0a7 7 0 0 1-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 0 1-3-3V5a3 3 0 1 1 6 0v6a3 3 0 0 1-3 3z"/></svg>
                </span>
                <span><%= t('subscription_page.free_voice') %></span>
              </li>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1"/><path d="m12 15 4-4m-4 4-4-4m4 4V4"/></svg>
                </span>
                <span><%= t('subscription_page.free_exports') %></span>
              </li>
              <li class="sub-feature-item">
                <span class="sub-feature-icon" aria-hidden="true">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>
                </span>
                <span><%= t('subscription_page.free_upgrade_cta') %></span>
              </li>
            <% end %>
          </ul>

          <% active_txn_id = billing_history_rows.find { |r| r[:status_kind] == 'completed' }&.dig(:id) %>
          <% if active_txn_id.present? && paid_plan %>
            <div class="sub-key" style="margin-top:0.7rem;"><%= t('subscription_page.transaction_id') %></div>
            <div class="sub-value" style="font-family:monospace;font-size:11px;color:rgba(255,255,255,0.6);"><%= active_txn_id %></div>
          <% end %>
        </div>

        <div class="sub-surface">
          <div class="sub-section-card-label"><%= t('subscription_page.subscription_section') %></div>
          <div class="sub-key"><%= t('subscription_page.status') %></div>
          <div class="sub-status-chip <%= status_active ? 'active' : (sub_canceled ? 'canceled' : 'inactive') %>"><%= status_label %></div>

          <div class="sub-key" style="margin-top:0.7rem;"><%= t('subscription_page.next_billing') %></div>
          <div class="sub-value"><%= next_billing_value %></div>

          <div class="sub-key" style="margin-top:0.7rem;"><%= t('subscription_page.next_charge_amount') %></div>
          <div class="sub-value"><%= next_charge_value %></div>
        </div>
      </div>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title"><%= t('subscription_page.billing_information') %></h2>
      <div class="billing-grid">
        <div class="sub-surface">
          <div class="sub-key"><%= t('subscription_page.payment_method') %></div>
          <div class="sub-value"><%= billing_payment_method %></div>
        </div>
        <div class="sub-surface">
          <div class="sub-key"><%= t('subscription_page.customer_email') %></div>
          <div class="sub-value"><%= billing_email %></div>
        </div>
        <div class="sub-surface">
          <div class="sub-key"><%= t('subscription_page.last_payment') %></div>
          <div class="sub-value"><%= billing_last_payment %></div>
        </div>
      </div>
      <div class="sub-actions">
        <% if show_manage_billing %>
          <%= button_to t('subscription_page.update_payment_method'), subscription_billing_portal_path(portal_action: 'update_payment'), method: :post, class: 'sub-btn', form: { class: 'sub-btn-form', target: '_blank', data: { turbo: false } } %>
          <%= button_to t('subscription_page.download_invoice_receipt'), subscription_billing_portal_path(portal_action: 'download_invoice'), method: :post, class: 'sub-btn', form: { class: 'sub-btn-form', target: '_blank', data: { turbo: false } } %>
        <% else %>
          <%= link_to contact_path, class: 'sub-btn' do %>
            <%= t('subscription_page.contact_support') %>
          <% end %>
        <% end %>
      </div>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title"><%= t('subscription_page.plan_options') %></h2>
      <div class="plan-options">
        <article class="plan-option-card <%= paid_plan ? '' : 'current' %>">
          <h3 class="plan-option-title"><%= t('subscription_page.plan_free') %></h3>
          <div class="plan-option-price"><%= t('subscription_page.free_price') %></div>
          <ul class="sub-feature-list" style="margin-top:0.7rem;">
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h8m-8 6h16" stroke-width="2.5" stroke-linecap="round"/></svg>
              </span>
              <span><%= t('subscription_page.free_transcript') %></span>
            </li>
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11a7 7 0 0 1-7 7m0 0a7 7 0 0 1-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 0 1-3-3V5a3 3 0 1 1 6 0v6a3 3 0 0 1-3 3z"/></svg>
              </span>
              <span><%= t('subscription_page.free_voice') %></span>
            </li>
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1"/><path d="m12 15 4-4m-4 4-4-4m4 4V4"/></svg>
              </span>
              <span><%= t('subscription_page.free_exports') %></span>
            </li>
          </ul>
          <% unless paid_plan %>
            <div class="plan-option-badge"><%= t('subscription_page.current_plan_badge') %></div>
          <% end %>
        </article>

        <article class="plan-option-card <%= paid_plan ? 'current' : '' %>">
          <h3 class="plan-option-title"><%= t('subscription_page.plan_pro') %></h3>
          <div class="plan-option-price"><%= ENV['PADDLE_PLAN_PRICE_LABEL'].presence || t('modal.pro_price') %></div>
          <ul class="sub-feature-list" style="margin-top:0.7rem;">
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h8m-8 6h16" stroke-width="2.5" stroke-linecap="round"/></svg>
              </span>
              <span><%= t('subscription_page.pro_transcript') %></span>
            </li>
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11a7 7 0 0 1-7 7m0 0a7 7 0 0 1-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 0 1-3-3V5a3 3 0 1 1 6 0v6a3 3 0 0 1-3 3z"/></svg>
              </span>
              <span><%= t('subscription_page.pro_voice') %></span>
            </li>
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1"/><path d="m12 15 4-4m-4 4-4-4m4 4V4"/></svg>
              </span>
              <span><%= t('subscription_page.pro_exports') %></span>
            </li>
            <li class="sub-feature-item">
              <span class="sub-feature-icon" aria-hidden="true">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"/></svg>
              </span>
              <span><%= t('subscription_page.pro_ai') %></span>
            </li>
          </ul>
          <% if paid_plan %>
            <div class="plan-option-badge"><%= t('subscription_page.current_plan_badge') %></div>
          <% else %>
            <div class="sub-actions" style="margin-top:0.75rem;">
              <%= link_to checkout_path, class: 'sub-btn primary' do %>
                <%= t('subscription_page.upgrade_now') %>
              <% end %>
            </div>
          <% end %>
        </article>
      </div>
      <div class="sub-actions" style="justify-content:center; margin-top:1.2rem;">
        <%= link_to pricing_path, class: "sub-btn#{paid_plan ? '' : ' primary'}" do %>
          <%= t('subscription_page.change_plan') %>
        <% end %>
      </div>
    </section>

    <section class="sub-section">
      <h2 class="sub-section-title"><%= t('subscription_page.billing_history') %></h2>
      <table class="history-table">
        <thead>
          <tr>
            <th><%= t('subscription_page.date') %></th>
            <th><%= t('subscription_page.amount') %></th>
            <th><%= t('subscription_page.status') %></th>
            <th class="txn-col"><%= t('subscription_page.transaction_id') %></th>
          </tr>
        </thead>
        <tbody>
          <% if billing_history_rows.any? %>
            <% billing_history_rows.each do |row| %>
              <tr>
                <td><%= row[:date] %></td>
                <td><%= row[:amount] %></td>
                <td>
                  <% localized_status = case row[:status_kind]
                     when 'completed' then t('subscription_page.history_completed')
                     when 'failed' then t('subscription_page.history_failed')
                     else row[:status]
                     end %>
                  <span class="history-status <%= row[:status_kind] %>"><%= localized_status %></span>
                </td>
                <td class="txn-col">
                  <% if row[:id].present? %>
                    <span style="font-family:monospace;font-size:11px;color:rgba(255,255,255,0.6);"><%= row[:id] %></span>
                  <% else %>
                    <span class="history-empty">â€”</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="4" class="history-empty txn-col-span"><%= t('subscription_page.no_billing_transactions') %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <% if show_manage_billing %>
        <div class="sub-actions">
          <%= button_to t('subscription_page.open_billing_portal'), subscription_billing_portal_path(portal_action: 'overview'), method: :post, class: 'sub-btn', form: { class: 'sub-btn-form', target: '_blank', data: { turbo: false } } %>
        </div>
      <% end %>
    </section>

    <section class="sub-section danger-zone">
      <h2 class="sub-section-title"><%= t('subscription_page.cancel_subscription') %></h2>
      <p class="danger-copy"><%= t('subscription_page.cancel_copy') %></p>
      <div class="sub-actions">
        <% if show_manage_billing %>
          <%= button_to t('subscription_page.cancel_in_billing_portal'), subscription_billing_portal_path(portal_action: 'cancel'), method: :post, class: 'sub-btn danger', form: { class: 'sub-btn-form', target: '_blank', data: { turbo: false } } %>
        <% else %>
          <%= link_to contact_path, class: 'sub-btn danger' do %>
            <%= t('subscription_page.contact_support_cancel') %>
          <% end %>
        <% end %>
      </div>
    </section>
  </div>
</div>
