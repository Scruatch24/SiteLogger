<% content_for :head do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<% end %>

<%
  currency = @is_demo ? "GEL" : (@profile.currency.presence || "USD")
  currency_symbol = @is_demo ? "₾" : case currency
                    when "GEL" then "₾"
                    when "EUR" then "€"
                    when "GBP" then "£"
                    else "$"
                    end

  fmt_money = ->(val) { "#{currency_symbol}#{number_with_delimiter(val.to_f.round(2))}" }

  total_invoices_count = @status_counts.values.sum
  paid_ratio = total_invoices_count > 0 ? ((@status_counts[:paid].to_f / total_invoices_count) * 100).round(0) : 0
  unpaid_ratio = 100 - paid_ratio

  trend_badge = ->(val) {
    return "" if val.nil?
    cls = val >= 0 ? "up" : "down"
    arrow = val >= 0 ? "↑" : "↓"
    raw("<span class=\"ana-trend-badge #{cls}\">#{arrow} #{val.abs}%</span>")
  }

  health_color = case @health_level
                 when "healthy" then "#4ade80"
                 when "risk" then "#fbbf24"
                 else "#f87171"
                 end
  health_bg = case @health_level
              when "healthy" then "rgba(74,222,128,0.08)"
              when "risk" then "rgba(251,191,36,0.08)"
              else "rgba(248,113,113,0.08)"
              end
  health_border = case @health_level
                  when "healthy" then "rgba(74,222,128,0.3)"
                  when "risk" then "rgba(251,191,36,0.3)"
                  else "rgba(248,113,113,0.3)"
                  end
%>

<style>
  .analytics-page {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0a0a0a;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  .pricing-bg {
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(249,115,22,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(99,102,241,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .pricing-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .pricing-particle {
    position: fixed;
    background: rgba(249,115,22,0.4);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: pricingFloat linear infinite;
  }

  @keyframes pricingFloat {
    0%   { transform: translateY(0) scale(1); opacity: 0; }
    10%  { opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
  }

  .analytics-content {
    position: relative;
    z-index: 1;
    max-width: 1080px;
    margin: 0 auto;
    padding: 2rem 1.2rem 4rem;
    color: #f8fafc;
    font-family: "Sora", "Inter", "Noto Sans Georgian", "Segoe UI", sans-serif;
  }

  .ana-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.72);
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-decoration: none;
    border-radius: 999px;
    padding: 11px 15px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.14);
    transition: all 0.2s ease;
  }
  .ana-back svg { width: 13px; height: 13px; }
  .ana-back:hover {
    color: #ffffff;
    border-color: rgba(249,115,22,0.45);
    background: rgba(249,115,22,0.15);
  }

  .analytics-header { margin: 1.2rem 0 1.4rem; }
  .analytics-title {
    margin: 0;
    font-size: clamp(2rem, 5.7vw, 3.4rem);
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: -0.01em;
    font-weight: 900;
    color: white;
  }
  .analytics-title .accent { color: #f97316; }

  /* Section Cards */
  .ana-section {
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(4,6,12,0.72);
    backdrop-filter: blur(8px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    padding: 1.15rem;
  }
  .ana-section + .ana-section { margin-top: 0.95rem; }

  .ana-section-title {
    margin: 0 0 0.9rem;
    font-size: 17px;
    line-height: 1.2;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #fff7ed;
    text-shadow: 0 10px 28px rgba(249,115,22,0.28);
    position: relative;
    padding-bottom: 0.45rem;
  }
  .ana-section-title::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 64px;
    height: 2px;
    border-radius: 999px;
    background: linear-gradient(90deg, #fb923c, rgba(251,146,60,0.08));
  }

  /* Overview Cards Grid */
  .ana-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.7rem;
  }

  .ana-card {
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    padding: 0.95rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    transition: border-color 0.2s ease;
  }
  .ana-card:hover { border-color: rgba(249,115,22,0.35); }
  .ana-card.highlight-danger { border-color: rgba(248,113,113,0.4); background: rgba(248,113,113,0.04); }
  .ana-card.highlight-warning { border-color: rgba(251,191,36,0.4); background: rgba(251,191,36,0.04); }

  .ana-card-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.54);
    font-weight: 700;
  }
  .ana-card-value {
    font-size: 26px;
    font-weight: 900;
    color: #f8fafc;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }
  .ana-card-value.accent { color: #f97316; }
  .ana-card-value.green { color: #4ade80; }
  .ana-card-value.red { color: #f87171; }
  .ana-card-value.yellow { color: #fbbf24; }
  .ana-card-trend {
    font-size: 10px;
    font-weight: 700;
    color: rgba(255,255,255,0.4);
  }
  .ana-card-trend.up { color: #4ade80; }
  .ana-card-trend.down { color: #f87171; }

  /* ── Trend Badges ── */
  .ana-trend-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 800;
    padding: 2px 7px;
    border-radius: 6px;
    margin-left: 4px;
    vertical-align: middle;
  }
  .ana-trend-badge.up { color: #4ade80; background: rgba(74,222,128,0.12); }
  .ana-trend-badge.down { color: #f87171; background: rgba(248,113,113,0.12); }

  /* ── Health Score Banner ── */
  .ana-health-banner {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.2rem;
    border-radius: 18px;
    margin-bottom: 0.95rem;
  }
  .ana-health-score-ring {
    width: 64px;
    height: 64px;
    flex-shrink: 0;
    position: relative;
  }
  .ana-health-score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
  .ana-health-score-ring .ring-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 5; }
  .ana-health-score-ring .ring-fill { fill: none; stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
  .ana-health-score-val {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 900;
    transform: none;
  }
  .ana-health-info { flex: 1; min-width: 0; }
  .ana-health-title {
    font-size: 14px;
    font-weight: 800;
    color: #f8fafc;
  }
  .ana-health-desc {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    margin-top: 2px;
    font-weight: 600;
  }
  .ana-health-metrics {
    display: flex;
    gap: 1.2rem;
    flex-shrink: 0;
  }
  .ana-health-metric { text-align: center; }
  .ana-health-metric-val {
    font-size: 16px;
    font-weight: 900;
  }
  .ana-health-metric-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.4);
    font-weight: 700;
  }

  /* ── Quick Action Links ── */
  .ana-action-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    text-decoration: none;
    padding: 5px 10px;
    border-radius: 8px;
    margin-top: 6px;
    transition: all 0.2s ease;
  }
  .ana-action-link svg { width: 12px; height: 12px; }
  .ana-alert.danger .ana-action-link { color: #f87171; background: rgba(248,113,113,0.1); }
  .ana-alert.danger .ana-action-link:hover { background: rgba(248,113,113,0.2); }
  .ana-alert.warning .ana-action-link { color: #fbbf24; background: rgba(251,191,36,0.1); }
  .ana-alert.warning .ana-action-link:hover { background: rgba(251,191,36,0.2); }
  .ana-alert.info .ana-action-link { color: #60a5fa; background: rgba(96,165,250,0.1); }
  .ana-alert.info .ana-action-link:hover { background: rgba(96,165,250,0.2); }

  /* ── Client Badges ── */
  .ana-client-badges {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 3px;
  }
  .ana-badge {
    font-size: 8px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 2px 6px;
    border-radius: 5px;
  }
  .ana-badge.top-client { color: #f97316; background: rgba(249,115,22,0.15); }
  .ana-badge.high-outstanding { color: #fbbf24; background: rgba(251,191,36,0.15); }
  .ana-badge.frequently-overdue { color: #f87171; background: rgba(248,113,113,0.15); }

  /* ── Alerts Panel ── */
  .ana-alerts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .ana-alert {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.85rem 1rem;
    border-radius: 16px;
    border: 1px solid;
  }
  .ana-alert.danger {
    border-color: rgba(248,113,113,0.35);
    background: rgba(248,113,113,0.06);
  }
  .ana-alert.warning {
    border-color: rgba(251,191,36,0.35);
    background: rgba(251,191,36,0.06);
  }
  .ana-alert.info {
    border-color: rgba(96,165,250,0.35);
    background: rgba(96,165,250,0.06);
  }
  .ana-alert-icon {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .ana-alert.danger .ana-alert-icon { background: rgba(248,113,113,0.15); color: #f87171; }
  .ana-alert.warning .ana-alert-icon { background: rgba(251,191,36,0.15); color: #fbbf24; }
  .ana-alert.info .ana-alert-icon { background: rgba(96,165,250,0.15); color: #60a5fa; }
  .ana-alert-icon svg { width: 16px; height: 16px; }
  .ana-alert-body { flex: 1; min-width: 0; }
  .ana-alert-title {
    font-size: 13px;
    font-weight: 800;
    color: #f8fafc;
    margin: 0;
  }
  .ana-alert-desc {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    margin-top: 2px;
    font-weight: 600;
  }

  /* ── Invoice Status Control Center ── */
  .ana-section-divider {
    display: flex; align-items: center; gap: 0.6rem;
    margin: 1rem 0 0.6rem;
  }
  .ana-section-divider-line {
    flex: 1; height: 1px;
    background: rgba(255,255,255,0.08);
  }
  .ana-section-divider-text {
    font-size: 9px; font-weight: 800; text-transform: uppercase;
    letter-spacing: 0.08em; color: rgba(255,255,255,0.3);
    white-space: nowrap;
  }

  .ana-aging-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .ana-aging-item {
    text-align: center;
    border-radius: 14px;
    padding: 0.7rem 0.4rem;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .ana-aging-item:hover { background: rgba(255,255,255,0.05); }
  .ana-aging-item.expanded { border-width: 1.5px; background: rgba(255,255,255,0.04); }
  .ana-aging-count {
    font-size: 22px;
    font-weight: 900;
    line-height: 1;
  }
  .ana-aging-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.4);
    margin-top: 0.3rem;
    font-weight: 700;
  }
  .ana-aging-item.green .ana-aging-count { color: #4ade80; }
  .ana-aging-item.yellow .ana-aging-count { color: #fbbf24; }
  .ana-aging-item.orange .ana-aging-count { color: #f97316; }
  .ana-aging-item.red .ana-aging-count { color: #f87171; }
  .ana-aging-item.green { border-color: rgba(74,222,128,0.2); }
  .ana-aging-item.yellow { border-color: rgba(251,191,36,0.2); }
  .ana-aging-item.orange { border-color: rgba(249,115,22,0.2); }
  .ana-aging-item.red { border-color: rgba(248,113,113,0.2); }
  .ana-aging-item.green.expanded { border-color: rgba(74,222,128,0.45); }
  .ana-aging-item.yellow.expanded { border-color: rgba(251,191,36,0.45); }
  .ana-aging-item.orange.expanded { border-color: rgba(249,115,22,0.45); }
  .ana-aging-item.red.expanded { border-color: rgba(248,113,113,0.45); }

  .ana-aging-expand {
    display: none;
    margin-top: 0.5rem;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    overflow: hidden;
  }
  .ana-aging-expand.visible { display: block; }
  .ana-aging-expand-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.6rem 0.85rem; flex-wrap: wrap; gap: 0.4rem;
  }
  .ana-aging-expand-header-left {
    display: flex; align-items: baseline; gap: 0.4rem; flex-wrap: wrap;
  }
  .ana-aging-expand-link {
    font-size: 10px; font-weight: 800; text-decoration: none;
    text-transform: uppercase; letter-spacing: 0.06em;
    white-space: nowrap; transition: opacity 0.2s;
  }
  .ana-aging-expand-link:hover { opacity: 0.7; }

  /* ── Paid/Unpaid Ratio Bar ── */
  .ana-ratio-bar-wrap { margin-top: 0.8rem; }
  .ana-ratio-labels {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.35rem;
  }
  .ana-ratio-labels .paid-label { color: #4ade80; }
  .ana-ratio-labels .unpaid-label { color: #f87171; }
  .ana-ratio-bar {
    height: 8px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(248,113,113,0.2);
    display: flex;
  }
  .ana-ratio-bar-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, #4ade80, #22c55e);
    transition: width 0.6s ease;
  }

  /* Chart Area */
  .ana-chart-wrap {
    position: relative;
    width: 100%;
    height: 280px;
    margin-top: 0.5rem;
  }
  .ana-chart-wrap canvas { width: 100% !important; height: 100% !important; }

  .ana-chart-filters {
    display: flex;
    gap: 0.4rem;
    margin-bottom: 0.6rem;
    flex-wrap: wrap;
  }
  .ana-filter-btn {
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.04);
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .ana-filter-btn:hover {
    border-color: rgba(249,115,22,0.45);
    color: #fff;
  }
  .ana-filter-btn.active {
    background: rgba(249,115,22,0.18);
    border-color: rgba(249,115,22,0.55);
    color: #f97316;
  }

  .ana-metric-tabs {
    display: flex;
    gap: 0.35rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 2px;
  }
  .ana-metric-tabs::-webkit-scrollbar { display: none; }
  .ana-metric-tab {
    padding: 7px 13px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    color: rgba(255,255,255,0.5);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .ana-metric-tab:hover { color: #fff; border-color: rgba(255,255,255,0.25); }
  .ana-metric-tab.active {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 4px 12px rgba(249,115,22,0.3);
  }

  /* Stats Grid inside sections */
  .ana-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.7rem;
  }

  .ana-stat-surface {
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    padding: 0.9rem;
  }
  .ana-stat-key {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.54);
    margin-bottom: 0.3rem;
    font-weight: 700;
  }
  .ana-stat-val {
    font-size: 18px;
    font-weight: 900;
    color: #f8fafc;
  }
  .ana-stat-val.orange { color: #f97316; }
  .ana-stat-val.green { color: #4ade80; }
  .ana-stat-val.red { color: #f87171; }

  /* Status Pills */
  .ana-status-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-top: 0.7rem;
  }
  .ana-status-pill {
    text-align: center;
    border-radius: 14px;
    padding: 0.6rem 0.4rem;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.02);
  }
  .ana-status-pill-count {
    font-size: 20px;
    font-weight: 900;
    color: #f8fafc;
    line-height: 1;
  }
  .ana-status-pill-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.45);
    margin-top: 0.25rem;
    font-weight: 700;
  }
  .ana-status-pill.draft { border-color: rgba(148,163,184,0.3); }
  .ana-status-pill.draft .ana-status-pill-count { color: #94a3b8; }
  .ana-status-pill.sent { border-color: rgba(96,165,250,0.3); }
  .ana-status-pill.sent .ana-status-pill-count { color: #60a5fa; }
  .ana-status-pill.paid { border-color: rgba(74,222,128,0.3); }
  .ana-status-pill.paid .ana-status-pill-count { color: #4ade80; }
  .ana-status-pill.overdue { border-color: rgba(248,113,113,0.3); }
  .ana-status-pill.overdue .ana-status-pill-count { color: #f87171; }

  /* ── Client Insights ── */
  .ana-client-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-bottom: 0.8rem;
  }
  .ana-client-summary-item {
    text-align: center;
    padding: 0.6rem;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
  }
  .ana-client-summary-val {
    font-size: 20px;
    font-weight: 900;
    color: #f97316;
    line-height: 1;
  }
  .ana-client-summary-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.4);
    margin-top: 0.25rem;
    font-weight: 700;
  }

  .ana-clients-list {
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
  }
  .ana-client-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.7rem 0.85rem;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    transition: border-color 0.2s ease;
  }
  .ana-client-row:hover { border-color: rgba(249,115,22,0.3); }
  .ana-client-rank {
    width: 26px;
    height: 26px;
    border-radius: 8px;
    background: rgba(249,115,22,0.12);
    color: #f97316;
    font-size: 11px;
    font-weight: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .ana-client-info { flex: 1; min-width: 0; }
  .ana-client-name {
    font-size: 13px;
    font-weight: 700;
    color: #f8fafc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ana-client-meta {
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    font-weight: 600;
    margin-top: 2px;
  }
  .ana-client-amounts {
    text-align: right;
    flex-shrink: 0;
  }
  .ana-client-total {
    font-size: 14px;
    font-weight: 900;
    color: #f97316;
  }
  .ana-client-outstanding {
    font-size: 10px;
    font-weight: 700;
    color: rgba(255,255,255,0.35);
    margin-top: 1px;
  }
  .ana-client-outstanding.has-outstanding { color: #fbbf24; }

  .ana-empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: rgba(255,255,255,0.3);
    font-size: 13px;
    font-weight: 600;
  }

  /* Last Updated + Export */
  .ana-last-updated {
    font-size: 10px;
    font-weight: 600;
    color: rgba(255,255,255,0.3);
    letter-spacing: 0.02em;
  }
  .ana-export-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.5);
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    transition: all 0.2s ease;
  }
  .ana-export-btn:hover {
    color: #f97316;
    border-color: rgba(249,115,22,0.4);
    background: rgba(249,115,22,0.08);
  }

  /* Due Soon Detail List */
  .ana-due-soon-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    margin-top: 0.6rem;
  }
  .ana-due-soon-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.55rem 0.75rem;
    border-radius: 12px;
    border: 1px solid rgba(96,165,250,0.15);
    background: rgba(96,165,250,0.03);
    transition: border-color 0.2s ease;
  }
  .ana-due-soon-row:hover { border-color: rgba(96,165,250,0.35); }
  .ana-due-soon-row.urgent { border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.04); }
  .ana-due-soon-days {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-weight: 900;
  }
  .ana-due-soon-days-num { font-size: 14px; line-height: 1; }
  .ana-due-soon-days-label { font-size: 7px; text-transform: uppercase; letter-spacing: 0.04em; opacity: 0.7; }
  .ana-due-soon-row:not(.urgent) .ana-due-soon-days { background: rgba(96,165,250,0.12); color: #60a5fa; }
  .ana-due-soon-row.urgent .ana-due-soon-days { background: rgba(251,191,36,0.15); color: #fbbf24; }
  .ana-due-soon-info { flex: 1; min-width: 0; }
  .ana-due-soon-client {
    font-size: 12px;
    font-weight: 700;
    color: #f8fafc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ana-due-soon-meta {
    font-size: 10px;
    color: rgba(255,255,255,0.35);
    font-weight: 600;
  }
  .ana-due-soon-amount {
    font-size: 13px;
    font-weight: 900;
    color: #60a5fa;
    flex-shrink: 0;
  }
  .ana-due-soon-row.urgent .ana-due-soon-amount { color: #fbbf24; }

  /* Top Client Share Warning */
  .ana-client-share-warning {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    padding: 0.6rem 0.85rem;
    border-radius: 12px;
    border: 1px solid rgba(251,191,36,0.25);
    background: rgba(251,191,36,0.05);
    margin-bottom: 0.7rem;
  }
  .ana-client-share-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    background: rgba(251,191,36,0.15);
    color: #fbbf24;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .ana-client-share-icon svg { width: 14px; height: 14px; }
  .ana-client-share-text {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    font-weight: 600;
  }
  .ana-client-share-text strong { color: #fbbf24; font-weight: 800; }

  /* Empty State Enhanced */
  .ana-empty-state svg { width: 32px; height: 32px; margin-bottom: 0.5rem; opacity: 0.3; }
  .ana-empty-state-hint {
    font-size: 11px;
    color: rgba(255,255,255,0.2);
    margin-top: 0.3rem;
    font-weight: 500;
  }

  /* Export Buttons */
  .ana-export-buttons {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 1.2rem;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
  }
  .ana-export-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex: 1;
    padding: 14px 20px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  .ana-export-btn.csv {
    border: 1px solid rgba(249,115,22,0.35);
    background: rgba(249,115,22,0.08);
    color: #f97316;
  }
  .ana-export-btn.csv:hover {
    background: rgba(249,115,22,0.15);
    border-color: rgba(249,115,22,0.55);
    box-shadow: 0 4px 16px rgba(249,115,22,0.15);
  }
  .ana-export-btn.pdf {
    border: 1px solid rgba(96,165,250,0.35);
    background: rgba(96,165,250,0.08);
    color: #60a5fa;
  }
  .ana-export-btn.pdf:hover {
    background: rgba(96,165,250,0.15);
    border-color: rgba(96,165,250,0.55);
    box-shadow: 0 4px 16px rgba(96,165,250,0.15);
  }

  /* Footer */
  .ana-footer {
    text-align: center;
    padding: 2rem 0 0;
    border-top: 1px solid rgba(255,255,255,0.06);
    margin-top: 1.5rem;
  }
  .ana-footer-text {
    font-size: 11px;
    color: rgba(255,255,255,0.2);
    font-weight: 500;
  }

  @media (max-width: 880px) {
    .ana-cards { grid-template-columns: repeat(2, 1fr); }
    .ana-stats-grid { grid-template-columns: 1fr; }
    .ana-status-grid { grid-template-columns: repeat(2, 1fr); }
    .ana-aging-grid { grid-template-columns: repeat(2, 1fr); }
    .ana-client-summary { grid-template-columns: repeat(3, 1fr); }
    .ana-health-metrics { gap: 0.8rem; }
  }
  @media (max-width: 640px) {
    .analytics-content { padding: 1.45rem 0.85rem 3rem; }
    .analytics-header { text-align: center !important; }
    .ana-cards { grid-template-columns: 1fr 1fr; }
    .ana-card-value { font-size: 22px; }
    .ana-chart-wrap { height: 220px; }
    .ana-health-banner { flex-wrap: wrap; }
    .ana-health-metrics { width: 100%; justify-content: space-around; margin-top: 0.5rem; }
    .ana-export-buttons { max-width: 100%; flex-direction: column; }
    .ana-aging-expand-header { flex-direction: column; align-items: flex-start; }
  }
  @media (max-width: 400px) {
    .ana-cards { grid-template-columns: 1fr; }
    .ana-status-grid { grid-template-columns: repeat(2, 1fr); }
    .ana-aging-grid { grid-template-columns: repeat(2, 1fr); }
    .ana-client-summary { grid-template-columns: 1fr; }
  }

  /* ── DEMO MODE ── */
  .ana-demo-banner {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,10,10,0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(249,115,22,0.25);
    padding: 0.65rem 1.25rem;
  }
  .ana-demo-banner-inner {
    max-width: 860px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .ana-demo-banner-left {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    color: rgba(255,255,255,0.55);
    min-width: 0;
  }
  .ana-demo-banner-left svg { color: #f97316; flex-shrink: 0; }
  .ana-demo-label {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #f97316;
    white-space: nowrap;
  }
  .ana-demo-desc {
    font-size: 11px;
    font-weight: 500;
    color: rgba(255,255,255,0.4);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ana-demo-banner-right { flex-shrink: 0; }
  .ana-demo-cta-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0.55rem 1.25rem;
    background: linear-gradient(to right, #f97316, #ea580c);
    color: white;
    border-radius: 0.75rem;
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    text-decoration: none;
    box-shadow: 0 4px 14px rgba(249,115,22,0.3);
    transition: opacity 0.2s;
  }
  .ana-demo-cta-btn:hover { opacity: 0.85; }

  .ana-demo-content-wrap {
    opacity: 0.35;
    filter: blur(1.5px);
    pointer-events: none;
    user-select: none;
    -webkit-user-select: none;
  }
  @media (max-width: 640px) {
    .ana-demo-desc { display: none; }
    .ana-demo-banner { padding: 0.55rem 1rem; }
  }
</style>

<div class="analytics-page" <%= @is_pro ? "data-controller=\"analytics-dashboard\" data-analytics-dashboard-data-url-value=\"#{analytics_data_path}\" data-analytics-dashboard-currency-symbol-value=\"#{@currency_symbol}\"" : "" %>>
  <div class="pricing-bg"></div>
  <div class="pricing-grid"></div>

  <% 12.times do %>
    <div class="pricing-particle" style="left:<%= rand(5..95) %>%; bottom:-2%; animation-duration:<%= rand(8..16) %>s; animation-delay:<%= (rand(0..60) / 10.0) %>s; width:<%= rand(1..3) %>px; height:<%= rand(1..3) %>px; opacity:<%= rand(2..5) / 10.0 %>;"></div>
  <% end %>

  <% if @is_demo %>
  <!-- ── DEMO OVERLAY CTA ── -->
  <div class="ana-demo-banner" id="anaDemoBanner">
    <div class="ana-demo-banner-inner">
      <div class="ana-demo-banner-left">
        <svg style="width:18px;height:18px;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>
        </svg>
        <span class="ana-demo-label"><%= t('analytics_page.demo_preview_label') %></span>
        <span class="ana-demo-desc"><%= t('analytics_page.demo_preview_desc') %></span>
      </div>
      <div class="ana-demo-banner-right">
        <% if user_signed_in? %>
          <%= link_to checkout_path, class: 'ana-demo-cta-btn' do %>
            <svg style="width:13px;height:13px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            <%= t('analytics_page.upgrade_to_pro') %>
          <% end %>
        <% else %>
          <%= link_to new_user_registration_path, class: 'ana-demo-cta-btn' do %>
            <%= t('modal.signup_free') %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
  <% end %>

  <!-- Back + header always outside the blur wrap so they're interactive -->
  <div class="analytics-content" style="padding-bottom:0; position:relative; z-index:10;">
    <%= link_to root_path, class: 'ana-back' do %>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
      </svg>
      <%= t('analytics_page.back_home') %>
    <% end %>
    <header class="analytics-header" style="text-align:center;">
      <h1 class="analytics-title"><%= t('analytics_page.title_prefix') %> <span class="accent"><%= t('analytics_page.title_accent') %></span></h1>
    </header>
  </div>

  <% if @is_demo %>
  <div class="ana-demo-content-wrap">
  <% end %>

  <div class="analytics-content" style="padding-top:0;">
    <% if @analytics_cached_at %>
      <div style="text-align:center; margin-bottom: 1rem;">
        <span class="ana-last-updated"><%= t('analytics_page.last_updated', time: time_ago_in_words(@analytics_cached_at)) %></span>
      </div>
    <% end %>

    <!-- ═══════════════ 0. FINANCIAL HEALTH SCORE ═══════════════ -->
    <% circumference = 2 * Math::PI * 27; dash_offset = circumference * (1 - @health_score / 100.0) %>
    <div class="ana-health-banner" style="background: <%= health_bg %>; border: 1px solid <%= health_border %>;">
      <div class="ana-health-score-ring">
        <svg viewBox="0 0 64 64">
          <circle class="ring-bg" cx="32" cy="32" r="27"/>
          <circle class="ring-fill" cx="32" cy="32" r="27" stroke="<%= health_color %>" stroke-dasharray="<%= circumference.round(1) %>" stroke-dashoffset="<%= dash_offset.round(1) %>"/>
        </svg>
        <div class="ana-health-score-val" style="color: <%= health_color %>;"><%= @health_score %>%</div>
      </div>
      <div class="ana-health-info">
        <div class="ana-health-title"><%= t("analytics_page.health_#{@health_level}") %></div>
        <div class="ana-health-desc"><%= t("analytics_page.health_#{@health_level}_desc") %></div>
      </div>
      <div class="ana-health-metrics">
        <div class="ana-health-metric">
          <div class="ana-health-metric-val" style="color: <%= @collection_rate >= 80 ? '#4ade80' : (@collection_rate >= 50 ? '#fbbf24' : '#f87171') %>;"><%= @collection_rate %>%</div>
          <div class="ana-health-metric-label"><%= t('analytics_page.collection_rate') %></div>
        </div>
        <div class="ana-health-metric">
          <div class="ana-health-metric-val" style="color: <%= @outstanding_ratio <= 20 ? '#4ade80' : (@outstanding_ratio <= 50 ? '#fbbf24' : '#f87171') %>;"><%= @outstanding_ratio %>%</div>
          <div class="ana-health-metric-label"><%= t('analytics_page.outstanding_ratio') %></div>
        </div>
      </div>
    </div>

    <!-- ═══════════════ 1. OVERVIEW ═══════════════ -->
    <section class="ana-section">
      <h2 class="ana-section-title"><%= t('analytics_page.overview') %></h2>
      <div class="ana-cards">
        <div class="ana-card">
          <div class="ana-card-label"><%= t('analytics_page.total_invoiced') %></div>
          <div class="ana-card-value"><%= fmt_money.call(@total_invoiced) %></div>
          <div class="ana-card-trend"><%= t('analytics_page.lifetime') %></div>
        </div>
        <div class="ana-card <%= @total_outstanding > 0 ? 'highlight-warning' : '' %>">
          <div class="ana-card-label"><%= t('analytics_page.outstanding') %></div>
          <div class="ana-card-value yellow"><%= fmt_money.call(@total_outstanding) %></div>
          <div class="ana-card-trend"><%= t('analytics_page.outstanding_equals', pct: @outstanding_ratio) %> <%= trend_badge.call(@outstanding_trend) %></div>
        </div>
        <div class="ana-card <%= @overdue_count > 0 ? 'highlight-danger' : '' %>">
          <div class="ana-card-label"><%= t('analytics_page.overdue_amount') %></div>
          <div class="ana-card-value red"><%= fmt_money.call(@total_overdue_amt) %></div>
          <div class="ana-card-trend"><%= pluralize(@overdue_count, t('analytics_page.invoice_singular')) %> <%= t('analytics_page.overdue_label') %></div>
        </div>
        <div class="ana-card">
          <div class="ana-card-label"><%= t('analytics_page.collected_this_month') %></div>
          <div class="ana-card-value green"><%= fmt_money.call(@collected_this_month) %></div>
          <div class="ana-card-trend"><%= l(Date.today, format: "%B %Y") %> <%= trend_badge.call(@revenue_trend) %></div>
        </div>
        <div class="ana-card">
          <div class="ana-card-label"><%= t('analytics_page.projected_revenue') %></div>
          <div class="ana-card-value accent"><%= fmt_money.call(@projected_revenue) %></div>
          <div class="ana-card-trend"><%= t('analytics_page.estimate_this_month') %></div>
        </div>
        <div class="ana-card">
          <div class="ana-card-label"><%= t('analytics_page.avg_invoice') %></div>
          <div class="ana-card-value"><%= fmt_money.call(@avg_invoice) %></div>
          <div class="ana-card-trend"><%= t('analytics_page.per_invoice') %></div>
        </div>
      </div>
    </section>

    <!-- ═══════════════ 2. ALERTS ═══════════════ -->
    <% if @alerts.any? %>
    <section class="ana-section">
      <h2 class="ana-section-title"><%= t('analytics_page.action_required') %></h2>
      <div class="ana-alerts">
        <% @alerts.each do |alert| %>
          <div class="ana-alert <%= alert[:type] %>">
            <div class="ana-alert-icon">
              <% case alert[:icon] %>
              <% when "alert-triangle" %>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
              <% when "clock" %>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              <% when "calendar" %>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
              <% when "dollar-sign" %>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              <% end %>
            </div>
            <div class="ana-alert-body">
              <div class="ana-alert-title"><%= alert[:title] %></div>
              <div class="ana-alert-desc"><%= alert[:desc] %></div>
              <% if alert[:action] %>
                <% alert_href = case alert[:action]
                   when "overdue" then "#{history_path}?status=overdue"
                   when "due_today" then "#{history_path}?due=today"
                   when "due_soon" then "#{history_path}?due=soon"
                   when "unpaid" then "#{history_path}?unpaid=true"
                   else history_path
                   end %>
                <a href="<%= alert_href %>" class="ana-action-link">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                  <%= t("analytics_page.view_#{alert[:action]}") %>
                </a>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </section>
    <% end %>

    <!-- ═══════════════ 3. INVOICE STATUS CONTROL CENTER ═══════════════ -->
    <section class="ana-section">
      <h2 class="ana-section-title"><%= t('analytics_page.invoice_status_center') %></h2>

      <div class="ana-status-grid">
        <div class="ana-status-pill draft">
          <div class="ana-status-pill-count"><%= @status_counts[:draft] %></div>
          <div class="ana-status-pill-label"><%= t('analytics_page.status_draft') %></div>
        </div>
        <div class="ana-status-pill sent">
          <div class="ana-status-pill-count"><%= @status_counts[:sent] %></div>
          <div class="ana-status-pill-label"><%= t('analytics_page.status_sent') %></div>
        </div>
        <div class="ana-status-pill paid">
          <div class="ana-status-pill-count"><%= @status_counts[:paid] %></div>
          <div class="ana-status-pill-label"><%= t('analytics_page.status_paid') %></div>
        </div>
        <div class="ana-status-pill overdue">
          <div class="ana-status-pill-count"><%= @status_counts[:overdue] %></div>
          <div class="ana-status-pill-label"><%= t('analytics_page.status_overdue') %></div>
        </div>
      </div>

      <!-- ── Divider: Aging Breakdown ── -->
      <div class="ana-section-divider">
        <div class="ana-section-divider-line"></div>
        <span class="ana-section-divider-text"><%= t('analytics_page.aging_breakdown') %></span>
        <div class="ana-section-divider-line"></div>
      </div>

      <!-- Aging Breakdown (clickable) -->
      <%
        aging_buckets = [
          { key: :due_today,      count: @aging[:due_today],       color: "green",  label: t('analytics_page.aging_due_today'), invoices: @aging_invoices[:due_today]  || [], total: @aging_amounts[:due_today]  || 0, due_param: "today",  link_color: "#4ade80" },
          { key: :overdue_1_7,    count: @aging[:overdue_1_7],     color: "yellow", label: t('analytics_page.aging_1_7'),       invoices: @aging_invoices[:overdue_1_7] || [], total: @aging_amounts[:overdue_1_7] || 0, due_param: "1-7",    link_color: "#fbbf24" },
          { key: :overdue_7_30,   count: @aging[:overdue_7_30],    color: "orange", label: t('analytics_page.aging_7_30'),      invoices: @aging_invoices[:overdue_7_30]|| [], total: @aging_amounts[:overdue_7_30]|| 0, due_param: "7-30",   link_color: "#f97316" },
          { key: :overdue_30_plus,count: @aging[:overdue_30_plus], color: "red",    label: t('analytics_page.aging_30_plus'),   invoices: @aging_invoices[:overdue_30_plus]||[], total: @aging_amounts[:overdue_30_plus]||0, due_param: "30plus", link_color: "#f87171" }
        ]
      %>
      <div class="ana-aging-grid">
        <% aging_buckets.each do |bucket| %>
          <div class="ana-aging-item <%= bucket[:color] %>" onclick="toggleAgingExpand('<%= bucket[:key] %>')" data-aging-key="<%= bucket[:key] %>">
            <div class="ana-aging-count"><%= bucket[:count] %></div>
            <div class="ana-aging-label"><%= bucket[:label] %></div>
          </div>
        <% end %>
      </div>

      <!-- Expandable invoice lists for each aging bucket -->
      <% aging_buckets.each do |bucket| %>
        <div class="ana-aging-expand" id="aging-expand-<%= bucket[:key] %>">
          <div class="ana-aging-expand-header">
            <div class="ana-aging-expand-header-left">
              <span style="font-size: 12px; font-weight: 800; color: <%= bucket[:link_color] %>;"><%= pluralize(bucket[:count], t('analytics_page.invoice_singular')) %></span>
              <span style="font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 600;"><%= bucket[:label].downcase %> · <%= fmt_money.call(bucket[:total]) %></span>
            </div>
            <a href="<%= history_path %>?due=<%= bucket[:due_param] %>" class="ana-aging-expand-link" style="color: <%= bucket[:link_color] %>;"><%= t('analytics_page.view_in_history') %> →</a>
          </div>
          <% if bucket[:invoices].any? %>
            <div class="ana-due-soon-list">
              <% bucket[:invoices].first(5).each do |inv| %>
                <div class="ana-due-soon-row <%= inv[:days] <= 2 ? 'urgent' : '' %>">
                  <div class="ana-due-soon-days">
                    <div class="ana-due-soon-days-num"><%= inv[:days] %></div>
                    <div class="ana-due-soon-days-label"><%= t('analytics_page.days_short') %></div>
                  </div>
                  <div class="ana-due-soon-info">
                    <div class="ana-due-soon-client"><%= inv[:client] %></div>
                    <div class="ana-due-soon-meta">INV-<%= inv[:display_number] %> · <%= inv[:due_date] %></div>
                  </div>
                  <div class="ana-due-soon-amount"><%= fmt_money.call(inv[:amount]) %></div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- ── Divider: Upcoming ── -->
      <% if @due_soon_count > 0 %>
        <div class="ana-section-divider" style="margin-top: 1rem;">
          <div class="ana-section-divider-line"></div>
          <span class="ana-section-divider-text"><%= t('analytics_page.upcoming_soon') %></span>
          <div class="ana-section-divider-line"></div>
        </div>
      <% end %>

      <!-- Due Soon highlight (1-7 days upcoming) -->
      <% if @due_soon_count > 0 %>
        <div style="margin-top: 0.7rem; padding: 0.6rem 0.85rem; border-radius: 12px; border: 1px solid rgba(96,165,250,0.25); background: rgba(96,165,250,0.05);">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.4rem;">
            <div style="display: flex; align-items: baseline; gap: 0.3rem; flex-wrap: wrap;">
              <span style="font-size: 12px; font-weight: 800; color: #60a5fa;"><%= pluralize(@due_soon_count, t('analytics_page.invoice_singular')) %></span>
              <span style="font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 600;"><%= t('analytics_page.due_next_7_days') %> · <%= fmt_money.call(@due_soon_amount) %></span>
            </div>
            <a href="<%= history_path %>?due=soon" class="ana-aging-expand-link" style="color: #60a5fa;"><%= t('analytics_page.view_due_soon') %> →</a>
          </div>
        </div>
        <% if @due_soon_invoices.any? %>
          <div class="ana-due-soon-list">
            <% @due_soon_invoices.first(5).each do |inv| %>
              <div class="ana-due-soon-row <%= inv[:days_left] <= 2 ? 'urgent' : '' %>">
                <div class="ana-due-soon-days">
                  <div class="ana-due-soon-days-num"><%= inv[:days_left] %></div>
                  <div class="ana-due-soon-days-label"><%= t('analytics_page.days_short') %></div>
                </div>
                <div class="ana-due-soon-info">
                  <div class="ana-due-soon-client"><%= inv[:client] %></div>
                  <div class="ana-due-soon-meta">INV-<%= inv[:display_number] %> · <%= inv[:due_date] %></div>
                </div>
                <div class="ana-due-soon-amount"><%= fmt_money.call(inv[:amount]) %></div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>

      <!-- Paid vs Unpaid Ratio -->
      <div class="ana-ratio-bar-wrap">
        <div class="ana-ratio-labels">
          <span class="paid-label"><%= t('analytics_page.paid_ratio') %> <%= paid_ratio %>%</span>
          <span class="unpaid-label"><%= t('analytics_page.unpaid_ratio') %> <%= unpaid_ratio %>%</span>
        </div>
        <div class="ana-ratio-bar">
          <div class="ana-ratio-bar-fill" style="width: <%= paid_ratio %>%;"></div>
        </div>
      </div>
    </section>

    <!-- ═══════════════ 4. BUSINESS INSIGHTS ═══════════════ -->
    <section class="ana-section">
      <h2 class="ana-section-title"><%= t('analytics_page.business_insights') %></h2>
      <div class="ana-stats-grid">
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.total_revenue') %> <%= trend_badge.call(@revenue_trend) %></div>
          <div class="ana-stat-val orange"><%= fmt_money.call(@total_invoiced) %></div>
        </div>
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.total_paid') %></div>
          <div class="ana-stat-val green"><%= fmt_money.call(@total_paid_amt) %></div>
        </div>
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.outstanding') %></div>
          <div class="ana-stat-val <%= @outstanding_ratio > 50 ? 'red' : '' %>"><%= fmt_money.call(@total_outstanding) %></div>
        </div>
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.collected_this_month') %></div>
          <div class="ana-stat-val green"><%= fmt_money.call(@collected_this_month) %></div>
        </div>
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.projected_revenue') %></div>
          <div class="ana-stat-val accent"><%= fmt_money.call(@projected_revenue) %></div>
        </div>
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.collection_rate') %></div>
          <div class="ana-stat-val <%= @collection_rate >= 80 ? 'green' : (@collection_rate >= 50 ? 'orange' : 'red') %>"><%= @collection_rate %>%</div>
        </div>
        <div class="ana-stat-surface">
          <div class="ana-stat-key"><%= t('analytics_page.avg_days_to_pay') %></div>
          <div class="ana-stat-val <%= @avg_days_to_pay && @avg_days_to_pay <= 14 ? 'green' : (@avg_days_to_pay && @avg_days_to_pay <= 30 ? 'orange' : 'red') %>"><%= @avg_days_to_pay ? "#{@avg_days_to_pay} #{t('analytics_page.days_unit')}" : "—" %></div>
        </div>
      </div>
    </section>

    <!-- ═══════════════ 5. CLIENT INSIGHTS ═══════════════ -->
    <section class="ana-section">
      <h2 class="ana-section-title"><%= t('analytics_page.client_insights') %></h2>

      <div class="ana-client-summary">
        <div class="ana-client-summary-item">
          <div class="ana-client-summary-val"><%= @overview[:active_clients] %></div>
          <div class="ana-client-summary-label"><%= t('analytics_page.total_clients') %></div>
        </div>
        <div class="ana-client-summary-item">
          <div class="ana-client-summary-val"><%= @repeat_clients %></div>
          <div class="ana-client-summary-label"><%= t('analytics_page.repeat_clients') %></div>
        </div>
        <div class="ana-client-summary-item">
          <div class="ana-client-summary-val"><%= @new_clients_month %> <%= trend_badge.call(@new_clients_trend) %></div>
          <div class="ana-client-summary-label"><%= t('analytics_page.new_this_month') %></div>
        </div>
      </div>

      <% if @top_client_share && @top_client_share > 50 && @top_client_name %>
        <div class="ana-client-share-warning">
          <div class="ana-client-share-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
          </div>
          <div class="ana-client-share-text"><%= t('analytics_page.top_client_warning', name: @top_client_name, pct: @top_client_share).html_safe %></div>
        </div>
      <% end %>

      <% if @client_insights.any? %>
        <div class="ana-clients-list">
          <% @client_insights.each_with_index do |client, idx| %>
            <div class="ana-client-row">
              <div class="ana-client-rank"><%= idx + 1 %></div>
              <div class="ana-client-info">
                <div class="ana-client-name"><%= client[:name] %></div>
                <div class="ana-client-meta"><%= pluralize(client[:count], t('analytics_page.invoice_singular')) %> · <%= t('analytics_page.last_invoice') %>: <%= client[:last_at] ? l(client[:last_at].to_date, format: :long) : "—" %></div>
                <% if client[:badges].any? %>
                  <div class="ana-client-badges">
                    <% client[:badges].each do |badge| %>
                      <span class="ana-badge <%= badge.dasherize %>"><%= t("analytics_page.badge_#{badge}") %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <div class="ana-client-amounts">
                <div class="ana-client-total"><%= fmt_money.call(client[:total]) %></div>
                <% if client[:outstanding] > 0 %>
                  <div class="ana-client-outstanding has-outstanding"><%= fmt_money.call(client[:outstanding]) %> <%= t('analytics_page.owed') %></div>
                <% else %>
                  <div class="ana-client-outstanding"><%= t('analytics_page.all_paid') %></div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="ana-empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <%= t('analytics_page.no_clients_yet') %>
          <div class="ana-empty-state-hint"><%= t('analytics_page.no_clients_hint') %></div>
        </div>
      <% end %>
    </section>

    <!-- ═══════════════ 6. USAGE TRENDS (CHARTS) ═══════════════ -->
    <section class="ana-section">
      <h2 class="ana-section-title"><%= t('analytics_page.usage_trends') %></h2>

      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.6rem;">
        <div class="ana-metric-tabs">
          <button class="ana-metric-tab active" data-analytics-dashboard-target="metricTab" data-action="click->analytics-dashboard#switchMetric" data-metric="invoices"><%= t('analytics_page.metric_invoices') %></button>
          <button class="ana-metric-tab" data-analytics-dashboard-target="metricTab" data-action="click->analytics-dashboard#switchMetric" data-metric="revenue"><%= t('analytics_page.metric_revenue') %></button>
          <button class="ana-metric-tab" data-analytics-dashboard-target="metricTab" data-action="click->analytics-dashboard#switchMetric" data-metric="outstanding"><%= t('analytics_page.metric_outstanding') %></button>
          <button class="ana-metric-tab" data-analytics-dashboard-target="metricTab" data-action="click->analytics-dashboard#switchMetric" data-metric="collected"><%= t('analytics_page.metric_collected') %></button>
          <button class="ana-metric-tab" data-analytics-dashboard-target="metricTab" data-action="click->analytics-dashboard#switchMetric" data-metric="voice"><%= t('analytics_page.metric_voice') %></button>
        </div>
        <div class="ana-chart-filters">
          <button class="ana-filter-btn" data-analytics-dashboard-target="periodBtn" data-action="click->analytics-dashboard#switchPeriod" data-period="7d">7D</button>
          <button class="ana-filter-btn active" data-analytics-dashboard-target="periodBtn" data-action="click->analytics-dashboard#switchPeriod" data-period="30d">30D</button>
          <button class="ana-filter-btn" data-analytics-dashboard-target="periodBtn" data-action="click->analytics-dashboard#switchPeriod" data-period="12m">12M</button>
        </div>
      </div>

      <div class="ana-chart-wrap">
        <canvas id="<%= @is_demo ? 'demoDashboardChart' : '' %>" data-analytics-dashboard-target="<%= @is_demo ? '' : 'chart' %>"></canvas>
      </div>
    </section>

    <!-- ═══════════════ EXPORT BUTTONS ═══════════════ -->
    <div class="ana-export-buttons">
      <a href="<%= analytics_export_path %>" class="ana-export-btn csv">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <%= t('analytics_page.export_csv') %>
      </a>
      <a href="<%= analytics_export_pdf_path %>" class="ana-export-btn pdf">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        <%= t('analytics_page.export_pdf') %>
      </a>
    </div>

    <div class="ana-footer">
      <p class="ana-footer-text"><%= t('analytics_page.footer') %></p>
    </div>
  </div>

  <% if @is_demo %>
  </div><!-- /ana-demo-content-wrap -->
  <% end %>
</div>

<% if @is_demo %>
<script>
(function() {
  var canvas = document.getElementById('demoDashboardChart');
  if (!canvas || typeof Chart === 'undefined') return;
  var labels = Array.from({length: 30}, function(_, i) {
    var d = new Date(); d.setDate(d.getDate() - (29 - i));
    return d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
  });
  var data = [3,0,1,2,0,4,1,0,2,3,1,5,2,1,0,3,2,1,4,2,1,3,2,1,5,3,2,6,3,4];
  var ctx = canvas.getContext('2d');
  var grad = ctx.createLinearGradient(0, 0, 0, canvas.offsetHeight || 200);
  grad.addColorStop(0, 'rgba(249,115,22,0.35)');
  grad.addColorStop(1, 'rgba(249,115,22,0.02)');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: grad,
        borderColor: '#f97316',
        borderWidth: 1.5,
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 }, maxTicksLimit: 6 } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } }, beginAtZero: true }
      }
    }
  });
})();
</script>
<% end %>

<% if @is_pro || @is_demo %>
<script>
  function toggleAgingExpand(key) {
    const panel = document.getElementById('aging-expand-' + key);
    const item = document.querySelector('[data-aging-key="' + key + '"]');
    if (!panel) return;
    const isVisible = panel.classList.contains('visible');

    // Close all
    document.querySelectorAll('.ana-aging-expand').forEach(p => p.classList.remove('visible'));
    document.querySelectorAll('.ana-aging-item').forEach(i => i.classList.remove('expanded'));

    // Toggle the clicked one
    if (!isVisible) {
      panel.classList.add('visible');
      if (item) item.classList.add('expanded');
    }
  }
</script>
<% end %>
