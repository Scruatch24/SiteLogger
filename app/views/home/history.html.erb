<div class="min-h-screen bg-white text-black font-sans p-4 pb-32">
  <header class="sticky top-0 z-40 bg-white border-b-2 border-black md:border-b-0 md:static md:bg-transparent -mx-4 px-4 py-3 mb-6 md:mb-4 md:pt-4 md:px-1 flex items-center justify-between gap-2 md:gap-4 shadow-sm md:shadow-none">
    <div class="flex items-center gap-3">
      <%= link_to root_path, class: "p-1.5 md:p-2 bg-white border-2 border-black rounded-xl text-black nav-link-hover transition-all active:scale-95 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[1px] active:translate-y-[1px] shrink-0" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      <% end %>
      <h1 class="text-xl md:text-2xl font-black tracking-tighter text-black uppercase italic truncate pr-2">
        HISTORY <span class="text-orange-600">LOGS</span>
      </h1>
    </div>
  </header>

  <main class="max-w-2xl mx-auto space-y-8">
    <div class="flex justify-end px-1 -mb-4">
      <% if @logs.any? %>
        <button type="button" 
                onclick="toggleClearModal(true)"
                class="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 text-[10px] font-black uppercase tracking-widest border-2 border-black rounded-xl shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] active:scale-95 transition-all">
          Clear All
        </button>
      <% end %>
    </div>
    <% if @logs.empty? %>
      <div class="text-center py-20 opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <p class="text-lg font-bold">No history found</p>
        <p class="text-sm">Generate invoices to see them here.</p>
      </div>
    <% else %>
      <% @logs.each do |log| %>
        <% stats = calculate_log_totals(log, @profile) %>
        <% currency = stats[:currency] %>
        
        <div class="bg-white border-2 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] overflow-hidden">
          
          <!-- Card Header -->
          <div class="bg-gray-50 border-b-2 border-black p-4 flex justify-between items-start">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-black text-orange-600 bg-orange-100 px-2 py-0.5 rounded uppercase tracking-wider">
                  INV-<%= 1000 + log.id %>
                </span>
                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">
                  <%= log.date || log.created_at.strftime("%b %d, %Y") %>
                </span>
              </div>
              <h3 class="text-xl font-black text-black leading-none">
                <%= log.client.presence || "Unknown Client" %>
              </h3>
            </div>
            <div class="text-right">
              <div class="text-2xl font-black text-orange-600">
                <%= format_money_ruby(stats[:total_due], @profile, currency) %>
              </div>
              <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Balance Due</div>
            </div>
          </div>

          <!-- Items List -->
          <div class="p-4 space-y-4">
            
            <% # LABOR %>
            <% if stats[:categorized_items][:labor].any? %>
              <div class="space-y-2">
                <div class="flex items-center gap-2 pb-1 border-b border-gray-100">
                  <div class="w-5 h-5 bg-orange-100 rounded flex items-center justify-center text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                      <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Labor</span>
                </div>
                <% stats[:categorized_items][:labor].each do |item| %>
                  <%= render partial: "home/history_item", locals: { item: item, profile: @profile, currency: currency } %>
                <% end %>
              </div>
            <% end %>

            <% # MATERIALS %>
            <% if stats[:categorized_items][:material].any? %>
              <div class="space-y-2 pt-2">
                <div class="flex items-center gap-2 pb-1 border-b border-gray-100">
                  <div class="w-5 h-5 bg-orange-100 rounded flex items-center justify-center text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" />
                      <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Materials</span>
                </div>
                <% stats[:categorized_items][:material].each do |item| %>
                  <%= render partial: "home/history_item", locals: { item: item, profile: @profile, currency: currency } %>
                <% end %>
              </div>
            <% end %>

            <% # EXPENSES %>
            <% if stats[:categorized_items][:expense].any? %>
              <div class="space-y-2 pt-2">
                <div class="flex items-center w-full gap-2 pb-1 border-b border-gray-100">
                  <div class="w-5 h-5 bg-red-100 rounded flex items-center justify-center text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 100 2h3a1 1 0 100-2H8zm0-3a1 1 0 110-2h3a1 1 0 110 2H8z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Expenses</span>
                </div>
                <% stats[:categorized_items][:expense].each do |item| %>
                  <%= render partial: "home/history_item", locals: { item: item, profile: @profile, currency: currency } %>
                <% end %>
              </div>
            <% end %>

            <% # FEES %>
            <% if stats[:categorized_items][:fee].any? %>
              <div class="space-y-2 pt-2">
                <div class="flex items-center w-full gap-2 pb-1 border-b border-gray-100">
                  <div class="w-5 h-5 bg-blue-100 rounded flex items-center justify-center text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" />
                    </svg>
                  </div>
                  <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Fees</span>
                </div>
                <% stats[:categorized_items][:fee].each do |item| %>
                  <%= render partial: "home/history_item", locals: { item: item, profile: @profile, currency: currency } %>
                <% end %>
              </div>
            <% end %>

            <% # OTHER %>
            <% if stats[:categorized_items][:other].any? %>
              <div class="space-y-2 pt-2">
                <div class="flex items-center w-full gap-2 pb-1 border-b border-gray-100">
                  <div class="w-5 h-5 bg-gray-100 rounded flex items-center justify-center text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                      <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Other</span>
                </div>
                <% stats[:categorized_items][:other].each do |item| %>
                  <%= render partial: "home/history_item", locals: { item: item, profile: @profile, currency: currency } %>
                <% end %>
              </div>
            <% end %>

            <% # CREDITS %>
            <% if stats[:credits].any? %>
              <div class="space-y-2 pt-2">
                <div class="flex items-center gap-2 pb-1 border-b border-gray-100">
                  <div class="w-5 h-5 bg-red-100 rounded flex items-center justify-center text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                      <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <span class="text-xs font-black text-red-400 uppercase tracking-widest">Credits</span>
                </div>
                <% stats[:credits].each do |credit| %>
                  <div class="flex justify-between items-center text-sm">
                    <div class="font-medium text-red-700"><%= credit[:reason] %></div>
                    <div class="font-bold text-red-700">-<%= format_money_ruby(credit[:amount], @profile, currency) %></div>
                  </div>
                <% end %>
              </div>
            <% end %>

          </div>

          <!-- Summary & Actions -->
          <div class="bg-gray-50 border-t-2 border-black p-4">
            <!-- Totals Breakdown (9-Step) -->
            <div class="space-y-1.5 mb-4 text-xs font-bold uppercase tracking-tight">
               
               <% # 1 & 2. ITEMS TOTAL & ITEM DISCOUNTS (Conditional) %>
               <% if stats[:item_discount_total] > 0 %>
                 <div class="flex justify-between text-gray-400">
                   <span class="font-black">Items Total</span>
                   <span><%= format_money_ruby(stats[:items_total], @profile, currency) %></span>
                 </div>
                 <div class="flex justify-between text-green-600">
                   <span>Item Discounts</span>
                   <span>-<%= format_money_ruby(stats[:item_discount_total], @profile, currency) %></span>
                 </div>
                 <div class="border-t border-dashed border-gray-300 my-1"></div>
               <% end %>

               <% # 3. SUBTOTAL %>
               <div class="flex justify-between text-gray-500">
                 <span class="font-black">Subtotal</span>
                 <span class="text-black"><%= format_money_ruby(stats[:net_items_subtotal], @profile, currency) %></span>
               </div>

               <% # 4 & 5. INVOICE DISCOUNT & TAXABLE TOTAL (Conditional) %>
               <% if stats[:global_discount_amount] > 0 %>
                 <div class="flex justify-between text-green-600">
                   <span>Invoice Discount</span>
                   <span>
                     -<%= format_money_ruby(stats[:global_discount_amount], @profile, currency) %>
                     <% if stats[:global_discount_percent] > 0 %>
                       (-<%= clean_num(stats[:global_discount_percent]) %>%)
                     <% end %>
                   </span>
                 </div>
                 <div class="border-t border-dashed border-gray-300 my-1"></div>
                 <div class="flex justify-between text-gray-500">
                   <span class="font-black">Taxable Total</span>
                   <span class="text-black"><%= format_money_ruby(stats[:taxable_total], @profile, currency) %></span>
                 </div>
               <% end %>

               <% # 6. TAX %>
               <div class="flex justify-between text-orange-600">
                 <span>Tax</span>
                 <span><%= format_money_ruby(stats[:tax_amount], @profile, currency) %></span>
               </div>

               <% # 7 & 8. TOTAL BEFORE CREDIT & CREDIT APPLIED (Conditional) %>
               <% if stats[:total_credits] > 0 %>
                 <div class="border-t border-dashed border-gray-300 my-1"></div>
                 <div class="flex justify-between text-gray-500">
                   <span class="font-black">Total Before Credit</span>
                   <span class="text-black"><%= format_money_ruby(stats[:total_before_credits], @profile, currency) %></span>
                 </div>
                 <div class="flex justify-between text-red-600">
                   <span>Credit Applied</span>
                   <span>-<%= format_money_ruby(stats[:total_credits], @profile, currency) %></span>
                 </div>
               <% end %>

               <div class="pt-2 mt-2 border-t-2 border-black flex justify-between text-black font-black text-sm">
                 <span>Balance Due</span>
                 <span class="text-orange-600"><%= format_money_ruby(stats[:total_due], @profile, currency) %></span>
               </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3">
              <%= link_to download_pdf_log_path(log), class: "flex items-center justify-center gap-2 bg-orange-600 text-white px-4 py-2 border-2 border-black rounded-lg font-black text-xs uppercase tracking-widest hover:bg-orange-700 transition-all shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] active:scale-95", target: "_blank", onclick: "window.trackEvent('invoice_exported')" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                PDF
              <% end %>

              <%= button_to log_path(log), method: :delete, class: "w-full flex items-center justify-center gap-2 bg-white border-2 border-black text-black px-4 py-2 rounded-lg font-black text-xs uppercase tracking-widest hover:bg-red-50 hover:text-red-600 transition-all shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] active:scale-95", form: { data: { turbo_confirm: "Delete this log?" } } do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
              <% end %>
            </div>
          </div>

        </div>
      <% end %>
    <% end %>
  </main>

  <!-- Custom Confirmation Modal -->
  <div id="clearConfirmModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleClearModal(false)"></div>
    
    <!-- Modal Content -->
    <div class="relative bg-white border-4 border-black rounded-3xl p-8 max-w-sm w-full shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] animate-in fade-in zoom-in duration-200">
      <div class="flex flex-col items-center text-center space-y-6">
        <!-- Warning Icon -->
        <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center border-4 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>

        <div class="space-y-2">
          <h2 class="text-2xl font-black uppercase italic tracking-tighter">Clear History?</h2>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-widest leading-relaxed">
            This will permanently delete all logs. This action cannot be undone.
          </p>
        </div>

        <div class="flex flex-col w-full gap-3 pt-2">
          <%= button_to clear_all_logs_path, method: :delete, 
              class: "w-full py-4 bg-red-600 text-white border-2 border-black rounded-2xl font-black uppercase text-xs tracking-[0.2em] shadow-[4px_4px_0px_0px_#000000] active:scale-[0.97] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all" do %>
            Clear Everything
          <% end %>
          
          <button type="button" 
                  onclick="toggleClearModal(false)"
                  class="w-full py-4 bg-white text-black border-2 border-black rounded-2xl font-black uppercase text-xs tracking-[0.2em] hover:bg-gray-50 active:scale-[0.97] active:translate-x-[1px] active:translate-y-[1px] transition-all">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleClearModal(show) {
    const modal = document.getElementById('clearConfirmModal');
    if (show) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    } else {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }
  }

  // Close on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') toggleClearModal(false);
  });
</script>
