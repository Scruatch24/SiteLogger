<%= render "home/svg_symbols" %>
<style>
  .log-menu-dropdown {
    display: none;
  }
  .log-menu-dropdown.active {
    display: block;
  }

  /* Selection Mode Styles */
  .log-card.selection-mode {
    cursor: pointer;
  }
  .log-card.selected .card-inner {
    border-color: #f97316 !important;
    box-shadow: 4px 4px 0px 0px #f97316 !important;
  }
  .selection-checkbox {
    scale: 0;
    opacity: 0;
  }
  .selection-checkbox svg {
    scale: 0;
  }
  .log-card.selected .selection-checkbox {
    background-color: #f97316;
    border-color: #f97316;
    scale: 1;
    opacity: 1;
  }
  .log-card.selected .selection-checkbox svg {
    scale: 1;
  }

  .log-card.selection-mode .selection-checkbox {
    scale: 1;
    opacity: 1;
  }

  /* Transition the chevron down when selection mode is active */
  .log-card .chevron-icon {
    position: absolute;
    top: 2px;
    left: 50%;
    margin-left: -10px; /* half of w-5 (20px) to center */
    transition: top 0.4s cubic-bezier(0.19, 1, 0.22, 1);
  }
  .log-card .chevron-icon.rotate-180 {
    rotate: 180deg;
  }
  .log-card.selection-mode .chevron-icon {
    top: 32px;
  }

  /* Status Badge Chevron Animation */
  .status-chevron {
    transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
  }
  .status-chevron.rotate-180 {
    transform: rotate(180deg);
  }

  .bulk-action-bar {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    z-index: 100;
    transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    opacity: 0;
    pointer-events: none;
  }
  .bulk-action-bar.active {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  .bulk-action-bar-inner {
    background-color: #f97316;
    border: 3px solid black;
    box-shadow: 8px 8px 0px 0px rgba(0,0,0,1);
  }

  /* Hamburger to X Morph */
  .log-menu-btn .line {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }
  .log-menu-btn { overflow: visible; }
  .log-menu-btn.active .line-1 { transform: translateY(4px) rotate(45deg); }
  .log-menu-btn.active .line-2 { opacity: 0; transform: scaleX(0); }
  .log-menu-btn.active .line-3 { transform: translateY(-4px) rotate(-45deg); }

  /* Icon Micro-Animations */
  @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
  .group\/item:hover .icon-recreate { animation: spin-slow 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

  @keyframes pen-draw { 
    0%, 100% { transform: translate(0,0); }
    50% { transform: translate(2px, -2px); }
  }
  .group\/item:hover .icon-rename { animation: pen-draw 0.5s ease-in-out infinite; }

  @keyframes pin-wobble {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-15deg); }
    75% { transform: rotate(15deg); }
  }
  .group\/item:hover .icon-pin { animation: pin-wobble 0.4s ease-in-out; }

  @keyframes trash-lid {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px) rotate(-5deg); }
  }
  .group\/item:hover .icon-delete-lid { animation: trash-lid 0.4s ease-in-out; }

  /* Base transition for all potentially editable fields to ensure smooth exit */
  [data-editable-type] {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    /* Ensure transform origin is useful if we scale */
    transform-origin: left center;
  }

  /* Specific tweak for Client Name to move it down visually when editing */
  h3[data-editable-type][contenteditable="true"] {
    transform: translateY(6px);
  }

  [contenteditable="true"] {
    outline: 2px dashed #3b82f6;
    outline-offset: 4px;
    border-radius: 4px;
    background-color: #eff6ff;
    cursor: text;
    padding: 2px 4px;
    min-width: 20px;
    /* transition is inherited/cascaded from base rule now, but we keep generic param just in case */
    margin-bottom: 20px;
    margin-top: 4px;
    position: relative;
    z-index: 10;
    user-select: text !important;
    -webkit-user-select: text !important;
  }
  [contenteditable="true"]:focus {
    outline: 2px solid #3b82f6;
    background-color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 20;
  }

  /* Modal Styles */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .modal-backdrop.active {
    display: flex;
  }
  .modal-content {
    background: white;
    width: 100%;
    max-width: 400px;
    border: 3px solid black;
    border-radius: 24px;
    box-shadow: 8px 8px 0px 0px rgba(0,0,0,1);
    padding: 24px;
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
  }
  .icon-option {
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
  }
  .icon-option.selected {
    border-color: black;
    background: #f3f4f6;
  }

  /* Custom Styles for Manage Categories Modal */
  .manage-category-item.removing-category {
    background-color: #fef2f2 !important; /* light red */
  }
  .manage-category-item.removing-category .check-indicator {
    background-color: #dc2626 !important; /* dark red */
    border-color: #dc2626 !important;
  }

  label:has(input[type="checkbox"]:checked) .check-indicator {
    background-color: #f97316 !important; /* orange */
    border-color: #f97316 !important;
    transform: scale(1.1);
  }
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #d1d5db;
  }

  /* ── Small-screen (≤430px) responsive tightening ────────────── */
  @media (max-width: 430px) {
    /* Modals: prevent clipping viewport */
    .modal-content {
      max-width: calc(100vw - 24px);
      padding: 18px;
      border-width: 2px;
      border-radius: 20px;
      box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
    }

    /* Bulk action bar: reduce shadow */
    .bulk-action-bar-inner {
      border-width: 2px;
      box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
    }

    /* Log cards: lighter borders and shadow */
    .log-card .card-inner {
      box-shadow: 3px 3px 0px 0px rgba(0,0,0,1);
    }
    .log-card .card-inner .bg-gray-50.border-b-2 {
      padding: 12px 12px 10px;
    }
    .log-card .card-inner .bg-gray-50.border-t-2 {
      padding: 12px;
    }

    /* Log card header: tighten */
    .log-card .header-main .min-w-0 .flex-wrap {
      gap: 3px;
    }
    .log-card .header-main h3 {
      font-size: 1.1rem;
    }

    /* Log card menu dropdown */
    .log-menu-dropdown {
      min-width: 160px;
    }
    .log-menu-dropdown .px-4 {
      padding-left: 12px;
      padding-right: 12px;
    }

    /* Log card hamburger button: slightly smaller */
    .log-menu-btn {
      width: 36px;
      height: 36px;
    }

    /* Tile grids (Categories + Clients): tighter for narrow screens */
    #categories-index .grid,
    #clients-index .grid {
      gap: 10px;
    }
    #categories-index .grid > *,
    #clients-index .grid > * {
      border-width: 3px;
      border-radius: 20px;
      box-shadow: 5px 5px 0px 0px rgba(0,0,0,1);
    }
    #categories-index .grid > *:first-child,
    #clients-index .grid > *:first-child {
      box-shadow: none;
    }

    /* Tile inner avatars: smaller */
    #categories-index .w-14,
    #clients-index .w-14 {
      width: 44px;
      height: 44px;
    }
    #categories-index .w-14 svg,
    #clients-index .w-14 svg {
      width: 22px;
      height: 22px;
    }

    /* Client/Category detail header: keep back + action buttons on same row */

    /* Outer padding: reduce from p-4 to p-3 */
    .min-h-screen.text-black.font-sans {
      padding: 10px;
      padding-bottom: 8rem;
    }

    /* Log card list gap: reduce from gap-20 to gap-16 */
    .flex.flex-col.gap-20 {
      gap: 3.5rem;
    }

    /* Search bar: slightly smaller */
    #historySearch {
      padding-top: 10px;
      padding-bottom: 10px;
      font-size: 13px;
    }
  }
</style>

<div class="min-h-screen text-black font-sans p-4 pb-32">
  <header class="md:static md:bg-transparent px-1 py-3 mb-2 md:mb-4 flex items-center justify-center gap-2 md:gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-xl md:text-2xl font-black tracking-tighter text-black uppercase truncate pr-2">
        <% if I18n.locale == :ka %>
          <%= t('history') %>
        <% else %>
          <%= t('history_logs') %>
        <% end %>
      </h1>
    </div>
  </header>



  <main class="max-w-2xl mx-auto">
    <!-- Tabs / Selectors -->
    <div class="mb-4 px-4 <%= 'opacity-30 grayscale pointer-events-none select-none' if @profile.guest? %>">
       <!-- Brutalist Premium View Selector -->
       <div class="relative flex p-1 bg-white rounded-2xl border-4 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] overflow-hidden h-14">
        <!-- Sliding Highlight Pill (Slim/Inset version) -->
         <div id="tab-highlight" 
              class="absolute top-0 bottom-0 left-0 w-1/3 p-2 transition-all duration-500 ease-[cubic-bezier(0.19,1,0.22,1)]">
           <div class="w-full h-full bg-orange-600 rounded-xl border-2 border-black"></div>
         </div>

         <button onclick="switchView('all')" id="tab-all" 
                 class="relative z-10 flex-1 flex items-center justify-center text-xs font-black uppercase tracking-widest text-white">
           <%= t('all') %>
         </button>
         <button onclick="switchView('categories')" id="tab-categories" 
                 class="relative z-10 flex-1 flex items-center justify-center text-xs font-bold uppercase tracking-widest text-black/40">
           <%= t('categories') %>
         </button>
         <button onclick="switchView('clients')" id="tab-clients" 
                 class="relative z-10 flex-1 flex items-center justify-center text-xs font-bold uppercase tracking-widest text-black/40">
           <%= t('clients') %>
         </button>
       </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6 px-4 <%= 'opacity-40 grayscale pointer-events-none select-none' if @profile.guest? %>">
      <div class="relative w-full">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400">
            <use xlink:href="#icon-search"></use>
          </svg>
        </div>
        <input type="text" 
               id="historySearch" 
               placeholder="<%= t('search_placeholder') %>" 
               autocomplete="off"
               class="w-full pl-12 pr-4 py-3 bg-white border-2 border-black rounded-xl text-black placeholder-gray-400 font-bold focus:outline-none focus:ring-0 focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-shadow">
      </div>
    </div>

    <% if @profile.guest? %>
    <!-- Guest: Modal-style Benefits Banner -->
    <div class="px-4 mb-8">
      <div class="relative zenith-container rounded-[28px] md:rounded-[32px]">
        <div class="zenith-bg"></div>
        <div class="zenith-grid"></div>
        <div class="zenith-trace">
          <svg preserveAspectRatio="none">
            <rect x="0" y="0" width="100%" height="100%" rx="28" ry="28" />
          </svg>
        </div>
        <div class="zenith-content p-5 md:p-8">
          <!-- Header: Centered & More Title-like -->
          <div class="flex flex-col items-center justify-center gap-2 mb-8 text-center">
            <div class="w-12 h-12 rounded-2xl bg-orange-600/20 border border-orange-500/30 flex items-center justify-center mb-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <h3 class="text-2xl md:text-3xl font-black tracking-tighter uppercase leading-none text-white"><%= t('free_account') %></h3>
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-500/80"><%= t('premium_features') %></p>
          </div>
          
          <!-- Benefits Grid: 2x2 on mobile, 4x1 on desktop -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 mb-5">
            <!-- Benefit 1: Save -->
            <div class="flex flex-col items-center justify-center gap-1.5 p-3 md:p-4 bg-white/5 border border-white/5 rounded-xl md:rounded-2xl text-center">
              <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-orange-600/20 border border-orange-500/30 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
              </div>
              <span class="text-[9px] md:text-[10px] font-black text-white/70 uppercase tracking-wide"><%= t('save') %></span>
            </div>
            
            <!-- Benefit 2: Track -->
            <div class="flex flex-col items-center justify-center gap-1.5 p-3 md:p-4 bg-white/5 border border-white/5 rounded-xl md:rounded-2xl text-center">
              <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-orange-600/20 border border-orange-500/30 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
              </div>
              <span class="text-[9px] md:text-[10px] font-black text-white/70 uppercase tracking-wide"><%= t('track') %></span>
            </div>
            
            <!-- Benefit 3: Organize -->
            <div class="flex flex-col items-center justify-center gap-1.5 p-3 md:p-4 bg-white/5 border border-white/5 rounded-xl md:rounded-2xl text-center">
              <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-orange-600/20 border border-orange-500/30 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
              </div>
              <span class="text-[9px] md:text-[10px] font-black text-white/70 uppercase tracking-wide"><%= t('organize') %></span>
            </div>
            
            <!-- Benefit 4: Sync -->
            <div class="flex flex-col items-center justify-center gap-1.5 p-3 md:p-4 bg-white/5 border border-white/5 rounded-xl md:rounded-2xl text-center">
              <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-orange-600/20 border border-orange-500/30 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </div>
              <span class="text-[9px] md:text-[10px] font-black text-white/70 uppercase tracking-wide"><%= t('sync') %></span>
            </div>
          </div>
          
          <%= link_to new_user_registration_path, class: "group flex items-center justify-center gap-2 w-full py-3.5 md:py-4 bg-orange-600 hover:bg-orange-700 rounded-xl md:rounded-2xl text-[10px] md:text-xs font-black text-white uppercase tracking-widest transition-all active:scale-[0.98] shadow-lg shadow-orange-600/20" do %>
            <%= t('sign_up_free') %>
            <svg class="w-3 h-3 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
          <% end %>
        </div>
      </div>
    </div>
    <% end %>

      <!-- FILTER & SORT BAR -->
      <style>
        .hf-bar { padding: 0 1rem; margin-bottom: 1rem; }
        .hf-dd-row { display: flex; gap: 0.5rem; align-items: flex-end; }
        @media (max-width: 767px) { .hf-dd-row { flex-direction: column; align-items: stretch; } }
        .hf-dd { position: relative; flex: 1; min-width: 0; }
        .hf-dd-label-above { display: flex; align-items: center; gap: 3px; font-size: 8px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; color: #9ca3af; margin-bottom: 4px; padding-left: 2px; }
        .hf-label-icon { width: 9px; height: 9px; flex-shrink: 0; }
        .hf-dd.disabled .hf-dd-label-above { opacity: 0.35; }
        .hf-dd.disabled .hf-dd-trigger { opacity: 0.35; pointer-events: none; cursor: not-allowed; border-color: #d1d5db; background: #f9fafb; }
        .hf-dd-sub-row { display: flex; gap: 0.5rem; flex: 2; min-width: 0; }
        .hf-dd-sub-row > .hf-dd { flex: 1; }
        @media (max-width: 767px) { .hf-dd-sub-row { flex: auto; } }
        .hf-dd-trigger {
          width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 6px;
          padding: 8px 12px; border-radius: 12px; font-size: 9px; font-weight: 900;
          text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer;
          border: 2px solid black; background: #fff; color: #000;
          transition: all 0.15s ease; white-space: nowrap;
        }
        .hf-dd-trigger:hover { background: #f9fafb; }
        .hf-dd-trigger.active-default { background: #fff7ed; border-color: #fb923c; color: #ea580c; }
        .hf-dd-trigger.active-gray { background: #f3f4f6; border-color: #9ca3af; color: #6b7280; }
        .hf-dd-trigger.active-blue { background: #eff6ff; border-color: #60a5fa; color: #2563eb; }
        .hf-dd-trigger.active-green { background: #f0fdf4; border-color: #4ade80; color: #16a34a; }
        .hf-dd-trigger.active-red { background: #fef2f2; border-color: #f87171; color: #dc2626; }
        .hf-dd-trigger.active-amber { background: #fffbeb; border-color: #fbbf24; color: #d97706; }
        .hf-dd-trigger.active-slate { background: #f8fafc; border-color: #94a3b8; color: #475569; }
        .hf-dd-trigger .hf-dd-chevron { width: 12px; height: 12px; flex-shrink: 0; transition: transform 0.2s; }
        .hf-dd-trigger.open .hf-dd-chevron { transform: rotate(180deg); }
        .hf-dd-menu {
          position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 200;
          background: #fff; border: 2px solid black; border-radius: 12px;
          overflow: hidden; display: none; min-width: 140px;
        }
        .hf-dd-menu.show { display: block; }
        .hf-dd-option {
          width: 100%; display: flex; align-items: center; gap: 6px;
          padding: 8px 12px; font-size: 9px; font-weight: 800;
          text-transform: uppercase; letter-spacing: 0.06em; cursor: pointer;
          border: none; background: transparent; color: #374151;
          transition: background 0.12s; text-align: left; white-space: nowrap;
        }
        .hf-dd-option:hover { background: #fff7ed; }
        .hf-dd-option.selected { background: #fff7ed; color: #ea580c; }
        .hf-dd-option + .hf-dd-option { border-top: 1px solid #f3f4f6; }
        .hf-dd-option .hf-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        /* STATUS per-status option colors */
        #hfStatusMenu .hf-dd-option[data-filter-status="draft"]:hover { background: #f9fafb; }
        #hfStatusMenu .hf-dd-option[data-filter-status="draft"].selected { background: #f3f4f6; color: #6b7280; }
        #hfStatusMenu .hf-dd-option[data-filter-status="sent"]:hover { background: #eff6ff; }
        #hfStatusMenu .hf-dd-option[data-filter-status="sent"].selected { background: #dbeafe; color: #2563eb; }
        #hfStatusMenu .hf-dd-option[data-filter-status="paid"]:hover { background: #f0fdf4; }
        #hfStatusMenu .hf-dd-option[data-filter-status="paid"].selected { background: #dcfce7; color: #16a34a; }
        #hfStatusMenu .hf-dd-option[data-filter-status="overdue"]:hover { background: #fef2f2; }
        #hfStatusMenu .hf-dd-option[data-filter-status="overdue"].selected { background: #fee2e2; color: #dc2626; }
        /* DUE IN per-option colors */
        #hfDueinMenu .hf-dd-option[data-filter-duein="today"]:hover { background: #fffbeb; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="today"].selected { background: #fef3c7; color: #d97706; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="1-7"]:hover { background: #eff6ff; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="1-7"].selected { background: #dbeafe; color: #2563eb; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="7-30"]:hover { background: #f8fafc; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="7-30"].selected { background: #f1f5f9; color: #475569; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="30plus"]:hover { background: #f9fafb; }
        #hfDueinMenu .hf-dd-option[data-filter-duein="30plus"].selected { background: #f3f4f6; color: #6b7280; }
        /* OVERDUE FOR option colors (all red) */
        #hfOverdueforMenu .hf-dd-option:not([data-filter-overduefor="all"]):hover { background: #fef2f2; }
        #hfOverdueforMenu .hf-dd-option:not([data-filter-overduefor="all"]).selected { background: #fee2e2; color: #dc2626; }
      </style>
      <div id="history-filters" class="hf-bar <%= 'opacity-30 grayscale pointer-events-none select-none' if @profile.guest? %>">
        <div class="hf-dd-row">
          <!-- STATUS Dropdown -->
          <div class="hf-dd" data-dropdown="status">
            <div class="hf-dd-label-above"><svg class="hf-label-icon" viewBox="0 0 10 10"><circle cx="5" cy="5" r="4" fill="currentColor"/></svg><%= t('status') %></div>
            <button type="button" onclick="toggleHfDropdown('status', event)" class="hf-dd-trigger" id="hfStatusTrigger">
              <span id="hfStatusText"><%= t('all') %></span>
              <svg class="hf-dd-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div class="hf-dd-menu" id="hfStatusMenu">
              <button type="button" onclick="selectStatus('all')" data-filter-status="all" class="hf-dd-option selected"><%= t('all') %></button>
              <button type="button" onclick="selectStatus('draft')" data-filter-status="draft" class="hf-dd-option"><span class="hf-dot" style="background:#9ca3af;"></span><%= t('draft') %></button>
              <button type="button" onclick="selectStatus('sent')" data-filter-status="sent" class="hf-dd-option"><span class="hf-dot" style="background:#3b82f6;"></span><%= t('sent') %></button>
              <button type="button" onclick="selectStatus('paid')" data-filter-status="paid" class="hf-dd-option"><span class="hf-dot" style="background:#22c55e;"></span><%= t('paid') %></button>
              <button type="button" onclick="selectStatus('overdue')" data-filter-status="overdue" class="hf-dd-option"><span class="hf-dot" style="background:#ef4444;"></span><%= t('overdue') %></button>
            </div>
          </div>

          <!-- DUE IN + OVERDUE FOR sub-row -->
          <div class="hf-dd-sub-row">
            <!-- DUE IN Dropdown -->
            <div class="hf-dd" data-dropdown="duein">
              <div class="hf-dd-label-above"><svg class="hf-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><%= t('due_in_label') %></div>
              <button type="button" onclick="toggleHfDropdown('duein', event)" class="hf-dd-trigger" id="hfDueinTrigger">
                <span id="hfDueinText"><%= t('any') %></span>
                <svg class="hf-dd-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="hf-dd-menu" id="hfDueinMenu">
                <button type="button" onclick="selectDueIn('all')" data-filter-duein="all" class="hf-dd-option selected"><%= t('any') %></button>
                <button type="button" onclick="selectDueIn('today')" data-filter-duein="today" class="hf-dd-option"><span class="hf-dot" style="background:#f59e0b;"></span><%= t('due_today') %></button>
                <button type="button" onclick="selectDueIn('1-7')" data-filter-duein="1-7" class="hf-dd-option"><span class="hf-dot" style="background:#3b82f6;"></span><%= t('filter_due_in_1_7') %></button>
                <button type="button" onclick="selectDueIn('7-30')" data-filter-duein="7-30" class="hf-dd-option"><span class="hf-dot" style="background:#64748b;"></span><%= t('filter_due_in_7_30') %></button>
                <button type="button" onclick="selectDueIn('30plus')" data-filter-duein="30plus" class="hf-dd-option"><span class="hf-dot" style="background:#9ca3af;"></span><%= t('filter_due_in_30plus') %></button>
              </div>
            </div>

            <!-- OVERDUE FOR Dropdown -->
            <div class="hf-dd" data-dropdown="overduefor">
              <div class="hf-dd-label-above"><svg class="hf-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><%= t('overdue_for_label') %></div>
              <button type="button" onclick="toggleHfDropdown('overduefor', event)" class="hf-dd-trigger" id="hfOverdueforTrigger">
                <span id="hfOverdueforText"><%= t('any') %></span>
                <svg class="hf-dd-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div class="hf-dd-menu" id="hfOverdueforMenu">
                <button type="button" onclick="selectOverdueFor('all')" data-filter-overduefor="all" class="hf-dd-option selected"><%= t('any') %></button>
                <button type="button" onclick="selectOverdueFor('overdue-1-7')" data-filter-overduefor="overdue-1-7" class="hf-dd-option"><span class="hf-dot" style="background:#ef4444;"></span><%= t('filter_overdue_1_7') %></button>
                <button type="button" onclick="selectOverdueFor('overdue-7-30')" data-filter-overduefor="overdue-7-30" class="hf-dd-option"><span class="hf-dot" style="background:#ef4444;"></span><%= t('filter_overdue_7_30') %></button>
                <button type="button" onclick="selectOverdueFor('overdue-30plus')" data-filter-overduefor="overdue-30plus" class="hf-dd-option"><span class="hf-dot" style="background:#ef4444;"></span><%= t('filter_overdue_30plus') %></button>
              </div>
            </div>
          </div>

          <!-- SORT BY Dropdown -->
          <div class="hf-dd" data-dropdown="sort">
            <div class="hf-dd-label-above"><svg class="hf-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M3 6h18M3 12h12M3 18h6"/></svg><%= t('sort_by') %></div>
            <button type="button" onclick="toggleHfDropdown('sort', event)" class="hf-dd-trigger" id="hfSortTrigger">
              <span id="hfSortText"><%= t('sort_default') %></span>
              <svg class="hf-dd-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div class="hf-dd-menu" id="hfSortMenu">
              <button type="button" onclick="selectSort('default')" data-sort="default" class="hf-dd-option selected"><%= t('sort_default') %></button>
              <button type="button" onclick="selectSort('newest')" data-sort="newest" class="hf-dd-option"><%= t('sort_newest') %></button>
              <button type="button" onclick="selectSort('oldest')" data-sort="oldest" class="hf-dd-option"><%= t('sort_oldest') %></button>
              <button type="button" onclick="selectSort('amount-high')" data-sort="amount-high" class="hf-dd-option"><%= t('sort_amount_high') %> $ ↓</button>
              <button type="button" onclick="selectSort('amount-low')" data-sort="amount-low" class="hf-dd-option"><%= t('sort_amount_low') %> $ ↑</button>
              <button type="button" onclick="selectSort('client-az')" data-sort="client-az" class="hf-dd-option"><%= t('sort_client_az') %> A→<%= I18n.locale == :ka ? 'ჰ' : 'Z' %></button>
            </div>
          </div>
        </div>
      </div>

      <!-- VIEW: ALL -->
      <div id="view-all" class="view-section">
        <% if @logs.empty? %>
          <div class="text-center py-20 opacity-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <p class="text-lg font-bold"><%= t('no_history') %></p>
            <p class="text-sm"><%= t('generate_invoices_hint') %></p>
          </div>
        <% else %>
          <div class="flex flex-col gap-20 px-4 pt-12">
            <% @logs.each do |log| %>
              <%= render partial: "home/log_card", locals: { log: log } %>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- VIEW: CATEGORIES -->
      <div id="view-categories" class="view-section hidden">
        <% 
            # icon_map replaced by centralized category_icon_map helper
        %>

        <!-- INDEX: GRID OF TILES -->
        <div id="categories-index" class="px-4">
          <div class="grid grid-cols-2 gap-4">
            <!-- Add Category Tile -->
            <% is_category_locked = user_signed_in? && !current_user.profile&.paid? %>
            <button onclick="<%= is_category_locked ? 'if(window.showPremiumModal) window.showPremiumModal(true)' : 'openAddCategoryModal()' %>" 
                    class="aspect-[4/3] border-4 border-black border-dashed rounded-3xl bg-gray-50 flex flex-col items-center justify-center gap-3 hover:bg-white hover:border-solid hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all group active:scale-95 relative">
              <% if is_category_locked %>
                <span class="absolute top-3 right-3 bg-black text-white text-[7px] font-black uppercase tracking-wider px-1.5 py-0.5 rounded leading-none">PRO</span>
              <% end %>
              <div class="w-12 h-12 rounded-full bg-black text-white flex items-center justify-center group-hover:scale-110 transition-transform <%= 'opacity-40' if is_category_locked %>">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </div>
              <span class="text-xs font-black uppercase tracking-widest text-black <%= 'opacity-40' if is_category_locked %>"><%= t('new_category') %></span>
            </button>

            <!-- Favorites Tile -->
            <% 
               fav_cat = @categories.find { |c| c.name == 'Favorites' } 
               favorites = fav_cat ? fav_cat.logs : []
            %>
            <% fav_overdue = favorites.count { |l| l.current_status == 'overdue' } %>
            <div onclick="enterCategory('favorites')" 
                 class="aspect-[4/3] border-4 border-black rounded-3xl bg-white shadow-[5px_5px_0px_0px_rgba(0,0,0,1)] flex flex-col items-center justify-center gap-3 cursor-pointer hover:-translate-y-1 hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all active:scale-95 group relative">
              <% if fav_overdue > 0 %>
                <div class="absolute top-2 right-2 z-10 min-w-[20px] h-5 px-1 bg-red-500 border-2 border-black rounded-full flex items-center justify-center">
                  <span class="text-white text-[9px] font-black leading-none"><%= fav_overdue %></span>
                </div>
              <% end %>
              <div class="w-14 h-14 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-500 border-2 border-black group-hover:scale-110 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              </div>
              <div class="text-center">
                <span class="block text-xs font-black uppercase tracking-widest"><%= t('favorites') %></span>
                <span id="fav-count" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest" data-category-count="favorites"><%= favorites.size %> <%= t('items') %></span>
              </div>
            </div>

            <!-- User Categories Tiles -->
            <% @categories.each do |category| %>
              <% next if category.name == 'Favorites' %>
              <% cat_overdue = category.logs.count { |l| l.current_status == 'overdue' } %>
              <div onclick="enterCategory('cat-<%= category.id %>')" 
                   class="aspect-[4/3] border-4 border-black rounded-3xl bg-white shadow-[5px_5px_0px_0px_rgba(0,0,0,1)] flex flex-col items-center justify-center gap-3 cursor-pointer hover:-translate-y-1 hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all active:scale-95 group relative">
                <% if cat_overdue > 0 %>
                  <div class="absolute top-2 right-2 z-10 min-w-[20px] h-5 px-1 bg-red-500 border-2 border-black rounded-full flex items-center justify-center">
                    <span class="text-white text-[9px] font-black leading-none"><%= cat_overdue %></span>
                  </div>
                <% end %>
                <div class="w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden relative border-2 border-black group-hover:scale-110 transition-transform"
                     style="<%= category.color.present? ? "background-color: #{category.color}20; color: #{category.color};" : "background-color: #f3f4f6; color: black;" %>">
                   <% if category.icon_type == 'custom' && category.custom_icon.attached? %>
                     <%= image_tag category.custom_icon, class: "w-full h-full object-cover" %>
                   <% else %>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                       <%= category_icon_map[category.icon].to_s.html_safe %>
                     </svg>
                   <% end %>
                </div>
                <div class="text-center px-2">
                  <span class="block text-xs font-black uppercase tracking-widest truncate max-w-[120px]"><%= category.name %></span>
                  <span id="cat-count-<%= category.id %>" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest" data-category-count="cat-<%= category.id %>"><%= category.logs.size %> <%= t('items') %></span>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- DETAILS: INDIVIDUAL VIEWS (HIDDEN) -->
        <div id="categories-details" class="px-4 hidden">

          <!-- Detail Containers -->
          <div id="category-detail-favorites" class="category-detail-view hidden">
            <!-- Back button row -->
            <div class="flex items-center justify-between mb-6 min-h-[48px]">
              <button onclick="exitCategory()" class="flex items-center gap-2 text-black hover:text-orange-600 transition-colors group">
                <div class="w-8 h-8 rounded-full border-2 border-black flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition-all">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                  </svg>
                </div>
                <span class="text-xs font-black uppercase tracking-widest"><%= t('back_to_categories') %></span>
              </button>
            </div>
            <div class="flex items-center gap-4 mb-10">
              <div class="w-16 h-16 bg-amber-50 rounded-3xl flex items-center justify-center text-amber-500 border-2 border-black flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              </div>
              <div>
                <h2 class="text-2xl font-black uppercase tracking-tighter"><%= t('favorites').upcase %></h2>
                <p id="fav-detail-count" class="text-xs font-bold text-gray-400 uppercase tracking-widest" data-category-count="favorites"><%= favorites.size %> <%= t('items_found') %></p>
              </div>
            </div>
            <% if favorites.any? %>
            <div class="flex flex-col gap-20 pt-12">
                <% favorites.each do |log| %>
                  <% assignment = log.log_category_assignments.find { |a| a.category_id == fav_cat&.id } %>
                  <% pinned_state = assignment&.pinned_at.present? %>
                  <%= render partial: "home/log_card", locals: { log: log, suffix: "-fav", pinned: pinned_state } %>
                <% end %>
              </div>
            <% else %>
              <div class="py-20 text-center opacity-50">
                <p class="font-bold"><%= t('no_favorites') %></p>
              </div>
            <% end %>
          </div>

          <% @categories.each do |category| %>
            <% next if category.name == 'Favorites' %>
            <div id="category-detail-cat-<%= category.id %>" class="category-detail-view hidden">
              <!-- Back + Delete row -->
              <div class="flex items-center justify-between mb-6">
                <button onclick="exitCategory()" class="flex items-center gap-2 text-black hover:text-orange-600 transition-colors group">
                  <div class="w-8 h-8 rounded-full border-2 border-black flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                  </div>
                  <span class="text-xs font-black uppercase tracking-widest"><%= t('back_to_categories') %></span>
                </button>
                <div class="flex gap-2">
                  <%= button_tag type: 'button', 
                                class: "p-3 bg-red-50 text-red-500 rounded-2xl border-2 border-red-300 hover:bg-red-500 hover:text-white hover:border-red-500 transition-all active:scale-90",
                                data: { category_id: category.id, category_name: category.name },
                                onclick: "handleDeleteClick(this)" do %>
                    <svg class="h-5 w-5">
                      <use xlink:href="#icon-delete"></use>
                    </svg>
                  <% end %>
                </div>
                <form id="delete-form-<%= category.id %>" action="<%= category_path(category) %>" method="post" class="hidden">
                  <input type="hidden" name="_method" value="delete">
                  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                </form>
              </div>
              <!-- Category header info -->
              <div class="flex items-center gap-4 mb-10">
                <div class="w-16 h-16 rounded-3xl flex items-center justify-center overflow-hidden relative border-2 border-black flex-shrink-0"
                     style="<%= category.color.present? ? "background-color: #{category.color}20; color: #{category.color};" : "background-color: #f3f4f6; color: black;" %>">
                   <% if category.icon_type == 'custom' && category.custom_icon.attached? %>
                     <%= image_tag category.custom_icon, class: "w-full h-full object-cover", loading: "lazy" %>
                   <% else %>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor">
                       <%= category_icon_map[category.icon].to_s.html_safe %>
                     </svg>
                   <% end %>
                </div>
                <div>
                  <h2 class="text-2xl font-black uppercase tracking-tighter"><%= category.name %></h2>
                  <p id="cat-detail-count-<%= category.id %>" class="text-xs font-bold text-gray-400 uppercase tracking-widest" data-category-count="cat-<%= category.id %>"><%= category.logs.size %> <%= t('items_found') %></p>
                </div>
              </div>

              <% if category.logs.any? %>
                <div class="flex flex-col gap-20 pt-12">
                  <% category.logs.each do |log| %>
                    <% assignment = log.log_category_assignments.find { |a| a.category_id == category.id } %>
                    <% pinned_state = assignment&.pinned_at.present? %>
                    <%= render partial: "home/log_card", locals: { log: log, pinned: pinned_state } %>
                  <% end %>
                </div>
              <% else %>
                <div class="py-20 text-center opacity-50">
                   <p class="font-bold"><%= t('no_entries_category') %></p>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- VIEW: CLIENTS -->
      <div id="view-clients" class="view-section hidden">
        <!-- CLIENTS INDEX: GRID OF TILES -->
        <div id="clients-index" class="px-4">
          <div class="grid grid-cols-2 gap-4">
            <!-- Add Client Tile -->
            <button onclick="openAddClientModal()"
                    class="aspect-[4/3] border-4 border-black border-dashed rounded-3xl bg-gray-50 flex flex-col items-center justify-center gap-3 hover:bg-white hover:border-solid hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all group active:scale-95">
              <div class="w-12 h-12 rounded-full bg-black text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </div>
              <span class="text-xs font-black uppercase tracking-widest text-black"><%= t('new_client') %></span>
            </button>

            <% client_overdue_map = {}; @clients.each { |c| cnt = c.logs.kept.count { |l| l.current_status == 'overdue' }; client_overdue_map[c.id] = cnt if cnt > 0 } %>
            <% @clients.each do |client| %>
              <% cl_overdue = client_overdue_map[client.id] || 0 %>
              <div onclick="enterClient(<%= client.id %>)"
                   class="aspect-[4/3] border-4 border-black rounded-3xl bg-white shadow-[5px_5px_0px_0px_rgba(0,0,0,1)] flex flex-col items-center justify-center gap-3 cursor-pointer hover:-translate-y-1 hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transition-all active:scale-95 group relative">
                <% if cl_overdue > 0 %>
                  <div class="absolute top-2 right-2 z-10 min-w-[20px] h-5 px-1 bg-red-500 border-2 border-black rounded-full flex items-center justify-center">
                    <span class="text-white text-[9px] font-black leading-none"><%= cl_overdue %></span>
                  </div>
                <% end %>
                <div class="w-14 h-14 bg-orange-50 rounded-2xl flex items-center justify-center text-orange-600 border-2 border-black group-hover:scale-110 transition-transform font-black text-lg">
                  <%= client.display_initials %>
                </div>
                <div class="text-center px-2">
                  <span class="block text-xs font-black uppercase tracking-widest truncate max-w-[120px]"><%= client.name %></span>
                  <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"><%= client.invoices_count %> <%= t('items') %></span>
                </div>
              </div>
            <% end %>
          </div>

          <% if @clients.empty? %>
            <div class="text-center py-16 opacity-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <p class="text-sm font-bold"><%= t('no_clients_yet') %></p>
              <p class="text-xs mt-1"><%= t('clients_auto_hint') %></p>
            </div>
          <% end %>
        </div>

        <!-- CLIENTS DETAILS: INDIVIDUAL VIEWS -->
        <div id="clients-details" class="px-4 hidden">

          <% @clients.each do |client| %>
            <% client_logs = client.logs.kept.order(created_at: :desc) %>
            <div id="client-detail-<%= client.id %>" class="client-detail-view hidden">
              <!-- Back + Edit/Delete row -->
              <div class="flex items-center justify-between mb-6">
                <button onclick="exitClient()" class="flex items-center gap-2 text-black hover:text-orange-600 transition-colors group">
                  <div class="w-8 h-8 rounded-full border-2 border-black flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                  </div>
                  <span class="text-xs font-black uppercase tracking-widest"><%= t('back_to_clients') %></span>
                </button>
                <div class="flex gap-2">
                  <button onclick="openEditClientModal(<%= client.id %>)" class="p-3 bg-blue-50 text-blue-500 rounded-2xl border-2 border-blue-300 hover:bg-blue-500 hover:text-white hover:border-blue-500 transition-all active:scale-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                  <button onclick="confirmDeleteClient(<%= client.id %>, '<%= j(client.name) %>')" class="p-3 bg-red-50 text-red-500 rounded-2xl border-2 border-red-300 hover:bg-red-500 hover:text-white hover:border-red-500 transition-all active:scale-90">
                    <svg class="h-5 w-5">
                      <use xlink:href="#icon-delete"></use>
                    </svg>
                  </button>
                </div>
              </div>
              <!-- Client header info -->
              <div class="flex items-center gap-4 mb-6">
                <div class="w-16 h-16 bg-orange-50 rounded-3xl flex items-center justify-center text-orange-600 border-2 border-black font-black text-xl flex-shrink-0">
                  <%= client.display_initials %>
                </div>
                <div>
                  <h2 class="text-2xl font-black uppercase tracking-tighter"><%= client.name %></h2>
                  <p class="text-xs font-bold text-gray-400 uppercase tracking-widest"><%= client_logs.size %> <%= t('items_found') %></p>
                </div>
              </div>

              <!-- Client Contact Info -->
              <% if client.email.present? || client.phone.present? || client.address.present? %>
                <div class="mb-6 p-4 bg-gray-50 rounded-2xl border-2 border-gray-100 flex flex-col gap-2">
                  <% if client.email.present? %>
                    <div class="flex items-center gap-2 text-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      <span class="font-bold text-gray-600 truncate"><%= client.email %></span>
                    </div>
                  <% end %>
                  <% if client.phone.present? %>
                    <div class="flex items-center gap-2 text-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                      </svg>
                      <span class="font-bold text-gray-600"><%= client.phone %></span>
                    </div>
                  <% end %>
                  <% if client.address.present? %>
                    <div class="flex items-start gap-2 text-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                      <span class="font-bold text-gray-600"><%= client.address %></span>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <!-- Client's Invoices -->
              <% if client_logs.any? %>
                <div class="flex flex-col gap-20 pt-12">
                  <% client_logs.each do |log| %>
                    <%= render partial: "home/log_card", locals: { log: log, suffix: "-cli#{client.id}" } %>
                  <% end %>
                </div>
              <% else %>
                <div class="py-20 text-center opacity-50">
                  <p class="font-bold"><%= t('no_invoices_client') %></p>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>


  </main>

  <!-- Bulk Action Bar -->
  <div id="bulkActionBar" class="bulk-action-bar w-[calc(100%-32px)] max-w-lg">
    <div class="bulk-action-bar-inner w-full text-white rounded-3xl p-4 flex items-center justify-between">
      <div class="flex flex-col pl-2">
        <span id="bulkCount" class="text-xl font-black tracking-tighter leading-none">0 <%= t('items').upcase %></span>
        <span class="text-[8px] font-black uppercase tracking-[0.2em] text-white/70"><%= t('selected') %></span>
      </div>
      
      <div class="flex items-center gap-2">
        <!-- Add to Category -->
        <button onclick="handleBulkCategory()" class="w-12 h-12 rounded-2xl bg-white text-[#f97316] border-2 border-black flex items-center justify-center hover:bg-gray-100 transition-all group">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        </button>

        <!-- Pin -->
        <button onclick="handleBulkPin()" id="bulkPinBtn" class="w-12 h-12 rounded-2xl bg-white text-[#f97316] border-2 border-black flex items-center justify-center hover:bg-gray-100 transition-all group">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
        </button>

        <!-- Delete -->
        <button onclick="handleBulkDelete()" class="w-12 h-12 rounded-2xl bg-red-600 text-white border-2 border-black flex items-center justify-center hover:bg-red-700 transition-all group active:scale-90">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>

        <div class="w-[1px] h-8 bg-white/20 mx-1"></div>

        <!-- Close Selection Mode -->
        <button onclick="exitSelectionMode()" class="w-9 h-9 rounded-xl bg-white text-black flex items-center justify-center hover:bg-gray-100 transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>


</div>

<!-- ADD CATEGORY MODAL -->
<div id="addCategoryModal" class="modal-backdrop" style="z-index: 100;" onclick="closeAddCategoryModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-black uppercase tracking-tighter"><%= t('new_category').split(' ').first %> <span class="text-orange-600"><%= t('new_category').split(' ').last %></span></h2>
      <button onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-black transition-colors">
        <svg class="h-6 w-6">
          <use xlink:href="#icon-close"></use>
        </svg>
      </button>
    </div>

    <%= form_with(model: Category.new, url: categories_path, local: true, multipart: true, id: "categoryForm") do |f| %>
      <div class="mb-6 relative">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500"><%= t('category_name') %></label>
          <span id="categoryNameError" class="hidden text-[10px] font-black uppercase tracking-widest text-red-500 animate-pulse"><%= t('please_fill_field') %></span>
        </div>
        <%= f.text_field :name, id: "categoryNameInput", placeholder: t('example_category_placeholder'), 
            class: "w-full px-4 py-3 bg-white border-2 border-black rounded-xl font-bold focus:outline-none focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all" %>
      </div>

      <div class="mb-6">
        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-3"><%= t('choose_icon') %></label>
        
        <div class="grid grid-cols-5 gap-3 mb-4" id="premadeIcons">
          <% [
            { id: 'briefcase', svg: '<path fill-rule="evenodd" d="M6 3.75A2.75 2.75 0 0 1 8.75 1h2.5A2.75 2.75 0 0 1 14 3.75v.443c.572.055 1.14.122 1.706.2C17.053 4.582 18 5.75 18 7.07v3.469c0 1.126-.694 2.191-1.83 2.54-1.952.599-4.024.921-6.17.921s-4.219-.322-6.17-.921C2.694 12.73 2 11.665 2 10.539V7.07c0-1.321.947-2.489 2.294-2.676A41.047 41.047 0 0 1 6 4.193V3.75Zm6.5 0v.325a41.622 41.622 0 0 0-5 0V3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25ZM10 10a1 1 0 0 0-1 1v.01a1 1 0 0 0 1 1h.01a1 1 0 0 0 1-1V11a1 1 0 0 0-1-1H10Z" clip-rule="evenodd" /><path d="M3 15.055v-.684c.126.053.255.1.39.142 2.092.642 4.313.987 6.61.987 2.297 0 4.518-.345 6.61-.987.135-.041.264-.089.39-.142v.684c0 1.347-.985 2.53-2.363 2.686a41.454 41.454 0 0 1-9.274 0C3.985 17.585 3 16.402 3 15.055Z" />' },
            { id: 'home', svg: '<path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />' },
            { id: 'star', svg: '<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />' },
            { id: 'heart', svg: '<path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />' },
            { id: 'shopping-cart', svg: '<path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />' },
            { id: 'tag', svg: '<path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />' },
            { id: 'user', svg: '<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />' },
            { id: 'camera', svg: '<path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />' },
            { id: 'globe', svg: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 014 0 1.499 1.499 0 01.8 2.315c-.322.692-.77 1.341-1.218 1.956L14 14v1a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2h-1a1 1 0 01-1-1v-1a1 1 0 00-1-1H7a1 1 0 01-1-1v-1a1 1 0 00-1-1H4.332z" clip-rule="evenodd" />' },
            { id: 'lightning', svg: '<path d="M11.983 1.907a.75.75 0 0 0-1.292-.657l-8.5 9.5A.75.75 0 0 0 2.75 12h6.572l-1.305 6.093a.75.75 0 0 0 1.292.657l8.5-9.5A.75.75 0 0 0 17.25 8h-6.572l1.305-6.093Z" />' }
          ].each do |icon| %>
            <div data-icon-id="<%= icon[:id] %>" onclick="selectPremadeIcon('<%= icon[:id] %>')"
                 class="icon-option w-full aspect-square bg-gray-50 rounded-xl flex items-center justify-center text-gray-400 hover:text-black hover:bg-gray-100 transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                <%= icon[:svg].html_safe %>
              </svg>
            </div>
          <% end %>
        </div>

        <%= f.hidden_field :premade_icon, id: "selectedPremadeIcon" %>
        <%= f.hidden_field :icon_type, id: "selectedIconType", value: "premade" %>
        <input type="hidden" name="auto_assign_log_id" id="autoAssignLogId">
      </div>

      <div class="my-8">
        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-3"><%= t('choose_color') %></label>
        <div class="flex flex-wrap gap-3">
          <% [
            '#EA580C', '#2563EB', '#9333EA', '#16A34A', 
            '#DB2777', '#0891B2', '#E11D48', '#000000'
          ].each do |color| %>
            <div onclick="selectCategoryColor('<%= color %>')" 
                 class="color-option w-8 h-8 rounded-full border-2 border-transparent cursor-pointer transition-all hover:scale-110" 
                 style="background-color: <%= color %>;"
                 data-color="<%= color %>">
            </div>
          <% end %>
        </div>
        <%= f.hidden_field :color, id: "selectedCategoryColor", value: "#000000" %>
      </div>

      <div class="relative mb-8">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-[10px] font-black uppercase tracking-widest text-gray-400"><%= t('or') %></span>
          <div class="flex-1 h-[1px] bg-gray-100"></div>
        </div>
        
        <button type="button" onclick="document.getElementById('customIconInput').click()" 
                class="w-full py-3 px-4 border-2 border-black border-dashed rounded-xl flex items-center justify-center gap-2 hover:bg-gray-100 transition-all group overflow-hidden relative">
          <div id="uploadPreview" class="absolute inset-0 bg-white items-center justify-center hidden">
             <img src="" id="iconPreview" class="h-8 w-8 object-cover rounded shadow-sm">
             <span class="ml-2 text-xs font-bold text-black truncate max-w-[150px]" id="fileName"></span>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          <span class="text-xs font-bold"><%= t('upload_custom_icon') %></span>
        </button>
        <%= f.file_field :custom_icon, id: "customIconInput", class: "hidden", accept: "image/*", onchange: "handleIconUpload(this)" %>
      </div>

      <button type="submit" class="w-full py-4 bg-black text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(234,88,12,1)] hover:bg-orange-600 transition-all active:scale-[0.98]">
        <%= t('create_category') %>
      </button>
    <% end %>
  </div>
</div>


<!-- MANAGE LOG MODAL (Categories + Clients collapsibles) -->
<div id="manageCategoriesModal" class="modal-backdrop" style="z-index: 300;" onclick="closeManageCategoriesModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-black uppercase tracking-tighter"><%= t('manage') %></h2>
      <button onclick="closeManageCategoriesModal()" class="text-gray-400 hover:text-black transition-colors">
        <svg class="h-6 w-6">
          <use xlink:href="#icon-close"></use>
        </svg>
      </button>
    </div>

    <input type="hidden" id="manageLogId">

    <!-- ═══ CATEGORIES Collapsible ═══ -->
    <div class="mb-3 border-2 border-black rounded-2xl overflow-hidden">
      <button type="button" onclick="toggleManageSection('categories')" class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition-colors">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-lg bg-orange-100 flex items-center justify-center text-orange-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
          </div>
          <span class="text-xs font-black uppercase tracking-widest"><%= t('categories') %></span>
        </div>
        <svg id="manage-chevron-categories" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="manage-body-categories" class="hidden">
        <div class="p-3 pt-2">
          <!-- Search/Filter Categories -->
          <div class="mb-3 relative">
            <input type="text" 
                   placeholder="<%= t('search_categories') %>" 
                   oninput="filterManageCategories(this.value)"
                   class="w-full pl-9 pr-3 py-2 bg-gray-50 border-2 border-black rounded-xl text-sm font-bold focus:outline-none focus:bg-white transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <div id="manageCategoriesList" class="flex flex-col gap-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">
            <% @categories.each do |category| %>
              <label class="manage-category-item group flex items-center justify-between p-3 rounded-xl border-2 border-transparent bg-gray-50 cursor-pointer hover:bg-gray-100 transition-all"
                     data-id="<%= category.id %>" data-name="<%= category.name %>">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs"
                       style="background-color: <%= category.color %>20; color: <%= category.color %>;">
                    <% if category.icon_type == 'custom' && category.custom_icon.attached? %>
                      <img src="<%= url_for(category.custom_icon) %>" class="w-5 h-5 object-cover rounded-sm" loading="lazy">
                    <% else %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <%= category_icon_map[category.icon].to_s.html_safe %>
                      </svg>
                    <% end %>
                  </div>
                  <span class="font-bold text-sm"><%= category.name == 'Favorites' ? t('favorites') : category.name %></span>
                </div>
                <input type="checkbox" value="<%= category.id %>" class="hidden" 
                       onchange="toggleCategorySelection(this)" data-state="unchecked">
                <div class="check-indicator w-6 h-6 rounded-lg border-2 border-black/10 transition-all bg-white relative">
                  <div class="absolute inset-0 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white hidden check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white hidden remover-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                  </div>
                </div>
              </label>
            <% end %>
            <% if @categories.empty? %>
              <div class="text-center py-4">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3"><%= t('no_categories_yet') %></p>
                <button onclick="closeManageCategoriesModal(); openAddCategoryModal(document.getElementById('manageLogId').value);" class="text-[10px] font-black uppercase tracking-widest text-orange-600 hover:text-black transition-colors underline underline-offset-4">
                  <%= t('create_first_category') %>
                </button>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ CLIENTS Collapsible ═══ -->
    <div class="mb-4 border-2 border-black rounded-2xl overflow-hidden">
      <button type="button" onclick="toggleManageSection('clients')" class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition-colors">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
          </div>
          <span class="text-xs font-black uppercase tracking-widest"><%= t('clients') %></span>
        </div>
        <svg id="manage-chevron-clients" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="manage-body-clients" class="hidden">
        <div class="p-3 pt-2">
          <!-- Search/Filter Clients -->
          <div class="mb-3 relative">
            <input type="text" 
                   placeholder="<%= t('search_clients') %>" 
                   oninput="filterManageClients(this.value)"
                   class="w-full pl-9 pr-3 py-2 bg-gray-50 border-2 border-black rounded-xl text-sm font-bold focus:outline-none focus:bg-white transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <div id="manageClientsList" class="flex flex-col gap-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">
            <% @clients.each do |cl| %>
              <label class="manage-client-item group flex items-center justify-between p-3 rounded-xl border-2 border-transparent bg-gray-50 cursor-pointer hover:bg-gray-100 transition-all"
                     data-client-id="<%= cl.id %>" data-client-name="<%= cl.name %>">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-orange-50 rounded-lg flex items-center justify-center text-orange-600 font-black text-xs border border-orange-200">
                    <%= cl.display_initials %>
                  </div>
                  <span class="font-bold text-sm"><%= cl.name %></span>
                </div>
                <input type="radio" name="manage_client_radio" value="<%= cl.id %>" class="hidden"
                       onchange="selectManageClient(this)">
                <div class="client-radio-indicator w-6 h-6 rounded-full border-2 border-black/10 transition-all bg-white relative">
                  <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-3 h-3 rounded-full bg-orange-500 hidden client-radio-dot"></div>
                  </div>
                </div>
              </label>
            <% end %>
            <% if @clients.empty? %>
              <div class="text-center py-4">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3"><%= t('no_clients_yet') %></p>
                <button onclick="closeManageCategoriesModal(); openAddClientModal();" class="text-[10px] font-black uppercase tracking-widest text-orange-600 hover:text-black transition-colors underline underline-offset-4">
                  <%= t('new_client') %>
                </button>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <button id="saveCategoriesBtn" onclick="saveLogCategories()" class="w-full py-4 bg-orange-600 text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
      <%= t('save_changes') %>
    </button>
  </div>
</div>
<div id="deleteCategoryModal" class="modal-backdrop" style="z-index: 200;" onclick="closeDeleteModal(event)">
  <div class="modal-content text-center" onclick="event.stopPropagation()">
    <div class="w-20 h-20 bg-red-50 text-red-500 rounded-3xl flex items-center justify-center mx-auto mb-6 scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    </div>
    
    <h2 class="text-2xl font-black uppercase tracking-tighter mb-2"><%= t('remove') %> <span class="text-red-600" id="deleteTargetName"><%= t('category') %></span>?</h2>
    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-10"><%= t('delete_category_hint') %></p>

    <div class="flex flex-col gap-3">
      <button id="finalDeleteBtn" class="w-full py-4 bg-red-600 text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-red-700 transition-all active:scale-95">
        <%= t('delete_permanently') %>
      </button>
      <button onclick="closeDeleteModal()" class="w-full py-4 bg-gray-100 text-black rounded-xl font-black uppercase tracking-widest hover:bg-gray-200 transition-all active:scale-95">
        <%= t('go_back') %>
      </button>
    </div>
  </div>
</div>

<!-- DELETE LOG MODAL -->
<div id="deleteLogModal" class="modal-backdrop" style="z-index: 200;" onclick="closeDeleteLogModal(event)">
  <div class="modal-content text-center" onclick="event.stopPropagation()">
    <div class="w-20 h-20 bg-red-50 text-red-500 rounded-3xl flex items-center justify-center mx-auto mb-6 scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    </div>
    
    <h2 class="text-2xl font-black uppercase tracking-tighter mb-2"><%= t('remove') %> <span class="text-red-600" id="deleteLogTargetName"><%= t('invoice') %></span>?</h2>
    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-10"><%= t('delete_invoice_hint') %></p>

    <div class="flex flex-col gap-3">
      <form id="deleteLogForm" method="post" action="">
        <input type="hidden" name="_method" value="delete">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <button type="submit" class="w-full py-4 bg-red-600 text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-red-700 transition-all active:scale-95">
          <%= t('delete_permanently') %>
        </button>
      </form>
      <button onclick="closeDeleteLogModal()" class="w-full py-4 bg-gray-100 text-black rounded-xl font-black uppercase tracking-widest hover:bg-gray-200 transition-all active:scale-95">
        <%= t('go_back') %>
      </button>
    </div>
  </div>
</div>

<!-- BULK DELETE MODAL -->
<div id="bulkDeleteModal" class="modal-backdrop" style="z-index: 200;" onclick="closeBulkDeleteModal(event)">
  <div class="modal-content text-center" onclick="event.stopPropagation()">
    <div class="w-20 h-20 bg-red-50 text-red-500 rounded-3xl flex items-center justify-center mx-auto mb-6 scale-110">
      <svg class="h-10 w-10">
        <use xlink:href="#icon-delete"></use>
      </svg>
    </div>
    
    <h2 class="text-2xl font-black uppercase tracking-tighter mb-2"><%= t('remove') %> <span class="text-red-600" id="bulkDeleteCount">0</span> <%= t('selected_invoices') %>?</h2>
    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-10"><%= t('delete_selected_hint') %></p>

    <div class="flex flex-col gap-3">
      <button onclick="performBulkDelete()" class="w-full py-4 bg-red-600 text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-red-700 transition-all active:scale-95">
        <%= t('delete_permanently') %>
      </button>
      <button onclick="closeBulkDeleteModal()" class="w-full py-4 bg-gray-100 text-black rounded-xl font-black uppercase tracking-widest hover:bg-gray-200 transition-all active:scale-95">
        <%= t('go_back') %>
      </button>
    </div>
  </div>
</div>


<!-- CONFIRM PAID MODAL -->
<div id="confirmPaidModal" class="modal-backdrop" style="z-index: 2000;" onclick="closeConfirmPaidModal(event)">
  <div class="modal-content text-center" onclick="event.stopPropagation()">
    <div class="w-16 h-16 bg-green-50 text-green-500 rounded-2xl flex items-center justify-center mx-auto mb-6 border-2 border-green-100">
      <svg class="h-8 w-8">
        <use xlink:href="#icon-check"></use>
      </svg>
    </div>
    
    <h2 class="text-xl font-black uppercase tracking-tighter mb-2"><%= t('mark_as_paid_confirm').split(' ').take(2).join(' ') %> <span class="text-green-600"><%= t('paid') %></span>?</h2>
    <p class="text-xs text-gray-500 mb-6"><%= t('mark_as_paid_hint').split('<br>').first.html_safe %></p>

    <div class="flex flex-col gap-2.5">
      <button id="finalConfirmPaidBtn" class="w-full py-4 bg-green-600 text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-green-700 transition-all active:scale-95">
        <%= t('confirm_payment') %>
      </button>
      <button onclick="closeConfirmPaidModal()" class="w-full py-3.5 bg-gray-100 text-black rounded-xl font-black uppercase tracking-widest hover:bg-gray-200 transition-all active:scale-95 text-[10px]">
        <%= t('wait_go_back') %>
      </button>
    </div>
  </div>
</div>

<!-- ADD / EDIT CLIENT MODAL -->
<div id="clientModal" class="modal-backdrop" style="z-index: 300;" onclick="closeClientModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-6">
      <h2 id="clientModalTitle" class="text-xl font-black uppercase tracking-tighter"><%= t('new_client') %></h2>
      <button onclick="closeClientModal()" class="text-gray-400 hover:text-black transition-colors">
        <svg class="h-6 w-6">
          <use xlink:href="#icon-close"></use>
        </svg>
      </button>
    </div>

    <input type="hidden" id="clientModalId" value="">

    <div class="flex flex-col gap-4">
      <div>
        <div class="flex justify-between items-center mb-1.5">
          <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500"><%= t('client_name') %> *</label>
          <span id="clientNameError" class="hidden text-[10px] font-black uppercase tracking-widest text-red-500 animate-pulse"><%= t('please_fill_field') %></span>
        </div>
        <input type="text" id="clientNameInput" placeholder="<%= t('client_placeholder') %>"
               class="w-full px-4 py-3 bg-white border-2 border-black rounded-xl font-bold focus:outline-none focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all">
      </div>

      <div>
        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-1.5"><%= t('client_email_label') %></label>
        <input type="email" id="clientEmailInput" placeholder="client@example.com"
               class="w-full px-4 py-3 bg-white border-2 border-black rounded-xl font-bold focus:outline-none focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all">
      </div>

      <div>
        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-1.5"><%= t('client_phone_label') %></label>
        <input type="tel" id="clientPhoneInput" placeholder="+1 555 123 4567"
               class="w-full px-4 py-3 bg-white border-2 border-black rounded-xl font-bold focus:outline-none focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all">
      </div>

      <div>
        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-1.5"><%= t('client_address_label') %></label>
        <textarea id="clientAddressInput" rows="2" placeholder="<%= t('client_address_placeholder') %>"
                  class="w-full px-4 py-3 bg-white border-2 border-black rounded-xl font-bold focus:outline-none focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all resize-none"></textarea>
      </div>

      <div>
        <label class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-1.5"><%= t('client_notes_label') %></label>
        <textarea id="clientNotesInput" rows="2" placeholder="<%= t('client_notes_placeholder') %>"
                  class="w-full px-4 py-3 bg-white border-2 border-black rounded-xl font-bold focus:outline-none focus:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all resize-none"></textarea>
      </div>
    </div>

    <button id="saveClientBtn" onclick="saveClient()" class="w-full mt-6 py-4 bg-black text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(234,88,12,1)] hover:bg-orange-600 transition-all active:scale-[0.98]">
      <%= t('save_client') %>
    </button>
  </div>
</div>

<!-- DELETE CLIENT MODAL -->
<div id="deleteClientModal" class="modal-backdrop" style="z-index: 400;" onclick="closeDeleteClientModal(event)">
  <div class="modal-content text-center" onclick="event.stopPropagation()">
    <div class="w-20 h-20 bg-red-50 text-red-500 rounded-3xl flex items-center justify-center mx-auto mb-6 scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    </div>
    
    <h2 class="text-2xl font-black uppercase tracking-tighter mb-2"><%= t('remove') %> <span class="text-red-600" id="deleteClientName"><%= t('client_label') %></span>?</h2>
    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-10"><%= t('delete_client_hint') %></p>

    <input type="hidden" id="deleteClientId" value="">

    <div class="flex flex-col gap-3">
      <button onclick="performDeleteClient()" class="w-full py-4 bg-red-600 text-white rounded-xl font-black uppercase tracking-widest hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-red-700 transition-all active:scale-95">
        <%= t('delete_permanently') %>
      </button>
      <button onclick="closeDeleteClientModal()" class="w-full py-4 bg-gray-100 text-black rounded-xl font-black uppercase tracking-widest hover:bg-gray-200 transition-all active:scale-95">
        <%= t('go_back') %>
      </button>
    </div>
  </div>
</div>

<script>
  window.APP_LANGUAGES = {
    draft: "<%= j t('draft') %>",
    sent: "<%= j t('sent') %>",
    paid: "<%= j t('paid') %>",
    overdue: "<%= j t('overdue') %>",
    file_size_limit: "<%= j t('file_size_limit') %>",
    failed_save_changes: "<%= j t('failed_save_changes') %>",
    error_while_saving: "<%= j t('error_while_saving') %>",
    failed_update_status: "<%= j t('failed_update_status') %>",
    error_updating_status: "<%= j t('error_updating_status') %>",
    failed_update_pinning: "<%= j t('failed_update_pinning') %>",
    an_error_occurred: "<%= j t('an_error_occurred') %>",
    rename_label: "<%= j t('rename_label') %>",
    done_label: "<%= j t('done_label') %>",
    unpin_log: "<%= j t('unpin_log') %>",
    pin_log: "<%= j t('pin_log') %>",
    save_changes: "<%= j t('save_changes') %>"
  };

  // State Management
  let activeCategoryId = null;

  // Search Functionality
  const searchInput = document.getElementById('historySearch');
  if (searchInput) {
    // Check initial view (Priority: URL Param > localStorage > Default 'all')
    const urlParams = new URLSearchParams(window.location.search);
    const viewParam = urlParams.get('view');
    const savedView = localStorage.getItem('history_active_view');
    const initialView = viewParam || savedView || 'all';
    
    if (initialView && ['all', 'categories', 'clients'].includes(initialView)) {
      switchView(initialView);
    }

    // Check for hash on load to enter specific category folder

    searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      applyAllFilters();
    });
  }

  // ── Filter & Sort State ──
  let activeStatusFilter = 'all';
  let activeDueInFilter = 'all';
  let activeOverdueForFilter = 'all';

  function getViewAllCards() {
    return document.querySelectorAll('#view-all .log-card');
  }

  function applyAllFilters() {
    const term = (document.getElementById('historySearch')?.value || '').toLowerCase();
    getViewAllCards().forEach(card => {
      const matchesSearch = !term || card.textContent.toLowerCase().includes(term);
      const matchesStatus = activeStatusFilter === 'all' || card.dataset.status === activeStatusFilter;
      const range = card.dataset.dueRange;
      const matchesDueIn = activeDueInFilter === 'all' || matchesDueInRange(range, activeDueInFilter);
      const matchesOverdue = activeOverdueForFilter === 'all' || range === activeOverdueForFilter;
      card.classList.toggle('hidden', !(matchesSearch && matchesStatus && matchesDueIn && matchesOverdue));
    });
  }

  function matchesDueInRange(cardRange, filter) {
    if (filter === 'today') return cardRange === 'today';
    if (filter === '1-7') return cardRange === '1-7' || cardRange === 'today';
    if (filter === '7-30') return cardRange === '7-30';
    if (filter === '30plus') return cardRange === '30plus';
    return false;
  }

  // ── Dropdown Toggle ──
  function toggleHfDropdown(name, e) {
    e.stopPropagation();
    const menu = document.getElementById('hf' + name.charAt(0).toUpperCase() + name.slice(1) + 'Menu');
    const trigger = document.getElementById('hf' + name.charAt(0).toUpperCase() + name.slice(1) + 'Trigger');
    const isOpen = menu.classList.contains('show');
    closeAllHfDropdowns();
    if (!isOpen) {
      menu.classList.add('show');
      trigger.classList.add('open');
    }
  }

  function closeAllHfDropdowns() {
    document.querySelectorAll('.hf-dd-menu').forEach(m => m.classList.remove('show'));
    document.querySelectorAll('.hf-dd-trigger').forEach(t => t.classList.remove('open'));
  }

  document.addEventListener('click', () => closeAllHfDropdowns());

  const _activeColorClasses = ['active-default','active-gray','active-blue','active-green','active-red','active-amber','active-slate'];
  function clearTriggerColors(trigger) { _activeColorClasses.forEach(c => trigger.classList.remove(c)); }

  const _statusColorMap = { all: '', draft: 'active-gray', sent: 'active-blue', paid: 'active-green', overdue: 'active-red' };
  function selectStatus(status) {
    activeStatusFilter = status;
    const menu = document.getElementById('hfStatusMenu');
    const textEl = document.getElementById('hfStatusText');
    const trigger = document.getElementById('hfStatusTrigger');
    menu.querySelectorAll('.hf-dd-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.filterStatus === status);
      if (opt.dataset.filterStatus === status) textEl.textContent = opt.textContent.trim();
    });
    clearTriggerColors(trigger);
    if (_statusColorMap[status]) trigger.classList.add(_statusColorMap[status]);
    // Disable DUE IN + OVERDUE FOR when PAID is selected
    const dueinDd = document.querySelector('[data-dropdown="duein"]');
    const overdueDd = document.querySelector('[data-dropdown="overduefor"]');
    if (status === 'paid') {
      selectDueIn('all', true);
      selectOverdueFor('all', true);
      dueinDd.classList.add('disabled');
      overdueDd.classList.add('disabled');
    } else {
      dueinDd.classList.remove('disabled');
      overdueDd.classList.remove('disabled');
    }
    closeAllHfDropdowns();
    applyAllFilters();
  }
  window.filterByStatus = selectStatus;

  const _dueInColorMap = { all: '', today: 'active-amber', '1-7': 'active-blue', '7-30': 'active-slate', '30plus': 'active-gray' };
  function selectDueIn(val, silent) {
    activeDueInFilter = val;
    const menu = document.getElementById('hfDueinMenu');
    const textEl = document.getElementById('hfDueinText');
    const trigger = document.getElementById('hfDueinTrigger');
    menu.querySelectorAll('.hf-dd-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.filterDuein === val);
      if (opt.dataset.filterDuein === val) textEl.textContent = opt.textContent.trim();
    });
    clearTriggerColors(trigger);
    if (_dueInColorMap[val]) trigger.classList.add(_dueInColorMap[val]);
    if (!silent) {
      if (val !== 'all') selectOverdueFor('all', true);
      closeAllHfDropdowns();
      applyAllFilters();
    }
  }
  window.filterByDue = function(due) {
    if (due === 'all') { selectDueIn('all'); return; }
    if (due === 'today') { selectDueIn('today'); return; }
    if (due === 'soon') { selectDueIn('1-7'); return; }
    selectDueIn(due);
  };

  function selectOverdueFor(val, silent) {
    activeOverdueForFilter = val;
    const menu = document.getElementById('hfOverdueforMenu');
    const textEl = document.getElementById('hfOverdueforText');
    const trigger = document.getElementById('hfOverdueforTrigger');
    menu.querySelectorAll('.hf-dd-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.filterOverduefor === val);
      if (opt.dataset.filterOverduefor === val) textEl.textContent = opt.textContent.trim();
    });
    clearTriggerColors(trigger);
    if (val !== 'all') trigger.classList.add('active-red');
    if (!silent) {
      if (val !== 'all') {
        selectStatus('overdue');
        selectDueIn('all', true);
      }
      closeAllHfDropdowns();
      applyAllFilters();
    }
  }

  function selectSort(sortBy) {
    const menu = document.getElementById('hfSortMenu');
    const textEl = document.getElementById('hfSortText');
    const trigger = document.getElementById('hfSortTrigger');
    menu.querySelectorAll('.hf-dd-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.sort === sortBy);
      if (opt.dataset.sort === sortBy) textEl.textContent = opt.textContent.trim();
    });
    clearTriggerColors(trigger);
    if (sortBy !== 'default') trigger.classList.add('active-default');
    closeAllHfDropdowns();
    sortInvoices(sortBy);
  }

  function sortInvoices(sortBy) {
    const container = document.querySelector('#view-all .flex.flex-col');
    if (!container) return;
    const cards = Array.from(container.querySelectorAll(':scope > .log-card'));
    cards.sort((a, b) => {
      switch (sortBy) {
        case 'newest': return (parseInt(b.dataset.created) || 0) - (parseInt(a.dataset.created) || 0);
        case 'oldest': return (parseInt(a.dataset.created) || 0) - (parseInt(b.dataset.created) || 0);
        case 'amount-high': return (parseFloat(b.dataset.amount) || 0) - (parseFloat(a.dataset.amount) || 0);
        case 'amount-low': return (parseFloat(a.dataset.amount) || 0) - (parseFloat(b.dataset.amount) || 0);
        case 'client-az': return (a.dataset.clientName || '').localeCompare(b.dataset.clientName || '');
        default: return 0;
      }
    });
    cards.forEach(card => container.appendChild(card));
  }

  // ── Apply URL params on load (from analytics links) ──
  (function applyUrlFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    const statusParam = urlParams.get('status');
    const dueParam = urlParams.get('due');
    const unpaidParam = urlParams.get('unpaid');

    if (statusParam && ['draft', 'sent', 'paid', 'overdue'].includes(statusParam)) {
      filterByStatus(statusParam);
    }
    if (dueParam) {
      const dueMap = { 'today': 'today', 'soon': 'soon', '1-7': '1-7', '7-30': '7-30', '30plus': '30plus' };
      if (dueMap[dueParam]) filterByDue(dueMap[dueParam]);
    }
    if (unpaidParam === 'true') {
      // Show all non-paid invoices
      activeStatusFilter = '_unpaid';
      getViewAllCards().forEach(card => {
        card.classList.toggle('hidden', card.dataset.status === 'paid');
      });
      // Highlight no specific button
    }
  })();

  // Close on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllLogMenus();
    }
  });

  function toggleLogMenu(btn, e) {
    if (isSelectionMode) return;
    e.stopPropagation();
    const dropdown = btn.nextElementSibling;
    const isActive = dropdown.classList.contains('active');
    
    // Reset all z-indexes first
    document.querySelectorAll('.log-card').forEach(c => c.style.zIndex = 'auto');
    
    closeAllLogMenus();
    
    if (!isActive) {
      dropdown.classList.add('active');
      btn.classList.add('active');
      // Bring THIS card to front so its menu goes over subsequent cards
      btn.closest('.log-card').style.zIndex = '1000';
    }
  }

  function closeAllLogMenus() {
    document.querySelectorAll('.log-menu-dropdown').forEach(d => d.classList.remove('active'));
    document.querySelectorAll('.log-menu-btn').forEach(b => b.classList.remove('active'));
    // Close status selectors
    document.querySelectorAll('.status-selector-dropdown').forEach(d => d.classList.add('hidden'));
    document.querySelectorAll('.status-chevron').forEach(c => c.classList.remove('rotate-180'));
    // Reset z-indexes
    document.querySelectorAll('.log-card').forEach(c => c.style.zIndex = 'auto');
  }

  function toggleStatusSelector(btn, e) {
    if (isSelectionMode) return;
    if (e) e.stopPropagation();
    const dropdown = btn.nextElementSibling;
    const isHidden = dropdown.classList.contains('hidden');
    const chevron = btn.querySelector('.status-chevron');
    
    // Close all others first
    document.querySelectorAll('.status-selector-dropdown').forEach(d => d.classList.add('hidden'));
    document.querySelectorAll('.status-chevron').forEach(c => c.classList.remove('rotate-180'));
    
    if (isHidden) {
      dropdown.classList.remove('hidden');
      if (chevron) chevron.classList.add('rotate-180');
      // Ensure specific z-index for the card to prevent overlap issues
      btn.closest('.log-card').style.zIndex = '1000';
    } else {
      dropdown.classList.add('hidden');
      if (chevron) chevron.classList.remove('rotate-180');
      btn.closest('.log-card').style.zIndex = 'auto';
    }
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.log-menu-dropdown') && !e.target.closest('.log-menu-btn') && !e.target.closest('.status-selector-dropdown') && !e.target.closest('button[onclick*="toggleStatusSelector"]')) {
      closeAllLogMenus();
    }
  });

  // --- Category Modal Logic ---
  let categoryToDelete = null;

  function openAddCategoryModal(logId = null) {
    closeAllModals();
    if (logId) {
      document.getElementById('autoAssignLogId').value = logId;
    } else {
      document.getElementById('autoAssignLogId').value = '';
    }
    document.getElementById('addCategoryModal').classList.add('active');
  }

  function closeAllModals() {
    document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('active'));
    categoryToDelete = null;
  }

  function openDeleteLogModal(url, displayName) {
    // Determine the name to show
    const name = displayName || 'Invoice';
    document.getElementById('deleteLogTargetName').textContent = name;
    
    // Set form action
    document.getElementById('deleteLogForm').action = url;
    
    // Close log menus
    closeAllLogMenus();
    
    // Show modal
    document.getElementById('deleteLogModal').classList.add('active');
  }

  function closeDeleteLogModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('deleteLogModal').classList.remove('active');
  }

  function closeAddCategoryModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('addCategoryModal').classList.remove('active');
    // Reset form
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryNameError').classList.add('hidden');
    document.getElementById('categoryNameInput').classList.remove('border-red-500');
    document.getElementById('uploadPreview').classList.add('hidden');
    document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
    document.getElementById('selectedPremadeIcon').value = '';
    document.getElementById('selectedIconType').value = 'premade';
  }

  // Handle Category Form Submission
  document.addEventListener('DOMContentLoaded', () => {
    const categoryForm = document.getElementById('categoryForm');
    if (categoryForm) {
      categoryForm.addEventListener('submit', (e) => {
        const nameInput = document.getElementById('categoryNameInput');
        const errorMsg = document.getElementById('categoryNameError');
        
        if (!nameInput.value.trim()) {
          e.preventDefault();
          errorMsg.classList.remove('hidden');
          nameInput.classList.add('border-red-500');
          nameInput.focus();
          
          // Flash animation
          nameInput.style.transform = 'translateX(5px)';
          setTimeout(() => nameInput.style.transform = 'translateX(-5px)', 50);
          setTimeout(() => nameInput.style.transform = 'translateX(0)', 100);
        } else {
          errorMsg.classList.add('hidden');
          nameInput.classList.remove('border-red-500');
        }
      });

      // Clear error as user types
      document.getElementById('categoryNameInput').addEventListener('input', (e) => {
        if (e.target.value.trim()) {
          document.getElementById('categoryNameError').classList.add('hidden');
          e.target.classList.remove('border-red-500');
        }
      });
    }
  });

  function selectPremadeIcon(iconId) {
    // Update Hidden Fields
    document.getElementById('selectedPremadeIcon').value = iconId;
    document.getElementById('selectedIconType').value = 'premade';
    
    // Update Selection UI
    const currentColor = document.getElementById('selectedCategoryColor').value;
    document.querySelectorAll('.icon-option').forEach(el => {
      if (el.dataset.iconId === iconId) {
        el.classList.add('selected');
        el.style.backgroundColor = currentColor + '20';
        el.style.color = currentColor;
      } else {
        el.classList.remove('selected');
        el.style.backgroundColor = '';
        el.style.color = '';
      }
    });

    // Hide Custom Upload Preview if it was shown
    document.getElementById('uploadPreview').classList.add('hidden');
    // Clear the file input
    document.getElementById('customIconInput').value = '';
  }

  function handleIconUpload(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      
      // Check size (2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert(window.APP_LANGUAGES.file_size_limit);
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('iconPreview').src = e.target.result;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('uploadPreview').classList.remove('hidden');
        document.getElementById('uploadPreview').classList.add('flex');
        
        // Update Icon Type
        document.getElementById('selectedIconType').value = 'custom';
        document.getElementById('selectedPremadeIcon').value = '';
        
        // Deselect premade icons
        document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
      }
      reader.readAsDataURL(file);
    }
  }

  function selectCategoryColor(color) {
    document.getElementById('selectedCategoryColor').value = color;
    
    // Update selected icon color in real-time
    const selectedIcon = document.querySelector('.icon-option.selected');
    if (selectedIcon) {
      selectedIcon.style.backgroundColor = color + '20';
      selectedIcon.style.color = color;
    }

    document.querySelectorAll('.color-option').forEach(el => {
      if (el.dataset.color === color) {
        el.style.borderColor = 'black';
        el.style.transform = 'scale(1.2)';
      } else {
        el.style.borderColor = 'transparent';
        el.style.transform = 'scale(1)';
      }
    });
  }

  let lastHoldTimestamp = 0;

  function handleHeaderClick(header, e) {
    if (isSelectionMode) {
      // Prevent immediate deselect if we just finished a hold-to-enter
      if (Date.now() - lastHoldTimestamp < 300) return;

      // In selection mode, ONLY the chevron allows toggling content
      if (e.target.closest('[data-toggle-trigger]')) {
        toggleLogContent(header, e);
      } else {
        // Otherwise, tap toggles selection
        const cardId = header.closest('.log-card').querySelector('[id^="status-badge-"]').id.split('-').pop();
        toggleSelection(cardId);
      }
      return;
    }
    // Normal mode: whole header toggles
    toggleLogContent(header, e);
  }

  function toggleLogContent(header, e) {
    // Prevent toggle if renaming or interacting with buttons
    if (e.target.closest('[contenteditable="true"]') || e.target.closest('button')) return;

    // Also prevent toggle if we are currently in "Renaming Mode" on this card
    const card = header.closest('.group\\/card');
    const renameBtn = card.querySelector('.rename-btn');
    if (renameBtn && renameBtn.dataset.editing === "true") return;

    const content = card.querySelector('.collapsible-content');
    const chevron = header.querySelector('.chevron-icon');
    
    const isExpanded = content.classList.contains('grid-rows-[1fr]');
    
    if (isExpanded) {
      content.classList.replace('grid-rows-[1fr]', 'grid-rows-[0fr]');
      chevron.classList.remove('rotate-180');
    } else {
      content.classList.replace('grid-rows-[0fr]', 'grid-rows-[1fr]');
      chevron.classList.add('rotate-180');
    }
  }

  function handleRecreate(btn) {
    try {
      const data = JSON.parse(btn.dataset.recreate);
      localStorage.setItem('recreate_log_data', JSON.stringify(data));
      window.location.href = '<%= root_path %>';
    } catch (e) {
      console.error("Recreate error:", e);
    }
  }

  function toggleCategoryModal(btn, e) {
    if (e) e.stopPropagation();
    console.log("Add to category clicked");
    // To be implemented
    closeAllLogMenus();
  }

  function toggleRenameMode(btn, e) {
    if (e) e.stopPropagation(); // CRITICAL: Stop click from bubbling to document (which closes menus)
                                // or to other handlers.
                                
    // Determine state
    const isEditing = btn.dataset.editing === "true";
    const card = btn.closest('.group\\/card');
    
    // Find all editable fields within this card
    const editables = card.querySelectorAll('[data-editable-type]');
    
    const textSpan = btn.querySelector('.rename-text');
    const iconContainer = btn.firstElementChild;
    const renameIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5" />
        <path class="icon-rename" stroke-linecap="round" stroke-linejoin="round" d="M18.414 2.586a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    `;
    const doneIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
    `;

    if (isEditing) {
      // Turn OFF editing
      btn.dataset.editing = "false";
      textSpan.textContent = window.APP_LANGUAGES.rename_label;
      iconContainer.innerHTML = renameIcon;
      iconContainer.classList.remove('bg-green-100', 'text-green-600', 'group-hover/item:bg-green-600');
      iconContainer.classList.add('bg-blue-100', 'text-blue-600', 'group-hover/item:bg-blue-600');
      
      editables.forEach(el => {
        el.contentEditable = "false";
      });
      
      // Close the menu
      // Force a slight delay or just ensure it runs
      closeAllLogMenus();
    } else {
      // Turn ON editing
      btn.dataset.editing = "true";
      textSpan.textContent = window.APP_LANGUAGES.done_label;
      iconContainer.innerHTML = doneIcon;
      iconContainer.classList.remove('bg-blue-100', 'text-blue-600', 'group-hover/item:bg-blue-600');
      iconContainer.classList.add('bg-green-100', 'text-green-600', 'group-hover/item:bg-green-600');

      editables.forEach(el => {
        el.contentEditable = "true";
        setupEditableListeners(el);
      });
      
      // Close all menus, including the one we are in.
      closeAllLogMenus();
    }
  }

  // --- View Switcher Logic ---
  function switchView(viewName) {
    <% if @profile.guest? %>
    if (viewName === 'categories') {
        if (window.showPremiumModal) window.showPremiumModal();
        switchView('all');
        return;
    }
    <% end %>

    // 1. Hide all view sections
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
    
    // 2. Show the selected view
    document.getElementById(`view-${viewName}`).classList.remove('hidden');

    // Show/hide filter bar only on "All" tab
    const filterBar = document.getElementById('history-filters');
    if (filterBar) {
      filterBar.style.display = viewName === 'all' ? '' : 'none';
    }
    
    // Persist view choice
    localStorage.setItem('history_active_view', viewName);
    
    // 3. Update Tab Highlight Position & Button Styles
    const highlight = document.getElementById('tab-highlight');
    const tabs = ['all', 'categories', 'clients'];
    const idx = tabs.indexOf(viewName);
    
    // Move the highlight pill
    if (highlight) {
      highlight.style.transform = `translateX(${idx * 100}%)`;
    }

    tabs.forEach(tab => {
      const btn = document.getElementById(`tab-${tab}`);
      if (tab === viewName) {
        // Active Style
        btn.classList.add('text-white', 'font-black');
        btn.classList.remove('text-black/40', 'font-bold');
      } else {
        // Inactive Style
        btn.classList.add('text-black/40', 'font-bold');
        btn.classList.remove('text-white', 'font-black');
      }
    });

    // 4. Update Search Scope?
    // For now search works on everything in DOM, so it inherently works if we don't remove elements from DOM but only hide parents.
    // However, if we hide a parent view, the search logic might need to know which items to show/hide within the Active View.
    // The current search logic toggles .hidden on .log-card globally.
    // This is meaningful: if I search "Dave", it will unhide Dave cards in ALL views.
    // This is probably fine for now.
  }

  // --- Delete Category Logic ---
  function handleDeleteClick(btn) {
    const id = btn.dataset.categoryId;
    const name = btn.dataset.categoryName;
    confirmDeleteCategory(id, name);
  }

  function confirmDeleteCategory(id, name) {
    closeAllModals();
    categoryToDelete = id;
    document.getElementById('deleteTargetName').textContent = name;
    document.getElementById('deleteCategoryModal').classList.add('active');
  }

  function closeDeleteModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('deleteCategoryModal').classList.remove('active');
    categoryToDelete = null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const finalDeleteBtn = document.getElementById('finalDeleteBtn');
    if (finalDeleteBtn) {
      finalDeleteBtn.addEventListener('click', () => {
        if (categoryToDelete) {
          const form = document.getElementById(`delete-form-${categoryToDelete}`);
          if (form) form.submit();
        }
      });
    }
  });

  // --- Category Navigation Logic ---
  function enterCategory(categoryId) {
    closeAllModals();
    
    // Update active state
    activeCategoryId = categoryId;

    // Preserve scroll position across layout shift
    const sy = window.scrollY;

    // Hide grid
    document.getElementById('categories-index').classList.add('hidden');
    // Show details container
    const detailsContainer = document.getElementById('categories-details');
    detailsContainer.classList.remove('hidden');
    
    // Hide all individual detail views first
    document.querySelectorAll('.category-detail-view').forEach(v => v.classList.add('hidden'));
    // Show the targeted one
    document.getElementById(`category-detail-${categoryId}`).classList.remove('hidden');

    window.scrollTo(0, sy);
  }

  function exitCategory() {
    closeAllModals();
    // Clear active state
    activeCategoryId = null;
    // Hide details container
    document.getElementById('categories-details').classList.add('hidden');
    // Show grid
    document.getElementById('categories-index').classList.remove('hidden');
  }

  // --- Category Toggle Logic (DEPRECATED for tiled view) ---
  function toggleCategory(header) {
    // No longer used in tiled navigation but kept for compatibility if needed
  }


  function setupEditableListeners(el) {
    if (el.dataset.listenerAttached) return;
    
    el.addEventListener('blur', () => {
      saveUpdate(el);
    });
    
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        el.blur(); // Triggers save
        
        // Find the rename/done button and click it to exit edit mode
        const card = el.closest('.group\\/card');
        if (card) {
          const btn = card.querySelector('.rename-btn');
          if (btn && btn.dataset.editing === "true") {
             toggleRenameMode(btn, e);
          }
        }
      }
    });

    el.dataset.listenerAttached = "true";
  }

  function saveUpdate(el) {
    const text = el.innerText.trim();
    // Prevent empty strings if necessary, though clearing might be valid?
    // Client name clearing is probably bad.
    if (!text && el.dataset.editableType === 'client') {
      // revert?
      return; 
    }
    
    const data = {
      id: el.dataset.logId,
      field: el.dataset.editableType,
      value: text,
      section_index: el.dataset.sectionIndex,
      item_index: el.dataset.itemIndex,
      subcategory_index: el.dataset.subcategoryIndex,
      credit_index: el.dataset.creditIndex,
      authenticity_token: document.querySelector('meta[name="csrf-token"]').content
    };
    
    fetch(`/logs/${data.id}/update_entry`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': data.authenticity_token
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(res => {
      if (res.success) {
        // Update the Recreate button data locally so valid data is used if clicked immediately
        try {
          const card = el.closest('.group\\/card');
          const recreateBtn = card.querySelector('button[data-recreate]');
          if (recreateBtn) {
            const recreateData = JSON.parse(recreateBtn.dataset.recreate);
            
            if (data.field === 'client') {
              recreateData.client = data.value;
            } else if (data.field === 'item') {
              const item = recreateData.sections[data.section_index].items[data.item_index];
              if (typeof item === 'string') {
                recreateData.sections[data.section_index].items[data.item_index] = data.value;
              } else {
                item.desc = data.value;
              }
            } else if (data.field === 'subcategory') {
              const item = recreateData.sections[data.section_index].items[data.item_index];
               if (item && item.sub_categories) {
                 item.sub_categories[data.subcategory_index] = data.value;
               }
            } else if (data.field === 'credit') {
              if (recreateData.credits && recreateData.credits[data.credit_index]) {
                recreateData.credits[data.credit_index].reason = data.value;
              }
            }

            recreateBtn.dataset.recreate = JSON.stringify(recreateData);
            console.log("Recreate data updated locally");
          }
        } catch (err) {
          console.error("Failed to update local recreate data:", err);
        }

      } else {
        console.error('Save failed', res.errors);
        el.style.color = '#dc2626'; // Red
      }
    })
    .catch(err => {
      console.error('Save error', err);
      el.style.color = '#dc2626';
    });
  }
  function openManageCategoriesModal(logIds, initialStates) {
    // logIds can be a single ID or an array of IDs
    const ids = Array.isArray(logIds) ? logIds : [logIds];
    const modal = document.getElementById('manageCategoriesModal');
    const logIdInput = document.getElementById('manageLogId');
    const categoriesList = document.getElementById('manageCategoriesList');
    const modalTitle = modal.querySelector('h2');
    
    logIdInput.value = JSON.stringify(ids);
    modalTitle.innerHTML = ids.length > 1 ? `<%= j t('bulk_manage') %>` : `<%= j t('manage') %>`;

    // Reset client selection
    selectedManageClientId = null;
    document.querySelectorAll('.client-radio-dot').forEach(d => d.classList.add('hidden'));
    document.querySelectorAll('input[name="manage_client_radio"]').forEach(r => r.checked = false);

    // Pre-select current client if single log has a client_id
    if (ids.length === 1) {
      const card = document.querySelector(`.log-card[data-log-id="${ids[0]}"]`);
      if (card && card.dataset.clientId) {
        const radio = document.querySelector(`input[name="manage_client_radio"][value="${card.dataset.clientId}"]`);
        if (radio) {
          radio.checked = true;
          selectedManageClientId = card.dataset.clientId;
          const dot = radio.closest('label').querySelector('.client-radio-dot');
          if (dot) dot.classList.remove('hidden');
        }
      }
    }

    // Collapse both sections by default
    document.getElementById('manage-body-categories').classList.add('hidden');
    document.getElementById('manage-chevron-categories').style.transform = 'rotate(0deg)';
    document.getElementById('manage-body-clients').classList.add('hidden');
    document.getElementById('manage-chevron-clients').style.transform = 'rotate(0deg)';

    // Process initial states
    // If multiple logs, only check categories that are present in ALL logs
    const isArray = Array.isArray(initialStates);
    categoriesList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      const catId = cb.value;
      let state = 'unchecked';
      
      if (isArray) {
        // Single log case: initialStates is an array of IDs
        const found = initialStates.some(id => id.toString() === catId.toString());
        state = found ? 'checked' : 'unchecked';
      } else {
        // Bulk case: initialStates is a mapping object { id: state }
        state = initialStates[catId] || 'unchecked';
      }
      
      cb.dataset.state = state;
      updateCheckboxUI(cb);
    });

    closeAllLogMenus();
    modal.classList.add('active');
  }

  function toggleCategorySelection(cb) {
    const currentState = cb.dataset.state || 'unchecked';
    let nextState = 'unchecked';

    // 3-State Logic: Unchecked -> Checked -> Removing -> Checked (skip unchecked after first click)
    if (currentState === 'unchecked') nextState = 'checked';
    else if (currentState === 'checked') nextState = 'removing';
    else nextState = 'checked';

    cb.dataset.state = nextState;
    updateCheckboxUI(cb);
  }

  function updateCheckboxUI(cb) {
    const state = cb.dataset.state;
    const label = cb.closest('label');
    const checkIcon = label.querySelector('.check-icon');
    const removeIcon = label.querySelector('.remover-icon');
    
    // Reset all
    label.classList.remove('removing-category');
    cb.checked = false;
    if (checkIcon) checkIcon.classList.add('hidden');
    if (removeIcon) removeIcon.classList.add('hidden');

    if (state === 'checked') {
      cb.checked = true;
      if (checkIcon) checkIcon.classList.remove('hidden');
    } else if (state === 'removing') {
      label.classList.add('removing-category');
      if (removeIcon) removeIcon.classList.remove('hidden');
    }
  }

  function filterManageCategories(term) {
    const items = document.querySelectorAll('.manage-category-item');
    term = term.toLowerCase();
    items.forEach(item => {
      const name = item.dataset.name.toLowerCase();
      if (name.includes(term)) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  function filterManageClients(term) {
    const items = document.querySelectorAll('.manage-client-item');
    term = term.toLowerCase();
    items.forEach(item => {
      const name = (item.dataset.clientName || '').toLowerCase();
      if (name.includes(term)) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  // ── Manage Modal: Collapsible Sections ──
  function toggleManageSection(section) {
    const body = document.getElementById(`manage-body-${section}`);
    const chevron = document.getElementById(`manage-chevron-${section}`);
    const isHidden = body.classList.contains('hidden');
    if (isHidden) {
      body.classList.remove('hidden');
      chevron.style.transform = 'rotate(180deg)';
    } else {
      body.classList.add('hidden');
      chevron.style.transform = 'rotate(0deg)';
    }
  }

  // ── Manage Modal: Client selection ──
  let selectedManageClientId = null;

  function selectManageClient(radio) {
    // Clear all radio dots
    document.querySelectorAll('.client-radio-dot').forEach(d => d.classList.add('hidden'));
    // Show selected
    const dot = radio.closest('label').querySelector('.client-radio-dot');
    if (dot) dot.classList.remove('hidden');
    selectedManageClientId = radio.value;
  }

  function saveLogCategories() {
    let logIds;
    try {
      logIds = JSON.parse(document.getElementById('manageLogId').value);
    } catch(e) {
      logIds = [document.getElementById('manageLogId').value];
    }

    const checkboxes = document.querySelectorAll('#manageCategoriesList input[type="checkbox"]');
    const addedIds = [];
    const removedIds = [];
    let pinnedAction = null;

    checkboxes.forEach(cb => {
      const state = cb.dataset.state;
      const val = cb.value;

      if (state === 'checked') {
        addedIds.push(val);
      } else if (state === 'removing') {
        removedIds.push(val);
      }
    });

    const btn = document.getElementById('saveCategoriesBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse"><%= t('saving') %></span>';

    fetch('/logs/bulk_update_categories', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ 
        log_ids: logIds, 
        added_category_ids: addedIds, 
        removed_category_ids: removedIds,
        client_id: selectedManageClientId
      })
    })
    .then(response => response.json())
    .then(res => {
      if (res.success) {
        window.location.reload();
      } else {
        alert(window.APP_LANGUAGES.failed_save_changes);
        btn.disabled = false;
        btn.textContent = window.APP_LANGUAGES.save_changes;
      }
    })
    .catch(err => {
      console.error(err);
      alert(window.APP_LANGUAGES.error_while_saving);
      btn.disabled = false;
      btn.textContent = window.APP_LANGUAGES.save_changes;
    });
  }

  function closeManageCategoriesModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('manageCategoriesModal').classList.remove('active');
  }

  function updateStatusLive(logId, newStatus) {
    if (newStatus === 'paid') {
      const modal = document.getElementById('confirmPaidModal');
      const btn = document.getElementById('finalConfirmPaidBtn');
      btn.onclick = () => {
        performStatusUpdate(logId, 'paid');
        closeConfirmPaidModal();
      };
      modal.classList.add('active');
      return;
    }
    performStatusUpdate(logId, newStatus);
  }

  function performStatusUpdate(logId, newStatus) {
    fetch(`/logs/${logId}/update_status`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(res => {
      if (res.success) {
        // UI Update Logic (No refresh!)
        const badge = document.getElementById(`status-badge-${logId}`);
        const dot = document.getElementById(`status-dot-${logId}`);
        const text = document.getElementById(`status-text-${logId}`);
        const oldStatus = badge.dataset.currentStatus;

        // Update data-status on all card instances so filters work dynamically
        document.querySelectorAll(`.log-card[data-log-id="${logId}"]`).forEach(card => {
          card.dataset.status = newStatus;
        });
        // Re-apply current filters so the card shows/hides correctly
        applyAllFilters();

        // Configuration map
        const configs = {
          'draft': { bg: 'bg-gray-50', border: 'border-gray-300', text: 'text-gray-500', dot: 'bg-gray-500' },
          'sent': { bg: 'bg-blue-50', border: 'border-blue-400', text: 'text-blue-600', dot: 'bg-blue-600' },
          'paid': { bg: 'bg-green-50', border: 'border-green-400', text: 'text-green-600', dot: 'bg-green-600' },
          'overdue': { bg: 'bg-red-50', border: 'border-red-400', text: 'text-red-600', dot: 'bg-red-600' }
        };

        const config = configs[newStatus];

        // Update Badge Classes (matching new smaller size)
        badge.className = `flex items-center gap-1.5 px-3.5 py-1.5 ${config.bg} border-2 ${config.border} rounded-t-lg rounded-b-none text-[10px] font-black uppercase tracking-widest ${config.text} transition-all`;
        
        // Update Dot
        dot.className = `w-1.5 h-1.5 rounded-full ${config.dot} ${newStatus === 'overdue' ? 'animate-pulse' : ''}`;
        
        // Update Text
        text.textContent = window.APP_LANGUAGES[newStatus] || newStatus;
        badge.dataset.currentStatus = newStatus;

        // Update Dropdown Options (Swap visible items)
        document.getElementById(`opt-${oldStatus}-${logId}`).classList.remove('hidden');
        document.getElementById(`opt-${newStatus}-${logId}`).classList.add('hidden');

        // Hide Dropdown & reset z-index
        badge.nextElementSibling.classList.add('hidden');
        const card = badge.closest('.log-card');
        if (card) {
          card.style.zIndex = 'auto';
          // Update due-range for paid invoices so they're excluded from due filtering
          if (newStatus === 'paid') card.dataset.dueRange = 'none';
        }

        // Rule: If Paid, hide Rename button; otherwise show it
        const renameBtn = document.getElementById(`rename-btn-${logId}`);
        if (renameBtn) {
          if (newStatus === 'paid') {
            renameBtn.classList.add('hidden');
          } else {
            renameBtn.classList.remove('hidden');
          }
        }

        // Hide due badge when paid or overdue (status already conveys due info)
        const statusBadgeContainer = badge.closest('.flex.items-end');
        if (statusBadgeContainer) {
          const dueBadge = statusBadgeContainer.querySelector('.pointer-events-none');
          if (dueBadge) {
            if (newStatus === 'paid' || newStatus === 'overdue') {
              dueBadge.classList.add('hidden');
            } else {
              dueBadge.classList.remove('hidden');
            }
          }
        }

      } else {
        alert(window.APP_LANGUAGES.failed_update_status + res.errors.join(", "));
      }
    })
    .catch(err => {
      console.error(err);
      alert(window.APP_LANGUAGES.error_updating_status);
    });
  }

  function closeConfirmPaidModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('confirmPaidModal').classList.remove('active');
  }

  // Selection Mode Logic
  let isSelectionMode = false;
  let selectedLogIds = []; // Changed to Array to preserve selection order
  let holdTimer;
  const HOLD_DURATION = 600; // ms

  function initSelectionListeners() {
    document.querySelectorAll('.log-card').forEach(card => {
      // Use data-log-id from the card wrapper (added in recent partial update)
      const cardId = card.dataset.logId;
      if (!cardId) return;
      
      if (card.dataset.selectionInit) return;
      card.dataset.selectionInit = "true";

      card.oncontextmenu = (e) => {
        if (isSelectionMode || holdTimer) {
          e.preventDefault();
          return false;
        }
      };

      let holdTriggeredSelection = false;
      let startX = 0;
      let startY = 0;

      const handlePress = (e) => {
        if (isSelectionMode) return; 
        holdTriggeredSelection = false;
        
        // Track starting position
        const touch = e.touches ? e.touches[0] : e;
        startX = touch.screenX;
        startY = touch.screenY;

        if (e.target.closest('button') || e.target.closest('input') || e.target.closest('[contenteditable="true"]')) return;

        holdTimer = setTimeout(() => {
          enterSelectionMode(cardId);
          holdTimer = null;
          holdTriggeredSelection = true;
        }, HOLD_DURATION);
      };

      const handleMove = (e) => {
        if (!holdTimer) return;
        
        const touch = e.touches ? e.touches[0] : e;
        const deltaX = Math.abs(touch.screenX - startX);
        const deltaY = Math.abs(touch.screenY - startY);
        
        // If moved more than 10px, cancel the hold
        if (deltaX > 10 || deltaY > 10) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
      };

      const handleRelease = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        } else if (holdTriggeredSelection) {
          // The hold just finished. Update timestamp to ignore the trailing click.
          lastHoldTimestamp = Date.now();
          holdTriggeredSelection = false;
        }
      };

      card.addEventListener('mousedown', handlePress);
      card.addEventListener('touchstart', handlePress, { passive: true });
      card.addEventListener('mousemove', handleMove);
      card.addEventListener('touchmove', handleMove, { passive: true });
      card.addEventListener('mouseup', handleRelease);
      card.addEventListener('mouseleave', handleRelease);
      card.addEventListener('touchend', handleRelease);
      card.addEventListener('touchcancel', handleRelease);
    });

    // Extra safety (Outside loop): cancel hold if window scrolls
    window.addEventListener('scroll', () => {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
    }, { passive: true });
  }

  function enterSelectionMode(firstCardId) {
    isSelectionMode = true;
    lastHoldTimestamp = Date.now();
    document.querySelectorAll('.log-card').forEach(c => c.classList.add('selection-mode'));
    toggleSelection(firstCardId);
    document.getElementById('bulkActionBar').classList.add('active');
  }

  function toggleSelection(cardId) {
    const stringId = cardId.toString();
    const cards = document.querySelectorAll(`.log-card[data-log-id="${cardId}"]`);
    const index = selectedLogIds.indexOf(stringId);
    const isSelected = index !== -1;

    if (isSelected) {
      selectedLogIds.splice(index, 1);
      cards.forEach(c => c.classList.remove('selected'));
    } else {
      selectedLogIds.push(stringId);
      cards.forEach(c => c.classList.add('selected'));
    }
    
    updateBulkUI();
    
    if (selectedLogIds.length === 0) {
      exitSelectionMode();
    }
  }

  function updateBulkUI() {
    const bulkBar = document.getElementById('bulkActionBar');
    if (selectedLogIds.length === 0) {
      exitSelectionMode();
      return;
    }
    
    document.getElementById('bulkCount').textContent = `${selectedLogIds.length} ${selectedLogIds.length === 1 ? '<%= t('item') %>' : '<%= t('items_plural') %>'}`;
    
    // Update Pin Icon 
    const isAllPinned = selectedLogIds.every(id => {
      const card = document.querySelector(`.log-card[data-log-id="${id}"]`);
      return card && card.dataset.pinned === 'true';
    });
    
    const pinBtn = document.getElementById('bulkPinBtn');
    if (pinBtn) {
      const svg = pinBtn.querySelector('svg');
      if (isAllPinned) {
        svg.setAttribute('fill', 'currentColor');
        svg.setAttribute('stroke-width', '1');
      } else {
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke-width', '2.5');
      }
    }
  }

  function exitSelectionMode() {
    isSelectionMode = false;
    selectedLogIds = [];
    document.querySelectorAll('.log-card').forEach(c => {
      c.classList.remove('selection-mode');
      c.classList.remove('selected');
    });
    document.getElementById('bulkActionBar').classList.remove('active');
  }

  function handleBulkDelete() {
    if (selectedLogIds.length === 0) return;
    document.getElementById('bulkDeleteCount').textContent = selectedLogIds.length;
    document.getElementById('bulkDeleteModal').classList.add('active');
  }

  function closeBulkDeleteModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('bulkDeleteModal').classList.remove('active');
  }

  function performBulkDelete() {
    const idsToDelete = [...selectedLogIds];
    let deletedCount = 0;
    const btn = document.querySelector('#bulkDeleteModal button[onclick="performBulkDelete()"]');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse"><%= t('deleting') %></span>';

    idsToDelete.forEach(id => {
      fetch(`/logs/${id}`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      }).then(() => {
        deletedCount++;
        // Remove from UI (all instances)
        const cards = document.querySelectorAll(`.log-card[data-log-id="${id}"]`);
        cards.forEach(c => c.remove());
        
        if (deletedCount === idsToDelete.length) {
          closeBulkDeleteModal();
          exitSelectionMode();
          refreshCategoryCounts();
          // Optionally show a toast or reset button state if needed (though UI is gone)
        }
      });
    });
  }

  function refreshCategoryCounts() {
    // Collect all elements that display a count
    // They are marked with data-category-count="favorites" or "cat-ID"
    const countElements = document.querySelectorAll('[data-category-count]');
    
    // We can group them by the category key
    const categories = {};
    countElements.forEach(el => {
      const key = el.dataset.categoryCount;
      if (!categories[key]) categories[key] = [];
      categories[key].push(el);
    });

    // Update each category group
    for (const [key, elements] of Object.entries(categories)) {
      // Find the detail container for this category to count visible cards
      const detailView = document.getElementById(`category-detail-${key}`);
      if (detailView) {
        const count = detailView.querySelectorAll('.log-card').length;
        elements.forEach(el => {
          // Check if it's a detail header or a tile count based on class or ID
            el.textContent = `${count} <%= t('items_found') %>`;
        });
      }
    }
  }

  function handleBulkPin() {
    if (selectedLogIds.length === 0) return;
    
    // Determine context (Category vs Global)
    let categoryId = null;
    if (activeCategoryId) {
      categoryId = activeCategoryId === 'favorites' ? 'favorites' : activeCategoryId.replace('cat-', '');
    }

    const logIds = [...selectedLogIds];
    
    // Logic: If ALL are pinned, we unpin all. Otherwise, we pin all.
    const isAllPinned = selectedLogIds.every(id => {
      const card = document.querySelector(`.log-card[data-log-id="${id}"]`);
      return card && card.dataset.pinned === 'true';
    });

    const shouldPin = !isAllPinned;
    
    fetch('/logs/bulk_pin', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        log_ids: logIds,
        category_id: categoryId,
        pin: shouldPin
      })
    })
    .then(response => response.json())
    .then(res => {
      if (res.success) {
        window.location.reload();
      } else {
        alert(window.APP_LANGUAGES.failed_update_pinning);
      }
    })
    .catch(err => {
      console.error(err);
      alert(window.APP_LANGUAGES.an_error_occurred);
    });
  }

  function handleTogglePin(btn, logId, currentlyPinned) {
    const shouldPin = !currentlyPinned;
    const iconContainer = btn.querySelector('div');
    const svg = btn.querySelector('svg');
    const text = btn.querySelector('span');
    
    // Optimistic UI update
    if (shouldPin) {
      iconContainer.classList.add('bg-yellow-400', 'text-white');
      iconContainer.classList.remove('bg-yellow-100', 'text-yellow-600');
      svg.setAttribute('fill', 'currentColor');
      text.textContent = window.APP_LANGUAGES.unpin_log;
    } else {
      iconContainer.classList.remove('bg-yellow-400', 'text-white');
      iconContainer.classList.add('bg-yellow-100', 'text-yellow-600');
      svg.setAttribute('fill', 'none');
      text.textContent = window.APP_LANGUAGES.pin_log;
    }

    // Determine context
    let categoryId = null;
    if (activeCategoryId) {
      categoryId = activeCategoryId === 'favorites' ? 'favorites' : activeCategoryId.replace('cat-', '');
    }

    fetch('/logs/bulk_pin', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        log_ids: [logId],
        category_id: categoryId,
        pin: shouldPin
      })
    })
    .then(response => response.json())
    .then(res => {
      if (res.success) {
        // Reload to update sort order (optional but recommended for UX clarity)
        window.location.reload();
      } else {
        alert(window.APP_LANGUAGES.failed_update_pinning);
      }
    })
    .catch(err => {
      console.error(err);
      alert(window.APP_LANGUAGES.an_error_occurred);
    });
  }

  function handleBulkCategory() {
    if (selectedLogIds.length === 0) return;
    
    // Get all selected log cards
    const selectedCards = selectedLogIds.map(id => 
      document.querySelector(`.log-card[data-log-id="${id}"]`)
    ).filter(c => !!c);

    // Calculate initial states
    // 1. All logs checked for a category -> 'checked'
    // 2. Some logs checked -> 'unchecked' (but can be toggled to 'checked' or 'removing' if present)
    const logCategories = selectedCards.map(c => JSON.parse(c.dataset.categories || '[]'));
    const logPinneds = selectedCards.map(c => c.dataset.pinned === 'true');

    const allCategoryIds = [...new Set(logCategories.flat())];
    const initialStates = {};

    allCategoryIds.forEach(catId => {
      const presentInAll = logCategories.every(cats => cats.includes(parseInt(catId)));
      if (presentInAll) {
        initialStates[catId] = 'checked';
      } else {
        initialStates[catId] = 'unchecked';
      }
    });

    // Handle initial state for Pinned/Favorites
    // DEPRECATED: Pinned is now decoupled from Favorites. 
    // Favorites category check is handled by the generic logic above.

    openManageCategoriesModal(Array.from(selectedLogIds), initialStates);
  }

  // ── Modal drag-close prevention ──────────────────────────────────────────
  // Track whether mousedown started on the backdrop itself (not on modal content).
  // Only close on click if the press also started on the backdrop.
  let _modalMousedownOnBackdrop = false;

  document.addEventListener('mousedown', (e) => {
    _modalMousedownOnBackdrop = e.target.classList.contains('modal-backdrop');
  });
  // ─────────────────────────────────────────────────────────────────────────

  // Initialize on load and after search/filters
  document.addEventListener('DOMContentLoaded', initSelectionListeners);
  // Re-init after any live updates that might replace content
  const observer = new MutationObserver(initSelectionListeners);
  observer.observe(document.body, { childList: true, subtree: true });

  // ═══════════════ CLIENT MANAGEMENT ═══════════════

  // Client data cache for editing
  const clientDataCache = {
    <% @clients.each do |client| %>
    <%= client.id %>: {
      id: <%= client.id %>,
      name: "<%= j(client.name) %>",
      email: "<%= j(client.email.to_s) %>",
      phone: "<%= j(client.phone.to_s) %>",
      address: "<%= j(client.address.to_s) %>",
      notes: "<%= j(client.notes.to_s) %>"
    },
    <% end %>
  };

  function enterClient(clientId) {
    const sy = window.scrollY;
    document.getElementById('clients-index').classList.add('hidden');
    const detailsContainer = document.getElementById('clients-details');
    detailsContainer.classList.remove('hidden');
    document.querySelectorAll('.client-detail-view').forEach(v => v.classList.add('hidden'));
    const detail = document.getElementById(`client-detail-${clientId}`);
    if (detail) detail.classList.remove('hidden');
    window.scrollTo(0, sy);
  }

  function exitClient() {
    document.getElementById('clients-details').classList.add('hidden');
    document.getElementById('clients-index').classList.remove('hidden');
  }

  function openAddClientModal() {
    closeAllModals();
    document.getElementById('clientModalId').value = '';
    document.getElementById('clientModalTitle').innerHTML = '<%= j t("new_client") %>';
    document.getElementById('clientNameInput').value = '';
    document.getElementById('clientEmailInput').value = '';
    document.getElementById('clientPhoneInput').value = '';
    document.getElementById('clientAddressInput').value = '';
    document.getElementById('clientNotesInput').value = '';
    document.getElementById('clientNameError').classList.add('hidden');
    document.getElementById('clientModal').classList.add('active');
    setTimeout(() => document.getElementById('clientNameInput').focus(), 100);
  }

  function openEditClientModal(clientId) {
    closeAllModals();
    const data = clientDataCache[clientId];
    if (!data) return;
    document.getElementById('clientModalId').value = clientId;
    document.getElementById('clientModalTitle').innerHTML = '<%= j t("edit_client") %>';
    document.getElementById('clientNameInput').value = data.name;
    document.getElementById('clientEmailInput').value = data.email;
    document.getElementById('clientPhoneInput').value = data.phone;
    document.getElementById('clientAddressInput').value = data.address;
    document.getElementById('clientNotesInput').value = data.notes;
    document.getElementById('clientNameError').classList.add('hidden');
    document.getElementById('clientModal').classList.add('active');
    setTimeout(() => document.getElementById('clientNameInput').focus(), 100);
  }

  function closeClientModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('clientModal').classList.remove('active');
  }

  function saveClient() {
    const name = document.getElementById('clientNameInput').value.trim();
    if (!name) {
      document.getElementById('clientNameError').classList.remove('hidden');
      document.getElementById('clientNameInput').classList.add('border-red-500');
      return;
    }

    const clientId = document.getElementById('clientModalId').value;
    const isEdit = clientId !== '';
    const btn = document.getElementById('saveClientBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse"><%= j t("saving") %></span>';

    const payload = {
      client: {
        name: name,
        email: document.getElementById('clientEmailInput').value.trim(),
        phone: document.getElementById('clientPhoneInput').value.trim(),
        address: document.getElementById('clientAddressInput').value.trim(),
        notes: document.getElementById('clientNotesInput').value.trim()
      }
    };

    const url = isEdit ? `/clients/${clientId}` : '/clients';
    const method = isEdit ? 'PATCH' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        window.location.reload();
      } else {
        alert(res.errors ? res.errors.join(', ') : window.APP_LANGUAGES.error_while_saving);
        btn.disabled = false;
        btn.textContent = '<%= j t("save_client") %>';
      }
    })
    .catch(err => {
      console.error(err);
      alert(window.APP_LANGUAGES.error_while_saving);
      btn.disabled = false;
      btn.textContent = '<%= j t("save_client") %>';
    });
  }

  function confirmDeleteClient(clientId, clientName) {
    closeAllModals();
    document.getElementById('deleteClientId').value = clientId;
    document.getElementById('deleteClientName').textContent = clientName;
    document.getElementById('deleteClientModal').classList.add('active');
  }

  function closeDeleteClientModal(e) {
    if (e && (e.target !== e.currentTarget || !_modalMousedownOnBackdrop)) return;
    document.getElementById('deleteClientModal').classList.remove('active');
  }

  function performDeleteClient() {
    const clientId = document.getElementById('deleteClientId').value;
    if (!clientId) return;

    fetch(`/clients/${clientId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        window.location.reload();
      } else {
        alert(window.APP_LANGUAGES.an_error_occurred);
      }
    })
    .catch(err => {
      console.error(err);
      alert(window.APP_LANGUAGES.an_error_occurred);
    });
  }

  // Clear error on input
  document.addEventListener('DOMContentLoaded', () => {
    const ni = document.getElementById('clientNameInput');
    if (ni) {
      ni.addEventListener('input', () => {
        if (ni.value.trim()) {
          document.getElementById('clientNameError').classList.add('hidden');
          ni.classList.remove('border-red-500');
        }
      });
    }
  });
</script>
