<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css" />

<div class="min-h-screen bg-white text-black font-sans p-4">
  <header class="flex items-center gap-4 mb-10 pt-4 px-1">
    <%= link_to root_path, class: "p-2 bg-white border-2 border-black rounded-lg text-black hover:bg-orange-50 hover:border-orange-500 transition" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    <% end %>
    <h1 class="text-2xl font-black tracking-tighter text-black uppercase">Settings</h1>
  </header>

  <%= form_with model: @profile, url: save_settings_path, class: "max-w-md mx-auto space-y-8" do |f| %>
    <div class="space-y-6">

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Billing Model</label>
        <div class="flex border-2 border-black rounded-xl overflow-hidden shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]">
          <%= f.label :billing_mode_hourly, class: "flex-1 cursor-pointer" do %>
            <%= f.radio_button :billing_mode, "hourly", class: "peer hidden", checked: @profile.billing_mode != "fixed" %>
            <div class="py-3 text-center text-[10px] font-black uppercase tracking-widest transition-all peer-checked:bg-orange-600 peer-checked:text-white">
              Hourly Rate
            </div>
          <% end %>
          <%= f.label :billing_mode_fixed, class: "flex-1 cursor-pointer" do %>
            <%= f.radio_button :billing_mode, "fixed", class: "peer hidden", checked: @profile.billing_mode == "fixed" %>
            <div class="py-3 text-center text-[10px] font-black uppercase tracking-widest transition-all peer-checked:bg-orange-600 peer-checked:text-white border-l-2 border-black">
              Fixed Price
            </div>
          <% end %>
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Global Currency</label>
        <div class="relative">
          <%= f.hidden_field :currency, id: "currency_hidden_field", value: @profile.currency.presence || "$" %>
          <button type="button" id="currencySelectBtn" class="w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black text-left flex justify-between items-center shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] focus:outline-none z-10">
            <span id="selectedCurrencyDisplay" class="flex items-center gap-2 italic">Loading...</span>
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="3" stroke="black"/></svg>
          </button>
          
          <div id="currencyMenu" class="hidden absolute z-50 mt-2 w-full bg-white border-2 border-black rounded-xl shadow-2xl max-h-80 overflow-y-auto">
            <div class="p-2 sticky top-0 bg-white border-b-2 border-black z-20">
              <input type="text" id="currencySearch" placeholder="Search country or code..." class="w-full px-3 py-3 text-sm border-2 border-black rounded-lg outline-none focus:border-orange-500 bg-white">
            </div>
            <div id="currencyList" class="relative z-10"></div>
          </div>
        </div>
      </div>
      
      <div class="space-y-2">
        <label class="text-[10px] font-black text-orange-600 uppercase tracking-widest ml-1">Company / Name</label>
        <%= f.text_field :business_name, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
          <label id="rateLabel" class="text-[10px] font-black text-black uppercase tracking-widest ml-1">
            <%= @profile.billing_mode == "fixed" ? "Default Price (#{@profile.currency.presence || '$'})" : "Rate (#{@profile.currency.presence || '$'}/hr)" %>
          </label>
          <%= f.number_field :hourly_rate, step: 0.01, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
        </div>
        <div class="space-y-2">
          <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Tax Rate (%)</label>
          <%= f.number_field :tax_rate, step: 0.1, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Payment Instructions</label>
        <%= f.text_area :payment_instructions, rows: 3, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-medium text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Email</label>
        <%= f.email_field :email, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Phone</label>
        <%= f.text_field :phone, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Address</label>
        <%= f.text_area :address, rows: 2, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-medium text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-black text-black uppercase tracking-widest ml-1">Tax ID</label>
        <%= f.text_field :tax_id, class: "w-full bg-white border-2 border-black rounded-xl py-4 px-4 text-sm font-bold text-black focus:border-orange-500 outline-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]" %>
      </div>
    </div>

    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white border-2 border-black font-black py-4 rounded-xl shadow-[4px_4px_0px_0px_#000000] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all uppercase text-xs tracking-[0.2em]">
      Save Profile
    </button>
  <% end %>
</div>

<script>
  // COMPLETE GLOBAL DATA SET
  const currencies = [
    { n: "US Dollar", c: "USD", s: "$", i: "us" },
    { n: "Euro", c: "EUR", s: "€", i: "eu" },
    { n: "British Pound", c: "GBP", s: "£", i: "gb" },
    { n: "Georgian Lari", c: "GEL", s: "₾", i: "ge" },
    { n: "Japanese Yen", c: "JPY", s: "¥", i: "jp" },
    { n: "Australian Dollar", c: "AUD", s: "A$", i: "au" },
    { n: "Canadian Dollar", c: "CAD", s: "C$", i: "ca" },
    { n: "Swiss Franc", c: "CHF", s: "Fr", i: "ch" },
    { n: "Chinese Yuan", c: "CNY", s: "¥", i: "cn" },
    { n: "Indian Rupee", c: "INR", s: "₹", i: "in" },
    { n: "Turkish Lira", c: "TRY", s: "₺", i: "tr" },
    { n: "UAE Dirham", c: "AED", s: "د.إ", i: "ae" },
    { n: "Israeli Shekel", c: "ILS", s: "₪", i: "il" },
    { n: "Swedish Krona", c: "SEK", s: "kr", i: "se" },
    { n: "Brazilian Real", c: "BRL", s: "R$", i: "br" },
    { n: "Mexican Peso", c: "MXN", s: "$", i: "mx" },
    { n: "Afghan Afghani", c: "AFN", s: "Af", i: "af" },
    { n: "Albanian Lek", c: "ALL", s: "L", i: "al" },
    { n: "Armenian Dram", c: "AMD", s: "֏", i: "am" },
    { n: "Angolan Kwanza", c: "AOA", s: "Kz", i: "ao" },
    { n: "Argentine Peso", c: "ARS", s: "$", i: "ar" },
    { n: "Azerbaijani Manat", c: "AZN", s: "₼", i: "az" },
    { n: "Bangladeshi Taka", c: "BDT", s: "৳", i: "bd" },
    { n: "Bulgarian Lev", c: "BGN", s: "лв", i: "bg" },
    { n: "Bahraini Dinar", c: "BHD", s: ".د.ب", i: "bh" },
    { n: "Chilean Peso", c: "CLP", s: "$", i: "cl" },
    { n: "Colombian Peso", c: "COP", s: "$", i: "co" },
    { n: "Czech Koruna", c: "CZK", s: "Kč", i: "cz" },
    { n: "Danish Krone", c: "DKK", s: "kr", i: "dk" },
    { n: "Egyptian Pound", c: "EGP", s: "E£", i: "eg" },
    { n: "Hong Kong Dollar", c: "HKD", s: "HK$", i: "hk" },
    { n: "Hungarian Forint", c: "HUF", s: "Ft", i: "hu" },
    { n: "Icelandic Króna", c: "ISK", s: "kr", i: "is" },
    { n: "Indonesian Rupiah", c: "IDR", s: "Rp", i: "id" },
    { n: "Jordanian Dinar", c: "JOD", s: "JD", i: "jo" },
    { n: "Kenyan Shilling", c: "KES", s: "KSh", i: "ke" },
    { n: "Kuwaiti Dinar", c: "KWD", s: "KD", i: "kw" },
    { n: "Kazakhstani Tenge", c: "KZT", s: "₸", i: "kz" },
    { n: "Lebanese Pound", c: "LBP", s: "L£", i: "lb" },
    { n: "Moroccan Dirham", c: "MAD", s: "DH", i: "ma" },
    { n: "Malaysian Ringgit", c: "MYR", s: "RM", i: "my" },
    { n: "Nigerian Naira", c: "NGN", s: "₦", i: "ng" },
    { n: "Norwegian Krone", c: "NOK", s: "kr", i: "no" },
    { n: "New Zealand Dollar", c: "NZD", s: "NZ$", i: "nz" },
    { n: "Omani Rial", c: "OMR", s: "RO", i: "om" },
    { n: "Philippine Peso", c: "PHP", s: "₱", i: "ph" },
    { n: "Pakistan Rupee", c: "PKR", s: "Rs", i: "pk" },
    { n: "Polish Zloty", c: "PLN", s: "zł", i: "pl" },
    { n: "Qatari Rial", c: "QAR", s: "QR", i: "qa" },
    { n: "Romanian Leu", c: "RON", s: "lei", i: "ro" },
    { n: "Saudi Riyal", c: "SAR", s: "SR", i: "sa" },
    { n: "Singapore Dollar", c: "SGD", s: "S$", i: "sg" },
    { n: "Thai Baht", c: "THB", s: "฿", i: "th" },
    { n: "Taiwan Dollar", c: "TWD", s: "NT$", i: "tw" },
    { n: "Ukrainian Hryvnia", c: "UAH", s: "₴", i: "ua" },
    { n: "Vietnamese Dong", c: "VND", s: "₫", i: "vn" },
    { n: "South African Rand", c: "ZAR", s: "R", i: "za" }
  ];

document.addEventListener("DOMContentLoaded", () => {
    const hiddenField = document.getElementById('currency_hidden_field');
    const selectBtn = document.getElementById('currencySelectBtn');
    const display = document.getElementById('selectedCurrencyDisplay');
    const menu = document.getElementById('currencyMenu');
    const search = document.getElementById('currencySearch');
    const list = document.getElementById('currencyList');
    const rateLabel = document.getElementById('rateLabel');
    const fixedRadio = document.getElementById('profile_billing_mode_fixed');

    // FIX: Look up by CODE instead of SYMBOL to avoid Yen/Yuan confusion
    const current = currencies.find(c => c.c === hiddenField.value) || currencies[0];
    updateDisplay(current);

    function updateDisplay(currency) {
      display.innerHTML = `<span class="fi fi-${currency.i} rounded-sm shadow-sm"></span> <span class="ml-1">${currency.c} (${currency.s})</span>`;
      if (fixedRadio.checked) rateLabel.innerText = `Default Price (${currency.s})`;
      else rateLabel.innerText = `Rate (${currency.s}/hr)`;
    }

    function renderList(filter = "") {
      list.innerHTML = "";
      const filtered = currencies.filter(c => 
        c.n.toLowerCase().includes(filter.toLowerCase()) || 
        c.c.toLowerCase().includes(filter.toLowerCase())
      );

      filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = "px-4 py-4 hover:bg-orange-50 cursor-pointer flex items-center justify-between border-b border-gray-100 last:border-0 transition-colors";
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="fi fi-${c.i} rounded-sm shadow-sm w-5 h-4"></span>
            <span class="text-sm font-bold text-black">${c.n}</span>
          </div>
          <span class="text-xs font-black text-orange-600 bg-orange-50 px-2 py-1 rounded-md border border-orange-100">${c.s}</span>
        `;
        div.onclick = (e) => {
          e.stopPropagation();
          hiddenField.value = c.c; // FIX: Saving the CODE (CNY) not the SYMBOL (¥)
          updateDisplay(c);
          menu.classList.add('hidden');
        };
        list.appendChild(div);
      });
    }

    selectBtn.onclick = (e) => {
      e.stopPropagation();
      menu.classList.toggle('hidden');
      if (!menu.classList.contains('hidden')) search.focus();
    };
    
    // Prevent search click from closing the menu
    search.onclick = (e) => e.stopPropagation();
    search.oninput = (e) => renderList(e.target.value);
    
    document.getElementById('profile_billing_mode_hourly').addEventListener('change', () => {
      rateLabel.innerText = `Rate (${hiddenField.value}/hr)`;
    });
    fixedRadio.addEventListener('change', () => {
      rateLabel.innerText = `Default Price (${hiddenField.value})`;
    });

    renderList();

    // Close menu when clicking anywhere else
    document.addEventListener('click', () => {
      menu.classList.add('hidden');
    });
  });
</script>