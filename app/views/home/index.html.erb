<style>
  #mainTranscript {
    min-height: 120px;
  }
  .industrial-shadow {
    box-shadow: 4px 4px 0px 0px #F97316;
  }
  .industrial-input:focus {
    box-shadow: 2px 2px 0px 0px #F97316;
    transform: translate(-1px, -1px);
  }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  
  /* Pulsing glow animation for record button */
  @keyframes pulseGlow {
    0%, 100% {
      box-shadow: 0 8px 32px rgba(249, 115, 22, 0.4), 0 4px 12px rgba(0,0,0,0.1), inset 0 2px 0 rgba(255,255,255,0.2);
      transform: scale(1);
    }
    50% {
      box-shadow: 0 12px 48px rgba(249, 115, 22, 0.6), 0 6px 16px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.2);
      transform: scale(1.02);
    }
  }
  
  /* Mic icon bounce animation */
  @keyframes micBounce {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-3px) rotate(-3deg); }
    50% { transform: translateY(0); }
    75% { transform: translateY(-3px) rotate(3deg); }
  }
  
  #micIcon {
    animation: micBounce 2s ease-in-out infinite;
  }
  
  #recordButton {
    animation: pulseGlow 2.5s ease-in-out infinite;
  }
  
  #recordButton:hover {
    animation: none;
    transform: scale(1.05);
    box-shadow: 0 16px 56px rgba(249, 115, 22, 0.5), 0 8px 20px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.2);
  }
  
  #recordButton:hover #micIcon {
    animation: none;
    transform: scale(1.1);
  }
  
  /* Recording state - red glow */
  #recordButton.recording {
    background: linear-gradient(145deg, #ef4444, #dc2626) !important;
    box-shadow: 0 8px 32px rgba(239, 68, 68, 0.5), 0 4px 12px rgba(0,0,0,0.1), inset 0 2px 0 rgba(255,255,255,0.2);
    animation: pulseGlow 1s ease-in-out infinite;
  }
  
  #recordButton.recording #micIcon {
    animation: micBounce 2s ease-in-out infinite;
  }
  
  /* Custom Scrollbar for Textareas */
  .custom-scrollbar::-webkit-scrollbar {
    width: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 5px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #ea580c;
    border-radius: 5px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #c2410c;
  }
  
  /* Analyzing Animation - Rotating Gradient Border */
  .transcript-container {
    position: relative;
    border-radius: 14px;
    padding: 3px;
    background: transparent;
  }
  
  .transcript-container.analyzing {
    background: linear-gradient(90deg, #f97316, #fbbf24, #f97316, #ea580c, #f97316);
    background-size: 300% 100%;
    animation: borderFlow 1.5s linear infinite;
  }
  
  .transcript-container.analyzing::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 14px;
    padding: 3px;
    background: inherit;
    background-size: inherit;
    animation: inherit;
    filter: blur(8px);
    opacity: 0.6;
    z-index: -1;
  }
  
  .transcript-container.analyzing #mainTranscript {
    border-color: transparent;
  }
  
  @keyframes borderFlow {
    0% { background-position: 0% 50%; }
    100% { background-position: 300% 50%; }
  }
  
  /* Review Data Analyzing Container */
  .review-container {
    position: relative;
    border-radius: 18px;
    padding: 3px;
    background: transparent;
  }
  
  .review-container.analyzing {
    background: linear-gradient(90deg, #f97316, #fbbf24, #f97316, #ea580c, #f97316);
    background-size: 300% 100%;
    animation: borderFlow 1.5s linear infinite;
  }
  
  .review-container.analyzing::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 18px;
    padding: 3px;
    background: inherit;
    background-size: inherit;
    animation: inherit;
    filter: blur(12px);
    opacity: 0.5;
    z-index: -1;
  }
  
  .review-container.analyzing .review-content {
    border-color: transparent;
  }
  
  /* Smooth Breathing Blur Overlay */
  .analyzing-overlay {
    display: none;
    position: absolute;
    inset: 0;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.85);
    background-size: 200% 200%;
    backdrop-filter: blur(6px);
    z-index: 50;
    animation: breatheGradient 2s ease-in-out infinite, breatheBlur 2s ease-in-out infinite;
  }
  
  .analyzing-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  @keyframes breatheGradient {
    0%, 100% { 
      background-position: 0% 50%;
      opacity: 0.7;
    }
    50% { 
      background-position: 100% 50%;
      opacity: 1;
    }
  }
  
  @keyframes breatheBlur {
    0%, 100% { 
      backdrop-filter: blur(4px);
    }
    50% { 
      backdrop-filter: blur(10px);
    }
  }
  
  /* Container pulse effect */
  .review-container.analyzing {
    animation: borderFlow 1.5s linear infinite, containerPulse 2s ease-in-out infinite;
  }
  
  @keyframes containerPulse {
    0%, 100% { 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
    }
    50% { 
      transform: scale(1.005);
      box-shadow: 0 0 30px 5px rgba(249, 115, 22, 0.2);
    }
  }
  
  .analyzing-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(0, 0, 0, 0.1);
    border-top-color: #f97316;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    z-index: 52;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Animation for the pop-up price field */
  .price-badge-container.hidden {
    display: none;
  }
  
  /* Item Operations Menu */
  .item-menu-btn {
    transition: all 0.2s;
  }
  .item-menu-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: -2px;
    background: white;
    border: 2px solid black;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
    z-index: 50;
    box-shadow: 3px 3px 0px 0px rgba(0,0,0,1);
    width: calc(100% + 4px);
    padding: 6px;
  }
  .item-menu-dropdown.show {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .slider-icon path {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-item {
    position: relative; /* For dropright positioning */
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 12px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.1s;
    background: white;
    color: #525252;
    border: 1px solid transparent;
  }
  .menu-item:hover {
    background: #FFF7ED;
    color: #EA580C;
  }
  .menu-item.active {
    background-color: #FFEDD5; /* Orange-100 */
    color: #EA580C;
    border: 1px solid #EA580C;
    border-bottom: none;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }
  .menu-item-discount.active {
    background-color: #DCFCE7; /* Green-100 */
    color: #16A34A;
    border: 1px solid #16A34A;
    border-bottom: none;
  }
  .menu-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 900;
    color: #a3a3a3;
  }
  .menu-item:hover .menu-icon {
    color: #EA580C;
    background: rgba(234, 88, 12, 0.1);
  }
  .menu-item.active .menu-icon {
    background: #EA580C;
    color: white;
  }
  .menu-item-discount.active .menu-icon {
    background: #16A34A;
    color: white;
  }
  .menu-item-discount:hover .menu-icon {
    color: #16A34A;
    background: #DCFCE7;
  }
  .menu-item-discount:hover {
    background: #F0FDF4; /* Green-50 */
    color: #16A34A;
  }
  
  /* Dropright Input */
  .menu-input-container {
    display: none;
    position: absolute;
    left: 100%;
    top: 0;
    margin-left: 8px;
    background: white;
    padding: 4px;
    border: 2px solid black;
    border-radius: 6px;
    box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
    z-index: 60;
    align-items: center;
    gap: 4px;
  }
  .menu-item.active .menu-input-container {
    display: flex;
    animation: fadeIn 0.1s ease-out;
  }
  .menu-input {
    width: 60px;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    padding: 4px;
    font-size: 11px;
    font-weight: 700;
    color: black;
    outline: none;
  }
  .menu-input:focus {
    border-color: #F97316;
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    padding: 0 10px;
    border-radius: 0 0 6px 6px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    border: 1px solid transparent;
  }
  .badge.hidden { display: none; }
  
  .badge-price, .badge-tax, .badge-after-tax {
    background-color: #EA580C;
    color: white;
    border: 1px solid black;
  }
  .badge-discount {
    background-color: #16A34A; /* Green-600 */
    color: white;
    border: 1px solid black;
  }
  
  /* Green Active State for Discount Menu */
  .menu-item-discount.active {
    background-color: #DCFCE7; /* Green-100 */
    color: #16A34A; /* Green-600 */
    border-color: #16A34A;
    border-bottom-left-radius: 0; 
    border-bottom-right-radius: 0;
    border-bottom: none;
    z-index: 10; /* Sit above inputs */
  }
  .menu-item-discount.active .menu-icon {
    background-color: #16A34A;
    color: white;
  }
  
  .discount-inputs-row {
    border-color: #16A34A; /* Match active green */
    border-width: 0 1px 1px 1px; /* Sides and bottom only */
    border-style: solid;
    border-radius: 0 0 6px 6px;
    margin-top: -1px; /* Overlap border */
    background-color: #F0FDF4; /* Very light green bg to match */
    padding: 6px; /* slightly more padding */
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="bg-white text-black font-sans p-4 pb-32 md:pb-10">
  
  <header class="flex flex-row justify-between items-center mb-8 md:mb-12 pt-2 px-1 gap-2">
    <div class="flex items-center gap-2 md:gap-4 select-none min-w-0">
      <div class="flex items-center justify-center w-11 h-11 md:w-14 md:h-14 bg-orange-600 border-2 border-black shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] rounded-xl shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6" />
        </svg>
      </div>
      <h1 class="text-2xl md:text-4xl font-black tracking-tighter text-black uppercase italic truncate leading-none pr-2">
        TALK<span class="text-orange-600">INVOICE</span>
      </h1>
    </div>
    
    <div class="flex gap-1.5 md:gap-3 shrink-0">
      <%= link_to history_path, class: "p-1.5 md:p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "History" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      <% end %>

      <%= link_to profile_path, class: "p-1.5 md:p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "Profile" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      <% end %>

      <%= link_to settings_path, class: "p-1.5 md:p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "Settings" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      <% end %>
    </div>
  </header>

  <div class="max-w-md md:max-w-6xl mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-[380px_1fr] gap-12 items-start">
      
      <!-- LEFT COLUMN: Sticky Console -->
      <div class="md:sticky md:top-8 flex flex-col gap-10">
        
        <!-- Recording Console -->
        <div class="flex flex-col items-center justify-center pt-4">
          <div id="recordingWave" class="hidden absolute w-48 h-48 border-4 border-orange-200 rounded-full animate-ping"></div>
          
          <button id="recordButton" class="relative w-40 h-40 rounded-full flex flex-col items-center justify-center transition-all duration-300 active:scale-95 group"
                  style="background: linear-gradient(145deg, #f97316, #ea580c); box-shadow: 0 8px 32px rgba(249, 115, 22, 0.4), 0 4px 12px rgba(0,0,0,0.1), inset 0 2px 0 rgba(255,255,255,0.2);">
            <!-- Outer glow ring -->
            <div class="absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                 style="box-shadow: 0 0 40px rgba(249, 115, 22, 0.5);"></div>
            <!-- Inner highlight -->
            <div class="absolute inset-2 rounded-full border-2 border-white/20"></div>
            
            <svg id="micIcon" class="w-12 h-12 text-white mb-2 group-hover:scale-110 transition-transform drop-shadow-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span id="buttonText" class="text-white text-[9px] font-black uppercase tracking-[0.15em] text-center px-4 drop-shadow-md">TAP TO RECORD</span>
          </button>
          
          <p id="status" class="mt-6 text-xs font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full uppercase tracking-widest border border-orange-100">Ready</p>
        </div>

        <!-- Transcript Console -->
        <div id="textSection" class="space-y-3 transition-all duration-500">
          <div class="relative">
            <label class="text-xs font-black text-black uppercase tracking-widest">Live Transcript</label>
          </div>
          <div id="transcriptContainer" class="transcript-container">
            <textarea id="mainTranscript" 
                      rows="6"
                      class="w-full bg-white border-2 border-black rounded-xl p-5 text-black text-sm font-medium leading-relaxed resize-none outline-none industrial-input placeholder:text-gray-400 custom-scrollbar overflow-hidden"
                      style="max-height: 800px; field-sizing: content;"
                      placeholder="Paste text or type notes here..."
                      oninput="autoResize(this)"></textarea>
          </div>
          
          <!-- Apply Action Button -->
          <div class="flex justify-end pr-1">
            <button id="reParseBtn" class="flex items-center gap-2 px-4 py-2 bg-orange-500 border-2 border-black text-white rounded-xl active:scale-95 transition-all hover:bg-orange-600 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] group" title="Analyze Text">
              <span class="text-[10px] font-black uppercase tracking-widest">Apply</span>
              <svg class="h-3.5 w-3.5 group-hover:translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Invoice Data -->
      <div id="invoicePreview" class="transition-all duration-700 space-y-8">

      
        <div class="flex items-center gap-4">
          <div class="h-px bg-black flex-1 opacity-10"></div>
          <span class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-600">Review Data</span>
          <div class="h-px bg-black flex-1 opacity-10"></div>
        </div>

        <div id="reviewContainer" class="review-container">
        <div class="bg-white border-2 border-black rounded-2xl p-6 industrial-shadow space-y-6 review-content relative">
          <!-- Analyzing Overlay -->
          <div id="analyzingOverlay" class="analyzing-overlay"></div>
        
        <div class="flex justify-between items-center pb-4 border-b-2 border-dashed border-gray-200">
          <h2 class="text-sm font-black uppercase tracking-widest text-black">Job Details</h2>
          <div class="flex items-center gap-2 relative">
            <span id="dateDisplay" class="text-xs font-bold text-orange-600"><%= Time.now.strftime("%b %d, %Y") %></span>
            <button type="button" onclick="toggleMainCalendar()" class="w-7 h-7 border-2 border-black rounded-lg bg-white hover:bg-orange-50 transition-colors flex items-center justify-center group">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </button>
            <!-- Main Date Calendar Popup -->
            <div id="mainCalendarPopup" class="hidden absolute top-full right-0 mt-2 bg-white border-2 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] z-[100] p-4 min-w-[280px]">
              <div class="flex justify-between items-center mb-3">
                <button type="button" onclick="changeMainCalendarMonth(-1)" class="w-8 h-8 border-2 border-black rounded-lg hover:bg-orange-50 flex items-center justify-center font-black text-lg">‹</button>
                <span id="mainCalendarMonthYear" class="text-sm font-black uppercase tracking-widest text-black"></span>
                <button type="button" onclick="changeMainCalendarMonth(1)" class="w-8 h-8 border-2 border-black rounded-lg hover:bg-orange-50 flex items-center justify-center font-black text-lg">›</button>
              </div>
              <div class="grid grid-cols-7 gap-1 mb-2">
                <span class="text-[9px] font-bold text-gray-400 text-center">SU</span>
                <span class="text-[9px] font-bold text-gray-400 text-center">MO</span>
                <span class="text-[9px] font-bold text-gray-400 text-center">TU</span>
                <span class="text-[9px] font-bold text-gray-400 text-center">WE</span>
                <span class="text-[9px] font-bold text-gray-400 text-center">TH</span>
                <span class="text-[9px] font-bold text-gray-400 text-center">FR</span>
                <span class="text-[9px] font-bold text-gray-400 text-center">SA</span>
              </div>
              <div id="mainCalendarDays" class="grid grid-cols-7 gap-1"></div>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="space-y-1">
            <label class="block text-[9px] font-bold text-gray-500 uppercase ml-1">Client Name</label>
            <div class="border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px] flex items-center">
              <input type="text" id="editClient" 
                     class="w-full bg-transparent border-none text-base font-black text-black focus:ring-0 py-3 px-3 outline-none placeholder:text-gray-300"
                     placeholder="Enter client name...">
            </div>
          </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="laborGrid">
          <div class="space-y-1 relative" id="laborBox" data-taxable="false" data-billing-mode="<%= @profile.billing_mode %>">
            <label id="timeLabel" class="block text-[9px] font-bold text-gray-500 uppercase ml-1">
              <% current_currency = currencies_data.find { |c| c[:c] == (@profile.currency.presence || "USD") } %>
              <% currency_sym = current_currency[:s] %>
              <%= @profile.billing_mode == "fixed" ? "LABOR PRICE" : "LABOR HOURS" %>
            </label>
            
            <div class="flex items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px]">
              <div class="h-full w-10 border-r-2 border-black flex-shrink-0 item-menu-container">
                <button type="button" onclick="toggleMenu(this)" class="labor-tax-toggle w-full h-full flex flex-col items-center justify-center gap-[3px] hover:bg-gray-50 item-menu-btn rounded-l-[10px]">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-colors slider-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path d="M3 4h18M3 12h18M3 20h18" />
                    <path class="slider-head-1" d="M12 2v4" />
                    <path class="slider-head-2" d="M12 10v4" />
                    <path class="slider-head-3" d="M12 18v4" />
                  </svg>
                </button>
                
                <div class="item-menu-dropdown">
                  <!-- Tax Menu Item -->
                  <div class="tax-wrapper flex flex-col w-full">
                      <div class="menu-item menu-item-tax" onclick="toggleLaborTaxable(this)">
                        <span>Taxable</span>
                        <div class="menu-icon">%</div>
                      </div>
                      
                      <div class="tax-inputs-row hidden gap-1 p-1 bg-orange-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-orange-600 rounded-b-md"
                           style="grid-template-columns: 1fr;">
                           <div class="relative w-full">
                             <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                             <input type="number" step="0.1" class="menu-input tax-menu-input text-right w-full border-orange-200 pl-4 pr-1" 
                                    style="width: 100%"
                                    value="<%= @profile.tax_rate.presence || 0 %>" placeholder="%" 
                                    oninput="updateLaborBadge()">
                           </div>
                      </div>
                  </div>
                  <!-- Divider -->
                  <div class="h-[1px] bg-gray-100 mx-2 my-0.5"></div>
                  <!-- Discount Menu Item -->
                  <div class="discount-wrapper flex flex-col w-full">
                      <div class="menu-item menu-item-discount" onclick="toggleDiscount(this)">
                        <span>Discount</span>
                        <div class="menu-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                          </svg>
                        </div>
                      </div>
                      
                       <div class="discount-inputs-row hidden grid gap-1 p-1 bg-green-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-green-600 rounded-b-md"
                            style="grid-template-columns: 1fr 1fr;">
                            <div class="relative flex-1">
                              <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400"><%= currency_sym %></span>
                              <input type="number" step="0.01" class="menu-input discount-flat-input text-right w-full border-gray-300 pl-4 pr-1" 
                                    style="width: 100%"
                                    placeholder="0.00" 
                                    oninput="updateLaborBadge()">
                            </div>
                            <div class="relative flex-1">
                              <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                              <input type="number" step="0.1" class="menu-input discount-percent-input text-right w-full border-gray-300 pl-4 pr-1" 
                                    style="width: 100%"
                                    placeholder="0" 
                                    oninput="updateLaborBadge()">
                           </div>
                      </div>
                  </div>
                </div>
              </div>
              <!-- Clock icon for hourly mode -->
              <span id="laborClockIcon" class="flex items-center justify-center bg-orange-600 text-white font-black border-2 border-black rounded-lg h-6 w-6 ml-2 shrink-0 <%= @profile.billing_mode == 'fixed' ? 'hidden' : '' %>">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              
              <!-- Currency icon for fixed mode -->
              <span id="laborUnitIndicator" class="flex items-center justify-center bg-orange-600 text-white font-black border-2 border-black rounded-lg h-6 w-6 ml-2 shrink-0 select-none text-[10px] <%= @profile.billing_mode == 'fixed' ? '' : 'hidden' %>"><%= currency_sym %></span>
              
              <!-- Hours/Price input -->
              <input type="text" id="editTime" 
                     inputmode="decimal"
                      value="<%= @profile.billing_mode == 'fixed' && @profile.hourly_rate ? (@profile.hourly_rate % 1 == 0 ? @profile.hourly_rate.to_i : @profile.hourly_rate) : '' %>"
                      placeholder="<%= @profile.billing_mode == 'fixed' ? 'Price...' : 'Hours...' %>"
                      onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46"
                      oninput="updateLaborBadge(); resizeInput(this)"
                      class="bg-transparent border-none py-3 pl-2 pr-0 font-black text-black focus:ring-0 outline-none text-left min-w-0 text-sm placeholder:text-gray-300 w-auto">
              
              <!-- Multiplication sign and rate (hourly mode only) -->
              <div id="laborRateSection" class="flex items-center shrink-0 <%= @profile.billing_mode == 'fixed' ? 'hidden' : '' %>">
                <div class="h-6 w-6 flex items-center justify-center text-gray-400 mr-3 ml-0">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </div>
                <span id="laborRateCurrency" class="flex items-center justify-center bg-orange-600 text-white font-black border-2 border-black rounded-lg h-6 w-6 shrink-0 select-none text-[10px]"><%= currency_sym %></span>
                <input type="text" id="editHourlyRate" 
                       inputmode="decimal"
                       value="<%= @profile.hourly_rate %>"
                       placeholder="Rate"
                       onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46"
                       oninput="updateLaborBadge(); document.getElementById('laborBox').dataset.hourlyRate = this.value;"
                       class="w-20 bg-transparent border-none py-3 px-1 font-black text-black focus:ring-0 outline-none text-left min-w-0 text-sm placeholder:text-gray-300">
              </div>
              
              <!-- Labor Badges (Hanging) -->
              <div class="absolute -bottom-6 left-2.5 flex items-center gap-2 z-0 pointer-events-none">
                  <span id="laborDiscountBadge" class="badge badge-discount hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"></span>
              </div>
              <div class="absolute -bottom-6 right-2.5 flex items-center gap-2 z-0 pointer-events-none">
                  <span id="laborTaxBadge" class="badge badge-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
              </div>
            </div>
          </div>

          <div class="space-y-1 relative">
            <label class="block text-[9px] font-bold text-gray-500 uppercase ml-1">After Tax</label>
            <div class="flex items-center border-2 border-black rounded-xl bg-orange-50 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px] px-4">
              <span class="flex-1 text-right font-black text-black" id="laborAfterTaxDisplay">0</span>
              <span class="flex items-center justify-center bg-orange-600 text-white font-black border-2 border-black rounded-lg h-6 w-6 ml-2 shrink-0 select-none text-[10px]"><%= currency_sym %></span>
            </div>
          </div>
        </div>
        </div>

        <div id="dynamicSections" class="space-y-6 pt-6">
          <div class="dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500" data-protected="labor">
            <div class="flex justify-between items-center group border-b-2 border-black pb-1">
              <div class="flex items-center">
                <svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></svg>
                <span class="text-base font-black text-orange-600 uppercase tracking-widest section-title">Labor/Service</span>
              </div>
              <div class="flex gap-2 mb-1 shrink-0">
                <button type="button" onclick="addItem('section_initial')" 
                        class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
                  + Item
                </button>
                <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                        class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
                  Remove
                </button>
              </div>
            </div>
            <div id="section_initial" class="pt-2">
              <!-- Initial item will be added via script to ensure it has all settings -->
              <script>
                document.addEventListener('DOMContentLoaded', () => {
                  if (typeof addItem === 'function') {
                    // Force the initial labor item to have the settings menu
                    addItem('section_initial', '', '', false, 'Labor/Service');
                  }
                });
              </script>
            </div>
          </div>
        </div>


        <!-- Due Date Display -->
        <div class="flex justify-end items-center pt-4 pb-2 relative">
          <div class="flex items-center gap-2">
            <div class="flex flex-col justify-center text-right">
              <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-none translate-y-[-1px]">Due Date</span>
              <div id="dueDateDisplay" class="text-xs font-black text-black leading-none mt-0.5 flex items-baseline justify-end">
                <% initial_due = Time.now + 14.days %>
                <span id="dueDateValue" class="leading-none"><%= initial_due.strftime("%b %d, %Y") %></span>
                <span id="dueDaysLabel" class="text-[12px] font-bold text-gray-400 ml-[2px] leading-none whitespace-nowrap"><%= "(in 14 days)" %></span>
              </div>
            </div>
            <button type="button" onclick="toggleCalendar()" class="w-8 h-8 border-2 border-black rounded-lg bg-white hover:bg-orange-50 transition-colors flex items-center justify-center group flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </button>
          </div>
          
          <!-- Calendar Popup -->
          <div id="calendarPopup" class="hidden absolute bottom-full right-0 mb-2 bg-white border-2 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] z-50 p-4 min-w-[280px]">
            <div class="flex justify-between items-center mb-3">
              <button type="button" onclick="changeCalendarMonth(-1)" class="w-8 h-8 border-2 border-black rounded-lg hover:bg-orange-50 flex items-center justify-center font-black text-lg">‹</button>
              <span id="calendarMonthYear" class="text-sm font-black uppercase tracking-widest"></span>
              <button type="button" onclick="changeCalendarMonth(1)" class="w-8 h-8 border-2 border-black rounded-lg hover:bg-orange-50 flex items-center justify-center font-black text-lg">›</button>
            </div>
            <div class="grid grid-cols-7 gap-1 mb-2">
              <span class="text-[9px] font-bold text-gray-400 text-center">SU</span>
              <span class="text-[9px] font-bold text-gray-400 text-center">MO</span>
              <span class="text-[9px] font-bold text-gray-400 text-center">TU</span>
              <span class="text-[9px] font-bold text-gray-400 text-center">WE</span>
              <span class="text-[9px] font-bold text-gray-400 text-center">TH</span>
              <span class="text-[9px] font-bold text-gray-400 text-center">FR</span>
              <span class="text-[9px] font-bold text-gray-400 text-center">SA</span>
            </div>
            <div id="calendarDays" class="grid grid-cols-7 gap-1"></div>
            <div class="flex gap-2 mt-3 pt-3 border-t-2 border-dashed border-gray-200">
              <button type="button" onclick="setQuickDue(7)" class="flex-1 py-2 border-2 border-black rounded-lg text-[9px] font-black uppercase hover:bg-orange-50 transition-colors">Net 7</button>
              <button type="button" onclick="setQuickDue(14)" class="flex-1 py-2 border-2 border-black rounded-lg text-[9px] font-black uppercase hover:bg-orange-50 transition-colors">Net 14</button>
              <button type="button" onclick="setQuickDue(30)" class="flex-1 py-2 border-2 border-black rounded-lg text-[9px] font-black uppercase hover:bg-orange-50 transition-colors">Net 30</button>
            </div>
          </div>
        </div>

        <!-- Totals Summary with Discount Badge -->
        <div class="relative">
          <!-- Discount Badge (top-left corner) with upward popup -->
          <div class="absolute -top-3 left-3 z-20">
            <button type="button" id="discountToggleBtn" onclick="toggleGlobalDiscountPanel()" 
                    class="flex items-center gap-1.5 px-2.5 py-1 bg-white border-2 border-gray-300 rounded-full text-gray-500 hover:border-green-500 hover:text-green-600 hover:bg-green-50 transition-all shadow-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
              </svg>
              <span class="text-[9px] font-black uppercase tracking-widest">Discount</span>
            </button>
            
            <!-- Discount Inputs Popup (pops up above the badge) -->
            <div id="discountInputsPanel" class="hidden absolute left-0 bottom-full mb-2 w-48 bg-white border-2 border-green-500 rounded-xl p-3 shadow-[4px_4px_0px_0px_rgba(22,163,74,0.2)] animate-in fade-in slide-in-from-bottom-2 duration-200">
              <div class="space-y-3">
                <div class="relative group">
                  <div class="absolute left-1 top-1/2 -translate-y-1/2 h-6 w-6 flex items-center justify-center bg-green-600 text-white font-black border-2 border-black rounded-lg text-[10px] pointer-events-none select-none z-10 shadow-sm">
                    <span id="discountCurrencySymbol"><%= currencies_data.find { |c| c[:c] == (@profile.currency.presence || 'USD') }&.dig(:s) || '$' %></span>
                  </div>
                  <input type="number" id="globalDiscountFlat" placeholder="0.00" 
                         class="w-full bg-white border-2 border-green-200 rounded-lg py-2 pl-9 pr-2 text-sm font-bold text-black focus:outline-none focus:border-green-500 transition-all placeholder:text-gray-300 font-mono"
                         oninput="updateTotalsSummary()">
                </div>
                <div class="relative group">
                  <div class="absolute left-1 top-1/2 -translate-y-1/2 h-6 w-6 flex items-center justify-center bg-green-600 text-white font-black border-2 border-black rounded-lg text-[10px] pointer-events-none select-none z-10 shadow-sm">
                    <span>%</span>
                  </div>
                  <input type="number" id="globalDiscountPercent" placeholder="0" 
                         class="w-full bg-white border-2 border-green-200 rounded-lg py-2 pl-9 pr-2 text-sm font-bold text-black focus:outline-none focus:border-green-500 transition-all placeholder:text-gray-300 font-mono"
                         oninput="updateTotalsSummary()">
                </div>
              </div>
            </div>
          </div>
          
          <div id="totalsSummary" class="bg-gray-50 border-2 border-black rounded-xl p-4 pt-5 space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Subtotal</span>
              <span id="summarySubtotal" class="text-sm font-black text-black"><%= format_money_ruby(0, @profile) %></span>
            </div>
            
            <!-- Discount Row (shows combined discount from items + global) -->
            <div id="discountRow" class="hidden flex justify-between items-center">
              <span class="text-[10px] font-black uppercase tracking-widest text-green-600">Discount</span>
              <span id="summaryDiscountTotal" class="text-sm font-black text-green-600">-<%= format_money_ruby(0, @profile) %></span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Tax</span>
              <span id="summaryTax" class="text-sm font-black text-orange-600"><%= format_money_ruby(0, @profile) %></span>
          </div>
          <div class="flex justify-between items-center h-8 relative">
             <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Credit</span>
             
             <div class="flex items-center gap-2">
                <!-- Clickable Credit Pill -->
                <button type="button" onclick="toggleCreditPopover()" id="creditPill" class="flex items-center gap-2 px-3 py-1 bg-white border border-gray-200 rounded-full hover:border-black transition-all group shadow-sm active:scale-95">
                  <span id="summaryCredit" class="text-xs font-black text-gray-400 group-hover:text-black transition-colors" data-value="0">Add Credit</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-400 group-hover:text-black transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                <!-- Credit Popover (Flat Amount Only) -->
                <div id="creditPopover" class="hidden absolute right-[-4px] bottom-full mb-2 w-56 bg-white border-2 border-black rounded-2xl shadow-[8px_8px_0px_0px_rgba(251,146,60,0.15)] z-[100] p-5 text-black animate-in fade-in slide-in-from-bottom-2 duration-200">
                  <div class="flex justify-between items-center mb-4">
                    <span class="text-[10px] font-black uppercase tracking-tighter text-orange-600">Credit Settings</span>
                    <button type="button" onclick="toggleCreditPopover()" class="text-gray-400 hover:text-orange-600 transition-colors p-1">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                       </svg>
                    </button>
                  </div>
                  
                  <div class="space-y-4">
                    <!-- Credit Amount Input -->
                    <div>
                      <label class="block text-[8px] font-black uppercase tracking-widest text-gray-500 mb-1.5 ml-1">Credit Amount</label>
                      <div class="relative group">
                        <div class="absolute left-1.5 top-1/2 -translate-y-1/2 h-6 w-6 flex items-center justify-center bg-orange-600 text-white font-black border-2 border-black rounded-lg text-[10px] pointer-events-none select-none z-10 shadow-sm">
                            <span id="creditCurrencySymbol"><%= currencies_data.find { |c| c[:c] == (@profile.currency.presence || 'USD') }&.dig(:s) || '$' %></span>
                        </div>
                        <input type="number" id="creditFlatInput" placeholder="0.00" 
                               class="w-full bg-white border-2 border-gray-200 rounded-xl py-2.5 pl-10 pr-3 text-sm font-bold text-black focus:outline-none focus:border-orange-500 transition-all placeholder:text-gray-300 font-mono"
                               oninput="updateTotalsSummary()">
                      </div>
                    </div>
                  </div>
                </div>
             </div>
           </div>
          <div class="flex justify-between items-center pt-2 border-t-2 border-dashed border-gray-300">
            <span class="text-xs font-black uppercase tracking-widest text-black">Total</span>
            <span id="summaryTotal" class="text-lg font-black text-black"><%= format_money_ruby(0, @profile) %></span>
          </div>
          </div>
        </div>

        <div class="flex items-center gap-3 pt-2">
          <!-- Plus Button with Dropup -->
          <div class="relative">
            <button type="button" id="addMenuBtn" onclick="toggleAddMenu()" class="w-12 h-12 border-2 border-black rounded-xl text-3xl font-black text-black hover:bg-gray-50 transition-colors flex items-center justify-center leading-none">
              <span class="inline-block translate-y-[-4px]">+</span>
            </button>
            <div id="addMenuDropup" class="hidden absolute bottom-full left-0 mb-2 bg-white border-2 border-black rounded-xl shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] overflow-hidden z-50 min-w-[160px]">
              <button type="button" id="addLaborBtn" onclick="if(!this.disabled){addFullSection('Labor/Service'); toggleAddMenu();}" class="w-full px-4 py-3 text-left text-[10px] font-black uppercase tracking-widest transition-colors border-b border-gray-200 hover:bg-orange-50 hover:text-orange-600">
                Add Labor
              </button>
              <button type="button" onclick="addFullSection(); toggleAddMenu();" class="w-full px-4 py-3 text-left text-[10px] font-black text-black uppercase tracking-widest hover:bg-orange-50 hover:text-orange-600 transition-colors border-b border-gray-200">
                Add Section
              </button>
              <button type="button" id="addExpenseBtn" onclick="if(!this.disabled){addExpenseSection(); toggleAddMenu();}" class="w-full px-4 py-3 text-left text-[10px] font-black uppercase tracking-widest transition-colors border-b border-gray-200">
                Add Expense
              </button>
              <button type="button" id="addFeeBtn" onclick="if(!this.disabled){addFeeSection(); toggleAddMenu();}" class="w-full px-4 py-3 text-left text-[10px] font-black uppercase tracking-widest transition-colors border-b border-gray-200">
                Add Fee
              </button>
              <button type="button" id="addCreditBtn" onclick="if(!this.disabled){addCreditSection(); toggleAddMenu();}" class="w-full px-4 py-3 text-left text-[10px] font-black uppercase tracking-widest transition-colors hover:bg-orange-50 hover:text-orange-600">
                Add Credit
              </button>
            </div>
          </div>
          
          <!-- Confirm Log Button (Centered/Expanded) -->
          <button id="saveButton" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white border-2 border-black font-black py-3 rounded-xl uppercase text-[10px] tracking-widest transition-all active:scale-[0.98] text-center">
            Confirm Log
          </button>
        </div>

      </div> <!-- End review-container -->
      </div> <!-- End Right Column (Invoice Preview) -->

    </div> <!-- End Grid Container -->
  </div> <!-- End Max-Width Container -->

  <div id="errorToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
    <div class="bg-white text-black px-6 py-4 rounded-xl shadow-2xl border-2 border-red-500 flex items-center gap-4">
      <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
      <span id="errorMessage" class="text-xs font-bold uppercase tracking-widest">Error Message</span>
    </div>
  </div>

</div>

<script>
  function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    const newHeight = el.scrollHeight;
    const maxHeight = parseInt(window.getComputedStyle(el).maxHeight) || 800;
    
    if (newHeight >= maxHeight) {
      el.style.height = maxHeight + 'px';
      el.style.overflowY = 'auto';
    } else {
      el.style.height = newHeight + 'px';
      el.style.overflowY = 'hidden';
    }
  }

  function resizeInput(el) {
    if (!el) return;
    const style = window.getComputedStyle(el);
    const span = document.getElementById('widthMeasureSpan') || document.createElement('span');
    if (!span.id) {
        span.id = 'widthMeasureSpan';
        span.style.visibility = 'hidden';
        span.style.position = 'absolute';
        span.style.whiteSpace = 'pre';
        document.body.appendChild(span);
    }
    span.style.font = style.font;
    span.style.fontSize = style.fontSize;
    span.style.fontWeight = style.fontWeight;
    span.style.letterSpacing = style.letterSpacing;
    span.textContent = el.value || el.placeholder || "";
    // Buffer for padding/cursor
    el.style.width = Math.max(40, span.offsetWidth + 12) + 'px';
  }

  function cleanNum(val) {
    if (val === null || val === undefined || val === "") return "";
    let f = parseFloat(val);
    if (isNaN(f)) return val;
    return (f % 1 === 0) ? f.toString() : f.toFixed(2).replace(/\.?0+$/, "");
  }

  function formatMoney(amount) {
    const code = typeof activeCurrencyCode !== 'undefined' ? activeCurrencyCode : "USD";
    const currency = (typeof CURRENCIES !== 'undefined' ? CURRENCIES : []).find(c => c.c === code);
    const sym = currency ? currency.s : "$";
    const pos = currency ? (currency.p || 'pre') : 'pre';
    // Always show 2 decimal places for money
    const num = parseFloat(amount) || 0;
    const val = num.toFixed(2);
    return pos === 'suf' ? `${val} ${sym}` : `${sym}${val}`;
  }

  window.toggleGlobalDiscountPanel = function() {
    const panel = document.getElementById('discountInputsPanel');
    const btn = document.getElementById('discountToggleBtn');
    const isHidden = panel.classList.contains('hidden');
    
    if (isHidden) {
      panel.classList.remove('hidden');
      btn.classList.remove('border-gray-300', 'text-gray-500');
      btn.classList.add('border-green-500', 'bg-green-50', 'text-green-600');
    } else {
      panel.classList.add('hidden');
      // Only reset button if no values entered
      const flat = parseFloat(document.getElementById('globalDiscountFlat')?.value) || 0;
      const pct = parseFloat(document.getElementById('globalDiscountPercent')?.value) || 0;
      if (flat === 0 && pct === 0) {
        btn.classList.add('border-gray-300', 'text-gray-500');
        btn.classList.remove('border-green-500', 'bg-green-50', 'text-green-600');
      }
    }
  }

  window.toggleCreditPopover = function() {
      const popover = document.getElementById('creditPopover');
      popover.classList.toggle('hidden');
  }

  function updateTotalsSummary() {
    let subtotal = 0;
    let totalTax = 0;
    
    // Profile settings
    const discountTaxRule = "<%= @profile.discount_tax_rule.presence || 'post_tax' %>";
    
    // Calculate Labor contribution
    const laborBox = document.getElementById('laborBox');
    if (laborBox) {
      const billingMode = laborBox.dataset.billingMode || 'hourly';
      const timeVal = parseFloat(document.getElementById('editTime')?.value) || 0;
      const hourlyRateInput = document.getElementById('editHourlyRate');
      const rateVal = (hourlyRateInput && hourlyRateInput.value) ? parseFloat(hourlyRateInput.value) : (parseFloat(laborBox.dataset.hourlyRate) || profileHourlyRate || 0);
      
      let laborAmount = 0;
      if (billingMode === 'fixed') {
        laborAmount = timeVal;
      } else {
        laborAmount = timeVal * rateVal;
      }
      
      // Apply labor discount
      const lDiscFlat = parseFloat(laborBox.querySelector('.discount-flat-input')?.value) || 0;
      const lDiscPercent = parseFloat(laborBox.querySelector('.discount-percent-input')?.value) || 0;
      laborAmount -= lDiscFlat;
      laborAmount -= laborAmount * (lDiscPercent / 100);
      laborAmount = Math.max(0, laborAmount);
      
      subtotal += laborAmount;
      
      // Labor tax
      if (laborBox.dataset.taxable === 'true') {
        const laborTaxRate = parseFloat(laborBox.querySelector('.tax-menu-input')?.value) || parseFloat(defaultGlobalTaxRate) || 0;
        totalTax += laborAmount * (laborTaxRate / 100);
      }
    }
    
    // Calculate all dynamic items (use .item-row, not .item-container)
    document.querySelectorAll('.dynamic-section .item-row').forEach(item => {
      const priceVal = parseFloat(item.querySelector('.price-menu-input')?.value) || 0;
      const qtyInput = item.querySelector('.qty-input');
      const qtyVal = qtyInput ? (parseFloat(qtyInput.value) || 1) : (parseFloat(item.dataset.qty) || 1);
      let itemAmount = priceVal * qtyVal;
      
      // Apply item discount
      const discFlat = parseFloat(item.querySelector('.discount-flat-input')?.value) || 0;
      const discPercent = parseFloat(item.querySelector('.discount-percent-input')?.value) || 0;
      itemAmount -= discFlat;
      itemAmount -= itemAmount * (discPercent / 100);
      itemAmount = Math.max(0, itemAmount);
      
      subtotal += itemAmount;
      
      // Item tax
      if (item.dataset.taxable === 'true') {
        const itemTaxRate = parseFloat(item.querySelector('.tax-menu-input')?.value) || parseFloat(defaultGlobalTaxRate) || 0;
        totalTax += itemAmount * (itemTaxRate / 100);
      }
    });
    
    // Global Discount
    const gDiscFlat = parseFloat(document.getElementById('globalDiscountFlat')?.value) || 0;
    const gDiscPercent = parseFloat(document.getElementById('globalDiscountPercent')?.value) || 0;
    
    let globalDiscount = 0;
    let taxAfterDiscount = totalTax;
    
    if (discountTaxRule === 'pre_tax') {
      // PRE-TAX: Discount applied to subtotal, then tax calculated on discounted amount
      globalDiscount = gDiscFlat + (subtotal * (gDiscPercent / 100));
      if (globalDiscount > subtotal) globalDiscount = subtotal;
      const discountedSubtotal = Math.max(0, subtotal - globalDiscount);
      // Recalculate tax on discounted subtotal (simplified - applies global tax rate)
      // For true PRE-TAX, we'd need to recalculate per-item, but this is a reasonable approximation
      taxAfterDiscount = (discountedSubtotal / subtotal) * totalTax || 0;
    } else {
      // POST-TAX: Discount applied after tax (default behavior)
      globalDiscount = gDiscFlat + (subtotal * (gDiscPercent / 100));
    }
    
    // Calculate combined discount (all item discounts + labor discount + global discount)
    let combinedDiscount = globalDiscount;
    
    // Add labor discount
    if (laborBox) {
      const lDiscFlat = parseFloat(laborBox.querySelector('.discount-flat-input')?.value) || 0;
      const lDiscPercent = parseFloat(laborBox.querySelector('.discount-percent-input')?.value) || 0;
      const timeVal = parseFloat(document.getElementById('editTime')?.value) || 0;
      const rateVal = parseFloat(document.getElementById('editHourlyRate')?.value) || profileHourlyRate || 0;
      const billingMode = laborBox.dataset.billingMode || 'hourly';
      const laborBase = billingMode === 'fixed' ? timeVal : timeVal * rateVal;
      const laborDiscAmount = lDiscFlat + (laborBase * lDiscPercent / 100);
      combinedDiscount += Math.min(laborDiscAmount, laborBase);
    }
    
    // Add all item discounts
    document.querySelectorAll('.dynamic-section .item-row').forEach(item => {
      const priceVal = parseFloat(item.querySelector('.price-menu-input')?.value) || 0;
      const qtyVal = parseFloat(item.querySelector('.qty-input')?.value) || parseFloat(item.dataset.qty) || 1;
      const itemBase = priceVal * qtyVal;
      const discFlat = parseFloat(item.querySelector('.discount-flat-input')?.value) || 0;
      const discPercent = parseFloat(item.querySelector('.discount-percent-input')?.value) || 0;
      const itemDiscAmount = discFlat + (itemBase * discPercent / 100);
      combinedDiscount += Math.min(itemDiscAmount, itemBase);
    });
    
    const preDiscountTotal = subtotal + (discountTaxRule === 'pre_tax' ? taxAfterDiscount : totalTax);
    
    // Credit (always applied last, can make total negative)
    let creditFlat = parseFloat(document.getElementById('creditFlatInput')?.value) || 0;
    
    let grandTotal = preDiscountTotal - globalDiscount - creditFlat;
    
    // Update Discount Row visibility and value
    const discountRow = document.getElementById('discountRow');
    const discountTotalEl = document.getElementById('summaryDiscountTotal');
    const discountToggleBtn = document.getElementById('discountToggleBtn');
    
    if (combinedDiscount > 0) {
      discountRow.classList.remove('hidden');
      discountRow.classList.add('flex');
      discountTotalEl.innerText = `-${formatMoney(combinedDiscount)}`;
      
      // Update toggle button to active state if global inputs have values
      if (gDiscFlat > 0 || gDiscPercent > 0) {
        discountToggleBtn.classList.remove('border-gray-300', 'text-gray-500');
        discountToggleBtn.classList.add('border-green-500', 'bg-green-50', 'text-green-600');
      }
    } else {
      discountRow.classList.add('hidden');
      discountRow.classList.remove('flex');
      
      // Reset toggle button if no global discount
      if (gDiscFlat === 0 && gDiscPercent === 0) {
        discountToggleBtn.classList.add('border-gray-300', 'text-gray-500');
        discountToggleBtn.classList.remove('border-green-500', 'bg-green-50', 'text-green-600');
      }
    }
    
    // Update Credit Pill Styling
    const summaryCreditEl = document.getElementById('summaryCredit');
    const creditPill = document.getElementById('creditPill');
    
    // Only show as "active" if there's actual credit value (not 0)
    if (creditFlat > 0) {
        summaryCreditEl.innerText = `-${formatMoney(creditFlat)}`;
        summaryCreditEl.classList.remove('text-gray-400');
        summaryCreditEl.classList.add('text-red-500');
        creditPill.classList.add('border-red-200', 'bg-red-50');
    } else {
        summaryCreditEl.innerText = 'Add Credit';
        summaryCreditEl.classList.add('text-gray-400');
        summaryCreditEl.classList.remove('text-red-500');
        creditPill.classList.remove('border-red-200', 'bg-red-50');
    }
    
    // Update display with currency aware formatting
    document.getElementById('summarySubtotal').innerText = formatMoney(subtotal);
    document.getElementById('summaryTax').innerText = formatMoney(discountTaxRule === 'pre_tax' ? taxAfterDiscount : totalTax);
    document.getElementById('summaryTotal').innerText = formatMoney(grandTotal);
  }

  // Global Tax Variables
  let currentLogTaxScope = "<%= @profile.tax_scope %>";
  const defaultGlobalTaxRate = "<%= @profile.tax_rate.presence || 0 %>";
  const profileBillingMode = "<%= @profile.billing_mode %>";
  const profileHourlyRate = <%= @profile.hourly_rate.to_f %>;
  
  // Inject Currency Data (Defined in ApplicationHelper)
  const CURRENCIES = <%= currencies_data.to_json.html_safe %>;
  // Initialize with profile default
  let activeCurrencyCode = "<%= @profile.currency.presence || 'USD' %>";
  let activeCurrencySymbol = CURRENCIES.find(c => c.c === activeCurrencyCode)?.s || "$";

document.addEventListener("DOMContentLoaded", () => {
  const recordBtn = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const transcriptArea = document.getElementById("mainTranscript");
  const reParseBtn = document.getElementById("reParseBtn");
  const micIcon = document.getElementById("micIcon");

  // Initialize transcript with proper overflow state
  if (transcriptArea) {
    transcriptArea.style.overflowY = 'hidden';
    autoResize(transcriptArea);
  }

  // Initial resize for time input
  const editTimeInput = document.getElementById('editTime');
  if (editTimeInput) resizeInput(editTimeInput);

  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let recordingStartTime = 0;


  // Close menus when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.item-menu-container')) {
      document.querySelectorAll('.item-menu-dropdown.show').forEach(d => {
        d.classList.remove('show');
        const btn = d.previousElementSibling;
        if (btn) {
          btn.classList.remove('active');
          randomizeIcon(btn);
        }
        
        const container = d.closest('.border-2.rounded-xl');
        if (container) {
          container.style.borderBottomLeftRadius = '';
          container.style.borderBottomRightRadius = '';
        }
      });
    }
  });
  
  // Initial randomization for Labor Box
  const laborIconContainer = document.querySelector('#laborBox .item-menu-btn');
  if (laborIconContainer) randomizeIcon(laborIconContainer);

  recordBtn.onclick = async () => {
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = processAudio;
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        isRecording = true;
        buttonText.innerText = "STOP";
        recordBtn.classList.add("recording");
        document.getElementById("recordingWave").classList.remove("hidden");
        document.getElementById("status").innerText = "RECORDING...";
        document.getElementById("status").classList.replace("text-orange-600", "text-red-600");
        document.getElementById("status").classList.replace("bg-orange-50", "bg-red-50");
      } catch (e) {
        showError("Microphone access required.");
      }
    } else {
      const duration = Date.now() - recordingStartTime;
      if (duration < 1000) {
        mediaRecorder.onstop = null;
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        resetRecorderUI();
        showError("Hold longer to record");
        return; 
      }
      mediaRecorder.stop();
      isRecording = false;
      document.getElementById("status").innerText = "PROCESSING...";
      document.getElementById("recordingWave").classList.add("hidden");
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
  };

  function resetRecorderUI() {
    isRecording = false;
    buttonText.innerText = "TAP TO RECORD";
    recordBtn.classList.remove("recording");
    document.getElementById("status").innerText = "READY";
    document.getElementById("status").classList.replace("text-red-600", "text-orange-600");
    document.getElementById("status").classList.replace("bg-red-50", "bg-orange-50");
    document.getElementById("recordingWave").classList.add("hidden");
  }

  async function processAudio() {
    const transcriptCont = document.getElementById('transcriptContainer');
    const reviewCont = document.getElementById('reviewContainer');
    const overlay = document.getElementById('analyzingOverlay');
    
    transcriptCont.classList.add('analyzing');
    reviewCont.classList.add('analyzing');
    overlay.classList.add('active');
    
    try {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("audio", audioBlob);

      const res = await fetch("/process_audio", {
        method: "POST",
        headers: { "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content },
        body: formData
      });

      const data = await res.json();
      transcriptCont.classList.remove('analyzing');
      reviewCont.classList.remove('analyzing');
      overlay.classList.remove('active');
      resetRecorderUI();
      if (!res.ok || data.error) showError(data.error || "Speech not recognized.");
      else updateUI(data);
    } catch (e) {
      transcriptCont.classList.remove('analyzing');
      reviewCont.classList.remove('analyzing');
      overlay.classList.remove('active');
      resetRecorderUI();
      showError("Network error.");
    }
  }

  reParseBtn.onclick = async () => {
    const text = transcriptArea.value;
    if (!text) return;
    
    // Add analyzing animation to both containers
    const transcriptCont = document.getElementById('transcriptContainer');
    const reviewCont = document.getElementById('reviewContainer');
    const overlay = document.getElementById('analyzingOverlay');
    
    transcriptCont.classList.add('analyzing');
    reviewCont.classList.add('analyzing');
    overlay.classList.add('active');
    
    const res = await fetch("/process_audio", {
      method: "POST",
      headers: { 
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ manual_text: text })
    });
    const data = await res.json();
    
    // Remove analyzing animation
    transcriptCont.classList.remove('analyzing');
    reviewCont.classList.remove('analyzing');
    overlay.classList.remove('active');
    
    if (data.error) showError(data.error);
    else updateUI(data);
  };

  document.getElementById("saveButton").onclick = async function() {
    const saveBtn = this;
    const client = document.getElementById("editClient").value;
    const time = document.getElementById("editTime").value;
    const date = document.getElementById("dateDisplay").innerText;

    const sections = [];
    document.querySelectorAll(".dynamic-section").forEach(sec => {
      const title = sec.querySelector(".section-title").value;
      const items = [];
      sec.querySelectorAll(".item-row").forEach(row => {
        const desc = row.querySelector(".item-input").value;
        const price = row.querySelector(".price-menu-input").value;
        const taxRate = row.querySelector(".tax-menu-input").value;
        const taxable = row.dataset.taxable === "true";
        
        // Discounts
        const discFlat = row.querySelector(".discount-flat-input").value;
        const discPercent = row.querySelector(".discount-percent-input").value;
        
        if (desc.trim() !== "") {
          items.push({ 
            desc: desc, 
            price: price, 
            taxable: taxable,
            tax_rate: (taxable && taxRate) ? taxRate : null,
            discount_flat: discFlat,
            discount_percent: discPercent
          });
        }
      });
      if (items.length > 0) sections.push({ title, items });
    });

    const laborDiscFlat = document.querySelector('#laborBox .discount-flat-input')?.value || "";
    const laborDiscPercent = document.querySelector('#laborBox .discount-percent-input')?.value || "";
    const globalDiscFlat = document.getElementById('globalDiscountFlat')?.value || "";
    const globalDiscPercent = document.getElementById('globalDiscountPercent')?.value || "";
    
    // Credit amount (from popover only) and reasons (from section items)
    let totalCredit = parseFloat(document.getElementById('creditFlatInput')?.value) || 0;
    let creditReasons = [];
    document.querySelectorAll('.credit-item-row').forEach(item => {
      const reason = item.querySelector('.credit-reason-input')?.value?.trim() || "";
      if (reason) creditReasons.push(reason);
    });

    const res = await fetch("/logs", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content 
      },
      body: JSON.stringify({
        log: { 
          client: client, 
          time: time, 
          date: date, 
          due_date: document.getElementById("dueDateValue").innerText,
          tasks: JSON.stringify(sections),
          tax_scope: currentLogTaxScope,
          labor_taxable: document.getElementById('laborBox').dataset.taxable === "true",
          labor_discount_flat: laborDiscFlat,
          labor_discount_percent: laborDiscPercent,
          global_discount_flat: globalDiscFlat,
          global_discount_percent: globalDiscPercent,
          credit_flat: totalCredit > 0 ? totalCredit.toString() : "",
          credit_reason: creditReasons.join(", "),
          currency: activeCurrencyCode,
          hourly_rate: document.getElementById("editHourlyRate")?.value || ""
        }
      })
    });

    const result = await res.json();
    if (result.success) {
      saveBtn.innerText = "SAVED";
      saveBtn.classList.replace("bg-orange-600", "bg-green-600");
      saveBtn.classList.replace("border-black", "border-green-800");
      setTimeout(() => { window.location.href = "/history"; }, 600);
    } else {
      showError("Error saving log.");
    }
  };

  // Hydrate initial static items if any
  document.querySelectorAll('.item-row').forEach(row => {
    randomizeIcon(row);
    updateBadge(row);
    updateHamburgerGlow(row);
  });
  
  // Initialize default due date (14 days)
  updateDueDate(null, null);
});

function updateDueDate(dueDays, dueDate) {
  const dueDateValue = document.getElementById('dueDateValue');
  const dueDaysLabel = document.getElementById('dueDaysLabel');
  
  let targetDate;
  let daysUntil;
  
  if (dueDate) {
    // Explicit date provided
    targetDate = new Date(dueDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    targetDate.setHours(0, 0, 0, 0);
    daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
  } else {
    // Use days (default to 14 if not provided)
    daysUntil = dueDays !== null && dueDays !== undefined ? parseInt(dueDays) : 14;
    targetDate = new Date();
    targetDate.setDate(targetDate.getDate() + daysUntil);
  }
  
  // Format the date
  const formattedDate = targetDate.toLocaleDateString('en-US', { 
    day: 'numeric', 
    month: 'short', 
    year: 'numeric' 
  });
  
  dueDateValue.innerText = formattedDate;
  
  // Format the days label
  if (daysUntil === 0) {
    dueDaysLabel.innerText = '(due today)';
  } else if (daysUntil === 1) {
    dueDaysLabel.innerText = '(in 1 day)';
  } else if (daysUntil < 0) {
    dueDaysLabel.innerText = `(${Math.abs(daysUntil)} days overdue)`;
    dueDaysLabel.classList.add('text-red-500');
    dueDaysLabel.classList.remove('text-gray-400');
  } else {
    dueDaysLabel.innerText = `(in ${daysUntil} days)`;
    dueDaysLabel.classList.remove('text-red-500');
    dueDaysLabel.classList.add('text-gray-400');
  }
  
  // Store the selected date for calendar
  window.selectedDueDate = targetDate;
}

// Calendar State
let calendarViewDate = new Date();

function toggleCalendar() {
  const popup = document.getElementById('calendarPopup');
  const isHidden = popup.classList.contains('hidden');
  
  if (isHidden) {
    // Initialize calendar to selected date or today
    calendarViewDate = window.selectedDueDate ? new Date(window.selectedDueDate) : new Date();
    renderCalendar();
    popup.classList.remove('hidden');
  } else {
    popup.classList.add('hidden');
  }
}

// Close calendars when clicking outside
document.addEventListener('click', (e) => {
  // Due Date Calendar
  const popup = document.getElementById('calendarPopup');
  const calendarBtn = e.target.closest('button[onclick="toggleCalendar()"]');
  if (popup && !popup.contains(e.target) && !calendarBtn) {
    popup.classList.add('hidden');
  }

  // Main Date Calendar
  const mainPopup = document.getElementById('mainCalendarPopup');
  const mainCalendarBtn = e.target.closest('button[onclick="toggleMainCalendar()"]');
  if (mainPopup && !mainPopup.contains(e.target) && !mainCalendarBtn) {
    mainPopup.classList.add('hidden');
  }
});

function changeCalendarMonth(delta) {
  calendarViewDate.setMonth(calendarViewDate.getMonth() + delta);
  renderCalendar();
}

function renderCalendar() {
  const monthYear = document.getElementById('calendarMonthYear');
  const daysContainer = document.getElementById('calendarDays');
  
  const year = calendarViewDate.getFullYear();
  const month = calendarViewDate.getMonth();
  
  // Update header
  monthYear.innerText = calendarViewDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  
  // Get first day of month and total days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  // Get today for highlighting
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Get selected date for highlighting
  const selected = window.selectedDueDate ? new Date(window.selectedDueDate) : null;
  if (selected) selected.setHours(0, 0, 0, 0);
  
  let html = '';
  
  // Empty cells for days before first day of month
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="w-8 h-8"></div>';
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    date.setHours(0, 0, 0, 0);
    
    const isToday = date.getTime() === today.getTime();
    const isSelected = selected && date.getTime() === selected.getTime();
    const isPast = date < today;
    
    let classes = 'w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center cursor-pointer transition-colors ';
    
    if (isSelected) {
      classes += 'bg-orange-600 text-white border-2 border-black';
    } else if (isToday) {
      classes += 'border-2 border-orange-600 text-orange-600 hover:bg-orange-50';
    } else if (isPast) {
      classes += 'text-gray-300 cursor-not-allowed';
    } else {
      classes += 'hover:bg-orange-50 hover:text-orange-600 border border-transparent';
    }
    
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const onclick = isPast ? '' : `onclick="selectCalendarDate('${dateStr}')"`;
    
    html += `<div class="${classes}" ${onclick}>${day}</div>`;
  }
  
  daysContainer.innerHTML = html;
}

function selectCalendarDate(dateStr) {
  const parts = dateStr.split('-');
  const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  
  // Calculate days until
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  selectedDate.setHours(0, 0, 0, 0);
  const daysUntil = Math.ceil((selectedDate - today) / (1000 * 60 * 60 * 24));
  
  updateDueDate(daysUntil, null);
  toggleCalendar();
}

function setQuickDue(days) {
  updateDueDate(days, null);
  toggleCalendar();
}

// Main Date Calendar State
let mainCalendarViewDate = new Date();
window.selectedMainDate = new Date(); // Default to today

function toggleMainCalendar() {
  const popup = document.getElementById('mainCalendarPopup');
  const isHidden = popup.classList.contains('hidden');
  
  if (isHidden) {
    mainCalendarViewDate = new Date(window.selectedMainDate);
    renderMainCalendar();
    popup.classList.remove('hidden');
  } else {
    popup.classList.add('hidden');
  }
}

function changeMainCalendarMonth(delta) {
  mainCalendarViewDate.setMonth(mainCalendarViewDate.getMonth() + delta);
  renderMainCalendar();
}

function renderMainCalendar() {
  const monthYear = document.getElementById('mainCalendarMonthYear');
  const daysContainer = document.getElementById('mainCalendarDays');
  
  const year = mainCalendarViewDate.getFullYear();
  const month = mainCalendarViewDate.getMonth();
  
  monthYear.innerText = mainCalendarViewDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const selected = new Date(window.selectedMainDate);
  selected.setHours(0, 0, 0, 0);
  
  let html = '';
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="w-8 h-8"></div>';
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    date.setHours(0, 0, 0, 0);
    
    const isToday = date.getTime() === today.getTime();
    const isSelected = date.getTime() === selected.getTime();
    
    let classes = 'w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center cursor-pointer transition-colors ';
    
    if (isSelected) {
      classes += 'bg-orange-600 text-white border-2 border-black';
    } else if (isToday) {
      classes += 'border-2 border-orange-600 text-orange-600 hover:bg-orange-50';
    } else {
      classes += 'hover:bg-orange-50 hover:text-orange-600 border border-transparent';
    }
    
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    html += `<div class="${classes}" onclick="selectMainCalendarDate('${dateStr}')">${day}</div>`;
  }
  
  daysContainer.innerHTML = html;
}

function selectMainCalendarDate(dateStr) {
  const parts = dateStr.split('-');
  const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  window.selectedMainDate = selectedDate;
  
  document.getElementById('dateDisplay').innerText = selectedDate.toLocaleDateString('en-US', { 
    month: 'short', day: 'numeric', year: 'numeric' 
  });
  
  toggleMainCalendar();
}

function addFullSection(title = "New Category", items = []) {
  const container = document.getElementById("dynamicSections");
  const sectionId = "section_" + Date.now() + Math.random().toString(36).substr(2, 5);
  
  // Check if this is a protected category (can't be renamed)
  const lowerTitle = title.toLowerCase();
  const isLaborService = /labor|service/.test(lowerTitle);
  const isMaterials = /material/.test(lowerTitle);
  const isExpenses = /expense/.test(lowerTitle);
  const isFees = /fee/.test(lowerTitle);
  const isProtected = isLaborService || isMaterials || isExpenses || isFees;
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  if (isLaborService) sectionDiv.dataset.protected = "labor";
  else if (isMaterials) sectionDiv.dataset.protected = "materials";
  else if (isExpenses) sectionDiv.dataset.protected = "expenses";
  else if (isFees) sectionDiv.dataset.protected = "fees";
  
  // Icons for sections
  let sectionIcon = "";
  if (isLaborService) {
     sectionIcon = `<svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></svg>`;
  } else if (isMaterials) {
     sectionIcon = `<svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>`;
  } else if (isExpenses) {
     sectionIcon = `<svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`;
  } else if (isFees) {
     sectionIcon = `<svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 011 12V7a4 4 0 014-4z" /></svg>`;
  } else {
     // Default Tasks Icon (Clipboard)
     sectionIcon = `<svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>`;
  }

  // Labor/Service section: non-removable, non-renamable
  // Materials/Expenses/Fees: removable, non-renamable
  // Custom: removable, renamable
  const titleElement = isProtected 
    ? `<div class="flex items-center">${sectionIcon}<span class="text-base font-black text-orange-600 uppercase tracking-widest section-title">${title}</span></div>`
    : `<div class="flex items-center w-2/3">${sectionIcon}<input type="text" value="${title}" class="bg-transparent border-none p-0 text-sm font-black text-orange-600 uppercase tracking-widest focus:ring-0 w-full section-title" onblur="validateCategoryName(this)"></div>`;
  
  const removeButton = `
        <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
          Remove
        </button>`;
  
  const addItemBtn = `<button type="button" onclick="addItem('${sectionId}', '', '', false, '${title}')" 
              class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
         + Item
       </button>`;
  
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      ${titleElement}
      <div class="flex gap-2 mb-1 shrink-0">
        ${addItemBtn}
        ${removeButton}
      </div>
    </div>
    <div id="${sectionId}" class="pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  
  // If no items provided, add an empty item automatically
  if (items.length === 0) {
      addItem(sectionId, "", "", false, title);
  } else {
    items.forEach(item => {
      if (!item) return;

      let val = "";
      let price = "";
      let taxable = null;
      let taxRate = null;
      let discFlat = "";
      let discPercent = "";
      
      if (typeof item === 'object') {
        val = item.desc || "";
        if (item.qty && item.qty !== '1' && item.qty !== 'N/A') {
          val += ` (x${item.qty})`;
        }
        price = item.price || "";
        if (item.taxable !== undefined && item.taxable !== null) {
          taxable = item.taxable;
        }
        if (item.tax_rate) {
            taxRate = item.tax_rate;
        }
        discFlat = item.discount_flat || "";
        discPercent = item.discount_percent || "";
      } else {
        val = item;
      }
      
      addItem(sectionId, val, price, taxable, title, taxRate, (item.qty && item.qty !== 'N/A') ? item.qty : 1, discFlat, discPercent);
    });
  }
}

// Validate category names - prevent reserved words
function validateCategoryName(input) {
  const reserved = ['fee', 'fees', 'expense', 'expenses', 'material', 'materials', 'labor', 'labour', 'service', 'services'];
  const val = input.value.toLowerCase().trim();
  
  if (reserved.some(r => val === r || val === r + 's' || val.includes('labor/service'))) {
    alert(`"${input.value}" is a reserved category name. Please choose a different name.`);
    input.value = "Custom";
    input.focus();
  }
}


function toggleAddMenu() {
  const dropup = document.getElementById('addMenuDropup');
  const isOpening = dropup.classList.contains('hidden');
  
  if (isOpening) {
    // Check if Labor/Expenses/Fees/Credit sections already exist
    const hasLabor = document.querySelector('.dynamic-section[data-protected="labor"]');
    const hasExpenses = document.querySelector('.dynamic-section[data-protected="expenses"]');
    const hasFees = document.querySelector('.dynamic-section[data-protected="fees"]');
    const hasCredit = document.querySelector('.dynamic-section[data-protected="credit"]');
    
    const laborBtn = document.getElementById('addLaborBtn');
    const expenseBtn = document.getElementById('addExpenseBtn');
    const feeBtn = document.getElementById('addFeeBtn');
    const creditBtn = document.getElementById('addCreditBtn');
    
    if (hasLabor) {
      laborBtn.disabled = true;
      laborBtn.classList.add('text-gray-300', 'cursor-not-allowed');
      laborBtn.classList.remove('hover:bg-orange-50', 'hover:text-orange-600');
    } else {
      laborBtn.disabled = false;
      laborBtn.classList.remove('text-gray-300', 'cursor-not-allowed');
      laborBtn.classList.add('hover:bg-orange-50', 'hover:text-orange-600');
    }
    
    if (hasExpenses) {
      expenseBtn.disabled = true;
      expenseBtn.classList.add('text-gray-300', 'cursor-not-allowed');
      expenseBtn.classList.remove('text-black', 'hover:bg-orange-50', 'hover:text-orange-600');
    } else {
      expenseBtn.disabled = false;
      expenseBtn.classList.remove('text-gray-300', 'cursor-not-allowed');
      expenseBtn.classList.add('text-black', 'hover:bg-orange-50', 'hover:text-orange-600');
    }
    
    if (hasFees) {
      feeBtn.disabled = true;
      feeBtn.classList.add('text-gray-300', 'cursor-not-allowed');
      feeBtn.classList.remove('text-black', 'hover:bg-orange-50', 'hover:text-orange-600');
    } else {
      feeBtn.disabled = false;
      feeBtn.classList.remove('text-gray-300', 'cursor-not-allowed');
      feeBtn.classList.add('text-black', 'hover:bg-orange-50', 'hover:text-orange-600');
    }
    
    if (hasCredit) {
      creditBtn.disabled = true;
      creditBtn.classList.add('text-gray-300', 'cursor-not-allowed');
      creditBtn.classList.remove('text-black', 'hover:bg-orange-50', 'hover:text-orange-600');
    } else {
      creditBtn.disabled = false;
      creditBtn.classList.remove('text-gray-300', 'cursor-not-allowed');
      creditBtn.classList.add('text-black', 'hover:bg-orange-50', 'hover:text-orange-600');
    }
  }
  
  dropup.classList.toggle('hidden');
}

// Close add menu when clicking outside
document.addEventListener('click', (e) => {
  const dropup = document.getElementById('addMenuDropup');
  const btn = document.getElementById('addMenuBtn');
  if (dropup && btn && !dropup.contains(e.target) && !btn.contains(e.target)) {
    dropup.classList.add('hidden');
  }
});

function addExpenseSection() {
  const container = document.getElementById("dynamicSections");
  const sectionId = "expense_" + Date.now() + Math.random().toString(36).substr(2, 5);
  const currencySymbol = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  sectionDiv.dataset.protected = "expenses";
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      <div class="flex items-center">
        <svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
        <span class="text-base font-black text-orange-600 uppercase tracking-widest section-title">Expenses</span>
      </div>
      <div class="flex gap-2 mb-1 shrink-0">
        <button type="button" onclick="addItem('${sectionId}')" 
                class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
          + Item
        </button>
        <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
          Remove
        </button>
      </div>
    </div>
    <div id="${sectionId}" class="pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  
  // Add a single empty expense item
  addItem(sectionId, "", "", false, "Expenses", null, 1, "", "");
}

function addFeeSection() {
  const container = document.getElementById("dynamicSections");
  const sectionId = "fee_" + Date.now() + Math.random().toString(36).substr(2, 5);
  const currencySymbol = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  sectionDiv.dataset.protected = "fees";
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      <div class="flex items-center">
        <svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 011 12V7a4 4 0 014-4z" /></svg>
        <span class="text-base font-black text-orange-600 uppercase tracking-widest section-title">Fees</span>
      </div>
      <div class="flex gap-2 mb-1 shrink-0">
        <button type="button" onclick="addItem('${sectionId}')" 
                class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
          + Item
        </button>
        <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
          Remove
        </button>
      </div>
    </div>
    <div id="${sectionId}" class="pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  
  // Add a single empty fee item
  addItem(sectionId, "", "", false, "Fees", null, 1, "", "");
}

function addCreditSection() {
  const container = document.getElementById("dynamicSections");
  const sectionId = "credit_" + Date.now() + Math.random().toString(36).substr(2, 5);
  const currencySymbol = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  sectionDiv.dataset.protected = "credit";
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      <div class="flex items-center">
        <svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
        <span class="text-base font-black text-orange-600 uppercase tracking-widest section-title">Credit</span>
      </div>
      <div class="flex gap-2 mb-1 shrink-0">
        <button type="button" onclick="addCreditItem('${sectionId}')" 
                class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
          + Item
        </button>
        <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
          Remove
        </button>
      </div>
    </div>
    <div id="${sectionId}" class="pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  
  // Add a single empty credit item
  addCreditItem(sectionId, "");
}

// Add Credit item - just a reason input (price is set via the global Credit popover)
function addCreditItem(containerId, reason = "") {
  const div = document.createElement('div');
  div.className = "flex items-center gap-2 mb-4 w-full animate-in fade-in slide-in-from-left-2 duration-300 credit-item-row";
  
  div.innerHTML = `
    <div class="flex flex-1 items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] min-w-0 main-item-box transition-colors relative">
      <input type="text" value="${reason}" class="flex-1 bg-transparent border-none text-sm font-bold text-black focus:ring-0 py-3 px-4 credit-reason-input placeholder:text-gray-300 min-w-0 rounded-xl"
             placeholder="Credit reason...">
    </div>
    
    <button type="button" 
            onclick="this.parentElement.remove();" 
            class="w-6 h-10 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors font-bold text-xl flex-shrink-0">
      ×
    </button>
  `;
  
  const container = document.getElementById(containerId);
  if (container) {
    container.appendChild(div);
  } else {
    console.error("Credit container not found: " + containerId);
  }
}

function randomizeIcon(container) {
  const heads = container.querySelectorAll('path[class^="slider-head-"]');
  heads.forEach(h => {
      const rand = (Math.random() * 14) - 7;
      h.style.transform = `translateX(${rand}px)`;
  });
}

function toggleMenu(btn) {
  const dropdown = btn.nextElementSibling;
  const isShow = dropdown.classList.contains('show');
  
  // Close all others and reset their container corners
  document.querySelectorAll('.item-menu-dropdown.show').forEach(d => {
      // Don't close the one we just clicked (toggle logic handles it)
      if (d === dropdown) return;

      d.classList.remove('show');
      // Remove active class from buttons
      const otherBtn = d.previousElementSibling;
      if (otherBtn) {
          otherBtn.classList.remove('active');
          randomizeIcon(otherBtn);
      }
      
      // Reset corners of their containers
      const container = d.closest('.border-2.rounded-xl');
      if (container) {
          container.style.borderBottomLeftRadius = '';
          container.style.borderBottomRightRadius = '';
      }
  });
  
  if (!isShow) {
    dropdown.classList.add('show');
    btn.classList.add('active');
    
    // Rerandomize on click for extra dynamic feel
    randomizeIcon(btn);
    
    const laborBox = document.getElementById('laborBox');
    const isLaborBox = btn.closest('#laborBox');
    const container = btn.closest('.border-2.rounded-xl');
    
    // Desktop width synchronization logic
    const isDesktop = window.innerWidth >= 768;
    const laborInputRow = laborBox.querySelector('.flex.items-center.border-2');
    const masterWidth = laborInputRow ? laborInputRow.offsetWidth : 0;
    const iconWidth = 40; // The h-10 w-10 icon container
    const inputAreaWidth = masterWidth - iconWidth;
    const targetWidth = (inputAreaWidth / 2) + iconWidth;

    if (isDesktop) {
        // Apply synchronized half-width logic to BOTH Labor and Items
        dropdown.style.width = (targetWidth + 2) + 'px'; 
        container.style.borderBottomLeftRadius = '0';
        // Only square off right corner if it's full width (it isn't on desktop anymore)
        container.style.borderBottomRightRadius = ''; 
    } else {
        // Mobile: Maintain original Behavior
        if (isLaborBox) {
            if (container) {
                container.style.borderBottomLeftRadius = '0';
                container.style.borderBottomRightRadius = '0';
            }
            dropdown.style.width = '';
        } else {
            if (container) container.style.borderBottomLeftRadius = '0';
            dropdown.style.width = (masterWidth + 4) + 'px';
        }
    }
  } else {
    // Already open, so close it
    dropdown.classList.remove('show');
    btn.classList.remove('active');
    randomizeIcon(btn);
    
    // Reset corners
    const container = btn.closest('.border-2.rounded-xl');
    if (container) {
        container.style.borderBottomLeftRadius = '';
        container.style.borderBottomRightRadius = '';
    }
  }
}

function updateBadge(row) {
  const priceInput = row.querySelector('.price-menu-input');
  const taxInput = row.querySelector('.tax-menu-input');
  const priceBadge = row.querySelector('.badge-price');
  const taxBadge = row.querySelector('.badge-tax');
  const afterTaxBadge = row.querySelector('.badge-after-tax');
  const multiplier = row.querySelector('.badge-multiplier');
  const equals = row.querySelector('.badge-equals');
  
  if (!priceInput || !taxInput) return;

  const priceVal = parseFloat(priceInput.value) || 0;
  const taxRate = parseFloat(taxInput.value) || 0;
  const currencySymbol = row.dataset.symbol;
  const isTaxable = row.dataset.taxable === "true";
  const qtyVal = parseFloat(row.dataset.qty) || 1;
  
  // Discount Calculation & Validation
  const discFlatInput = row.querySelector('.discount-flat-input');
  const discPercentInput = row.querySelector('.discount-percent-input');
  
  let discFlat = parseFloat(discFlatInput ? discFlatInput.value : 0) || 0;
  let discPercent = parseFloat(discPercentInput ? discPercentInput.value : 0) || 0;
  
  const baseTotal = priceVal * qtyVal;
  
  // Validation: Cap Percentage at 100
  if (discPercent > 100) {
      discPercent = 100;
      discPercentInput.value = "100"; // Visual Clamp
  }
  
  // Validation: Cap Flat at BaseTotal
  if (discFlat > baseTotal) {
      discFlat = baseTotal;
      discFlatInput.value = cleanNum(baseTotal); // Visual Clamp
  }
  
  // Priority: If Percent is present, it might override or add? 
  // User said "one will say $ for flat, the other % for percentage". Usually mutually exclusive or additive.
  // Implementation plan: Additive (Flat + Percent of Base).
  // But Validation says "Discount cannot be... more than the actual price".
  
  let discountAmount = discFlat + (baseTotal * (discPercent / 100));
  
  // Final Cap on Total Discount
  if (discountAmount > baseTotal) {
      discountAmount = baseTotal;
      // If we hit this, it means the combination exceeded total. 
      // We could clamp the flat amount down? Or just clamp the result.
      // Clamping result covers it.
  }
  
  const subtotal = Math.max(0, baseTotal - discountAmount); // Pre-tax subtotal after discount



  // 1. Update Price Badge
  if (baseTotal > 0) {
    priceBadge.innerText = `${currencySymbol}${cleanNum(baseTotal)}`;
    priceBadge.classList.remove('hidden');
  } else {
    priceBadge.classList.add('hidden');
  }

  // 1.5 Update Discount Badge
  const discountBadge = row.querySelector('.badge-discount');
  if (discountAmount > 0) {
    if (discPercent > 0 && discFlat === 0) {
        // Show Percentage if only percent used
        const displayPercent = cleanNum(discPercent);
        discountBadge.innerText = `-${displayPercent}%`;
    } else {
        // Show Amount
        discountBadge.innerText = `-${currencySymbol}${cleanNum(discountAmount)}`;
    }
    discountBadge.classList.remove('hidden');
  } else {
    discountBadge.classList.add('hidden');
  }

  // 2. Update Tax Badge - Only show if taxable AND has a price
  if (isTaxable && subtotal > 0) {
    const displayRate = parseFloat(taxRate); // Strip .0
    taxBadge.innerText = `${displayRate}%`;
    taxBadge.classList.remove('hidden');
    row.querySelector('.menu-item-tax').classList.add('active');
  } else {
    taxBadge.classList.add('hidden');
    row.querySelector('.menu-item-tax').classList.toggle('active', isTaxable);
  }

  // 3. Update Equation visibility and Result Badge
  if (isTaxable && subtotal > 0) {
    const taxAmount = subtotal * (taxRate / 100);
    
    afterTaxBadge.innerText = `${currencySymbol}${cleanNum(taxAmount)}`;
    afterTaxBadge.classList.remove('hidden');
    multiplier.classList.remove('hidden');
    equals.classList.remove('hidden');
  } else {
    afterTaxBadge.classList.add('hidden');
    multiplier.classList.add('hidden');
    equals.classList.add('hidden');
  }
  
  // Update totals summary
  updateTotalsSummary();
}

function toggleTaxable(menuItem) {
  /* New Toggle Taxable Logic */
  const row = menuItem.closest('.item-row');
  const wrapper = menuItem.closest('.tax-wrapper');
  const taxInputRow = wrapper.querySelector('.tax-inputs-row');
  const taxInput = wrapper.querySelector('.tax-menu-input');
  
  const priceWrapper = row.querySelector('.price-wrapper');
  const priceInputRow = priceWrapper.querySelector('.price-inputs-row');
  const priceMenuItem = row.querySelector('.menu-item-price');
  const priceInput = row.querySelector('.price-menu-input');
  const priceLabel = priceMenuItem.querySelector('span'); 
  const priceIcon = priceMenuItem.querySelector('.menu-icon');

  // Toggle Taxable State
  let newTaxableState = false;
  if (menuItem.classList.contains('active')) {
     menuItem.classList.remove('active');
     taxInputRow.classList.add('hidden');
     taxInputRow.classList.remove('grid');
     newTaxableState = false;
  } else {
     menuItem.classList.add('active');
     taxInputRow.classList.remove('hidden');
     taxInputRow.classList.add('grid');
     if (!taxInput.value) {
        taxInput.value = defaultGlobalTaxRate;
     }

     // Auto-enable Price if not active, and populate default if empty
     if (!priceMenuItem.classList.contains('active')) {
        priceMenuItem.classList.add('active');
        priceInputRow.classList.remove('hidden'); // SHOW PRICE INPUT
        priceInputRow.classList.add('grid');
        if (!priceInput.value || parseFloat(priceInput.value) === 0) {
            priceInput.value = "10"; // Default price
        }
     }
     newTaxableState = true;
  }
  
  row.dataset.taxable = newTaxableState; // Keep dataset sync
  updateBadge(row);
  updateHamburgerGlow(row);
  
  // --- DEPENDENCY LOGIC ---
  if (newTaxableState) {
       priceLabel.style.opacity = "0.5";
       priceIcon.style.opacity = "0.5";
       priceMenuItem.style.cursor = "not-allowed";
  } else {
       const discountMenuItem = row.querySelector('.menu-item-discount');
       const isDiscountActive = discountMenuItem && discountMenuItem.classList.contains('active');
       
       if (!isDiscountActive) {
           priceLabel.style.opacity = "1";
           priceIcon.style.opacity = "1";
           priceMenuItem.style.cursor = "pointer";
       }
  }

  // If turning ON, focus the TAX input
  if (newTaxableState) {
    setTimeout(() => taxInput.focus(), 50);
  }
}

function toggleLaborTaxable(menuItem) {
  const laborBox = document.getElementById('laborBox');
  const isTaxable = laborBox.dataset.taxable === "true";
  const newTaxableState = !isTaxable;
  laborBox.dataset.taxable = newTaxableState;
  
  const wrapper = menuItem.closest('.tax-wrapper');
  const taxInputRow = wrapper.querySelector('.tax-inputs-row');
  const taxInput = wrapper.querySelector('.tax-menu-input');
  
  if (newTaxableState) {
    menuItem.classList.add('active');
    taxInputRow.classList.remove('hidden');
    taxInputRow.classList.add('grid');
    if (!taxInput.value || taxInput.value === "0") {
         // Should pull default from somewhere if needed, currently value is in HTML or user set
    }
    setTimeout(() => taxInput.focus(), 50);
  } else {
    menuItem.classList.remove('active');
    taxInputRow.classList.add('hidden');
    taxInputRow.classList.remove('grid');
  }
  
  updateLaborBadge();
  updateHamburgerGlow(laborBox);
}

function updateHamburgerGlow(container) {
  const isLabor = container.id === 'laborBox';
  const isTaxable = container.dataset.taxable === "true";
  const discountMenuItem = container.querySelector('.menu-item-discount');
  const isDiscountActive = discountMenuItem && discountMenuItem.classList.contains('active');
  
  // Disable glow if Labor value is 0 or empty
  if (isLabor) {
      const timeInput = document.getElementById('editTime');
      const val = parseFloat(timeInput.value) || 0;
      if (val === 0) {
          const sliderIcon = container.querySelector('.slider-icon');
          if (sliderIcon) {
              sliderIcon.classList.remove('text-orange-600', 'text-green-600');
              sliderIcon.classList.add('text-black');
          }
          return;
      }
  }

  let isOrange = isTaxable;
  if (!isLabor) {
    const priceActive = container.querySelector('.menu-item-price').classList.contains('active');
    if (priceActive) isOrange = true;
  }
  const sliderIcon = container.querySelector('.slider-icon');
  if (sliderIcon) {
    if (isOrange) {
      sliderIcon.classList.remove('text-black', 'text-green-600');
      sliderIcon.classList.add('text-orange-600');
    } else if (isDiscountActive) {
      sliderIcon.classList.remove('text-black', 'text-orange-600');
      sliderIcon.classList.add('text-green-600');
    } else {
      sliderIcon.classList.remove('text-orange-600', 'text-green-600');
      sliderIcon.classList.add('text-black');
    }
  }
}

function updateLaborBadge() {
  const laborBox = document.getElementById('laborBox');
  const isTaxable = laborBox.dataset.taxable === "true";
  const taxBadge = document.getElementById('laborTaxBadge');
  const timeInput = document.getElementById('editTime');
  const afterTaxDisplay = document.getElementById('laborAfterTaxDisplay');
  const value = parseFloat(timeInput.value) || 0;
  const taxInput = laborBox.querySelector('.tax-menu-input');
  let currentTaxRate = taxInput && taxInput.value ? parseFloat(taxInput.value) : (parseFloat(laborBox.dataset.taxRate) || parseFloat(defaultGlobalTaxRate));
  const discFlatInput = laborBox.querySelector('.discount-flat-input');
  const discPercentInput = laborBox.querySelector('.discount-percent-input');
  let discFlat = parseFloat(discFlatInput ? discFlatInput.value : 0) || 0;
  let discPercent = parseFloat(discPercentInput ? discPercentInput.value : 0) || 0;
  const billingMode = laborBox.dataset.billingMode || profileBillingMode;
  const hourlyRateInput = document.getElementById('editHourlyRate');
  const currentHourlyRate = (hourlyRateInput && hourlyRateInput.value) ? parseFloat(hourlyRateInput.value) : (parseFloat(laborBox.dataset.hourlyRate) || profileHourlyRate);
  const baseCost = billingMode === 'fixed' ? value : value * currentHourlyRate;
  if (discPercent > 100) { discPercent = 100; discPercentInput.value = "100"; }
  if (discFlat > baseCost && baseCost > 0) { discFlat = baseCost; discFlatInput.value = cleanNum(baseCost); }
  let discountAmount = discFlat + (baseCost * (discPercent / 100));
  if (discountAmount > baseCost) discountAmount = baseCost;
  const laborCost = Math.max(0, baseCost - discountAmount);
  const discountBadge = document.getElementById('laborDiscountBadge');
  if (discountAmount > 0) {
    const currencySym = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
    if (discPercent > 0 && discFlat === 0) {
        discountBadge.innerText = `-${cleanNum(discPercent)}%`;
    } else {
        discountBadge.innerText = `-${currencySym}${cleanNum(discountAmount)}`;
    }
    discountBadge.classList.remove('hidden');
  } else {
    discountBadge.classList.add('hidden');
  }
  if (isTaxable && laborCost > 0) {
    taxBadge.innerText = `${cleanNum(currentTaxRate)}%`;
    taxBadge.classList.remove('hidden');
  } else {
    taxBadge.classList.add('hidden');
  }
  let tax = isTaxable ? laborCost * (currentTaxRate / 100) : 0;
  const total = laborCost + tax;
  afterTaxDisplay.innerText = cleanNum(total);
  
  // Ensure icon glow updates based on value
  updateHamburgerGlow(laborBox);
  
  // Update totals summary
  updateTotalsSummary();
}


function togglePrice(menuItem) {
  const row = menuItem.closest('.item-row');
  const isTaxable = row.dataset.taxable === "true";
  
  // Prevent disabling if Taxable is ON OR Discount is ON
  const discountMenuItem = row.querySelector('.menu-item-discount');
  const isDiscount = discountMenuItem && discountMenuItem.classList.contains('active');
  
  if ((isTaxable || isDiscount) && menuItem.classList.contains('active')) {
      return; 
  }

  const wrapper = menuItem.closest('.price-wrapper');
  const priceInputRow = wrapper.querySelector('.price-inputs-row');
  const priceInput = wrapper.querySelector('.price-menu-input');
  
  // If globally disabled (due to Taxable/Discount being active), prevent interaction
  if (menuItem.style.cursor === "not-allowed") return;
  
  if (menuItem.classList.contains('active')) {
    menuItem.classList.remove('active');
    priceInputRow.classList.add('hidden');
    priceInputRow.classList.remove('grid');
    priceInput.value = ""; 
  } else {
    menuItem.classList.add('active');
    priceInputRow.classList.remove('hidden');
    priceInputRow.classList.add('grid');
    // Set default value if empty when activating
    if (!priceInput.value || parseFloat(priceInput.value) === 0) {
        priceInput.value = "10";
    }
    setTimeout(() => priceInput.focus(), 50);
  }
  
  updateBadge(row);
  updateHamburgerGlow(row);
}

function toggleDiscount(menuItem) {
  const container = menuItem.closest('.item-row') || menuItem.closest('#laborBox');
  const wrapper = menuItem.closest('.discount-wrapper');
  const inputsRow = wrapper.querySelector('.discount-inputs-row');
  
  menuItem.classList.toggle('active');
  const isActive = menuItem.classList.contains('active');
  
  const flatInput = inputsRow.querySelector('.discount-flat-input');
  
  if (isActive) {
      inputsRow.classList.remove('hidden');
      inputsRow.classList.add('grid'); // Ensure grid layout
      
      // 1. Auto-Activate and Lock Price (for Items) FIRST
      if (container.id !== 'laborBox') {
          const priceMenuItem = container.querySelector('.menu-item-price');
          const priceInputRow = container.querySelector('.price-inputs-row');
          const priceInput = container.querySelector('.price-menu-input');
          const priceLabel = priceMenuItem.querySelector('span');
          const priceIcon = priceMenuItem.querySelector('.menu-icon');
          
          if (!priceMenuItem.classList.contains('active')) {
              priceMenuItem.classList.add('active');
              // SHOW PRICE INPUT ROW
              priceInputRow.classList.remove('hidden');
              priceInputRow.classList.add('grid');
              
              if (!priceInput.value || parseFloat(priceInput.value) === 0) {
                  priceInput.value = "10";
              }
          }
          // Lock UI
          priceLabel.style.opacity = "0.5";
          priceIcon.style.opacity = "0.5";
          priceMenuItem.style.cursor = "not-allowed";
      }

      // 2. Set Default Discount Value (5)
      const percentVal = inputsRow.querySelector('.discount-percent-input').value;
      if (!flatInput.value || flatInput.value === "0" || flatInput.value === "") {
          if (!percentVal || percentVal === "0" || percentVal === "") {
              flatInput.value = "5";
          }
      }
      
      // 3. Update Badges
      if (container.id === 'laborBox') updateLaborBadge();
      else updateBadge(container);
      
      setTimeout(() => flatInput.focus(), 50);

  } else {
      inputsRow.classList.add('hidden');
      // Clear inputs
      const percentInput = inputsRow.querySelector('.discount-percent-input');
      if(flatInput) flatInput.value = "";
      if(percentInput) percentInput.value = "";
      
      // Unlock Price UI if needed (for Items)
      if (container.id !== 'laborBox') {
          const priceMenuItem = container.querySelector('.menu-item-price');
          const priceLabel = priceMenuItem.querySelector('span');
          const priceIcon = priceMenuItem.querySelector('.menu-icon');
          const isTaxable = container.dataset.taxable === "true";
          
          // Only unlock if Taxable is ALSO not active
          if (!isTaxable) {
              priceLabel.style.opacity = "1";
              priceIcon.style.opacity = "1";
              priceMenuItem.style.cursor = "pointer";
          }
      }
      
      if (container.id === 'laborBox') updateLaborBadge();
      else updateBadge(container);
  }
  
  updateHamburgerGlow(container);
}

function addItem(containerId, value = "", price = "", taxable = null, sectionTitle = "", taxRate = null, qty = 1, discFlat = "", discPercent = "") {
  // Use global currency symbol if available, fallback to profile default (which initializes it anyway)
  const currencySymbol = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
  
    // Default taxable logic (if valid boolean not provided)
    if (typeof taxable !== 'boolean') {
      const scope = (currentLogTaxScope || "").split(",").map(t => t.trim());
      const lowerTitle = (sectionTitle || "").toLowerCase();
      
      // Detect category type from section title
      const isMaterials = /material/.test(lowerTitle);
      const isExpenses = /expense/.test(lowerTitle);
      const isFees = /fee/.test(lowerTitle);
      
      const taxAll = scope.includes("all") || scope.includes("total");
      const taxMaterials = scope.includes("materials_only");
      const taxFees = scope.includes("fees_only");
      const taxExpenses = scope.includes("expenses_only");

      const hasPrice = price && price !== "" && parseFloat(price) !== 0;

      if (taxAll) {
        taxable = hasPrice;
      } else {
        if (isMaterials && taxMaterials && hasPrice) taxable = true;
        else if (isFees && taxFees && hasPrice) taxable = true;
        else if (isExpenses && taxExpenses && hasPrice) taxable = true;
        else taxable = false;
      }
    }


    
    // Default Tax Rate
    const globalRate = defaultGlobalTaxRate; 
    if (taxRate === null || taxRate === undefined) {
        taxRate = globalRate;
    }
  
    const div = document.createElement('div');
    div.dataset.taxable = taxable;
    div.dataset.symbol = currencySymbol;
    div.dataset.qty = qty || 1;
    // Adjusted margin (mb-8) for optimal spacing
    div.className = "flex items-center gap-2 mb-8 w-full animate-in fade-in slide-in-from-left-2 duration-300 item-row";
    
    // Inputs (Price and Tax)
    const hasPrice = price && price !== "" && price !== "0" && price !== "0.00";
    const priceVal = hasPrice ? cleanNum(price) : "";
    
    // Discount Logic for Initial Load
    const hasDiscount = (discFlat && parseFloat(discFlat) > 0) || (discPercent && parseFloat(discPercent) > 0);
    const discActiveClass = hasDiscount ? "active" : "";
    const discFlatVal = discFlat ? cleanNum(discFlat) : "";
    const discPercentVal = discPercent ? cleanNum(discPercent) : "";
    
    const priceActiveClass = hasPrice ? "active" : "";
    const taxActiveClass = taxable ? "active" : "";
    
    // Style for locked state
    const lockedStyle = taxable ? 'opacity: 0.5;' : '';
    const cursorStyle = taxable ? 'cursor: not-allowed;' : '';
    
    div.innerHTML = `
      <div class="flex flex-1 items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] min-w-0 main-item-box transition-colors relative">
        
        <!-- Hamburger Menu Container -->
        <div class="h-10 w-10 border-r-2 border-black flex-shrink-0 item-menu-container">
          <button type="button" onclick="toggleMenu(this)" class="w-full h-full flex flex-col items-center justify-center gap-[3px] hover:bg-gray-50 item-menu-btn rounded-l-[10px]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-colors slider-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path d="M3 4h18M3 12h18M3 20h18" />
              <path class="slider-head-1" d="M12 2v4" />
              <path class="slider-head-2" d="M12 10v4" />
              <path class="slider-head-3" d="M12 18v4" />
            </svg>
          </button>
          
          <div class="item-menu-dropdown">
            
            <!-- Tax Menu Item (MOVED TOP) -->
            <div class="tax-wrapper flex flex-col w-full">
                <div class="menu-item menu-item-tax ${taxActiveClass}" onclick="toggleTaxable(this)">
                  <span>Taxable</span>
                  <div class="menu-icon">%</div>
                </div>
                
                <div class="tax-inputs-row ${taxable ? 'grid' : 'hidden'} gap-1 p-1 bg-orange-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-orange-600 rounded-b-md"
                     style="grid-template-columns: 1fr;">
                     <div class="relative w-full">
                       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                       <input type="number" step="0.1" class="menu-input tax-menu-input text-right w-full border-orange-200 pl-4 pr-1" 
                              style="width: 100%"
                              value="${parseFloat(taxRate) > 0 ? parseFloat(taxRate) : globalRate}" placeholder="%" 
                              oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                </div>
            </div>
            <!-- Divider -->
            <div class="h-[1px] bg-gray-100 mx-2 my-0.5"></div>
            <!-- Price Menu Item (Moved Middle) -->
            <div class="price-wrapper flex flex-col w-full">
                <div class="menu-item menu-item-price ${priceActiveClass}" onclick="togglePrice(this)"
                     style="${cursorStyle}">
                  <span style="${lockedStyle}">Price</span>
                  <div class="menu-icon price-menu-icon" style="${lockedStyle}">${currencySymbol}</div>
                </div>

                <div class="price-inputs-row ${hasPrice ? 'grid' : 'hidden'} gap-1 p-1 bg-orange-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-orange-600 rounded-b-md"
                     style="grid-template-columns: 1fr;">
                     <div class="relative w-full">
                        <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400 price-input-symbol">${currencySymbol}</span>
                        <input type="number" step="0.01" class="menu-input price-menu-input text-right w-full border-orange-200 pl-4 pr-1" 
                               style="width: 100%"
                               value="${priceVal}" placeholder="0.00" 
                               oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                </div>
            </div>
            <!-- Divider -->
            <div class="h-[1px] bg-gray-100 mx-2 my-0.5"></div>
            <!-- Discount Menu Item (Moved Last) -->
            <div class="discount-wrapper flex flex-col w-full">
                <div class="menu-item menu-item-discount ${discActiveClass}" onclick="toggleDiscount(this)">
                  <span>Discount</span>
                  <div class="menu-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                    </svg>
                  </div>
                </div>
                
                <!-- Inline Input Container -->
                <div class="discount-inputs-row ${hasDiscount ? 'grid' : 'hidden'} gap-1 p-1 bg-green-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-green-600 rounded-b-md" 
                     style="grid-template-columns: 1fr 1fr;">
                     <div class="relative w-full">
                       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400 discount-flat-symbol">${currencySymbol}</span>
                       <input type="number" step="0.01" class="menu-input discount-flat-input text-right w-full border-gray-300 pl-4 pr-1" 
                              style="width: 100%"
                              value="${discFlatVal}"
                              placeholder="0.00" 
                              oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                     <div class="relative w-full">
                       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                       <input type="number" step="0.1" class="menu-input discount-percent-input text-right w-full border-gray-300 pl-4 pr-1" 
                              style="width: 100%"
                              value="${discPercentVal}"
                              placeholder="0" 
                              oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                </div>
            </div>

          </div>
        </div>
  
        <input type="text" value="${value}" 
               class="flex-1 bg-transparent border-none text-sm font-bold text-black focus:ring-0 py-2 px-3 item-input placeholder:text-gray-300 min-w-0 rounded-r-xl"
               placeholder="Work description...">
        
        <!-- Badges Container (Hanging Bottom Right) -->
        <div class="absolute -bottom-6 left-2.5 flex items-center gap-2 z-0 pointer-events-none">
            <span class="badge badge-discount hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"></span>
        </div>
        <div class="absolute -bottom-6 right-2.5 flex items-center gap-1 z-0 pointer-events-none">
            <span class="badge badge-price hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
            <div class="badge-operator badge-multiplier hidden flex items-center justify-center">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </div>
            <span class="badge badge-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
            <div class="badge-operator badge-equals hidden flex items-center justify-center">
                <svg width="12" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="5" stroke-linecap="round"><path d="M4 8h16M4 16h16"/></svg>
            </div>
            <span class="badge badge-after-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
        </div>
      </div>
      
      <button type="button" 
              onclick="this.parentElement.remove();" 
              class="w-6 h-10 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors font-bold text-xl flex-shrink-0">
        ×
      </button>
    `;
    // Finalize
    document.getElementById(containerId).appendChild(div);
    randomizeIcon(div); // RANDOMIZE ON CREATION
    setTimeout(() => { updateBadge(div); updateHamburgerGlow(div); }, 50);
    return div;
}

function updateUI(data) {
  try {
    const transcriptArea = document.getElementById("mainTranscript");
    if (data.raw_summary) {
      transcriptArea.value = data.raw_summary;
      autoResize(transcriptArea);
    }
    document.getElementById("editClient").value = data.client || "";
    const laborBox = document.getElementById('laborBox');
    
    // Set tax scope (AI-detected or profile default)
    currentLogTaxScope = data.tax_scope || "<%= @profile.tax_scope %>";
    
    // Billing Mode & Time Label synchronization
    const billingMode = data.billing_mode || "<%= @profile.billing_mode %>";
    const defaultRate = "<%= @profile.hourly_rate %>";
    
    // Currency Update Logic
    // Reset to profile default first (so we don't stick to a previous query's currency)
    activeCurrencyCode = "<%= @profile.currency.presence || 'USD' %>";
    
    if (data.currency) {
      activeCurrencyCode = data.currency;
    }
    
    const found = CURRENCIES.find(c => c.c === activeCurrencyCode);
    if (found) activeCurrencySymbol = found.s;
    const currencySymbol = activeCurrencySymbol;
    
    // Update Labor Unit Indicator
    const timeLabel = document.getElementById("timeLabel");
    const laborUnitIndicator = document.getElementById("laborUnitIndicator");
    
    if (timeLabel) {
      timeLabel.innerText = billingMode === "fixed" ? "LABOR PRICE" : "LABOR HOURS";
    }
    
    // Toggle visibility of clock/currency icons and rate section
    const laborClockIcon = document.getElementById("laborClockIcon");
    const laborRateSection = document.getElementById("laborRateSection");
    const editTimeInput = document.getElementById("editTime");
    
    if (billingMode === "hourly") {
      // Show clock, hide currency indicator, show rate section
      if (laborClockIcon) laborClockIcon.classList.remove('hidden');
      if (laborUnitIndicator) laborUnitIndicator.classList.add('hidden');
      if (laborRateSection) laborRateSection.classList.remove('hidden');
      if (editTimeInput) {
        editTimeInput.placeholder = "Hours...";
        resizeInput(editTimeInput);
      }
    } else {
      // Hide clock, show currency indicator, hide rate section
      if (laborClockIcon) laborClockIcon.classList.add('hidden');
      if (laborUnitIndicator) {
        laborUnitIndicator.classList.remove('hidden');
        laborUnitIndicator.innerText = currencySymbol;
      }
      if (laborRateSection) laborRateSection.classList.add('hidden');
      if (editTimeInput) {
        editTimeInput.placeholder = "Price...";
        resizeInput(editTimeInput);
      }
    }
    
    // Update rate currency symbol
    const laborRateCurrency = document.getElementById("laborRateCurrency");
    if (laborRateCurrency) laborRateCurrency.innerText = currencySymbol;
    
    // Update Global Discount Currency Symbol
    const globalDiscSym = document.getElementById("discountCurrencySymbol");
    if (globalDiscSym) globalDiscSym.innerText = currencySymbol;
    
    // Update Labor After Tax Symbol
    const afterTaxSym = document.querySelector('#laborAfterTaxDisplay + span');
    if (afterTaxSym) afterTaxSym.innerText = currencySymbol;
    
    // Update Labor Discount Flat Symbol
    const laborDiscSym = document.querySelector('#laborBox .discount-inputs-row span.absolute:first-child');
    // Using a more robust selector if above is fragile: 
    // The structure is fixed: .discount-inputs-row > div:first-child > span (this is the $)
    const laborDiscRow = document.querySelector('#laborBox .discount-inputs-row');
    if (laborDiscRow) {
        const flatSym = laborDiscRow.querySelector('div:first-child span.absolute');
        if (flatSym) flatSym.innerText = currencySymbol;
    }

    // Update ALL dynamic items (Price icon and input symbols)
    document.querySelectorAll('.price-menu-icon').forEach(el => el.innerText = currencySymbol);
    document.querySelectorAll('.price-input-symbol').forEach(el => el.innerText = currencySymbol);
    document.querySelectorAll('.discount-flat-symbol').forEach(el => el.innerText = currencySymbol);
    document.querySelectorAll('.badge-price').forEach(el => {
        // Since badges often contain calculations, we might need a more complex update logic
        // but for now, we'll let updateBadge handle it since it's called in most places.
        // However, updating the symbol inside the badge text if it's static is good.
    });

    // Update ANY existing items/badges if they differ (though usually we clear sections below, but labor might persist)
    // Actually sections are cleared below (sectionContainer.innerHTML = ""), so we only need to worry about Labor Box here.
    // However, if we preserve any state, we should be careful. 
    // Data from AI usually replaces everything.
    
    if (laborBox) {
      laborBox.dataset.billingMode = billingMode;
      // ... (rest of laborBox logic)
      if (data.hourly_rate) {
        laborBox.dataset.hourlyRate = data.hourly_rate;
        const editHourlyRateInput = document.getElementById('editHourlyRate');
        if (editHourlyRateInput) editHourlyRateInput.value = data.hourly_rate;
      }
      if (data.labor_tax_rate) {
        laborBox.dataset.taxRate = data.labor_tax_rate;
        const laborTaxInput = laborBox.querySelector('.tax-menu-input');
        if (laborTaxInput) laborTaxInput.value = data.labor_tax_rate;
      }
    }
    
    // ... (rest of function continues)
    
    // *IMPORTANT*: Since sections are rebuilt below using `addFullSection` -> `addItem`, 
    // we need to make sure `addItem` uses the global `activeCurrencySymbol`.
    // I will update addItem separately.

    const timeInput = document.getElementById("editTime");
    if (billingMode === "fixed") {
      timeInput.value = data.fixed_price && data.fixed_price !== "" && data.fixed_price !== "0" ? cleanNum(data.fixed_price) : "";
    } else {
      timeInput.value = cleanNum(data.labor_hours || data.time || "");
    }
    resizeInput(timeInput);

    // Handle Labor Taxable initial state based on scope
    const laborMenuItem = laborBox.querySelector('.menu-item-tax');
    const hamburgerLines = laborBox.querySelectorAll('.hamburger-line');
    const scope = (currentLogTaxScope || "").split(",").map(t => t.trim());
    
    // Explicit override from AI vs Scope-based default
    const laborTime = document.getElementById("editTime").value;
    const hasLaborValue = laborTime && laborTime !== "" && parseFloat(laborTime) !== 0;
    
    // Rerandomize labor icon specifically
    const laborIconBtn = laborBox.querySelector('.item-menu-btn');
    if (laborIconBtn) randomizeIcon(laborIconBtn);

    let laborTaxableByDefault = (scope.includes("all") || scope.includes("total") || scope.includes("labor")) && hasLaborValue;
    if (typeof data.labor_taxable === 'boolean') {
      laborTaxableByDefault = data.labor_taxable;
    }
    
    laborBox.dataset.taxable = laborTaxableByDefault;
    const laborTaxInputRow = laborBox.querySelector('.tax-inputs-row');
    
    if (laborTaxableByDefault) {
      laborMenuItem.classList.add('active');
      laborTaxInputRow.classList.remove('hidden');
      laborTaxInputRow.classList.add('grid');
    } else {
      laborMenuItem.classList.remove('active');
      laborTaxInputRow.classList.add('hidden');
      laborTaxInputRow.classList.remove('grid');
    }

    // Populate Labor Discount
    const lDiscFlat = data.labor_discount_flat || "";
    const lDiscPercent = data.labor_discount_percent || "";
    laborBox.querySelector('.discount-flat-input').value = lDiscFlat ? cleanNum(lDiscFlat) : "";
    laborBox.querySelector('.discount-percent-input').value = lDiscPercent ? cleanNum(lDiscPercent) : "";
    const laborDiscountInputs = laborBox.querySelector('.discount-inputs-row');
    if ((lDiscFlat && parseFloat(lDiscFlat) > 0) || (lDiscPercent && parseFloat(lDiscPercent) > 0)) {
        laborBox.querySelector('.menu-item-discount').classList.add('active');
        laborDiscountInputs.classList.remove('hidden');
        laborDiscountInputs.classList.add('grid');
    } else {
        laborBox.querySelector('.menu-item-discount').classList.remove('active');
        laborDiscountInputs.classList.add('hidden');
        laborDiscountInputs.classList.remove('grid');
    }

    // Populate Global Discount
    const gDiscFlat = data.global_discount_flat || "";
    const gDiscPercent = data.global_discount_percent || "";
    const gFlatInput = document.getElementById('globalDiscountFlat');
    const gPercentInput = document.getElementById('globalDiscountPercent');
    
    if (gFlatInput) gFlatInput.value = gDiscFlat ? cleanNum(gDiscFlat) : "";
    if (gPercentInput) gPercentInput.value = gDiscPercent ? cleanNum(gDiscPercent) : "";
    
    // Populate Credit
    const creditFlat = data.credit_flat || "";
    const creditReason = data.credit_reason || "";
    const creditFlatInput = document.getElementById('creditFlatInput');
    const creditCurrencySym = document.getElementById('creditCurrencySymbol');
    
    if (creditFlatInput) creditFlatInput.value = creditFlat ? cleanNum(creditFlat) : "";
    if (creditCurrencySym) creditCurrencySym.innerText = currencySymbol;
    
    // DEBUG: Check what we received
    // if (creditFlat) {
    //    alert("DEBUG: Credit Flat = " + creditFlat + ", Reason = " + creditReason);
    // }

    // If AI detected credit, ensure Credit section exists (even if reason is missing, we add a placeholder)
    // MOVED LOGIC BELOW TO AFTER SECTION REBUILDING
    // if (creditFlat && parseFloat(creditFlat) > 0) { ... }
    
    updateLaborBadge();
    updateHamburgerGlow(laborBox);

  
    let dateVal = data.date;
    if (!dateVal || dateVal === "N/A" || dateVal.toLowerCase().includes("specified")) {
      dateVal = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    document.getElementById("dateDisplay").innerText = dateVal;
  
    // Due Date Logic
    updateDueDate(data.due_days, data.due_date);
  
    // Clear existing sections first (except protected ones? No, AI rebuilds everything)
    // BUT we must be careful not to delete the Labor section if it's protected in HTML?
    // Actually, dynamicSections contains Labor section too? 
    // Wait, the static HTML has <div id="dynamicSections"> ... <div data-protected="labor"> ... </div> </div>
    // So sectionContainer.innerHTML = "" WIPES OUT THE LABOR SECTION TOO.
    // The previous code re-added "Labor/Service" via addFullSection? No.
    // Let's check how Labor is handled. Use data-protected.
    
    const sectionContainer = document.getElementById("dynamicSections");
    // Preserve protected sections if they shouldn't be rebuilt by AI?
    // The previous logic wiped everything.
    
    // We need to rebuild sections from data.sections.
    // Credit logic above CREATES a section in dynamicSections.
    // THEN this line wipes it out: sectionContainer.innerHTML = "";
    
    // FIX: Move the wiping to BEFORE credit logic, but we need to preserve Labor?
    // Actually, Labor is handled by the Labor Box in the LEFT column now? 
    // WRONG. Labor/Service IS a dynamic section in the RIGHT column (Review Data).
    
    // IF we wipe everything, we lose the Labor section unless data.sections triggers it.
    // But data.sections comes from AI.
    
    // Let's just create Credit AFTER rebuilding sections.
    
    sectionContainer.innerHTML = "";
    
    // Rebuild standard sections
    if (data.sections && data.sections.length > 0) {
      data.sections.forEach(sec => addFullSection(sec.title, sec.items));
    } else if (data.tasks) {
      addFullSection("Tasks", Array.isArray(data.tasks) ? data.tasks : [data.tasks]);
    } else {
        // AI didn't return sections? Keep Labor?
        // If AI returns empty sections (e.g. credit only), we want empty container (except Credit).
    }
    
    // NOW Create/Update Credit Section (after sections are rebuilt)
    // If AI detected credit, ensure Credit section exists
    if (creditFlat && parseFloat(creditFlat) > 0) {
        // Check if a Credit section already exists (it won't, we just wiped it, unless addFullSection added it? No.)
        const container = document.getElementById("dynamicSections");
        const sectionId = "credit_ai_" + Date.now();
        const sectionDiv = document.createElement('div');
        sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
        sectionDiv.dataset.protected = "credit";
        sectionDiv.innerHTML = `
          <div class="flex justify-between items-center group border-b-2 border-black pb-1">
            <div class="flex items-center">
              <svg class="h-4 w-4 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
              <span class="text-base font-black text-orange-600 uppercase tracking-widest section-title">Credit</span>
            </div>
            <div class="flex gap-2 mb-1 shrink-0">
              <button type="button" onclick="addCreditItem('${sectionId}')" 
                      class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
                + Item
              </button>
              <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                      class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
                Remove
              </button>
            </div>
          </div>
          <div id="${sectionId}" class="pt-2"></div>
        `;
        container.appendChild(sectionDiv);
        addCreditItem(sectionId, creditReason || "");
    }
    
    // Handle Labor/Service specific logic
    // If AI returns labor items in "Labor/Service" section, fine. 
    // If AI returns explicit "labor_service_items" in JSON (from controller), we should create that section if data.sections didn't.
    if (data.labor_service_items && data.labor_service_items.length > 0) {
      // Check if Labor already exists (from data.sections)
      const existingLabor = Array.from(document.querySelectorAll('.section-title')).find(el => el.innerText === "LABOR/SERVICE" || el.value === "Labor/Service");
      if (!existingLabor) {
        addFullSection("Labor/Service", data.labor_service_items);
        const laborSec = sectionContainer.lastElementChild;
        if(laborSec) sectionContainer.prepend(laborSec);
      }
    }
  
    document.getElementById("invoicePreview").classList.remove("hidden");
    document.getElementById("invoicePreview").scrollIntoView({ behavior: 'smooth' });
    
    // Update totals summary after all items are added
    updateTotalsSummary();
  } catch (e) {
    showError("UI Update Error: " + e.message);
    console.error(e);
  }
}

function showError(msg) {
  const toast = document.getElementById("errorToast");
  const msgSpan = document.getElementById("errorMessage");
  msgSpan.innerText = msg;
  toast.classList.remove("hidden");
  setTimeout(() => { toast.classList.add("hidden"); }, 4000);
}
</script>
