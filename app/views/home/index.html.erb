<div class="flex flex-col items-center space-y-6 max-w-md mx-auto mt-10">
  
  <div class="text-center">
    <h1 class="text-4xl font-bold text-gray-800 tracking-tight">SiteLogger</h1>
    <p class="text-gray-500 mt-2">Tap below to log your job</p>
    <div class="mt-4">
      <%= link_to "View History", history_path, class: "text-blue-600 hover:text-blue-800 font-medium underline" %>
    </div>
  </div>

  <button 
    id="recordButton"
    class="w-48 h-48 rounded-full bg-red-600 shadow-xl flex items-center justify-center transition-all active:scale-95 hover:bg-red-700 border-4 border-white ring-4 ring-red-100 cursor-pointer">
    <span id="buttonText" class="text-white font-bold text-2xl uppercase tracking-widest">RECORD</span>
  </button>

  <div 
    id="invoicePreview" 
    class="hidden w-full bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 mt-8">
    
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-700">Invoice Preview</h2>
    </div>

    <div class="p-6 space-y-4">
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-500">Date</span>
        <span id="dateField" class="font-medium text-gray-900">-</span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-500">Client</span>
        <span id="clientField" class="font-medium text-gray-900">-</span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="text-gray-500">Time Spent</span>
        <span id="timeField" class="font-medium text-gray-900">-</span>
      </div>
      <div>
        <span class="text-gray-500 block mb-1">Tasks</span>
        <ul id="tasksField" class="list-none space-y-1 text-gray-800 bg-gray-50 p-3 rounded-lg text-sm"></ul>
      </div>
      <div>
        <span class="text-gray-500 block mb-1">Materials</span>
        <ul id="materialsField" class="list-none space-y-1 text-gray-800 bg-gray-50 p-3 rounded-lg text-sm"></ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const button = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const outputDiv = document.getElementById("invoicePreview");
  
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;

  button.addEventListener("click", async () => {
    if (!isRecording) {
      // START RECORDING
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = sendAudioToServer;

        mediaRecorder.start();
        isRecording = true;
        
        // Change UI
        buttonText.innerText = "STOP";
        button.classList.add("animate-pulse", "bg-red-800");
      } catch (err) {
        alert("Microphone access denied. Please allow permissions.");
        console.error(err);
      }
    } else {
      // STOP RECORDING
      mediaRecorder.stop();
      isRecording = false;
      
      // Change UI
      buttonText.innerText = "THINKING...";
      button.classList.remove("animate-pulse", "bg-red-800");
      
      // Stop the microphone "red dot"
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
  });

  async function sendAudioToServer() {
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const formData = new FormData();
    formData.append("audio", audioBlob, "recording.webm");

    // Get Rails Security Token
    const token = document.querySelector('meta[name="csrf-token"]').content;

    try {
      const response = await fetch("/process_audio", {
        method: "POST",
        headers: { "X-CSRF-Token": token },
        body: formData
      });

      const data = await response.json();
      console.log("AI Data:", data);

      if (data.error) {
        alert("Error: " + data.error);
        buttonText.innerText = "RETRY";
      } else {
        // Show Results
        outputDiv.classList.remove("hidden");
        buttonText.innerText = "RECORD";

        // Fill Data
        document.getElementById("dateField").innerText = data.date || "-";
        document.getElementById("clientField").innerText = data.client || "-";
        document.getElementById("timeField").innerText = data.time || "-";
        
        document.getElementById("tasksField").innerHTML = 
          (data.tasks || []).map(t => `<li>• ${t}</li>`).join('');
          
        document.getElementById("materialsField").innerHTML = 
          (data.materials || []).map(m => `<li>• ${m}</li>`).join('');
      }
    } catch (error) {
      console.error(error);
      alert("Server Error. Check console.");
      buttonText.innerText = "ERROR";
    }
  }
});
</script>