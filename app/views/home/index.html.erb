<!-- PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // Initialize PDF.js worker
  (function() {
    const lib = window['pdfjs-dist/build/pdf'] || window.pdfjsLib;
    if (lib) {
      window.pdfjsLib = lib;
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  })();
</script>

<div class="bg-white text-black font-sans p-4 pb-32 md:pb-10">
  
  <!-- SEO Content Priority for Search Snippets (Visually Hidden) -->
  <section style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;" aria-hidden="false">
    <h1>TalkInvoice: AI Voice Invoicing for Professionals</h1>
    <p>
      TalkInvoice is the smarter way to bill. Use AI voice recording to create professional invoices instantly. 
      Transcribe spoken job notes, calculate totals automatically, and generate beautiful PDFs in seconds. 
      The perfect tool for contractors, freelancers, and service providers. Start voicing your invoices today.
    </p>
  </section>

  <%= render 'header' %>
  <%= render 'svg_symbols' %>

  <div class="max-w-md md:max-w-6xl mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-[380px_1fr] gap-12 items-start">
      
      <!-- LEFT COLUMN: Sticky Console -->
      <div class="md:sticky md:top-8 flex flex-col gap-10">
        
        <!-- Recording Console -->
        <%= render 'recording_console' %>
        <%= render 'transcript_console' %>

        </div>
      
      <!-- RIGHT COLUMN: Invoice Data -->
      <div id="invoicePreview" class="transition-all duration-700 space-y-8">
        
        <!-- Global Invoice Controls (NEW) -->
        <%= render 'invoice_controls' %>

        <div class="flex items-center gap-4">
          <div class="h-px bg-black flex-1 opacity-10"></div>
          <span class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-600">Review Data</span>
          <div class="h-px bg-black flex-1 opacity-10"></div>
        </div>

        <div id="reviewContainer" data-nosnippet class="review-container">
          <div class="bg-white border-2 border-black rounded-2xl p-6 industrial-shadow space-y-6 review-content relative">
            <!-- Analyzing Overlay -->
            <div id="analyzingOverlay" class="analyzing-overlay"></div>
          
            <%= render 'job_details' %>
            <%= render 'labor_section' %>

            <!-- Dynamic Sections Container (Materials, Expenses, etc.) -->
            <div id="dynamicSections" class="space-y-6 mt-8"></div>

            <%= render 'credit_section' %>
            <%= render 'due_date_section' %>
            <%= render 'totals_summary' %>
            <%= render 'action_buttons' %>

          </div>
        </div>

      </div> <!-- End review-container -->
      </div> <!-- End Right Column (Invoice Preview) -->

    </div> <!-- End Grid Container -->
  </div> <!-- End Max-Width Container -->

  <div id="errorToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[50000] hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
    <div class="bg-white text-black px-6 py-4 rounded-xl shadow-2xl border-2 border-red-500 flex items-center gap-4">
      <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
      <span id="errorMessage" class="text-xs font-bold uppercase tracking-widest">Error Message</span>
    </div>
  </div>

</div>

<script>
  // Global Tax & Profile Variables
  let currentLogTaxScope, currentLogBillingMode, currentLogDiscountTaxRule, profileHourlyRate, profileTaxRate, activeCurrencyCode, activeCurrencySymbol, currentLogAccentColor;
  let logAlreadySaved = false;
  let savedLogId = null;
  let savedLogDisplayNumber = null;
  let savedLogClient = null;
  let shareTrackedThisSession = false; // Tracks if share was already counted for this preview popup

  // Check historical usage
  window.calculateHistoricalChars = function() {
    if (!window.clarificationHistory || window.clarificationHistory.length === 0) return 0;
    let total = 0;
    window.clarificationHistory.forEach(h => {
        // Count ONLY the user's actual text length, ignoring prompt overhead
        // This ensures math like "290 limit - 200 used = 90 remaining" holds true
        total += (h.answer ? h.answer.length : 0);
    });
    return total;
  };

  // Dynamic Character Counter Logic
  window.updateDynamicCounters = function() {
    const limit = <%= @profile.char_limit %>;
    
    // Get Elements
    const elT = document.getElementById('mainTranscript');
    const elR = document.getElementById('refinementInput');
    const elC = document.getElementById('clarificationAnswerInput');
    
    // Get Lengths
    const lenT = elT ? elT.value.length : 0;
    const lenR = elR ? elR.value.length : 0;
    const lenC = elC ? elC.value.length : 0;
    const lenHistory = window.calculateHistoricalChars();
    
    const totalUsed = lenT + lenR + lenC + lenHistory;
    const remaining = Math.max(0, limit - totalUsed);
    
    // Update Transcript Counter (T)
    const valT = document.getElementById('currentCharCount');
    const maxT = document.getElementById('mainTranscriptMax');
    if (valT && maxT) {
      valT.innerText = lenT;
      maxT.innerText = Math.max(0, limit - lenR - lenC - lenHistory);
    }
    
    // Update Refinement Counter (R)
    const valR = document.getElementById('refinementCharCount');
    const maxR = document.getElementById('refinementMax');
    if (valR && maxR) {
      valR.innerText = lenR;
      maxR.innerText = Math.max(0, limit - lenT - lenC - lenHistory);
    }

    // Update Clarification Counter (C)
    const valC = document.getElementById('clarificationCharCount');
    const maxC = document.getElementById('clarificationMax');
    if (valC && maxC) {
      valC.innerText = lenC;
      maxC.innerText = Math.max(0, limit - lenT - lenR - lenHistory);
    }
    
    return totalUsed;
  };
  
  window.updateDynamicCountersCheck = function(el) {
    const total = window.updateDynamicCounters();
    const limit = <%= @profile.char_limit %>;
    
    if (total > limit) {
       // Trim the input that caused the overflow
       let excess = total - limit;
       if (el && excess > 0) {
          el.value = el.value.slice(0, -excess);
       }
       
       // Stop live recognition if active
       if (window.liveRecognition) {
         try { window.liveRecognition.stop(); } catch(e) {}
         window.liveRecognition = null;
       }

       window.updateDynamicCounters(); // Re-update after trim
       if (window.showPremiumModal) window.showPremiumModal();
    }
  };

  // Initialize checks on load
  document.addEventListener('turbo:load', window.updateDynamicCounters);
  document.addEventListener('DOMContentLoaded', window.updateDynamicCounters); 

  function initGlobalVariables() {
    currentLogTaxScope = "<%= @profile.tax_scope %>";
    currentLogBillingMode = "<%= @profile.billing_mode || 'hourly' %>";
    currentLogDiscountTaxRule = "<%= @profile.discount_tax_rule || 'post_tax' %>";
    profileHourlyRate = <%= @profile.hourly_rate.to_f %>;
    activeCurrencyCode = "<%= @profile.currency.presence || 'USD' %>";
    activeCurrencySymbol = CURRENCIES.find(c => c.c === activeCurrencyCode)?.s || "$";
    profileTaxRate = <%= @profile.tax_rate.to_f %>;
    currentLogAccentColor = "<%= @profile.accent_color %>";
  }

  function checkRecreateData() {
    console.log("[Recreate] checkRecreateData called.");
    const raw = localStorage.getItem('recreate_log_data');
    if (!raw) {
      console.log("[Recreate] No staged data found in localStorage.");
      return;
    }
    
    try {
      const data = JSON.parse(raw);
      localStorage.removeItem('recreate_log_data');
      console.log("[Recreate] Data parsed from localStorage, preparing injection:", data);
      
      // We use a small recursive check or safe delay to ensure updateUI exists and DOM is populated
      const inject = () => {
        if (typeof updateUI === 'function') {
          console.log("[Recreate] updateUI function found, injecting data...");
          updateUI(data);
          console.log("[Recreate] Data injection complete.");
        } else {
          console.log("[Recreate] updateUI not yet available, retrying in 100ms...");
          setTimeout(inject, 100);
        }
      };
      
      // Initial trigger after short delay to let standard scripts init
      console.log("[Recreate] Initiating data injection with a 400ms delay...");
      setTimeout(inject, 400);
    } catch (e) {
      console.error("[Recreate] Error parsing staged data from localStorage:", e);
    }
  }

  window.CURRENCIES = <%= currencies_data.to_json.html_safe %>;
  window.activeCurrencyCode = "USD";
  window.activeCurrencySymbol = "$";
  window.currentLogBillingMode = "hourly";
  window.currentLogDiscountTaxRule = "tax_excluded";
  window.profileCharLimit = <%= @profile.char_limit %>;
  window.userSignedIn = <%= user_signed_in? %>;
  window.profileTaxScope = "<%= @profile.tax_scope %>";
  window.profileAudioLimit = <%= @profile.audio_limit %>;
  window.currentUserId = <%= user_signed_in? ? current_user.id.to_json : 'null' %>;
  window.profileTaxRate = <%= @profile.tax_rate || 0 %>;
  
  // Initialize once on load
  document.addEventListener('DOMContentLoaded', () => {
    initGlobalVariables();
  });
  
</script>
<%= javascript_include_tag "home_legacy" %>

<!-- PDF Preview Modal -->
<div id="pdfModal" class="fixed inset-0 z-[200] hidden overflow-hidden flex flex-col items-center justify-center p-0 md:p-6 lg:p-10 pointer-events-none">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-300 pointer-events-auto" id="pdfModalOverlay" onclick="closePdfModal()"></div>
    <div class="relative w-full max-w-3xl h-full md:h-[85vh] flex flex-col bg-white md:rounded-[2.5rem] shadow-2xl overflow-hidden translate-y-full transition-transform duration-500 pointer-events-auto" id="pdfModalContent">
        <!-- Modal Header -->
        <div class="flex flex-col border-b-2 border-black bg-white shrink-0">
            <div class="flex items-center justify-between px-6 py-4">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-black flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                  Invoice Preview
                </h3>
                
                <div class="flex items-center gap-2">
                    <button onclick="closePdfModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:text-black transition-colors hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-4 px-6 pb-4">
                <!-- Status Selector -->
                <div class="flex flex-col gap-1">
                    <label class="text-[8px] font-black text-gray-400 uppercase tracking-widest ml-1">Status</label>
                    <div class="relative">
                        <input type="hidden" id="pdfLogStatus" value="draft">
                        <button type="button" 
                                onclick="togglePdfStatusSelector(this, event)"
                                id="pdfStatusBadge"
                                class="flex items-center gap-1.5 px-3.5 py-1.5 bg-gray-50 border-2 border-gray-300 rounded-lg text-[10px] font-black uppercase tracking-widest text-gray-500 transition-all shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-x-[1px] active:translate-y-[1px] active:shadow-none">
                            <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                            <span id="pdfStatusText">Draft</span>
                            <svg class="h-3 w-3 opacity-50 status-chevron transition-transform duration-300">
                                <use xlink:href="#icon-chevron-down"></use>
                            </svg>
                        </button>
                        
                        <div id="pdfStatusDropdown" class="pdf-selector-dropdown absolute left-0 top-full mt-2 w-40 bg-white border-2 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] overflow-hidden">
                            <% status_options = [
                                { name: 'draft', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5', color: 'bg-gray-500' },
                                { name: 'sent', icon: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z', color: 'bg-blue-600' },
                                { name: 'paid', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', color: 'bg-green-600' }
                            ] %>
                            <% status_options.each do |opt| %>
                                <button type="button" onclick="setPdfStatus('<%= opt[:name] %>')" 
                                        class="w-full flex items-center gap-3 px-4 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-gray-50 transition-all border-b border-gray-100 last:border-0">
                                    <div class="w-2 h-2 rounded-full <%= opt[:color] %>"></div>
                                    <%= opt[:name] %>
                                </button>
                            <% end %>
                        </div>
                    </div>
                </div>

                <!-- Category Selector -->
                <div class="flex flex-col gap-1 flex-1 min-w-[180px]">
                    <label class="text-[8px] font-black text-gray-400 uppercase tracking-widest ml-1">Category</label>
                    <div class="relative">
                        <input type="hidden" id="pdfLogCategory" value="">
                        <button type="button" 
                                onclick="togglePdfCategorySelector(this, event)"
                                id="pdfCategoryBadge"
                                class="w-full flex items-center justify-between px-3.5 py-1.5 bg-white border-2 border-black rounded-lg text-[10px] font-black uppercase tracking-widest text-black transition-all shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-x-[1px] active:translate-y-[1px] active:shadow-none h-[34px]">
                            <div class="flex items-center gap-2 truncate">
                                <span id="pdfCategoryIcon" class="hidden shrink-0"></span>
                                <span id="pdfCategoryText" class="truncate">Add to Category</span>
                            </div>
                            <svg class="h-3 w-3 opacity-50 status-chevron transition-transform duration-300">
                                <use xlink:href="#icon-chevron-down"></use>
                            </svg>
                        </button>
                        
                        <div id="pdfCategoryDropdown" class="pdf-selector-dropdown absolute left-0 right-0 top-full mt-2 bg-white border-2 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] max-h-60 overflow-y-auto custom-scrollbar">
                            <button type="button" onclick="setPdfCategory('', '- No Category -', '')" 
                                    class="w-full flex items-center gap-3 px-4 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-gray-50 transition-all border-b border-gray-100 italic text-gray-400">
                                - No Category -
                            </button>
                            <% @categories.each do |category| %>
                                <button type="button" onclick="setPdfCategory('<%= category.id %>', '<%= category.name %>', '<%= category.color %>', '<%= category.icon %>', '<%= category.icon_type %>', '<%= category.icon_type == 'custom' && category.custom_icon.attached? ? url_for(category.custom_icon) : '' %>')" 
                                        class="w-full flex items-center gap-3 px-4 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-gray-50 transition-all border-b border-gray-100 group/cat">
                                    <div class="w-6 h-6 rounded flex items-center justify-center border-2 shrink-0 group-hover/cat:scale-110 transition-transform" style="border-color: <%= category.color %>; color: <%= category.color %>;">
                                        <% if category.icon_type == 'custom' && category.custom_icon.attached? %>
                                            <img src="<%= url_for(category.custom_icon) %>" class="w-3 h-3 object-cover rounded-sm">
                                        <% else %>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                <%= category_icon_map[category.icon].to_s.html_safe %>
                                            </svg>
                                        <% end %>
                                    </div>
                                    <span class="truncate"><%= category.name %></span>
                                </button>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PDF Viewer Container -->
        <div class="flex-1 relative overflow-y-auto overflow-x-hidden p-4 md:p-10 custom-scrollbar scroll-smooth flex flex-col items-center" id="pdfViewerContainer" style="background-color: #282828; -webkit-overflow-scrolling: touch; scroll-behavior: auto !important;" oncontextmenu="return false;">
            <!-- Primary Desktop Viewer (Iframe) -->
            <div id="pdfCanvas" class="relative bg-white shadow-2xl shrink-0 w-full hidden md:block unselectable" style="min-height: 500px; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;">
                <iframe id="pdfFrame" class="w-full h-full border-none block" style="position: absolute; inset: 0;" frameborder="0" type="application/pdf"></iframe>
                <!-- Protection Overlay (Desktop Right-Click Block) -->
                <div class="absolute inset-0 z-10 bg-transparent" oncontextmenu="return false;"></div>
            </div>

            <!-- Mobile PDF.js Viewer Container -->
            <div id="pdfJSContainer" class="w-full flex flex-col items-center md:hidden unselectable" oncontextmenu="return false;">
                <!-- Canvases will be injected here -->
            </div>

            <!-- Loading Indicator -->
            <div id="pdfLoading" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-gray-100 text-black">
                <div class="analyzing-spinner mb-4"></div>
                <span class="text-[10px] font-black uppercase tracking-widest animate-pulse">Generating PDF...</span>
            </div>
        </div>



        <!-- Modal Footer Actions (Sticky Bottom) -->
        <div class="flex items-center justify-around md:justify-center gap-6 md:gap-12 px-6 py-6 md:py-8 bg-white border-t-2 border-black shrink-0">
            <!-- CHANGE (Back to Edit) -->
            <button id="pdfModalChangeBtn" onclick="closePdfModal()" class="flex flex-col items-center gap-2 group transition-all">
                <div class="w-14 h-14 md:w-16 md:h-16 rounded-[1.25rem] md:rounded-3xl border-2 border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] flex items-center justify-center group-active:translate-x-[2px] group-active:translate-y-[2px] group-active:shadow-none transition-all hover:bg-gray-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </div>
                <span class="text-[9px] md:text-[10px] font-black uppercase tracking-widest text-gray-500 group-hover:text-black transition-colors">Change</span>
            </button>

            <!-- SAVE (Confirm and to History) -->
            <% if @profile.guest? %>
            <!-- Guest: Inactive SAVE button - completely unclickable -->
            <div class="flex flex-col items-center gap-2 pointer-events-none select-none">
                <div class="w-14 h-14 md:w-16 md:h-16 rounded-[1.25rem] md:rounded-3xl border-2 border-black/30 bg-orange-600/40 shadow-none flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7 text-white/60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 21v-8H7v8M9 3v5h6V3" />
                         <path d="M10 18h4" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="text-[9px] md:text-[10px] font-black uppercase tracking-widest text-gray-400 text-center leading-tight">Sign Up<br/>to Save</span>
            </div>
            <% else %>
            <button id="pdfModalSaveBtn" onclick="finalSaveLog()" class="flex flex-col items-center gap-2 group transition-all">
                <div class="w-14 h-14 md:w-16 md:h-16 rounded-[1.25rem] md:rounded-3xl border-2 border-black bg-orange-600 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] flex items-center justify-center group-active:translate-x-[2px] group-active:translate-y-[2px] group-active:shadow-none transition-all hover:bg-orange-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 21v-8H7v8M9 3v5h6V3" />
                         <path d="M10 18h4" stroke-linecap="round" />
                    </svg>
                </div>
                <span class="text-[9px] md:text-[10px] font-black uppercase tracking-widest text-gray-500 group-hover:text-black transition-colors">Save</span>
            </button>
            <% end %>

            <!-- SHARE (Native Share or similar) -->
            <button id="pdfModalShareBtn" onclick="sharePdf()" class="flex flex-col items-center gap-2 group transition-all">
                <div class="w-14 h-14 md:w-16 md:h-16 rounded-[1.25rem] md:rounded-3xl border-2 border-black bg-orange-600 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] flex items-center justify-center group-active:translate-x-[2px] group-active:translate-y-[2px] group-active:shadow-none transition-all hover:bg-orange-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                </div>
                <span class="text-[9px] md:text-[10px] font-black uppercase tracking-widest text-gray-500 group-hover:text-black transition-colors">Share</span>
            </button>
        </div>
    </div>
</div>

