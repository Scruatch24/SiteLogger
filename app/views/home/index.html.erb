<style>
  #mainTranscript {
    transition: height 0.1s ease;
    min-height: 120px;
  }
  .industrial-shadow {
    box-shadow: 4px 4px 0px 0px #F97316;
  }
  .industrial-input:focus {
    box-shadow: 2px 2px 0px 0px #F97316;
    transform: translate(-1px, -1px);
  }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  /* Animation for the pop-up price field */
  .price-badge-container.hidden {
    display: none;
  }
  
  /* Item Operations Menu */
  .item-menu-btn {
    transition: all 0.2s;
  }
  .item-menu-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    background: white;
    border: 2px solid black;
    border-radius: 8px;
    z-index: 50;
    box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
    min-width: 140px;
    padding: 6px;
  }
  .item-menu-dropdown.show {
    display: flex;
    flex-direction: column;
    gap: 4px;
    animation: fadeIn 0.1s ease-out;
  }
  .menu-item {
    position: relative; /* For dropright positioning */
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 12px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.1s;
    background: white;
    color: #525252;
    border: 1px solid transparent;
  }
  .menu-item:hover {
    background: #FFF7ED;
    color: #EA580C;
  }
  .menu-item.active {
    background-color: #FFF7ED;
    color: #EA580C;
    border-color: #EA580C;
  }
  .menu-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 900;
    color: #a3a3a3;
  }
  .menu-item:hover .menu-icon {
    color: #EA580C;
    background: rgba(234, 88, 12, 0.1);
  }
  .menu-item.active .menu-icon {
    background: #EA580C;
    color: white;
  }
  
  /* Dropright Input */
  .menu-input-container {
    display: none;
    position: absolute;
    left: 100%;
    top: 0;
    margin-left: 8px;
    background: white;
    padding: 4px;
    border: 2px solid black;
    border-radius: 6px;
    box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
    z-index: 60;
    align-items: center;
    gap: 4px;
  }
  .menu-item.active .menu-input-container {
    display: flex;
    animation: fadeIn 0.1s ease-out;
  }
  .menu-input {
    width: 60px;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    padding: 4px;
    font-size: 11px;
    font-weight: 700;
    color: black;
    outline: none;
  }
  .menu-input:focus {
    border-color: #F97316;
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    padding: 0 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    border: 1px solid transparent;
  }
  .badge.hidden { display: none; }
  
  .badge-price, .badge-tax, .badge-after-tax {
    background-color: #EA580C;
    color: white;
    border: 1px solid black;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="min-h-screen bg-white text-black font-sans p-4 pb-32">
  
  <header class="flex justify-between items-center mb-12 pt-2 px-1">
    <div class="flex items-center gap-2">
      <div class="w-3 h-8 bg-orange-600"></div>
      <h1 class="text-2xl font-black tracking-tighter text-black uppercase italic">
        SITE<span class="text-orange-600">LOGGER</span>
      </h1>
    </div>
    
    <div class="flex gap-3">
      <%= link_to history_path, class: "p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "History" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      <% end %>

      <%= link_to settings_path, class: "p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "Profile" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      <% end %>
    </div>
  </header>

  <div class="max-w-md mx-auto space-y-10">
    
    <div class="flex flex-col items-center justify-center">
      <div id="recordingWave" class="hidden absolute w-48 h-48 border-4 border-orange-200 rounded-full animate-ping"></div>
      
      <button id="recordButton" class="relative w-36 h-36 rounded-full bg-white border-[6px] border-orange-500 shadow-xl flex flex-col items-center justify-center transition-all active:scale-95 group hover:bg-orange-50">
        <svg id="micIcon" class="w-10 h-10 text-orange-600 mb-1 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <span id="buttonText" class="text-black text-[10px] font-black uppercase tracking-widest text-center px-2 mt-1">TAP TO RECORD</span>
      </button>
      
      <p id="status" class="mt-6 text-xs font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full uppercase tracking-widest border border-orange-100">Ready</p>
    </div>

    <div id="textSection" class="space-y-3 transition-all duration-500">
      <div class="flex justify-between items-end px-1">
        <label class="text-xs font-black text-black uppercase tracking-widest">Manual Log</label>
        <span id="syncStatus" class="text-[10px] text-orange-600 font-bold uppercase hidden animate-pulse">Analyzing...</span>
      </div>
      <div class="relative">
        <textarea id="mainTranscript" 
                  rows="4"
                  class="w-full bg-white border-2 border-black rounded-xl p-5 text-black text-sm font-medium leading-relaxed resize-none outline-none industrial-input placeholder:text-gray-400"
                  placeholder="Paste text or type notes here..."
                  oninput="autoResize(this)"></textarea>
        
        <button id="reParseBtn" class="absolute bottom-4 right-4 p-2 bg-orange-500 border-2 border-black text-white rounded-lg active:scale-95 transition-transform hover:bg-orange-600 shadow-sm" title="Analyze Text">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>
    </div>

    <div id="invoicePreview" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-700 space-y-6">
      
      <div class="flex items-center gap-4">
        <div class="h-px bg-black flex-1 opacity-10"></div>
        <span class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-600">Review Data</span>
        <div class="h-px bg-black flex-1 opacity-10"></div>
      </div>

      <div class="bg-white border-2 border-black rounded-2xl p-6 industrial-shadow space-y-6">
        
        <div class="flex justify-between items-center pb-4 border-b-2 border-dashed border-gray-200">
          <h2 class="text-sm font-black uppercase tracking-widest text-black">Job Details</h2>
          <span id="dateDisplay" class="text-xs font-bold text-orange-600"></span>
        </div>

        <div class="space-y-6">
          <div class="space-y-1">
            <label class="block text-[9px] font-bold text-gray-500 uppercase ml-1">Client Name</label>
            <input type="text" id="editClient" class="w-full bg-orange-50/50 border border-orange-100 rounded-lg py-3 px-3 font-bold text-black focus:ring-1 focus:ring-orange-500 outline-none">
          </div>
        <div class="grid grid-cols-2 gap-4" id="laborGrid">
          <div class="space-y-1 relative" id="laborBox" data-taxable="false">
            <label id="timeLabel" class="block text-[9px] font-bold text-gray-500 uppercase ml-1">
              <% current_currency = currencies_data.find { |c| c[:c] == (@profile.currency.presence || "USD") } %>
              <% currency_sym = current_currency[:s] %>
              <%= @profile.billing_mode == "fixed" ? "LABOR PRICE" : "LABOR HOURS" %>
            </label>
            
            <div class="flex items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px]">
              <div class="h-full w-10 border-r-2 border-black flex-shrink-0 relative item-menu-container">
                <button type="button" onclick="toggleMenu(this)" class="labor-tax-toggle w-full h-full flex flex-col items-center justify-center gap-[3px] hover:bg-gray-50 item-menu-btn rounded-l-[10px]">
                  <div class="w-4 h-0.5 bg-black rounded-full transition-colors hamburger-line"></div>
                  <div class="w-4 h-0.5 bg-black rounded-full transition-colors hamburger-line"></div>
                  <div class="w-4 h-0.5 bg-black rounded-full transition-colors hamburger-line"></div>
                </button>
                
                <div class="item-menu-dropdown">
                  <!-- Tax Menu Item -->
                  <div class="menu-item menu-item-tax" onclick="toggleLaborTaxable(this)">
                    <span>Taxable</span>
                    <div class="flex items-center gap-2">
                       <div class="menu-icon">%</div>
                    </div>
                  </div>
                </div>
              </div>
              <input type="text" id="editTime" 
                     inputmode="decimal"
                     onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46"
                     oninput="updateLaborBadge()"
                     class="flex-1 bg-transparent border-none py-3 px-2 font-black text-black focus:ring-0 outline-none text-right min-w-0 text-sm">
              <span class="text-[10px] font-black text-gray-400 mr-3 shrink-0"><%= currency_sym %></span>
              
              <!-- Labor Badges (Hanging) -->
              <div class="absolute -bottom-6 right-2 flex items-center gap-2 z-0 pointer-events-none">
                  <span id="laborTaxBadge" class="badge badge-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
              </div>
            </div>
          </div>

          <div class="space-y-1 relative">
            <label class="block text-[9px] font-bold text-gray-500 uppercase ml-1">After Tax</label>
            <div class="flex items-center border-2 border-black rounded-xl bg-orange-50 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px] px-4">
              <span class="flex-1 text-right font-black text-black" id="laborAfterTaxDisplay">0.00</span>
              <span class="text-xs font-black text-gray-400 ml-2 shrink-0"><%= currency_sym %></span>
            </div>
          </div>
        </div>
        </div>

        <div id="dynamicSections" class="space-y-6"></div>

        <!-- Global Tax Indicator Button -->
        <div id="globalTaxIndicator" class="border-2 border-black rounded-xl py-3 px-4 flex items-center justify-between bg-gray-100 transition-colors">
          <span class="text-[10px] font-black uppercase tracking-widest text-black">Order Taxability</span>
          <div class="flex items-center gap-2">
            <span id="taxIndicatorStatus" class="text-[9px] font-bold uppercase text-gray-500">Partial / No Tax</span>
            <div id="taxIndicatorBulb" class="w-3 h-3 rounded-full bg-gray-400 border border-black shadow-inner"></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <button type="button" onclick="addFullSection()" class="py-3 border-2 border-black rounded-xl text-[10px] font-black text-black uppercase tracking-widest hover:bg-gray-50 transition-colors">
            + Section
          </button>
          <button id="saveButton" class="bg-orange-600 hover:bg-orange-700 text-white border-2 border-black font-black py-3 rounded-xl uppercase text-[10px] tracking-widest transition-all active:scale-[0.98]">
            Confirm Log
          </button>
        </div>

      </div>
    </div>
  </div>

  <div id="errorToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
    <div class="bg-white text-black px-6 py-4 rounded-xl shadow-2xl border-2 border-red-500 flex items-center gap-4">
      <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
      <span id="errorMessage" class="text-xs font-bold uppercase tracking-widest">Error Message</span>
    </div>
  </div>

</div>

<script>

  // Global Tax Variables
  let currentLogTaxScope = "<%= @profile.tax_scope %>";
  const defaultGlobalTaxRate = "<%= @profile.tax_rate.presence || 0 %>";
  const profileBillingMode = "<%= @profile.billing_mode %>";
  const profileHourlyRate = <%= @profile.hourly_rate.to_f %>;

document.addEventListener("DOMContentLoaded", () => {
  const recordBtn = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const transcriptArea = document.getElementById("mainTranscript");
  const reParseBtn = document.getElementById("reParseBtn");
  const micIcon = document.getElementById("micIcon");

  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let recordingStartTime = 0;


  // Close menus when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.item-menu-container')) {
      document.querySelectorAll('.item-menu-dropdown').forEach(d => d.classList.remove('show'));
    }
  });

  recordBtn.onclick = async () => {
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = processAudio;
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        isRecording = true;
        buttonText.innerText = "STOP";
        buttonText.classList.add("text-red-600");
        micIcon.classList.replace("text-orange-600", "text-red-600");
        recordBtn.classList.replace("border-orange-500", "border-red-500");
        document.getElementById("recordingWave").classList.remove("hidden");
        document.getElementById("status").innerText = "RECORDING...";
        document.getElementById("status").classList.replace("text-orange-600", "text-red-600");
        document.getElementById("status").classList.replace("bg-orange-50", "bg-red-50");
      } catch (e) {
        showError("Microphone access required.");
      }
    } else {
      const duration = Date.now() - recordingStartTime;
      if (duration < 1000) {
        mediaRecorder.onstop = null;
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        resetRecorderUI();
        showError("Hold longer to record");
        return; 
      }
      mediaRecorder.stop();
      isRecording = false;
      document.getElementById("status").innerText = "PROCESSING...";
      document.getElementById("recordingWave").classList.add("hidden");
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
  };

  function resetRecorderUI() {
    isRecording = false;
    buttonText.innerText = "TAP TO RECORD";
    buttonText.classList.remove("text-red-600");
    micIcon.classList.replace("text-red-600", "text-orange-600");
    recordBtn.classList.replace("border-red-500", "border-orange-500");
    document.getElementById("status").innerText = "READY";
    document.getElementById("status").classList.replace("text-red-600", "text-orange-600");
    document.getElementById("status").classList.replace("bg-red-50", "bg-orange-50");
    document.getElementById("recordingWave").classList.add("hidden");
  }

  async function processAudio() {
    try {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("audio", audioBlob);

      const res = await fetch("/process_audio", {
        method: "POST",
        headers: { "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content },
        body: formData
      });

      const data = await res.json();
      resetRecorderUI();
      if (!res.ok || data.error) showError(data.error || "Speech not recognized.");
      else updateUI(data);
    } catch (e) {
      resetRecorderUI();
      showError("Network error.");
    }
  }

  reParseBtn.onclick = async () => {
    const text = transcriptArea.value;
    if (!text) return;
    document.getElementById("syncStatus").classList.remove("hidden");
    const res = await fetch("/process_audio", {
      method: "POST",
      headers: { 
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ manual_text: text })
    });
    const data = await res.json();
    document.getElementById("syncStatus").classList.add("hidden");
    if (data.error) showError(data.error);
    else updateUI(data);
  };

  document.getElementById("saveButton").onclick = async function() {
    const saveBtn = this;
    const client = document.getElementById("editClient").value;
    const time = document.getElementById("editTime").value;
    const date = document.getElementById("dateDisplay").innerText;

    const sections = [];
    document.querySelectorAll(".dynamic-section").forEach(sec => {
      const title = sec.querySelector(".section-title").value;
      const items = [];
      sec.querySelectorAll(".item-row").forEach(row => {
        const desc = row.querySelector(".item-input").value;
        const price = row.querySelector(".price-menu-input").value;
        const taxRate = row.querySelector(".tax-menu-input").value;
        const taxable = row.dataset.taxable === "true";
        
        if (desc.trim() !== "") {
          items.push({ 
            desc: desc, 
            price: price, 
            taxable: taxable,
            tax_rate: (taxable && taxRate) ? taxRate : null 
          });
        }
      });
      if (items.length > 0) sections.push({ title, items });
    });

    const res = await fetch("/logs", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content 
      },
      body: JSON.stringify({
        log: { 
          client: client, 
          time: time, 
          date: date, 
          tasks: JSON.stringify(sections),
          tax_scope: currentLogTaxScope,
          labor_taxable: document.getElementById('laborBox').dataset.taxable === "true"
        }
      })
    });

    const result = await res.json();
    if (result.success) {
      saveBtn.innerText = "SAVED";
      saveBtn.classList.replace("bg-orange-600", "bg-green-600");
      saveBtn.classList.replace("border-black", "border-green-800");
      setTimeout(() => { window.location.href = "/history"; }, 600);
    } else {
      showError("Error saving log.");
    }
  };
});

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}

function addFullSection(title = "New Category", items = [""]) {
  const container = document.getElementById("dynamicSections");
  const sectionId = "section_" + Date.now() + Math.random().toString(36).substr(2, 5);
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      <input type="text" value="${title}" class="bg-transparent border-none p-0 text-xs font-black text-orange-600 uppercase tracking-widest focus:ring-0 w-2/3 section-title">
      <div class="flex gap-2 mb-1 shrink-0">
        <button type="button" onclick="addItem('${sectionId}')" 
                class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
          + Item
        </button>
        <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
          Remove
        </button>
      </div>
    </div>
    <div id="${sectionId}" class="pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  items.forEach(item => {
    if (!item) return; // Skip null/undefined items

    let val = "";
    let price = "";
    let taxable = null;
    let taxRate = null;
    
    if (typeof item === 'object') {
      val = item.desc || "";
      if (item.qty && item.qty !== '1' && item.qty !== 'N/A') {
        val += ` (x${item.qty})`;
      }
      price = item.price || "";
      if (item.taxable !== undefined && item.taxable !== null) {
        taxable = item.taxable;
      }
      if (item.tax_rate) {
          taxRate = item.tax_rate;
      }
    } else {
      val = item;
    }
    
    addItem(sectionId, val, price, taxable, title, taxRate);
  });
}

function toggleMenu(btn) {
  const dropdown = btn.nextElementSibling;
  const isShow = dropdown.classList.contains('show');
  
  // Close all others
  document.querySelectorAll('.item-menu-dropdown').forEach(d => d.classList.remove('show'));
  
  if (!isShow) {
    dropdown.classList.add('show');
  }
}

function updateBadge(row) {
  const priceInput = row.querySelector('.price-menu-input');
  const taxInput = row.querySelector('.tax-menu-input');
  const priceBadge = row.querySelector('.badge-price');
  const taxBadge = row.querySelector('.badge-tax');
  const afterTaxBadge = row.querySelector('.badge-after-tax');
  const multiplier = row.querySelector('.badge-multiplier');
  const equals = row.querySelector('.badge-equals');
  
  if (!priceInput || !taxInput) return;

  const priceVal = parseFloat(priceInput.value) || 0;
  const taxRate = parseFloat(taxInput.value) || 0;
  const currencySymbol = row.dataset.symbol;
  const isTaxable = row.dataset.taxable === "true";

  // 1. Update Price Badge
  if (priceVal > 0) {
    priceBadge.innerText = `${currencySymbol}${priceVal.toFixed(2)}`;
    priceBadge.classList.remove('hidden');
  } else {
    priceBadge.classList.add('hidden');
  }

  // 2. Update Tax Badge
  if (isTaxable) {
    const displayRate = parseFloat(taxRate); // Strip .0
    taxBadge.innerText = `${displayRate}%`;
    taxBadge.classList.remove('hidden');
    row.querySelector('.menu-item-tax').classList.add('active');
  } else {
    taxBadge.classList.add('hidden');
    row.querySelector('.menu-item-tax').classList.remove('active');
  }

  // 3. Update Equation visibility and After Tax Badge
  if (isTaxable && priceVal > 0) {
    const taxAmount = priceVal * (taxRate / 100);
    const total = priceVal + taxAmount;
    
    afterTaxBadge.innerText = `${currencySymbol}${total.toFixed(2)}`;
    afterTaxBadge.classList.remove('hidden');
    multiplier.classList.remove('hidden');
    equals.classList.remove('hidden');
  } else {
    afterTaxBadge.classList.add('hidden');
    multiplier.classList.add('hidden');
    equals.classList.add('hidden');
  }
}

function toggleTaxable(menuItem) {
  const row = menuItem.closest('.item-row');
  const isTaxable = row.dataset.taxable === "true";
  
  // Toggle state
  const newTaxableState = !isTaxable;
  row.dataset.taxable = newTaxableState;
  
  const taxInput = row.querySelector('.tax-menu-input');
  
  // If turning ON
  if (newTaxableState) {
     // Default rate logic
     if (!taxInput.value || taxInput.value === "0") {
        taxInput.value = defaultGlobalTaxRate;
     }

     // Auto-enable Price if not active, and populate default if empty
     const priceMenuItem = row.querySelector('.menu-item-price');
     const priceInput = row.querySelector('.price-menu-input');
     
     if (!priceMenuItem.classList.contains('active')) {
        priceMenuItem.classList.add('active');
        if (!priceInput.value || parseFloat(priceInput.value) === 0) {
            priceInput.value = "5"; // Default price
        }
     }
  }
  
  updateBadge(row);
  updateHamburgerGlow(row);
  
  // Update Price visual state (dim if locked)
  const priceMenuItem = row.querySelector('.menu-item-price');
  const priceLabel = priceMenuItem.querySelector('span');
  const priceIcon = priceMenuItem.querySelector('.menu-icon');
  
  if (newTaxableState) {
    priceLabel.style.opacity = "0.5";
    priceIcon.style.opacity = "0.5";
    priceMenuItem.style.cursor = "not-allowed";
  } else {
    priceLabel.style.opacity = "1";
    priceIcon.style.opacity = "1";
    priceMenuItem.style.cursor = "pointer";
  }
  
  // If turning ON, focus the TAX input
  if (newTaxableState) {
    setTimeout(() => taxInput.focus(), 50);
  }

  if (window.updateGlobalTaxIndicator) window.updateGlobalTaxIndicator();
}

function toggleLaborTaxable(menuItem) {
  const laborBox = document.getElementById('laborBox');
  const isTaxable = laborBox.dataset.taxable === "true";
  const newTaxableState = !isTaxable;
  laborBox.dataset.taxable = newTaxableState;
  
  if (newTaxableState) {
    menuItem.classList.add('active');
  } else {
    menuItem.classList.remove('active');
  }
  
  updateLaborBadge();
  updateHamburgerGlow(laborBox);
  if (window.updateGlobalTaxIndicator) window.updateGlobalTaxIndicator();
}

function updateHamburgerGlow(container) {
  // Works for both individual items (row) and Labor section (laborBox)
  const isLabor = container.id === 'laborBox';
  const isTaxable = container.dataset.taxable === "true";
  
  // For items, also check if Price is active
  let hasActiveAction = isTaxable;
  if (!isLabor) {
    const priceActive = container.querySelector('.menu-item-price').classList.contains('active');
    if (priceActive) hasActiveAction = true;
  }

  const hamburgerLines = container.querySelectorAll('.hamburger-line');
  hamburgerLines.forEach(line => {
    if (hasActiveAction) {
      line.classList.replace('bg-black', 'bg-orange-600');
    } else {
      line.classList.replace('bg-orange-600', 'bg-black');
    }
  });
}

function updateLaborBadge() {
  const laborBox = document.getElementById('laborBox');
  const isTaxable = laborBox.dataset.taxable === "true";
  const taxBadge = document.getElementById('laborTaxBadge');
  const timeInput = document.getElementById('editTime');
  const afterTaxDisplay = document.getElementById('laborAfterTaxDisplay');
  const value = parseFloat(timeInput.value) || 0;

  // 1. Badge Visibility & Text
  if (isTaxable && value > 0) {
    const displayRate = parseFloat(defaultGlobalTaxRate); // This strips .0
    taxBadge.innerText = `${displayRate}%`;
    taxBadge.classList.remove('hidden');
  } else {
    taxBadge.classList.add('hidden');
  }

  // 2. AFTER TAX Calculation
  let laborCost = profileBillingMode === 'fixed' ? value : value * profileHourlyRate;
  let tax = 0;
  if (isTaxable) {
    tax = laborCost * (parseFloat(defaultGlobalTaxRate) / 100);
  }
  const total = laborCost + tax;
  afterTaxDisplay.innerText = total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function togglePrice(menuItem) {
  const row = menuItem.closest('.item-row');
  const isTaxable = row.dataset.taxable === "true";
  
  // Prevent disabling if Taxable is ON
  if (isTaxable && menuItem.classList.contains('active')) {
      return; 
  }

  const input = row.querySelector('.price-menu-input');
  
  // Toggle visibility manually
  menuItem.classList.toggle('active');
  
  if (menuItem.classList.contains('active')) {
    // Set default value if empty
    if (!input.value || parseFloat(input.value) === 0) {
        input.value = "5";
        updateBadge(row); // Update badge immediately to show the $5
    }
    setTimeout(() => input.focus(), 50);
  } else {
      // If disabling, clear the value so the badge disappears
      input.value = "";
      updateBadge(row);
  }
  updateHamburgerGlow(row);
}

function addItem(containerId, value = "", price = "", taxable = null, sectionTitle = "", taxRate = null) {
  const currencySymbol = "<%= currencies_data.find { |c| c[:c] == (@profile.currency.presence || 'USD') }[:s] %>";
  
    // Default taxable logic (if valid boolean not provided)
    if (typeof taxable !== 'boolean') {
      const scope = (currentLogTaxScope || "").split(",").map(t => t.trim());
      const isTasks = /task|labor|work|service/i.test(sectionTitle || "");
      const isMaterials = /material|part|supply|expense/i.test(sectionTitle || "");
      
      const taxAll = scope.includes("all") || scope.includes("total");
      const taxLabor = scope.includes("labor");
      const taxTasks = scope.includes("tasks_only");
      const taxMaterials = scope.includes("materials_only");

      if (taxAll) {
        taxable = true;
      } else {
        if (isTasks && taxTasks) taxable = true;
        else if (isMaterials && taxMaterials) taxable = true;
        else taxable = false;
      }
    }

    // Update global indicator whenever something is added
    if (window.updateGlobalTaxIndicator) setTimeout(window.updateGlobalTaxIndicator, 50);
    
    // Default Tax Rate
    const globalRate = defaultGlobalTaxRate; 
    if (taxRate === null || taxRate === undefined) {
        taxRate = globalRate;
    }
  
    const div = document.createElement('div');
    div.dataset.taxable = taxable;
    div.dataset.symbol = currencySymbol;
    // Adjusted margin (mb-8) for optimal spacing
    div.className = "flex items-center gap-2 mb-8 w-full animate-in fade-in slide-in-from-left-2 duration-300 item-row";
    
    // Inputs (Price and Tax)
    const hasPrice = price && price !== "" && price !== "0" && price !== "0.00";
    const priceVal = hasPrice ? price : "";
    
    const priceActiveClass = hasPrice ? "active" : "";
    const taxActiveClass = taxable ? "active" : "";
    
    // Style for locked state
    const lockedStyle = taxable ? 'opacity: 0.5;' : '';
    const cursorStyle = taxable ? 'cursor: not-allowed;' : '';
    
    div.innerHTML = `
      <div class="flex flex-1 items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] min-w-0 main-item-box transition-colors relative">
        
        <!-- Hamburger Menu Container -->
        <div class="relative h-10 w-10 border-r-2 border-black flex-shrink-0 item-menu-container">
          <button type="button" onclick="toggleMenu(this)" class="w-full h-full flex flex-col items-center justify-center gap-[3px] hover:bg-gray-50 item-menu-btn rounded-l-[10px]">
            <div class="w-4 h-0.5 bg-black rounded-full transition-colors hamburger-line"></div>
            <div class="w-4 h-0.5 bg-black rounded-full transition-colors hamburger-line"></div>
            <div class="w-4 h-0.5 bg-black rounded-full transition-colors hamburger-line"></div>
          </button>
          
          <div class="item-menu-dropdown">
            <!-- Price Menu Item -->
            <div class="menu-item menu-item-price ${priceActiveClass}" onclick="togglePrice(this)"
                 style="${cursorStyle}">
              <span style="${lockedStyle}">Price</span>
              <div class="flex items-center gap-2">
                 <div class="menu-input-container" onclick="event.stopPropagation()">
                    <input type="number" step="0.01" class="menu-input price-menu-input text-right" 
                           value="${priceVal}" placeholder="0.00" 
                           oninput="updateBadge(this.closest('.item-row'))">
                    <span class="text-[10px] font-bold text-gray-400 ml-1">${currencySymbol}</span>
                 </div>
                 <div class="menu-icon" style="${lockedStyle}">$</div>
              </div>
            </div>
            
            <!-- Tax Menu Item -->
            <div class="menu-item menu-item-tax ${taxActiveClass}" onclick="toggleTaxable(this)">
              <span>Taxable</span>
              <div class="flex items-center gap-2">
                 <div class="menu-input-container" onclick="event.stopPropagation()">
                    <input type="number" step="0.1" class="menu-input tax-menu-input text-right" 
                           value="${parseFloat(taxRate) > 0 ? parseFloat(taxRate) : globalRate}" placeholder="%" 
                           oninput="updateBadge(this.closest('.item-row'))">
                    <span class="text-[10px] font-bold text-gray-400 ml-1">%</span>
                 </div>
                 <div class="menu-icon">%</div>
              </div>
            </div>
          </div>
        </div>
  
        <input type="text" value="${value}" 
               class="flex-1 bg-transparent border-none text-sm font-bold text-black focus:ring-0 py-2 px-3 item-input placeholder:text-gray-300 min-w-0 rounded-r-xl"
               placeholder="Work description...">
        
        <!-- Badges Container (Hanging Bottom Right) -->
        <div class="absolute -bottom-6 right-2 flex items-center gap-2 z-0 pointer-events-none">
            <span class="badge badge-price hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
            <div class="badge-operator badge-multiplier hidden mx-0.5 flex items-center justify-center">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </div>
            <span class="badge badge-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
            <div class="badge-operator badge-equals hidden mx-0.5 flex items-center justify-center">
                <svg width="12" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="5" stroke-linecap="round"><path d="M4 8h16M4 16h16"/></svg>
            </div>
            <span class="badge badge-after-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
        </div>
      </div>
      
      <button type="button" 
              onclick="this.parentElement.remove(); if(window.updateGlobalTaxIndicator) window.updateGlobalTaxIndicator();" 
              class="w-6 h-10 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors font-bold text-xl flex-shrink-0">
        Ã—
      </button>
    `;
    document.getElementById(containerId).appendChild(div);
    updateBadge(div);
    updateHamburgerGlow(div);
}

function updateUI(data) {
  try {
    const transcriptArea = document.getElementById("mainTranscript");
    if (data.raw_summary) {
      transcriptArea.value = data.raw_summary;
      autoResize(transcriptArea);
    }
    document.getElementById("editClient").value = data.client || "";
    
    // Set tax scope
    currentLogTaxScope = data.tax_scope || "<%= @profile.tax_scope %>";
    
    const billingMode = "<%= @profile.billing_mode %>";
    const defaultRate = "<%= @profile.hourly_rate %>";
    if (billingMode === "fixed") {
      document.getElementById("editTime").value = data.time && data.time !== "" && data.time !== "0" ? data.time : defaultRate;
    } else {
      document.getElementById("editTime").value = data.time || "";
    }

    // Handle Labor Taxable initial state based on scope
    const laborBox = document.getElementById('laborBox');
    const laborMenuItem = laborBox.querySelector('.menu-item-tax');
    const hamburgerLines = laborBox.querySelectorAll('.hamburger-line');
    const scope = (currentLogTaxScope || "").split(",").map(t => t.trim());
    const laborTaxableByDefault = scope.includes("all") || scope.includes("total") || scope.includes("labor");
    
    laborBox.dataset.taxable = laborTaxableByDefault;
    if (laborTaxableByDefault) {
      laborMenuItem.classList.add('active');
    } else {
      laborMenuItem.classList.remove('active');
    }
    updateLaborBadge();
    updateHamburgerGlow(laborBox);

  
    let dateVal = data.date;
    if (!dateVal || dateVal === "N/A" || dateVal.toLowerCase().includes("specified")) {
      dateVal = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    document.getElementById("dateDisplay").innerText = dateVal;
  
    const sectionContainer = document.getElementById("dynamicSections");
    sectionContainer.innerHTML = "";
    if (data.sections && data.sections.length > 0) {
      data.sections.forEach(sec => addFullSection(sec.title, sec.items));
    } else if (data.tasks) {
      addFullSection("Tasks", Array.isArray(data.tasks) ? data.tasks : [data.tasks]);
    }
  
    document.getElementById("invoicePreview").classList.remove("hidden");
    document.getElementById("invoicePreview").scrollIntoView({ behavior: 'smooth' });
  } catch (e) {
    showError("UI Update Error: " + e.message);
    console.error(e);
  }
}

function showError(msg) {
  const toast = document.getElementById("errorToast");
  const msgSpan = document.getElementById("errorMessage");
  msgSpan.innerText = msg;
  toast.classList.remove("hidden");
  setTimeout(() => { toast.classList.add("hidden"); }, 4000);
}
  window.updateGlobalTaxIndicator = function() {
    const indicator = document.getElementById("globalTaxIndicator");
    const statusText = document.getElementById("taxIndicatorStatus");
    const bulb = document.getElementById("taxIndicatorBulb");
    const itemRows = document.querySelectorAll(".item-row");
    
    if (itemRows.length === 0) {
      // Default state based on scope if no items
      const isAll = (currentLogTaxScope === "all" || currentLogTaxScope === "total");
      setIndicator(isAll);
      return;
    }

    let allTaxable = true;
    
    // Check Labor taxable state
    const laborBox = document.getElementById('laborBox');
    if (laborBox && laborBox.dataset.taxable !== "true") allTaxable = false;

    itemRows.forEach(row => {
      if (row.dataset.taxable !== "true") allTaxable = false;
    });

    setIndicator(allTaxable);

    function setIndicator(active) {
      if (active) {
        indicator.classList.replace("bg-gray-100", "bg-orange-600");
        indicator.classList.add("border-orange-700");
        statusText.innerText = "Full Tax Active";
        statusText.classList.replace("text-gray-500", "text-white");
        bulb.classList.replace("bg-gray-400", "bg-white");
        bulb.classList.add("animate-pulse");
      } else {
        indicator.className = indicator.className.replace(/bg-orange-600|border-orange-700/, "bg-gray-100");
        statusText.innerText = "Partial / No Tax";
        statusText.classList.replace("text-white", "text-gray-500");
        bulb.className = bulb.className.replace(/bg-white|animate-pulse/, "bg-gray-400");
      }
    }
  };

  // Initial call
  setTimeout(window.updateGlobalTaxIndicator, 100);
</script>
