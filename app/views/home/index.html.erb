<style>
  #mainTranscript {
    transition: height 0.1s ease;
    min-height: 120px;
  }
  .industrial-shadow {
    box-shadow: 4px 4px 0px 0px #F97316;
  }
  .industrial-input:focus {
    box-shadow: 2px 2px 0px 0px #F97316;
    transform: translate(-1px, -1px);
  }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
  /* Animation for the pop-up price field */
  .price-badge-container.hidden {
    display: none;
  }
  
  /* Item Operations Menu */
  .item-menu-btn {
    transition: all 0.2s;
  }
  .item-menu-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: -2px;
    background: white;
    border: 2px solid black;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
    z-index: 50;
    box-shadow: 3px 3px 0px 0px rgba(0,0,0,1);
    width: calc(100% + 4px);
    padding: 6px;
  }
  .item-menu-dropdown.show {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .slider-icon path {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-item {
    position: relative; /* For dropright positioning */
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 12px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.1s;
    background: white;
    color: #525252;
    border: 1px solid transparent;
  }
  .menu-item:hover {
    background: #FFF7ED;
    color: #EA580C;
  }
  .menu-item.active {
    background-color: #FFEDD5; /* Orange-100 */
    color: #EA580C;
    border: 1px solid #EA580C;
    border-bottom: none;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }
  .menu-item-discount.active {
    background-color: #DCFCE7; /* Green-100 */
    color: #16A34A;
    border: 1px solid #16A34A;
    border-bottom: none;
  }
  .menu-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 900;
    color: #a3a3a3;
  }
  .menu-item:hover .menu-icon {
    color: #EA580C;
    background: rgba(234, 88, 12, 0.1);
  }
  .menu-item.active .menu-icon {
    background: #EA580C;
    color: white;
  }
  .menu-item-discount.active .menu-icon {
    background: #16A34A;
    color: white;
  }
  .menu-item-discount:hover .menu-icon {
    color: #16A34A;
    background: #DCFCE7;
  }
  
  /* Dropright Input */
  .menu-input-container {
    display: none;
    position: absolute;
    left: 100%;
    top: 0;
    margin-left: 8px;
    background: white;
    padding: 4px;
    border: 2px solid black;
    border-radius: 6px;
    box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
    z-index: 60;
    align-items: center;
    gap: 4px;
  }
  .menu-item.active .menu-input-container {
    display: flex;
    animation: fadeIn 0.1s ease-out;
  }
  .menu-input {
    width: 60px;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    padding: 4px;
    font-size: 11px;
    font-weight: 700;
    color: black;
    outline: none;
  }
  .menu-input:focus {
    border-color: #F97316;
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    padding: 0 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    border: 1px solid transparent;
  }
  .badge.hidden { display: none; }
  
  .badge-price, .badge-tax, .badge-after-tax {
    background-color: #EA580C;
    color: white;
    border: 1px solid black;
  }
  .badge-discount {
    background-color: #16A34A; /* Green-600 */
    color: white;
    border: 1px solid black;
  }
  
  /* Green Active State for Discount Menu */
  .menu-item-discount.active {
    background-color: #DCFCE7; /* Green-100 */
    color: #16A34A; /* Green-600 */
    border-color: #16A34A;
    border-bottom-left-radius: 0; 
    border-bottom-right-radius: 0;
    border-bottom: none;
    z-index: 10; /* Sit above inputs */
  }
  .menu-item-discount.active .menu-icon {
    background-color: #16A34A;
    color: white;
  }
  
  .discount-inputs-row {
    border-color: #16A34A; /* Match active green */
    border-width: 0 1px 1px 1px; /* Sides and bottom only */
    border-style: solid;
    border-radius: 0 0 6px 6px;
    margin-top: -1px; /* Overlap border */
    background-color: #F0FDF4; /* Very light green bg to match */
    padding: 6px; /* slightly more padding */
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="min-h-screen bg-white text-black font-sans p-4 pb-32">
  
  <header class="flex justify-between items-center mb-12 pt-2 px-1">
    <div class="flex items-center gap-2">
      <div class="w-3 h-8 bg-orange-600"></div>
      <h1 class="text-2xl font-black tracking-tighter text-black uppercase italic">
        SITE<span class="text-orange-600">LOGGER</span>
      </h1>
    </div>
    
    <div class="flex gap-3">
      <%= link_to history_path, class: "p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "History" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      <% end %>

      <%= link_to settings_path, class: "p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group", title: "Profile" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      <% end %>
    </div>
  </header>

  <div class="max-w-md mx-auto space-y-10">
    
    <div class="flex flex-col items-center justify-center">
      <div id="recordingWave" class="hidden absolute w-48 h-48 border-4 border-orange-200 rounded-full animate-ping"></div>
      
      <button id="recordButton" class="relative w-36 h-36 rounded-full bg-white border-[6px] border-orange-500 shadow-xl flex flex-col items-center justify-center transition-all active:scale-95 group hover:bg-orange-50">
        <svg id="micIcon" class="w-10 h-10 text-orange-600 mb-1 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <span id="buttonText" class="text-black text-[10px] font-black uppercase tracking-widest text-center px-2 mt-1">TAP TO RECORD</span>
      </button>
      
      <p id="status" class="mt-6 text-xs font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full uppercase tracking-widest border border-orange-100">Ready</p>
    </div>

    <div id="textSection" class="space-y-3 transition-all duration-500">
      <div class="flex justify-between items-end px-1">
        <label class="text-xs font-black text-black uppercase tracking-widest">Manual Log</label>
        <span id="syncStatus" class="text-[10px] text-orange-600 font-bold uppercase hidden animate-pulse">Analyzing...</span>
      </div>
      <div class="relative">
        <textarea id="mainTranscript" 
                  rows="4"
                  class="w-full bg-white border-2 border-black rounded-xl p-5 text-black text-sm font-medium leading-relaxed resize-none outline-none industrial-input placeholder:text-gray-400"
                  placeholder="Paste text or type notes here..."
                  oninput="autoResize(this)"></textarea>
        
        <button id="reParseBtn" class="absolute bottom-4 right-4 p-2 bg-orange-500 border-2 border-black text-white rounded-lg active:scale-95 transition-transform hover:bg-orange-600 shadow-sm" title="Analyze Text">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>
    </div>

    <div id="invoicePreview" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-700 space-y-6">
      
      <div class="flex items-center gap-4">
        <div class="h-px bg-black flex-1 opacity-10"></div>
        <span class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-600">Review Data</span>
        <div class="h-px bg-black flex-1 opacity-10"></div>
      </div>

      <div class="bg-white border-2 border-black rounded-2xl p-6 industrial-shadow space-y-6">
        
        <div class="flex justify-between items-center pb-4 border-b-2 border-dashed border-gray-200">
          <h2 class="text-sm font-black uppercase tracking-widest text-black">Job Details</h2>
          <span id="dateDisplay" class="text-xs font-bold text-orange-600"></span>
        </div>

        <div class="space-y-6">
          <div class="space-y-1">
            <label class="block text-[9px] font-bold text-gray-500 uppercase ml-1">Client Name</label>
            <div class="border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px] flex items-center">
              <input type="text" id="editClient" 
                     class="w-full bg-transparent border-none text-base font-black text-black focus:ring-0 py-3 px-3 outline-none placeholder:text-gray-300"
                     placeholder="Enter client name...">
            </div>
          </div>
        <div class="grid grid-cols-2 gap-4" id="laborGrid">
          <div class="space-y-1 relative" id="laborBox" data-taxable="false" data-billing-mode="<%= @profile.billing_mode %>">
            <label id="timeLabel" class="block text-[9px] font-bold text-gray-500 uppercase ml-1">
              <% current_currency = currencies_data.find { |c| c[:c] == (@profile.currency.presence || "USD") } %>
              <% currency_sym = current_currency[:s] %>
              <%= @profile.billing_mode == "fixed" ? "LABOR PRICE" : "LABOR HOURS" %>
            </label>
            
            <div class="flex items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px]">
              <div class="h-full w-10 border-r-2 border-black flex-shrink-0 item-menu-container">
                <button type="button" onclick="toggleMenu(this)" class="labor-tax-toggle w-full h-full flex flex-col items-center justify-center gap-[3px] hover:bg-gray-50 item-menu-btn rounded-l-[10px]">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-colors slider-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path d="M3 4h18M3 12h18M3 20h18" />
                    <path class="slider-head-1" d="M12 2v4" />
                    <path class="slider-head-2" d="M12 10v4" />
                    <path class="slider-head-3" d="M12 18v4" />
                  </svg>
                </button>
                
                <div class="item-menu-dropdown">
                  <!-- Tax Menu Item -->
                  <div class="tax-wrapper flex flex-col w-full">
                      <div class="menu-item menu-item-tax" onclick="toggleLaborTaxable(this)">
                        <span>Taxable</span>
                        <div class="menu-icon">%</div>
                      </div>
                      
                      <div class="tax-inputs-row hidden gap-1 p-1 bg-orange-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-orange-600 rounded-b-md"
                           style="grid-template-columns: 1fr;">
                           <div class="relative w-full">
                             <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                             <input type="number" step="0.1" class="menu-input tax-menu-input text-right w-full border-orange-200 pl-4 pr-1" 
                                    style="width: 100%"
                                    value="<%= @profile.tax_rate.presence || 0 %>" placeholder="%" 
                                    oninput="updateLaborBadge()">
                           </div>
                      </div>
                  </div>
                  <!-- Discount Menu Item -->
                  <div class="discount-wrapper flex flex-col w-full">
                      <div class="menu-item menu-item-discount" onclick="toggleDiscount(this)">
                        <span>Discount</span>
                        <div class="menu-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                          </svg>
                        </div>
                      </div>
                      
                       <div class="discount-inputs-row hidden grid gap-1 p-1 bg-green-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-green-600 rounded-b-md"
                            style="grid-template-columns: 1fr 1fr;">
                            <div class="relative flex-1">
                              <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">$</span>
                              <input type="number" step="0.01" class="menu-input discount-flat-input text-right w-full border-gray-300 pl-4 pr-1" 
                                    style="width: 100%"
                                    placeholder="0.00" 
                                    oninput="updateLaborBadge()">
                            </div>
                            <div class="relative flex-1">
                              <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                              <input type="number" step="0.1" class="menu-input discount-percent-input text-right w-full border-gray-300 pl-4 pr-1" 
                                    style="width: 100%"
                                    placeholder="0" 
                                    oninput="updateLaborBadge()">
                           </div>
                      </div>
                  </div>
                </div>
              </div>
              <input type="text" id="editTime" 
                     inputmode="decimal"
                     onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46"
                     oninput="updateLaborBadge()"
                     class="flex-1 bg-transparent border-none py-3 px-2 font-black text-black focus:ring-0 outline-none text-right min-w-0 text-sm">
              <span id="laborUnitIndicator" class="text-[10px] font-black text-gray-400 mr-3 shrink-0"><%= currency_sym %></span>
              
              <!-- Labor Badges (Hanging) -->
              <div class="absolute -bottom-6 left-2 flex items-center gap-2 z-0 pointer-events-none">
                  <span id="laborDiscountBadge" class="badge badge-discount hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"></span>
              </div>
              <div class="absolute -bottom-6 right-2 flex items-center gap-2 z-0 pointer-events-none">
                  <span id="laborTaxBadge" class="badge badge-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
              </div>
            </div>
          </div>

          <div class="space-y-1 relative">
            <label class="block text-[9px] font-bold text-gray-500 uppercase ml-1">After Tax</label>
            <div class="flex items-center border-2 border-black rounded-xl bg-orange-50 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] relative h-[52px] px-4">
              <span class="flex-1 text-right font-black text-black" id="laborAfterTaxDisplay">0.00</span>
              <span class="text-xs font-black text-gray-400 ml-2 shrink-0"><%= currency_sym %></span>
            </div>
          </div>
        </div>
        </div>

        <div id="dynamicSections" class="space-y-6 pt-6"></div>



        <div class="grid grid-cols-2 gap-3 pt-2">
          <button type="button" onclick="addFullSection()" class="py-3 border-2 border-black rounded-xl text-[10px] font-black text-black uppercase tracking-widest hover:bg-gray-50 transition-colors">
            + Section
          </button>
          <button id="saveButton" class="bg-orange-600 hover:bg-orange-700 text-white border-2 border-black font-black py-3 rounded-xl uppercase text-[10px] tracking-widest transition-all active:scale-[0.98]">
            Confirm Log
          </button>
        </div>

      </div>
    </div>
  </div>

  <div id="errorToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
    <div class="bg-white text-black px-6 py-4 rounded-xl shadow-2xl border-2 border-red-500 flex items-center gap-4">
      <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
      <span id="errorMessage" class="text-xs font-bold uppercase tracking-widest">Error Message</span>
    </div>
  </div>

</div>

<script>
  function cleanNum(val) {
    if (val === null || val === undefined || val === "") return "";
    let f = parseFloat(val);
    if (isNaN(f)) return val;
    return (f % 1 === 0) ? f.toString() : f.toFixed(2).replace(/\.?0+$/, "");
  }

  // Global Tax Variables
  let currentLogTaxScope = "<%= @profile.tax_scope %>";
  const defaultGlobalTaxRate = "<%= @profile.tax_rate.presence || 0 %>";
  const profileBillingMode = "<%= @profile.billing_mode %>";
  const profileHourlyRate = <%= @profile.hourly_rate.to_f %>;
  
  // Inject Currency Data (Defined in ApplicationHelper)
  const CURRENCIES = <%= currencies_data.to_json.html_safe %>;
  // Initialize with profile default
  let activeCurrencyCode = "<%= @profile.currency.presence || 'USD' %>";
  let activeCurrencySymbol = CURRENCIES.find(c => c.c === activeCurrencyCode)?.s || "$";

document.addEventListener("DOMContentLoaded", () => {
  const recordBtn = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const transcriptArea = document.getElementById("mainTranscript");
  const reParseBtn = document.getElementById("reParseBtn");
  const micIcon = document.getElementById("micIcon");

  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let recordingStartTime = 0;


  // Close menus when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.item-menu-container')) {
      document.querySelectorAll('.item-menu-dropdown.show').forEach(d => {
        d.classList.remove('show');
        const btn = d.previousElementSibling;
        if (btn) {
          btn.classList.remove('active');
          randomizeIcon(btn);
        }
        
        const container = d.closest('.border-2.rounded-xl');
        if (container) {
          container.style.borderBottomLeftRadius = '';
          container.style.borderBottomRightRadius = '';
        }
      });
    }
  });
  
  // Initial randomization for Labor Box
  const laborIconContainer = document.querySelector('#laborBox .item-menu-btn');
  if (laborIconContainer) randomizeIcon(laborIconContainer);

  recordBtn.onclick = async () => {
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = processAudio;
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        isRecording = true;
        buttonText.innerText = "STOP";
        buttonText.classList.add("text-red-600");
        micIcon.classList.replace("text-orange-600", "text-red-600");
        recordBtn.classList.replace("border-orange-500", "border-red-500");
        document.getElementById("recordingWave").classList.remove("hidden");
        document.getElementById("status").innerText = "RECORDING...";
        document.getElementById("status").classList.replace("text-orange-600", "text-red-600");
        document.getElementById("status").classList.replace("bg-orange-50", "bg-red-50");
      } catch (e) {
        showError("Microphone access required.");
      }
    } else {
      const duration = Date.now() - recordingStartTime;
      if (duration < 1000) {
        mediaRecorder.onstop = null;
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        resetRecorderUI();
        showError("Hold longer to record");
        return; 
      }
      mediaRecorder.stop();
      isRecording = false;
      document.getElementById("status").innerText = "PROCESSING...";
      document.getElementById("recordingWave").classList.add("hidden");
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
  };

  function resetRecorderUI() {
    isRecording = false;
    buttonText.innerText = "TAP TO RECORD";
    buttonText.classList.remove("text-red-600");
    micIcon.classList.replace("text-red-600", "text-orange-600");
    recordBtn.classList.replace("border-red-500", "border-orange-500");
    document.getElementById("status").innerText = "READY";
    document.getElementById("status").classList.replace("text-red-600", "text-orange-600");
    document.getElementById("status").classList.replace("bg-red-50", "bg-orange-50");
    document.getElementById("recordingWave").classList.add("hidden");
  }

  async function processAudio() {
    try {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("audio", audioBlob);

      const res = await fetch("/process_audio", {
        method: "POST",
        headers: { "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content },
        body: formData
      });

      const data = await res.json();
      resetRecorderUI();
      if (!res.ok || data.error) showError(data.error || "Speech not recognized.");
      else updateUI(data);
    } catch (e) {
      resetRecorderUI();
      showError("Network error.");
    }
  }

  reParseBtn.onclick = async () => {
    const text = transcriptArea.value;
    if (!text) return;
    document.getElementById("syncStatus").classList.remove("hidden");
    const res = await fetch("/process_audio", {
      method: "POST",
      headers: { 
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ manual_text: text })
    });
    const data = await res.json();
    document.getElementById("syncStatus").classList.add("hidden");
    if (data.error) showError(data.error);
    else updateUI(data);
  };

  document.getElementById("saveButton").onclick = async function() {
    const saveBtn = this;
    const client = document.getElementById("editClient").value;
    const time = document.getElementById("editTime").value;
    const date = document.getElementById("dateDisplay").innerText;

    const sections = [];
    document.querySelectorAll(".dynamic-section").forEach(sec => {
      const title = sec.querySelector(".section-title").value;
      const items = [];
      sec.querySelectorAll(".item-row").forEach(row => {
        const desc = row.querySelector(".item-input").value;
        const price = row.querySelector(".price-menu-input").value;
        const taxRate = row.querySelector(".tax-menu-input").value;
        const taxable = row.dataset.taxable === "true";
        
        // Discounts
        const discFlat = row.querySelector(".discount-flat-input").value;
        const discPercent = row.querySelector(".discount-percent-input").value;
        
        if (desc.trim() !== "") {
          items.push({ 
            desc: desc, 
            price: price, 
            taxable: taxable,
            tax_rate: (taxable && taxRate) ? taxRate : null,
            discount_flat: discFlat,
            discount_percent: discPercent
          });
        }
      });
      if (items.length > 0) sections.push({ title, items });
    });

    const laborDiscFlat = document.querySelector('#laborBox .discount-flat-input')?.value || "";
    const laborDiscPercent = document.querySelector('#laborBox .discount-percent-input')?.value || "";

    const res = await fetch("/logs", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content 
      },
      body: JSON.stringify({
        log: { 
          client: client, 
          time: time, 
          date: date, 
          tasks: JSON.stringify(sections),
          tax_scope: currentLogTaxScope,
          labor_taxable: document.getElementById('laborBox').dataset.taxable === "true",
          labor_discount_flat: laborDiscFlat,
          labor_discount_percent: laborDiscPercent
        }
      })
    });

    const result = await res.json();
    if (result.success) {
      saveBtn.innerText = "SAVED";
      saveBtn.classList.replace("bg-orange-600", "bg-green-600");
      saveBtn.classList.replace("border-black", "border-green-800");
      setTimeout(() => { window.location.href = "/history"; }, 600);
    } else {
      showError("Error saving log.");
    }
  };
});

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}

function addFullSection(title = "New Category", items = [""]) {
  const container = document.getElementById("dynamicSections");
  const sectionId = "section_" + Date.now() + Math.random().toString(36).substr(2, 5);
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      <input type="text" value="${title}" class="bg-transparent border-none p-0 text-xs font-black text-orange-600 uppercase tracking-widest focus:ring-0 w-2/3 section-title">
      <div class="flex gap-2 mb-1 shrink-0">
        <button type="button" onclick="addItem('${sectionId}')" 
                class="bg-orange-600 text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,1)] hover:bg-orange-700 transition-colors whitespace-nowrap">
          + Item
        </button>
        <button type="button" onclick="this.closest('.dynamic-section').remove()" 
                class="bg-black text-white px-2.5 py-0.5 rounded-md font-black uppercase text-[9px] shadow-[1px_1px_0px_0px_rgba(0,0,0,0.3)] hover:bg-gray-800 transition-colors whitespace-nowrap">
          Remove
        </button>
      </div>
    </div>
    <div id="${sectionId}" class="pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  items.forEach(item => {
    if (!item) return; // Skip null/undefined items

    let val = "";
    let price = "";
    let taxable = null;
    let taxRate = null;
    let discFlat = "";
    let discPercent = "";
    
    if (typeof item === 'object') {
      val = item.desc || "";
      if (item.qty && item.qty !== '1' && item.qty !== 'N/A') {
        val += ` (x${item.qty})`;
      }
      price = item.price || "";
      if (item.taxable !== undefined && item.taxable !== null) {
        taxable = item.taxable;
      }
      if (item.tax_rate) {
          taxRate = item.tax_rate;
      }
      discFlat = item.discount_flat || "";
      discPercent = item.discount_percent || "";
    } else {
      val = item;
    }
    
    addItem(sectionId, val, price, taxable, title, taxRate, (item.qty && item.qty !== 'N/A') ? item.qty : 1, discFlat, discPercent);
  });
}

function randomizeIcon(container) {
  const heads = container.querySelectorAll('path[class^="slider-head-"]');
  heads.forEach(h => {
      const rand = (Math.random() * 14) - 7;
      h.style.transform = `translateX(${rand}px)`;
  });
}

function toggleMenu(btn) {
  const dropdown = btn.nextElementSibling;
  const isShow = dropdown.classList.contains('show');
  
  // Close all others and reset their container corners
  document.querySelectorAll('.item-menu-dropdown.show').forEach(d => {
      // Don't close the one we just clicked (toggle logic handles it)
      if (d === dropdown) return;

      d.classList.remove('show');
      // Remove active class from buttons
      const otherBtn = d.previousElementSibling;
      if (otherBtn) {
          otherBtn.classList.remove('active');
          randomizeIcon(otherBtn);
      }
      
      // Reset corners of their containers
      const container = d.closest('.border-2.rounded-xl');
      if (container) {
          container.style.borderBottomLeftRadius = '';
          container.style.borderBottomRightRadius = '';
      }
  });
  
  if (!isShow) {
    dropdown.classList.add('show');
    btn.classList.add('active');
    
    // Rerandomize on click for extra dynamic feel
    randomizeIcon(btn);
    
    // "Labor as Master" Width Logic
    const laborBox = document.getElementById('laborBox');
    const isLaborBox = btn.closest('#laborBox');
    const container = btn.closest('.border-2.rounded-xl');
    
    if (isLaborBox) {
        // Labor Box: Full width dropdown, so square off BOTH bottom corners
        if (container) {
            container.style.borderBottomLeftRadius = '0';
            container.style.borderBottomRightRadius = '0';
        }
        dropdown.style.width = ''; // Reset to CSS default
    } else {
        // Items: Dropdown is partial width (matches Labor), so square off ONLY bottom-left
        if (container) {
            container.style.borderBottomLeftRadius = '0';
            // Leave bottom-right rounded
        }
        
        const laborInputContainer = laborBox.querySelector('.flex.items-center.border-2');
        if (laborInputContainer) {
            const masterWidth = laborInputContainer.offsetWidth; 
            dropdown.style.width = (masterWidth + 4) + 'px';
        }
    }
  } else {
    // Already open, so close it
    dropdown.classList.remove('show');
    btn.classList.remove('active');
    randomizeIcon(btn);
    
    // Reset corners
    const container = btn.closest('.border-2.rounded-xl');
    if (container) {
        container.style.borderBottomLeftRadius = '';
        container.style.borderBottomRightRadius = '';
    }
  }
}

function updateBadge(row) {
  const priceInput = row.querySelector('.price-menu-input');
  const taxInput = row.querySelector('.tax-menu-input');
  const priceBadge = row.querySelector('.badge-price');
  const taxBadge = row.querySelector('.badge-tax');
  const afterTaxBadge = row.querySelector('.badge-after-tax');
  const multiplier = row.querySelector('.badge-multiplier');
  const equals = row.querySelector('.badge-equals');
  
  if (!priceInput || !taxInput) return;

  const priceVal = parseFloat(priceInput.value) || 0;
  const taxRate = parseFloat(taxInput.value) || 0;
  const currencySymbol = row.dataset.symbol;
  const isTaxable = row.dataset.taxable === "true";
  const qtyVal = parseFloat(row.dataset.qty) || 1;
  
  // Discount Calculation & Validation
  const discFlatInput = row.querySelector('.discount-flat-input');
  const discPercentInput = row.querySelector('.discount-percent-input');
  
  let discFlat = parseFloat(discFlatInput ? discFlatInput.value : 0) || 0;
  let discPercent = parseFloat(discPercentInput ? discPercentInput.value : 0) || 0;
  
  const baseTotal = priceVal * qtyVal;
  
  // Validation: Cap Percentage at 100
  if (discPercent > 100) {
      discPercent = 100;
      discPercentInput.value = "100"; // Visual Clamp
  }
  
  // Validation: Cap Flat at BaseTotal
  if (discFlat > baseTotal) {
      discFlat = baseTotal;
      discFlatInput.value = cleanNum(baseTotal); // Visual Clamp
  }
  
  // Priority: If Percent is present, it might override or add? 
  // User said "one will say $ for flat, the other % for percentage". Usually mutually exclusive or additive.
  // Implementation plan: Additive (Flat + Percent of Base).
  // But Validation says "Discount cannot be... more than the actual price".
  
  let discountAmount = discFlat + (baseTotal * (discPercent / 100));
  
  // Final Cap on Total Discount
  if (discountAmount > baseTotal) {
      discountAmount = baseTotal;
      // If we hit this, it means the combination exceeded total. 
      // We could clamp the flat amount down? Or just clamp the result.
      // Clamping result covers it.
  }
  
  const subtotal = Math.max(0, baseTotal - discountAmount); // Pre-tax subtotal after discount



  // 1. Update Price Badge
  if (baseTotal > 0) {
    priceBadge.innerText = `${currencySymbol}${cleanNum(baseTotal)}`;
    priceBadge.classList.remove('hidden');
  } else {
    priceBadge.classList.add('hidden');
  }

  // 1.5 Update Discount Badge
  const discountBadge = row.querySelector('.badge-discount');
  if (discountAmount > 0) {
    if (discPercent > 0 && discFlat === 0) {
        // Show Percentage if only percent used
        const displayPercent = cleanNum(discPercent);
        discountBadge.innerText = `-${displayPercent}%`;
    } else {
        // Show Amount
        discountBadge.innerText = `-${currencySymbol}${cleanNum(discountAmount)}`;
    }
    discountBadge.classList.remove('hidden');
  } else {
    discountBadge.classList.add('hidden');
  }

  // 2. Update Tax Badge - Only show if taxable AND has a price
  if (isTaxable && subtotal > 0) {
    const displayRate = parseFloat(taxRate); // Strip .0
    taxBadge.innerText = `${displayRate}%`;
    taxBadge.classList.remove('hidden');
    row.querySelector('.menu-item-tax').classList.add('active');
  } else {
    taxBadge.classList.add('hidden');
    row.querySelector('.menu-item-tax').classList.toggle('active', isTaxable);
  }

  // 3. Update Equation visibility and Result Badge
  if (isTaxable && subtotal > 0) {
    const taxAmount = subtotal * (taxRate / 100);
    
    afterTaxBadge.innerText = `${currencySymbol}${cleanNum(taxAmount)}`;
    afterTaxBadge.classList.remove('hidden');
    multiplier.classList.remove('hidden');
    equals.classList.remove('hidden');
  } else {
    afterTaxBadge.classList.add('hidden');
    multiplier.classList.add('hidden');
    equals.classList.add('hidden');
  }
}

function toggleTaxable(menuItem) {
  /* New Toggle Taxable Logic */
  const row = menuItem.closest('.item-row');
  const wrapper = menuItem.closest('.tax-wrapper');
  const taxInputRow = wrapper.querySelector('.tax-inputs-row');
  const taxInput = wrapper.querySelector('.tax-menu-input');
  
  const priceWrapper = row.querySelector('.price-wrapper');
  const priceInputRow = priceWrapper.querySelector('.price-inputs-row');
  const priceMenuItem = row.querySelector('.menu-item-price');
  const priceInput = row.querySelector('.price-menu-input');
  const priceLabel = priceMenuItem.querySelector('span'); 
  const priceIcon = priceMenuItem.querySelector('.menu-icon');

  // Toggle Taxable State
  let newTaxableState = false;
  if (menuItem.classList.contains('active')) {
     menuItem.classList.remove('active');
     taxInputRow.classList.add('hidden');
     taxInputRow.classList.remove('grid');
     newTaxableState = false;
  } else {
     menuItem.classList.add('active');
     taxInputRow.classList.remove('hidden');
     taxInputRow.classList.add('grid');
     if (!taxInput.value) {
        taxInput.value = defaultGlobalTaxRate;
     }

     // Auto-enable Price if not active, and populate default if empty
     if (!priceMenuItem.classList.contains('active')) {
        priceMenuItem.classList.add('active');
        priceInputRow.classList.remove('hidden'); // SHOW PRICE INPUT
        priceInputRow.classList.add('grid');
        if (!priceInput.value || parseFloat(priceInput.value) === 0) {
            priceInput.value = "10"; // Default price
        }
     }
     newTaxableState = true;
  }
  
  row.dataset.taxable = newTaxableState; // Keep dataset sync
  updateBadge(row);
  updateHamburgerGlow(row);
  
  // --- DEPENDENCY LOGIC ---
  if (newTaxableState) {
       priceLabel.style.opacity = "0.5";
       priceIcon.style.opacity = "0.5";
       priceMenuItem.style.cursor = "not-allowed";
  } else {
       const discountMenuItem = row.querySelector('.menu-item-discount');
       const isDiscountActive = discountMenuItem && discountMenuItem.classList.contains('active');
       
       if (!isDiscountActive) {
           priceLabel.style.opacity = "1";
           priceIcon.style.opacity = "1";
           priceMenuItem.style.cursor = "pointer";
       }
  }

  // If turning ON, focus the TAX input
  if (newTaxableState) {
    setTimeout(() => taxInput.focus(), 50);
  }
}

function toggleLaborTaxable(menuItem) {
  const laborBox = document.getElementById('laborBox');
  const isTaxable = laborBox.dataset.taxable === "true";
  const newTaxableState = !isTaxable;
  laborBox.dataset.taxable = newTaxableState;
  
  const wrapper = menuItem.closest('.tax-wrapper');
  const taxInputRow = wrapper.querySelector('.tax-inputs-row');
  const taxInput = wrapper.querySelector('.tax-menu-input');
  
  if (newTaxableState) {
    menuItem.classList.add('active');
    taxInputRow.classList.remove('hidden');
    taxInputRow.classList.add('grid');
    if (!taxInput.value || taxInput.value === "0") {
         // Should pull default from somewhere if needed, currently value is in HTML or user set
    }
    setTimeout(() => taxInput.focus(), 50);
  } else {
    menuItem.classList.remove('active');
    taxInputRow.classList.add('hidden');
    taxInputRow.classList.remove('grid');
  }
  
  updateLaborBadge();
  updateHamburgerGlow(laborBox);
}

function updateHamburgerGlow(container) {
  const isLabor = container.id === 'laborBox';
  const isTaxable = container.dataset.taxable === "true";
  const discountMenuItem = container.querySelector('.menu-item-discount');
  const isDiscountActive = discountMenuItem && discountMenuItem.classList.contains('active');
  let isOrange = isTaxable;
  if (!isLabor) {
    const priceActive = container.querySelector('.menu-item-price').classList.contains('active');
    if (priceActive) isOrange = true;
  }
  const sliderIcon = container.querySelector('.slider-icon');
  if (sliderIcon) {
    if (isOrange) {
      sliderIcon.classList.remove('text-black', 'text-green-600');
      sliderIcon.classList.add('text-orange-600');
    } else if (isDiscountActive) {
      sliderIcon.classList.remove('text-black', 'text-orange-600');
      sliderIcon.classList.add('text-green-600');
    } else {
      sliderIcon.classList.remove('text-orange-600', 'text-green-600');
      sliderIcon.classList.add('text-black');
    }
  }
}

function updateLaborBadge() {
  const laborBox = document.getElementById('laborBox');
  const isTaxable = laborBox.dataset.taxable === "true";
  const taxBadge = document.getElementById('laborTaxBadge');
  const timeInput = document.getElementById('editTime');
  const afterTaxDisplay = document.getElementById('laborAfterTaxDisplay');
  const value = parseFloat(timeInput.value) || 0;
  const taxInput = laborBox.querySelector('.tax-menu-input');
  let currentTaxRate = taxInput && taxInput.value ? parseFloat(taxInput.value) : (parseFloat(laborBox.dataset.taxRate) || parseFloat(defaultGlobalTaxRate));
  const discFlatInput = laborBox.querySelector('.discount-flat-input');
  const discPercentInput = laborBox.querySelector('.discount-percent-input');
  let discFlat = parseFloat(discFlatInput ? discFlatInput.value : 0) || 0;
  let discPercent = parseFloat(discPercentInput ? discPercentInput.value : 0) || 0;
  const billingMode = laborBox.dataset.billingMode || profileBillingMode;
  const currentHourlyRate = parseFloat(laborBox.dataset.hourlyRate) || profileHourlyRate;
  const baseCost = billingMode === 'fixed' ? value : value * currentHourlyRate;
  if (discPercent > 100) { discPercent = 100; discPercentInput.value = "100"; }
  if (discFlat > baseCost && baseCost > 0) { discFlat = baseCost; discFlatInput.value = cleanNum(baseCost); }
  let discountAmount = discFlat + (baseCost * (discPercent / 100));
  if (discountAmount > baseCost) discountAmount = baseCost;
  const laborCost = Math.max(0, baseCost - discountAmount);
  const discountBadge = document.getElementById('laborDiscountBadge');
  if (discountAmount > 0) {
    const currencySym = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
    if (discPercent > 0 && discFlat === 0) {
        discountBadge.innerText = `-${cleanNum(discPercent)}%`;
    } else {
        discountBadge.innerText = `-${currencySym}${cleanNum(discountAmount)}`;
    }
    discountBadge.classList.remove('hidden');
  } else {
    discountBadge.classList.add('hidden');
  }
  if (isTaxable && laborCost > 0) {
    taxBadge.innerText = `${cleanNum(currentTaxRate)}%`;
    taxBadge.classList.remove('hidden');
  } else {
    taxBadge.classList.add('hidden');
  }
  let tax = isTaxable ? laborCost * (currentTaxRate / 100) : 0;
  const total = laborCost + tax;
  afterTaxDisplay.innerText = total.toLocaleString(undefined, { maximumFractionDigits: 2 });
}


function togglePrice(menuItem) {
  const row = menuItem.closest('.item-row');
  const isTaxable = row.dataset.taxable === "true";
  
  // Prevent disabling if Taxable is ON OR Discount is ON
  const discountMenuItem = row.querySelector('.menu-item-discount');
  const isDiscount = discountMenuItem && discountMenuItem.classList.contains('active');
  
  if ((isTaxable || isDiscount) && menuItem.classList.contains('active')) {
      return; 
  }

  const wrapper = menuItem.closest('.price-wrapper');
  const priceInputRow = wrapper.querySelector('.price-inputs-row');
  const priceInput = wrapper.querySelector('.price-menu-input');
  
  // If globally disabled (due to Taxable/Discount being active), prevent interaction
  if (menuItem.style.cursor === "not-allowed") return;
  
  if (menuItem.classList.contains('active')) {
    menuItem.classList.remove('active');
    priceInputRow.classList.add('hidden');
    priceInputRow.classList.remove('grid');
    priceInput.value = ""; 
  } else {
    menuItem.classList.add('active');
    priceInputRow.classList.remove('hidden');
    priceInputRow.classList.add('grid');
    // Set default value if empty when activating
    if (!priceInput.value || parseFloat(priceInput.value) === 0) {
        priceInput.value = "10";
    }
    setTimeout(() => priceInput.focus(), 50);
  }
  
  updateBadge(row);
  updateHamburgerGlow(row);
}

function toggleDiscount(menuItem) {
  const container = menuItem.closest('.item-row') || menuItem.closest('#laborBox');
  const wrapper = menuItem.closest('.discount-wrapper');
  const inputsRow = wrapper.querySelector('.discount-inputs-row');
  
  menuItem.classList.toggle('active');
  const isActive = menuItem.classList.contains('active');
  
  const flatInput = inputsRow.querySelector('.discount-flat-input');
  
  if (isActive) {
      inputsRow.classList.remove('hidden');
      inputsRow.classList.add('grid'); // Ensure grid layout
      
      // 1. Auto-Activate and Lock Price (for Items) FIRST
      if (container.id !== 'laborBox') {
          const priceMenuItem = container.querySelector('.menu-item-price');
          const priceInputRow = container.querySelector('.price-inputs-row');
          const priceInput = container.querySelector('.price-menu-input');
          const priceLabel = priceMenuItem.querySelector('span');
          const priceIcon = priceMenuItem.querySelector('.menu-icon');
          
          if (!priceMenuItem.classList.contains('active')) {
              priceMenuItem.classList.add('active');
              // SHOW PRICE INPUT ROW
              priceInputRow.classList.remove('hidden');
              priceInputRow.classList.add('grid');
              
              if (!priceInput.value || parseFloat(priceInput.value) === 0) {
                  priceInput.value = "10";
              }
          }
          // Lock UI
          priceLabel.style.opacity = "0.5";
          priceIcon.style.opacity = "0.5";
          priceMenuItem.style.cursor = "not-allowed";
      }

      // 2. Set Default Discount Value (5)
      const percentVal = inputsRow.querySelector('.discount-percent-input').value;
      if (!flatInput.value || flatInput.value === "0" || flatInput.value === "") {
          if (!percentVal || percentVal === "0" || percentVal === "") {
              flatInput.value = "5";
          }
      }
      
      // 3. Update Badges
      if (container.id === 'laborBox') updateLaborBadge();
      else updateBadge(container);
      
      setTimeout(() => flatInput.focus(), 50);

  } else {
      inputsRow.classList.add('hidden');
      // Clear inputs
      const percentInput = inputsRow.querySelector('.discount-percent-input');
      if(flatInput) flatInput.value = "";
      if(percentInput) percentInput.value = "";
      
      // Unlock Price UI if needed (for Items)
      if (container.id !== 'laborBox') {
          const priceMenuItem = container.querySelector('.menu-item-price');
          const priceLabel = priceMenuItem.querySelector('span');
          const priceIcon = priceMenuItem.querySelector('.menu-icon');
          const isTaxable = container.dataset.taxable === "true";
          
          // Only unlock if Taxable is ALSO not active
          if (!isTaxable) {
              priceLabel.style.opacity = "1";
              priceIcon.style.opacity = "1";
              priceMenuItem.style.cursor = "pointer";
          }
      }
      
      if (container.id === 'laborBox') updateLaborBadge();
      else updateBadge(container);
  }
  
  updateHamburgerGlow(container);
}

function addItem(containerId, value = "", price = "", taxable = null, sectionTitle = "", taxRate = null, qty = 1, discFlat = "", discPercent = "") {
  // Use global currency symbol if available, fallback to profile default (which initializes it anyway)
  const currencySymbol = typeof activeCurrencySymbol !== 'undefined' ? activeCurrencySymbol : "$";
  
    // Default taxable logic (if valid boolean not provided)
    if (typeof taxable !== 'boolean') {
      const scope = (currentLogTaxScope || "").split(",").map(t => t.trim());
      const isTasks = /task|labor|work|service/i.test(sectionTitle || "");
      const isMaterials = /material|part|supply|expense/i.test(sectionTitle || "");
      
      const taxAll = scope.includes("all") || scope.includes("total");
      const taxLabor = scope.includes("labor");
      const taxTasks = scope.includes("tasks_only");
      const taxMaterials = scope.includes("materials_only");

      const hasPrice = price && price !== "" && parseFloat(price) !== 0;

      if (taxAll) {
        taxable = hasPrice;
      } else {
        if (isTasks && taxTasks && hasPrice) taxable = true;
        else if (isMaterials && taxMaterials && hasPrice) taxable = true;
        else taxable = false;
      }
    }


    
    // Default Tax Rate
    const globalRate = defaultGlobalTaxRate; 
    if (taxRate === null || taxRate === undefined) {
        taxRate = globalRate;
    }
  
    const div = document.createElement('div');
    div.dataset.taxable = taxable;
    div.dataset.symbol = currencySymbol;
    div.dataset.qty = qty || 1;
    // Adjusted margin (mb-8) for optimal spacing
    div.className = "flex items-center gap-2 mb-8 w-full animate-in fade-in slide-in-from-left-2 duration-300 item-row";
    
    // Inputs (Price and Tax)
    const hasPrice = price && price !== "" && price !== "0" && price !== "0.00";
    const priceVal = hasPrice ? cleanNum(price) : "";
    
    // Discount Logic for Initial Load
    const hasDiscount = (discFlat && parseFloat(discFlat) > 0) || (discPercent && parseFloat(discPercent) > 0);
    const discActiveClass = hasDiscount ? "active" : "";
    const discFlatVal = discFlat ? cleanNum(discFlat) : "";
    const discPercentVal = discPercent ? cleanNum(discPercent) : "";
    
    const priceActiveClass = hasPrice ? "active" : "";
    const taxActiveClass = taxable ? "active" : "";
    
    // Style for locked state
    const lockedStyle = taxable ? 'opacity: 0.5;' : '';
    const cursorStyle = taxable ? 'cursor: not-allowed;' : '';
    
    div.innerHTML = `
      <div class="flex flex-1 items-center border-2 border-black rounded-xl bg-white shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] min-w-0 main-item-box transition-colors relative">
        
        <!-- Hamburger Menu Container -->
        <div class="h-10 w-10 border-r-2 border-black flex-shrink-0 item-menu-container">
          <button type="button" onclick="toggleMenu(this)" class="w-full h-full flex flex-col items-center justify-center gap-[3px] hover:bg-gray-50 item-menu-btn rounded-l-[10px]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-colors slider-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path d="M3 4h18M3 12h18M3 20h18" />
              <path class="slider-head-1" d="M12 2v4" />
              <path class="slider-head-2" d="M12 10v4" />
              <path class="slider-head-3" d="M12 18v4" />
            </svg>
          </button>
          
          <div class="item-menu-dropdown">
            
            <!-- Tax Menu Item (MOVED TOP) -->
            <div class="tax-wrapper flex flex-col w-full">
                <div class="menu-item menu-item-tax ${taxActiveClass}" onclick="toggleTaxable(this)">
                  <span>Taxable</span>
                  <div class="menu-icon">%</div>
                </div>
                
                <div class="tax-inputs-row ${taxable ? 'grid' : 'hidden'} gap-1 p-1 bg-orange-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-orange-600 rounded-b-md"
                     style="grid-template-columns: 1fr;">
                     <div class="relative w-full">
                       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                       <input type="number" step="0.1" class="menu-input tax-menu-input text-right w-full border-orange-200 pl-4 pr-1" 
                              style="width: 100%"
                              value="${parseFloat(taxRate) > 0 ? parseFloat(taxRate) : globalRate}" placeholder="%" 
                              oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                </div>
            </div>

            <!-- Price Menu Item (Moved Middle) -->
            <div class="price-wrapper flex flex-col w-full">
                <div class="menu-item menu-item-price ${priceActiveClass}" onclick="togglePrice(this)"
                     style="${cursorStyle}">
                  <span style="${lockedStyle}">Price</span>
                  <div class="menu-icon price-menu-icon" style="${lockedStyle}">${currencySymbol}</div>
                </div>

                <div class="price-inputs-row ${hasPrice ? 'grid' : 'hidden'} gap-1 p-1 bg-orange-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-orange-600 rounded-b-md"
                     style="grid-template-columns: 1fr;">
                     <div class="relative w-full">
                        <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400 price-input-symbol">${currencySymbol}</span>
                        <input type="number" step="0.01" class="menu-input price-menu-input text-right w-full border-orange-200 pl-4 pr-1" 
                               style="width: 100%"
                               value="${priceVal}" placeholder="0.00" 
                               oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                </div>
            </div>

            <!-- Discount Menu Item (Moved Last) -->
            <div class="discount-wrapper flex flex-col w-full">
                <div class="menu-item menu-item-discount ${discActiveClass}" onclick="toggleDiscount(this)">
                  <span>Discount</span>
                  <div class="menu-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                    </svg>
                  </div>
                </div>
                
                <!-- Inline Input Container -->
                <div class="discount-inputs-row ${hasDiscount ? 'grid' : 'hidden'} gap-1 p-1 bg-green-50 animate-in slide-in-from-top-1 duration-200 border border-t-0 border-green-600 rounded-b-md" 
                     style="grid-template-columns: 1fr 1fr;">
                     <div class="relative w-full">
                       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400 discount-flat-symbol">${currencySymbol}</span>
                       <input type="number" step="0.01" class="menu-input discount-flat-input text-right w-full border-gray-300 pl-4 pr-1" 
                              style="width: 100%"
                              value="${discFlatVal}"
                              placeholder="0.00" 
                              oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                     <div class="relative w-full">
                       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">%</span>
                       <input type="number" step="0.1" class="menu-input discount-percent-input text-right w-full border-gray-300 pl-4 pr-1" 
                              style="width: 100%"
                              value="${discPercentVal}"
                              placeholder="0" 
                              oninput="updateBadge(this.closest('.item-row'))">
                     </div>
                </div>
            </div>

          </div>
        </div>
  
        <input type="text" value="${value}" 
               class="flex-1 bg-transparent border-none text-sm font-bold text-black focus:ring-0 py-2 px-3 item-input placeholder:text-gray-300 min-w-0 rounded-r-xl"
               placeholder="Work description...">
        
        <!-- Badges Container (Hanging Bottom Right) -->
        <div class="absolute -bottom-6 left-2 flex items-center gap-2 z-0 pointer-events-none">
            <span class="badge badge-discount hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]"></span>
        </div>
        <div class="absolute -bottom-6 right-2 flex items-center gap-1 z-0 pointer-events-none">
            <span class="badge badge-price hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
            <div class="badge-operator badge-multiplier hidden flex items-center justify-center">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </div>
            <span class="badge badge-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
            <div class="badge-operator badge-equals hidden flex items-center justify-center">
                <svg width="12" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="5" stroke-linecap="round"><path d="M4 8h16M4 16h16"/></svg>
            </div>
            <span class="badge badge-after-tax hidden shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] border border-black bg-orange-600 text-white"></span>
        </div>
      </div>
      
      <button type="button" 
              onclick="this.parentElement.remove();" 
              class="w-6 h-10 flex items-center justify-center text-gray-300 hover:text-red-500 transition-colors font-bold text-xl flex-shrink-0">
        
      </button>
    `;
    // Finalize
    document.getElementById(containerId).appendChild(div);
    randomizeIcon(div); // RANDOMIZE ON CREATION
    setTimeout(() => { updateBadge(div); updateHamburgerGlow(div); }, 50);
    return div;
}

function updateUI(data) {
  try {
    const transcriptArea = document.getElementById("mainTranscript");
    if (data.raw_summary) {
      transcriptArea.value = data.raw_summary;
      autoResize(transcriptArea);
    }
    document.getElementById("editClient").value = data.client || "";
    const laborBox = document.getElementById('laborBox');
    
    // Set tax scope (AI-detected or profile default)
    currentLogTaxScope = data.tax_scope || "<%= @profile.tax_scope %>";
    
    // Billing Mode & Time Label synchronization
    const billingMode = data.billing_mode || "<%= @profile.billing_mode %>";
    const defaultRate = "<%= @profile.hourly_rate %>";
    
    // Currency Update Logic
    // Reset to profile default first (so we don't stick to a previous query's currency)
    activeCurrencyCode = "<%= @profile.currency.presence || 'USD' %>";
    
    if (data.currency) {
      activeCurrencyCode = data.currency;
    }
    
    const found = CURRENCIES.find(c => c.c === activeCurrencyCode);
    if (found) activeCurrencySymbol = found.s;
    const currencySymbol = activeCurrencySymbol;
    
    // Update Labor Unit Indicator
    const timeLabel = document.getElementById("timeLabel");
    const laborUnitIndicator = document.getElementById("laborUnitIndicator");
    
    if (timeLabel) {
      timeLabel.innerText = billingMode === "fixed" ? "LABOR PRICE" : "LABOR HOURS";
    }
    
    if (laborUnitIndicator) {
      if (billingMode === "hourly") {
         laborUnitIndicator.innerHTML = `
           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
             <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>`;
      } else {
         laborUnitIndicator.innerText = currencySymbol;
      }
    }
    
    // Update Labor After Tax Symbol
    const afterTaxSym = document.querySelector('#laborAfterTaxDisplay + span');
    if (afterTaxSym) afterTaxSym.innerText = currencySymbol;
    
    // Update Labor Discount Flat Symbol
    const laborDiscSym = document.querySelector('#laborBox .discount-inputs-row span.absolute:first-child');
    // Using a more robust selector if above is fragile: 
    // The structure is fixed: .discount-inputs-row > div:first-child > span (this is the $)
    const laborDiscRow = document.querySelector('#laborBox .discount-inputs-row');
    if (laborDiscRow) {
        const flatSym = laborDiscRow.querySelector('div:first-child span.absolute');
        if (flatSym) flatSym.innerText = currencySymbol;
    }

    // Update ALL dynamic items (Price icon and input symbols)
    document.querySelectorAll('.price-menu-icon').forEach(el => el.innerText = currencySymbol);
    document.querySelectorAll('.price-input-symbol').forEach(el => el.innerText = currencySymbol);
    document.querySelectorAll('.discount-flat-symbol').forEach(el => el.innerText = currencySymbol);
    document.querySelectorAll('.badge-price').forEach(el => {
        // Since badges often contain calculations, we might need a more complex update logic
        // but for now, we'll let updateBadge handle it since it's called in most places.
        // However, updating the symbol inside the badge text if it's static is good.
    });

    // Update ANY existing items/badges if they differ (though usually we clear sections below, but labor might persist)
    // Actually sections are cleared below (sectionContainer.innerHTML = ""), so we only need to worry about Labor Box here.
    // However, if we preserve any state, we should be careful. 
    // Data from AI usually replaces everything.
    
    if (laborBox) {
      laborBox.dataset.billingMode = billingMode;
      // ... (rest of laborBox logic)
      if (data.hourly_rate) {
        laborBox.dataset.hourlyRate = data.hourly_rate;
      }
      if (data.labor_tax_rate) {
        laborBox.dataset.taxRate = data.labor_tax_rate;
        const laborTaxInput = laborBox.querySelector('.tax-menu-input');
        if (laborTaxInput) laborTaxInput.value = data.labor_tax_rate;
      }
    }
    
    // ... (rest of function continues)
    
    // *IMPORTANT*: Since sections are rebuilt below using `addFullSection` -> `addItem`, 
    // we need to make sure `addItem` uses the global `activeCurrencySymbol`.
    // I will update addItem separately.

    if (billingMode === "fixed") {
      document.getElementById("editTime").value = data.fixed_price && data.fixed_price !== "" && data.fixed_price !== "0" ? cleanNum(data.fixed_price) : (cleanNum(data.time) || defaultRate);
    } else {
      document.getElementById("editTime").value = cleanNum(data.labor_hours || data.time || "");
    }

    // Handle Labor Taxable initial state based on scope
    const laborMenuItem = laborBox.querySelector('.menu-item-tax');
    const hamburgerLines = laborBox.querySelectorAll('.hamburger-line');
    const scope = (currentLogTaxScope || "").split(",").map(t => t.trim());
    
    // Explicit override from AI vs Scope-based default
    const laborTime = document.getElementById("editTime").value;
    const hasLaborValue = laborTime && laborTime !== "" && parseFloat(laborTime) !== 0;
    
    let laborTaxableByDefault = (scope.includes("all") || scope.includes("total") || scope.includes("labor")) && hasLaborValue;
    if (typeof data.labor_taxable === 'boolean') {
      laborTaxableByDefault = data.labor_taxable;
    }
    
    laborBox.dataset.taxable = laborTaxableByDefault;
    const laborTaxInputRow = laborBox.querySelector('.tax-inputs-row');
    
    if (laborTaxableByDefault) {
      laborMenuItem.classList.add('active');
      laborTaxInputRow.classList.remove('hidden');
      laborTaxInputRow.classList.add('grid');
    } else {
      laborMenuItem.classList.remove('active');
      laborTaxInputRow.classList.add('hidden');
      laborTaxInputRow.classList.remove('grid');
    }

    // Populate Labor Discount
    const lDiscFlat = data.labor_discount_flat || "";
    const lDiscPercent = data.labor_discount_percent || "";
    laborBox.querySelector('.discount-flat-input').value = lDiscFlat ? cleanNum(lDiscFlat) : "";
    laborBox.querySelector('.discount-percent-input').value = lDiscPercent ? cleanNum(lDiscPercent) : "";
    const laborDiscountInputs = laborBox.querySelector('.discount-inputs-row');
    if ((lDiscFlat && parseFloat(lDiscFlat) > 0) || (lDiscPercent && parseFloat(lDiscPercent) > 0)) {
        laborBox.querySelector('.menu-item-discount').classList.add('active');
        laborDiscountInputs.classList.remove('hidden');
        laborDiscountInputs.classList.add('grid');
    } else {
        laborBox.querySelector('.menu-item-discount').classList.remove('active');
        laborDiscountInputs.classList.add('hidden');
        laborDiscountInputs.classList.remove('grid');
    }
    
    updateLaborBadge();
    updateHamburgerGlow(laborBox);

  
    let dateVal = data.date;
    if (!dateVal || dateVal === "N/A" || dateVal.toLowerCase().includes("specified")) {
      dateVal = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    document.getElementById("dateDisplay").innerText = dateVal;
  
    const sectionContainer = document.getElementById("dynamicSections");
    sectionContainer.innerHTML = "";
    if (data.sections && data.sections.length > 0) {
      data.sections.forEach(sec => addFullSection(sec.title, sec.items));
    } else if (data.tasks) {
      addFullSection("Tasks", Array.isArray(data.tasks) ? data.tasks : [data.tasks]);
    }
  
    document.getElementById("invoicePreview").classList.remove("hidden");
    document.getElementById("invoicePreview").scrollIntoView({ behavior: 'smooth' });
  } catch (e) {
    showError("UI Update Error: " + e.message);
    console.error(e);
  }
}

function showError(msg) {
  const toast = document.getElementById("errorToast");
  const msgSpan = document.getElementById("errorMessage");
  msgSpan.innerText = msg;
  toast.classList.remove("hidden");
  setTimeout(() => { toast.classList.add("hidden"); }, 4000);
}
</script>
