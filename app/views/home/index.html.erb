<div class="flex flex-col items-center space-y-6 max-w-md mx-auto mt-10 pb-20">
  
  <div class="text-center">
    <h1 class="text-4xl font-bold text-gray-800 tracking-tight italic">SiteLogger</h1>
    <p class="text-gray-500 mt-2 font-light">Tap below to log your job</p>
    <div class="mt-4">
      <%# This is the standard Rails way to link to the history page %>
      <%= link_to "View History", "/history", class: "text-blue-600 hover:text-blue-800 font-medium underline flex items-center justify-center gap-1" %>
    </div>
  </div>

  <button 
    id="recordButton"
    type="button"
    class="w-48 h-48 rounded-full bg-red-600 shadow-xl flex items-center justify-center transition-all active:scale-95 hover:bg-red-700 border-4 border-white ring-4 ring-red-100 cursor-pointer">
    <span id="buttonText" class="text-white font-bold text-2xl uppercase tracking-widest">RECORD</span>
  </button>

  <div 
    id="invoicePreview" 
    class="hidden w-full bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 mt-8">
    
    <div class="bg-blue-600 px-6 py-4">
      <h2 class="text-lg font-semibold text-white italic">Review & Confirm</h2>
      <p class="text-blue-100 text-xs">Verify the AI's work before saving.</p>
    </div>

    <div class="p-6 space-y-4">

    <div class="bg-amber-50 border border-amber-200 p-3 rounded-lg">
  <label class="text-[10px] font-bold text-amber-600 uppercase">AI Transcript</label>
  <p id="rawSummary" class="text-sm text-amber-900 italic">Waiting for processing...</p>
</div>

<div>
  <label class="text-[10px] font-bold text-red-500 uppercase tracking-wider italic">Raw Transcript (What AI Heard)</label>
  <div id="rawTranscript" class="w-full mt-1 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-800 italic">
    Waiting for audio...
  </div>
</div>

      <div>
        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Client Name</label>
        <input type="text" id="editClient" class="w-full border-b border-gray-200 focus:border-blue-500 outline-none py-1 text-lg font-medium text-gray-900 bg-transparent">
      </div>

      <div>
        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Time Spent</label>
        <input type="text" id="editTime" class="w-full border-b border-gray-200 focus:border-blue-500 outline-none py-1 text-lg font-medium text-gray-900 bg-transparent">
      </div>

      <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
        <span class="text-[10px] font-bold text-gray-400 uppercase">Date</span>
        <span id="dateField" class="text-sm text-gray-600 font-medium"></span>
      </div>

      <div>
        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Tasks Performed</label>
        <textarea id="editTasks" class="w-full mt-1 p-3 border border-gray-100 rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-400 outline-none min-h-[80px] text-sm text-gray-800"></textarea>
      </div>

      <div>
        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Materials Used</label>
        <textarea id="editMaterials" class="w-full mt-1 p-3 border border-gray-100 rounded-lg bg-gray-50 focus:ring-1 focus:ring-blue-400 outline-none min-h-[60px] text-sm text-gray-800"></textarea>
      </div>

      <button 
        id="saveButton"
        type="button"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
        CONFIRM & SAVE
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const button = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const outputDiv = document.getElementById("invoicePreview");
  
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;

  button.addEventListener("click", async () => {
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = sendAudioToServer;
        mediaRecorder.start();
        isRecording = true;
        buttonText.innerText = "STOP";
        button.classList.add("animate-pulse", "bg-red-800");
      } catch (err) {
        alert("Microphone error. Make sure you are on HTTPS or localhost.");
        console.error(err);
      }
    } else {
      mediaRecorder.stop();
      isRecording = false;
      buttonText.innerText = "WAIT...";
      button.classList.remove("animate-pulse", "bg-red-800");
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
  });

  async function sendAudioToServer() {
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const formData = new FormData();
    formData.append("audio", audioBlob, "recording.webm");
    
    // Fail-safe for the CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

    try {
      const response = await fetch("/process_audio", {
        method: "POST",
        headers: { "X-CSRF-Token": csrfToken },
        body: formData
      });

      const data = await response.json();
      
      if (data.error) {
        alert("AI could not understand: " + data.error);
        buttonText.innerText = "RECORD";
      } else {
        outputDiv.classList.remove("hidden");
        buttonText.innerText = "DONE";
        
        // Populate fields
        document.getElementById("rawTranscript").innerText = data.raw_summary || "No transcript generated.";
        document.getElementById("rawSummary").innerText = data.raw_summary || "Could not transcribe.";
        document.getElementById("editClient").value = data.client || "";
        document.getElementById("editTime").value = data.time || "";
        document.getElementById("dateField").innerText = data.date || new Date().toLocaleDateString();
        
        // Join arrays with new lines for easier editing
        document.getElementById("editTasks").value = Array.isArray(data.tasks) ? data.tasks.join("\n") : (data.tasks || "");
        document.getElementById("editMaterials").value = Array.isArray(data.materials) ? data.materials.join("\n") : (data.materials || "");
        
        outputDiv.scrollIntoView({ behavior: 'smooth' });
      }
    } catch (error) {
      console.error(error);
      alert("Network error occurred.");
      buttonText.innerText = "ERROR";
    }
  }

  // Temporary local success feedback
  document.getElementById("saveButton").addEventListener("click", function() {
    this.innerText = "SUCCESS!";
    this.classList.replace("bg-green-600", "bg-blue-600");
    setTimeout(() => {
        window.location.href = "/history";
    }, 800);
  });
});
</script>