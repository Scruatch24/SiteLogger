<style>
  #mainTranscript {
    transition: height 0.1s ease;
    min-height: 120px;
  }
  .industrial-shadow {
    box-shadow: 4px 4px 0px 0px #F97316;
  }
  .industrial-input:focus {
    box-shadow: 2px 2px 0px 0px #F97316;
    transform: translate(-1px, -1px);
  }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }
</style>

<div class="min-h-screen bg-white text-black font-sans p-4 pb-32">
  
  <header class="flex justify-between items-center mb-12 pt-2 px-1">
    <div class="flex items-center gap-2">
      <div class="w-3 h-8 bg-orange-600"></div>
      <h1 class="text-2xl font-black tracking-tighter text-black uppercase italic">
        SITE<span class="text-orange-600">LOGGER</span>
      </h1>
    </div>
    
    <div class="flex gap-3">
      <%= link_to history_path, class: "p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      <% end %>
      <%= link_to settings_path, class: "p-2 bg-white border-2 border-black rounded-lg hover:bg-orange-50 transition hover:border-orange-500 group" do %>
        <svg class="h-6 w-6 text-black group-hover:text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      <% end %>
    </div>
  </header>

  <div class="max-w-md mx-auto space-y-10">
    
    <div class="flex flex-col items-center justify-center">
      <div id="recordingWave" class="hidden absolute w-48 h-48 border-4 border-orange-200 rounded-full animate-ping"></div>
      
      <button id="recordButton" class="relative w-36 h-36 rounded-full bg-white border-[6px] border-orange-500 shadow-xl flex flex-col items-center justify-center transition-all active:scale-95 group hover:bg-orange-50">
        <svg id="micIcon" class="w-10 h-10 text-orange-600 mb-1 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <span id="buttonText" class="text-black text-[10px] font-black uppercase tracking-widest text-center px-2 mt-1">TAP TO RECORD</span>
      </button>
      
      <p id="status" class="mt-6 text-xs font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full uppercase tracking-widest border border-orange-100">Ready</p>
    </div>

    <div id="textSection" class="space-y-3 transition-all duration-500">
      <div class="flex justify-between items-end px-1">
        <label class="text-xs font-black text-black uppercase tracking-widest">Manual Log</label>
        <span id="syncStatus" class="text-[10px] text-orange-600 font-bold uppercase hidden animate-pulse">Analyzing...</span>
      </div>
      <div class="relative">
        <textarea id="mainTranscript" 
                  rows="4"
                  class="w-full bg-white border-2 border-black rounded-xl p-5 text-black text-sm font-medium leading-relaxed resize-none outline-none industrial-input placeholder:text-gray-400"
                  placeholder="Paste text or type notes here..."
                  oninput="autoResize(this)"></textarea>
        
        <button id="reParseBtn" class="absolute bottom-4 right-4 p-2 bg-orange-500 border-2 border-black text-white rounded-lg active:scale-95 transition-transform hover:bg-orange-600 shadow-sm" title="Analyze Text">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>
    </div>

    <div id="invoicePreview" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-700 space-y-6">
      
      <div class="flex items-center gap-4">
        <div class="h-px bg-black flex-1 opacity-10"></div>
        <span class="text-[10px] font-black uppercase tracking-[0.2em] text-orange-600">Review Data</span>
        <div class="h-px bg-black flex-1 opacity-10"></div>
      </div>

      <div class="bg-white border-2 border-black rounded-2xl p-6 industrial-shadow space-y-6">
        
        <div class="flex justify-between items-center pb-4 border-b-2 border-dashed border-gray-200">
          <h2 class="text-sm font-black uppercase tracking-widest text-black">Job Details</h2>
          <span id="dateDisplay" class="text-xs font-bold text-orange-600"></span>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <label class="block text-[9px] font-bold text-gray-500 uppercase">Client Name</label>
            <input type="text" id="editClient" class="w-full bg-orange-50/50 border border-orange-100 rounded-lg py-3 px-3 font-bold text-black focus:ring-1 focus:ring-orange-500 outline-none">
          </div>
<div class="space-y-1">
  <label id="timeLabel" class="block text-[9px] font-bold text-gray-500 uppercase">
    <% current_symbol = @profile.currency.presence || "$" %>
    <%= @profile.billing_mode == "fixed" ? "Job Price (#{current_symbol})" : "Total Hours" %>
  </label>
  <input type="number" step="any" id="editTime" 
         onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46"
         class="w-full bg-orange-50/50 border border-orange-100 rounded-lg py-3 px-3 font-bold text-black focus:ring-1 focus:ring-orange-500 outline-none">
</div>
        </div>

        <div id="dynamicSections" class="space-y-6"></div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <button type="button" onclick="addFullSection()" class="py-3 border-2 border-black rounded-xl text-[10px] font-black text-black uppercase tracking-widest hover:bg-gray-50 transition-colors">
            + Section
          </button>
          <button id="saveButton" class="bg-orange-600 hover:bg-orange-700 text-white border-2 border-black font-black py-3 rounded-xl uppercase text-[10px] tracking-widest transition-all active:scale-[0.98]">
            Confirm Log
          </button>
        </div>

      </div>
    </div>
  </div>

  <div id="errorToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
    <div class="bg-white text-black px-6 py-4 rounded-xl shadow-2xl border-2 border-red-500 flex items-center gap-4">
      <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
      <span id="errorMessage" class="text-xs font-bold uppercase tracking-widest">Error Message</span>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const recordBtn = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const transcriptArea = document.getElementById("mainTranscript");
  const reParseBtn = document.getElementById("reParseBtn");
  const micIcon = document.getElementById("micIcon");

  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let recordingStartTime = 0;

  // 1. RECORDING LOGIC
  recordBtn.onclick = async () => {
    if (!isRecording) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
      mediaRecorder.onstop = processAudio;
      
      mediaRecorder.start();
      recordingStartTime = Date.now();
      
      isRecording = true;
      buttonText.innerText = "STOP";
      buttonText.classList.add("text-red-600");
      micIcon.classList.replace("text-orange-600", "text-red-600");
      recordBtn.classList.replace("border-orange-500", "border-red-500");
      document.getElementById("recordingWave").classList.remove("hidden");
      document.getElementById("status").innerText = "RECORDING...";
      document.getElementById("status").classList.replace("text-orange-600", "text-red-600");
      document.getElementById("status").classList.replace("bg-orange-50", "bg-red-50");
    } else {
      const duration = Date.now() - recordingStartTime;
      
      if (duration < 1000) {
        mediaRecorder.onstop = null;
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        resetRecorderUI();
        showError("Hold longer to record");
        return; 
      }

      mediaRecorder.stop();
      isRecording = false;
      document.getElementById("status").innerText = "PROCESSING...";
      document.getElementById("recordingWave").classList.add("hidden");
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
  };

  function resetRecorderUI() {
    isRecording = false;
    buttonText.innerText = "TAP TO RECORD";
    buttonText.classList.remove("text-red-600");
    micIcon.classList.replace("text-red-600", "text-orange-600");
    recordBtn.classList.replace("border-red-500", "border-orange-500");
    document.getElementById("status").innerText = "READY";
    document.getElementById("status").classList.replace("text-red-600", "text-orange-600");
    document.getElementById("status").classList.replace("bg-red-50", "bg-orange-50");
    document.getElementById("recordingWave").classList.add("hidden");
  }

  async function processAudio() {
    try {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("audio", audioBlob);

      const res = await fetch("/process_audio", {
        method: "POST",
        headers: { "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content },
        body: formData
      });

      const data = await res.json();
      resetRecorderUI();
      
      if (!res.ok || data.error) {
        showError(data.error || "Speech not recognized.");
      } else {
        updateUI(data);
      }
    } catch (e) {
      resetRecorderUI();
      showError("Network error.");
    }
  }

  // 2. MANUAL TEXT ANALYZE LOGIC
  reParseBtn.onclick = async () => {
    const text = transcriptArea.value;
    if (!text) return;

    document.getElementById("syncStatus").classList.remove("hidden");
    
    const res = await fetch("/process_audio", {
      method: "POST",
      headers: { 
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ manual_text: text })
    });

    const data = await res.json();
    document.getElementById("syncStatus").classList.add("hidden");

    if (data.error) {
      showError(data.error);
    } else {
      updateUI(data);
    }
  };

  // 3. SAVE LOGIC
  document.getElementById("saveButton").onclick = async function() {
    const saveBtn = this;
    const client = document.getElementById("editClient").value;
    const time = document.getElementById("editTime").value;
    const date = document.getElementById("dateDisplay").innerText;

    const sections = [];
    document.querySelectorAll(".dynamic-section").forEach(sec => {
      const title = sec.querySelector(".section-title").value;
      const items = [];
      sec.querySelectorAll(".item-row").forEach(row => {
        const desc = row.querySelector(".item-input").value;
        const price = row.querySelector(".price-input").value;
        if (desc.trim() !== "") items.push({ desc: desc, price: price });
      });
      if (items.length > 0) sections.push({ title, items });
    });

    const res = await fetch("/logs", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content 
      },
      body: JSON.stringify({
        log: { client: client, time: time, date: date, tasks: JSON.stringify(sections) }
      })
    });

    const result = await res.json();
    if (result.success) {
      saveBtn.innerText = "SAVED";
      saveBtn.classList.replace("bg-orange-600", "bg-green-600");
      saveBtn.classList.replace("border-black", "border-green-800");
      setTimeout(() => { window.location.href = "/history"; }, 600);
    } else {
      showError("Error saving log.");
    }
  };
});

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}

function addFullSection(title = "New Category", items = [""]) {
  const container = document.getElementById("dynamicSections");
  const sectionId = "section_" + Date.now() + Math.random().toString(36).substr(2, 5);
  
  const sectionDiv = document.createElement('div');
  sectionDiv.className = "dynamic-section space-y-3 animate-in fade-in slide-in-from-bottom-2 duration-500";
  sectionDiv.innerHTML = `
    <div class="flex justify-between items-center group border-b-2 border-black pb-1">
      <input type="text" value="${title}" class="bg-transparent border-none p-0 text-xs font-black text-orange-600 uppercase tracking-widest focus:ring-0 w-2/3 section-title">
      <div class="flex gap-3">
        <button type="button" onclick="addItem('${sectionId}')" class="text-[10px] text-black font-bold uppercase hover:text-orange-600">+ Item</button>
        <button type="button" onclick="this.closest('.dynamic-section').remove()" class="text-[10px] text-gray-400 font-bold uppercase hover:text-red-500">Remove</button>
      </div>
    </div>
    <div id="${sectionId}" class="space-y-3 pt-2"></div>
  `;
  container.appendChild(sectionDiv);
  items.forEach(item => {
    const val = (typeof item === 'object' && item.desc) ? 
      (item.desc + (item.qty && item.qty !== '1' && item.qty !== 'N/A' ? ` (x${item.qty})` : '')) : item;
    addItem(sectionId, val);
  });
}

function addItem(containerId, value = "") {
  
  // DYNAMIC CURRENCY FOR JS
  const currency = "<%= @profile.currency.presence || '$' %>";
  const div = document.createElement('div');
  div.className = "flex gap-2 animate-in fade-in slide-in-from-left-2 duration-300 item-row items-center";
  div.innerHTML = `
    <div class="w-1.5 h-1.5 bg-black rounded-full"></div>
    <input type="text" value="${value}" 
           class="flex-1 bg-white border-b border-gray-200 text-sm font-medium text-black focus:border-orange-500 focus:ring-0 py-2 px-1 item-input placeholder:text-gray-300"
           placeholder="Description...">
    
    <div class="relative w-20">
       <span class="absolute left-1 top-1/2 -translate-y-1/2 text-gray-400 text-[10px] font-bold">${currency}</span>
       <input type="number" step="0.01" 
              class="w-full bg-white border-b border-gray-200 text-sm font-bold text-orange-600 focus:border-orange-500 focus:ring-0 py-2 pl-4 pr-0 price-input placeholder:text-gray-300"
              placeholder="0.00">
    </div>

    <button type="button" onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 transition px-1">Ã—</button>
  `;
  document.getElementById(containerId).appendChild(div);
}

function updateUI(data) {
  const transcriptArea = document.getElementById("mainTranscript");
  if (data.raw_summary) {
    transcriptArea.value = data.raw_summary;
    autoResize(transcriptArea);
  }
  document.getElementById("editClient").value = data.client || "";
  
  // BILLING MODE LOGIC
  const billingMode = "<%= @profile.billing_mode %>";
  const defaultRate = "<%= @profile.hourly_rate %>";
  if (billingMode === "fixed") {
    document.getElementById("editTime").value = data.time && data.time !== "" && data.time !== "0" ? data.time : defaultRate;
  } else {
    document.getElementById("editTime").value = data.time || "";
  }

  let dateVal = data.date;
  if (!dateVal || dateVal === "N/A" || dateVal.toLowerCase().includes("specified")) {
    dateVal = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  document.getElementById("dateDisplay").innerText = dateVal;

  const sectionContainer = document.getElementById("dynamicSections");
  sectionContainer.innerHTML = "";
  if (data.sections && data.sections.length > 0) {
    data.sections.forEach(sec => addFullSection(sec.title, sec.items));
  } else if (data.tasks) {
    addFullSection("Tasks", Array.isArray(data.tasks) ? data.tasks : [data.tasks]);
  }

  document.getElementById("invoicePreview").classList.remove("hidden");
  document.getElementById("invoicePreview").scrollIntoView({ behavior: 'smooth' });
}

function showError(msg) {
  const toast = document.getElementById("errorToast");
  const msgSpan = document.getElementById("errorMessage");
  msgSpan.innerText = msg;
  toast.classList.remove("hidden");
  setTimeout(() => { toast.classList.add("hidden"); }, 4000);
}
</script>