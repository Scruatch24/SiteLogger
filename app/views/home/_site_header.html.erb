<% is_active = ->(path) { request.path == path ? 'site-nav-active' : '' } %>

<nav class="site-header" data-nosnippet>
  <div class="site-header-inner" id="siteHeaderInner">
    <!-- Logo -->
    <a href="/" class="site-logo" id="siteLogo">
      <div class="site-logo-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6" />
        </svg>
      </div>
      <div class="site-logo-text-wrap">
        <span class="site-logo-text">TALK<span class="text-orange-600">INVOICE</span></span>
      </div>
    </a>

    <!-- Nav Links (JS controls visibility via overflow detection) -->
    <div class="site-nav-links" id="siteNavLinks">
      <%= link_to root_path, class: "site-nav-link #{is_active.call('/')}", data: { nav_key: "home" } do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <%= t('nav.home') %>
      <% end %>
      <%= link_to history_path, class: "site-nav-link #{is_active.call('/history')}", data: { nav_key: "history" } do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <%= t('nav.history') %>
      <% end %>
      <%= link_to profile_path, class: "site-nav-link #{is_active.call('/profile')}", data: { nav_key: "profile", nav_alt_for: "settings" } do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        <%= t('nav.profile') %>
      <% end %>
      <%= link_to settings_path, class: "site-nav-link #{is_active.call('/settings')}", data: { nav_key: "settings" } do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <%= t('nav.settings') %>
      <% end %>
      <%= link_to analytics_path, class: "site-nav-link #{is_active.call('/analytics')}", data: { nav_key: "analytics" } do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
        <%= t('nav.analytics') %>
      <% end %>
      <% if user_signed_in? && current_user.profile&.ever_paid? %>
        <%= link_to subscription_path, class: "site-nav-link site-nav-pricing #{is_active.call('/subscription')}", data: { nav_key: "pricing" } do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24" stroke="none">
            <path d="M12 2.4c.33 0 .63.2.76.5l1.87 4.34 4.64.36c.63.05.88.84.38 1.23l-3.55 3.05 1.06 4.44c.13.55-.44.98-.94.7L12 14.72l-4.22 2.3c-.5.28-1.07-.15-.94-.7l1.06-4.44-3.55-3.05c-.5-.39-.25-1.18.38-1.23l4.64-.36 1.87-4.34c.13-.3.43-.5.76-.5z" />
          </svg>
          <%= t('nav.subscription') %>
        <% end %>
      <% else %>
        <%= link_to pricing_path, class: "site-nav-link site-nav-pricing #{is_active.call('/pricing')}", data: { nav_key: "pricing" } do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24" stroke="none">
            <path d="M12 2.4c.33 0 .63.2.76.5l1.87 4.34 4.64.36c.63.05.88.84.38 1.23l-3.55 3.05 1.06 4.44c.13.55-.44.98-.94.7L12 14.72l-4.22 2.3c-.5.28-1.07-.15-.94-.7l1.06-4.44-3.55-3.05c-.5-.39-.25-1.18.38-1.23l4.64-.36 1.87-4.34c.13-.3.43-.5.76-.5z" />
          </svg>
          <%= t('nav.pricing') %>
        <% end %>
      <% end %>
    </div>

    <!-- Desktop Auth -->
    <div class="site-auth-links" id="siteAuthLinks">
      <% if user_signed_in? %>
        <button type="button" onclick="window.showLogoutModal()" class="site-auth-btn site-auth-logout">
          <span class="inline-flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
            </svg>
            <%= t('nav.log_out') %>
          </span>
        </button>
      <% else %>
        <%= link_to new_user_session_path, class: "site-auth-btn site-auth-signin" do %>
          <%= t('nav.sign_in') %>
        <% end %>
        <%= link_to new_user_registration_path, class: "site-auth-btn site-auth-signup" do %>
          <%= t('nav.sign_up') %>
        <% end %>
      <% end %>
    </div>

    <!-- Hamburger (visible when overflow items exist) -->
    <button type="button" class="site-hamburger" id="siteHamburger" onclick="toggleSiteMenu()" aria-label="<%= t('nav.menu') %>">
      <span class="hamburger-line hamburger-line-1"></span>
      <span class="hamburger-line hamburger-line-2"></span>
      <span class="hamburger-line hamburger-line-3"></span>
    </button>
  </div>

  <!-- Overflow Menu (hamburger dropdown) — all items present, JS shows overflowed ones -->
  <div class="site-mobile-menu" id="siteMenuMobile">
    <div class="site-mobile-nav" id="siteMenuNav">
      <%= link_to root_path, class: "site-mobile-link #{is_active.call('/')}", data: { menu_key: "home" } do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <%= t('nav.home') %>
      <% end %>
      <%= link_to history_path, class: "site-mobile-link #{is_active.call('/history')}", data: { menu_key: "history" } do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <%= t('nav.history') %>
      <% end %>
      <%= link_to profile_path, class: "site-mobile-link #{is_active.call('/profile')}", data: { menu_key: "profile" } do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        <%= t('nav.profile') %>
      <% end %>
      <%= link_to settings_path, class: "site-mobile-link #{is_active.call('/settings')}", data: { menu_key: "settings" } do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <%= t('nav.settings') %>
      <% end %>
      <%= link_to analytics_path, class: "site-mobile-link #{is_active.call('/analytics')}", data: { menu_key: "analytics" } do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
        <%= t('nav.analytics') %>
      <% end %>
      <% if user_signed_in? && current_user.profile&.ever_paid? %>
        <%= link_to subscription_path, class: "site-mobile-link site-mobile-pricing #{is_active.call('/subscription')}", data: { menu_key: "pricing" } do %>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" stroke="none"><path d="M12 2.4c.33 0 .63.2.76.5l1.87 4.34 4.64.36c.63.05.88.84.38 1.23l-3.55 3.05 1.06 4.44c.13.55-.44.98-.94.7L12 14.72l-4.22 2.3c-.5.28-1.07-.15-.94-.7l1.06-4.44-3.55-3.05c-.5-.39-.25-1.18.38-1.23l4.64-.36 1.87-4.34c.13-.3.43-.5.76-.5z"/></svg>
          <%= t('nav.subscription') %>
        <% end %>
      <% else %>
        <%= link_to pricing_path, class: "site-mobile-link site-mobile-pricing #{is_active.call('/pricing')}", data: { menu_key: "pricing" } do %>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" stroke="none"><path d="M12 2.4c.33 0 .63.2.76.5l1.87 4.34 4.64.36c.63.05.88.84.38 1.23l-3.55 3.05 1.06 4.44c.13.55-.44.98-.94.7L12 14.72l-4.22 2.3c-.5.28-1.07-.15-.94-.7l1.06-4.44-3.55-3.05c-.5-.39-.25-1.18.38-1.23l4.64-.36 1.87-4.34c.13-.3.43-.5.76-.5z"/></svg>
          <%= t('nav.pricing') %>
        <% end %>
      <% end %>
    </div>
    <div class="site-mobile-auth" id="siteMenuAuth">
      <% if user_signed_in? %>
        <button type="button" onclick="window.showLogoutModal()" class="site-mobile-auth-btn site-auth-logout">
          <span class="inline-flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
            </svg>
            <%= t('nav.log_out') %>
          </span>
        </button>
      <% else %>
        <%= link_to new_user_session_path, class: "site-mobile-auth-btn site-auth-signin" do %>
          <%= t('nav.sign_in') %>
        <% end %>
        <%= link_to new_user_registration_path, class: "site-mobile-auth-btn site-auth-signup" do %>
          <%= t('nav.sign_up') %>
        <% end %>
      <% end %>
    </div>
  </div>

</nav>

<script>
  function toggleSiteMenu() {
    const menu = document.getElementById('siteMenuMobile');
    const btn = document.getElementById('siteHamburger');
    menu.classList.toggle('open');
    btn.classList.toggle('open');
  }

  /* ── Priority-Plus Nav: jank-free single-pass fitting ── */
  (function() {
    var header   = document.getElementById('siteHeaderInner');
    var logo     = document.getElementById('siteLogo');
    var navWrap  = document.getElementById('siteNavLinks');
    var authWrap = document.getElementById('siteAuthLinks');
    var burger   = document.getElementById('siteHamburger');
    var menuNav  = document.getElementById('siteMenuNav');
    if (!header || !navWrap || !burger) return;

    /*
     * Display order (visual left→right when shown):
     *   HOME  HISTORY  SETTINGS  PROFILE  ANALYTICS  PRICING
     *
     * Fitting priority:
     *   1. Home  2. History  (always tried first)
     *   3. Settings preferred over Profile; show both if budget allows
     *   4. Analytics  5. Pricing
     */
    var DISPLAY_ORDER = ['home', 'history', 'settings', 'profile', 'analytics', 'pricing'];
    var M = 10;        /* margin per slot (CSS padding + gap) */
    var NAV_GAP = 4;   /* gap between nav buttons */
    var BURGER_W = 40; /* 36px + 2px border + 2px shadow = ~40px */

    function getEl(key) {
      return navWrap.querySelector('[data-nav-key="' + key + '"]');
    }

    var totalNavCount = DISPLAY_ORDER.filter(function(k) { return !!getEl(k); }).length;

    /* ── Measure natural widths in a single hidden pass (zero visual impact) ── */
    function measureNatural() {
      var natW = {};
      var items = navWrap.querySelectorAll('[data-nav-key]');
      /* Make nav container measurable but invisible */
      navWrap.style.setProperty('display', 'flex', 'important');
      navWrap.style.setProperty('position', 'absolute', 'important');
      navWrap.style.setProperty('visibility', 'hidden', 'important');
      navWrap.style.setProperty('pointer-events', 'none', 'important');
      items.forEach(function(el) {
        el.style.setProperty('display', 'inline-flex', 'important');
        el.style.setProperty('visibility', 'hidden', 'important');
        el.style.setProperty('width', 'auto', 'important');
      });
      /* Single forced layout read */
      items.forEach(function(el) {
        natW[el.dataset.navKey] = Math.ceil(el.getBoundingClientRect().width);
      });
      /* Reset — remove only the properties we set */
      items.forEach(function(el) {
        el.style.removeProperty('display');
        el.style.removeProperty('visibility');
        el.style.removeProperty('width');
      });
      navWrap.style.removeProperty('display');
      navWrap.style.removeProperty('position');
      navWrap.style.removeProperty('visibility');
      navWrap.style.removeProperty('pointer-events');
      return natW;
    }

    /* ── Priority fitting — returns array of keys that fit in budget ── */
    function runFitting(budget, natW) {
      var keys = [];
      var used = 0;
      function canFit(key) {
        if (!getEl(key)) return false;
        return (used + (natW[key] || 0) + (keys.length ? NAV_GAP : 0) <= budget);
      }
      function add(key) {
        if (keys.length) used += NAV_GAP;
        used += (natW[key] || 0);
        keys.push(key);
      }

      /* 1-2: Home, History */
      if (!canFit('home')) return keys;
      add('home');
      if (!canFit('history')) return keys;
      add('history');

      /* 3: Settings > Profile; show both if space allows */
      var pEl = getEl('profile'), sEl = getEl('settings');
      var bothNeed = (pEl && sEl)
        ? (natW['settings'] || 0) + NAV_GAP + (natW['profile'] || 0) + NAV_GAP
        : Infinity;

      if (used + bothNeed <= budget) {
        add('settings'); add('profile');
      } else if (canFit('settings')) {
        add('settings');
      } else if (canFit('profile')) {
        add('profile');
      } else {
        return keys;
      }

      /* 4-5: Analytics, Pricing */
      if (canFit('analytics')) {
        add('analytics');
        if (canFit('pricing')) add('pricing');
      }
      return keys;
    }

    /* ── Cache last result to skip redundant DOM writes ── */
    var lastResult = '';

    function fitNav() {
      var allItems = navWrap.querySelectorAll('[data-nav-key]');
      var vw = window.innerWidth;

      /* Desktop (≥ 1280): CSS handles everything */
      if (vw >= 1280) {
        if (lastResult === 'desktop') return;
        lastResult = 'desktop';
        navWrap.classList.remove('mobile-fit-active');
        allItems.forEach(function(el) {
          el.classList.remove('nav-hidden');
          el.style.width = '';
        });
        burger.classList.remove('has-overflow');
        burger.style.display = '';
        if (authWrap) authWrap.classList.remove('auth-hidden');
        menuNav.querySelectorAll('[data-menu-key]').forEach(function(el) { el.classList.remove('menu-visible'); });
        return;
      }

      /* ── Sub-desktop ── */
      try {

      /* Step 1: Measure natural widths while everything is still hidden */
      var natW = measureNatural();

      /* Step 2: Hide ALL nav items BEFORE making container visible (prevents flash) */
      allItems.forEach(function(el) {
        el.classList.add('nav-hidden');
        el.style.width = '';
      });
      navWrap.classList.add('mobile-fit-active');

      /* Step 3: Calculate available budget */
      var isTablet = vw >= 768;
      var logoW = logo.offsetWidth;
      var authW = 0;
      var budget, showKeys;

      if (isTablet) {
        if (authWrap) authWrap.classList.remove('auth-hidden');
        authW = authWrap ? authWrap.offsetWidth : 0;
        burger.classList.remove('has-overflow');

        /* Try without hamburger first */
        budget = header.clientWidth - logoW - authW - (4 * M);
        showKeys = runFitting(Math.max(budget, 0), natW);

        if (showKeys.length < totalNavCount) {
          burger.classList.add('has-overflow');
          budget = header.clientWidth - logoW - authW - BURGER_W - (5 * M);
          showKeys = runFitting(Math.max(budget, 0), natW);
        }
      } else {
        if (authWrap) authWrap.classList.add('auth-hidden');
        burger.classList.add('has-overflow');
        budget = header.clientWidth - logoW - BURGER_W - (4 * M);
        showKeys = runFitting(Math.max(budget, 0), natW);
      }

      /* Skip DOM writes if result is identical to last run */
      var resultKey = showKeys.join(',') + '|' + budget;
      if (resultKey === lastResult) return;
      lastResult = resultKey;

      /* Step 4: Build fitted list in DISPLAY_ORDER for visual ordering */
      var showSet = {};
      showKeys.forEach(function(k) { showSet[k] = true; });
      var fitted = [];
      DISPLAY_ORDER.forEach(function(key) {
        if (!showSet[key]) return;
        var el = getEl(key);
        if (el) fitted.push({ key: key, el: el, minW: natW[key] || 0 });
      });

      /* Step 5: Calculate widths — equalize if all fit, else proportional */
      if (fitted.length > 0) {
        var totalGaps = (fitted.length - 1) * NAV_GAP;
        var space = Math.max(budget - totalGaps, 0);
        var targetW = Math.floor(space / fitted.length);
        var maxNat = 0;
        for (var i = 0; i < fitted.length; i++) {
          if (fitted[i].minW > maxNat) maxNat = fitted[i].minW;
        }

        if (maxNat <= targetW) {
          /* All items fit at equal width — use equalized */
          for (var i = 0; i < fitted.length; i++) {
            fitted[i].el.style.width = targetW + 'px';
          }
        } else {
          /* Can't equalize — lock wide items at natural, share remaining among smaller */
          var locked = 0, lockedW = 0;
          for (var i = 0; i < fitted.length; i++) {
            if (fitted[i].minW > targetW) { locked++; lockedW += fitted[i].minW; }
          }
          var rest = fitted.length - locked;
          var restW = rest > 0 ? Math.floor((space - lockedW) / rest) : 0;
          for (var i = 0; i < fitted.length; i++) {
            fitted[i].el.style.width = (fitted[i].minW > targetW ? fitted[i].minW : Math.max(restW, fitted[i].minW)) + 'px';
          }
        }

        /* Step 6: Reveal fitted items (single paint) */
        for (var i = 0; i < fitted.length; i++) {
          fitted[i].el.classList.remove('nav-hidden');
        }
      }

      /* Step 7: Update hamburger menu — show items NOT in header */
      menuNav.querySelectorAll('[data-menu-key]').forEach(function(el) {
        el.classList.toggle('menu-visible', !showSet[el.dataset.menuKey]);
      });

      } catch(e) {
        /* Fallback: show all items without width constraints */
        navWrap.classList.add('mobile-fit-active');
        navWrap.querySelectorAll('[data-nav-key]').forEach(function(el) {
          el.classList.remove('nav-hidden');
          el.style.width = '';
        });
        burger.classList.add('has-overflow');
      }
    }

    /* ── Run on resize (debounced) ── */
    var resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      lastResult = '';          /* force recalc on resize */
      resizeTimer = setTimeout(fitNav, 80);
    });

    /* ── Initial run: once immediately, once after fonts settle ── */
    fitNav();
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(function() {
        lastResult = '';        /* fonts may change measurements */
        requestAnimationFrame(fitNav);
      });
    }

    /* ── Logo hover animation (unchanged) ── */
    const isMobile = () => window.innerWidth < 1280;
    const VISITED_KEY = 'logoTextVisited';

    function attachDesktopHover() {
      logo.addEventListener('mouseenter', function() {
        if (!isMobile()) logo.classList.add('logo-text-open');
      });
      logo.addEventListener('mouseleave', function() {
        if (!isMobile()) logo.classList.remove('logo-text-open');
      });
    }

    var hasVisited = localStorage.getItem(VISITED_KEY) === 'true';

    if (!isMobile()) {
      if (!hasVisited) {
        localStorage.setItem(VISITED_KEY, 'true');
      }
      setTimeout(function() {
        logo.classList.add('logo-text-open');
        setTimeout(function() {
          logo.classList.remove('logo-text-open');
          attachDesktopHover();
        }, 3000);
      }, 800);

      if (hasVisited) {
        attachDesktopHover();
      }
    } else {
      attachDesktopHover();
    }
  })();
</script>
