<style>
  /* ============================================ */
  /* CHECKOUT PAGE — Onboarding-Inspired Dark UI  */
  /* ============================================ */
  .checkout-page {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0a0a0a;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  .checkout-bg {
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(249,115,22,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(99,102,241,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .checkout-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .checkout-particle {
    position: fixed;
    background: rgba(249,115,22,0.4);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: checkoutFloat linear infinite;
  }
  @keyframes checkoutFloat {
    0%   { transform: translateY(0) scale(1); opacity: 0; }
    10%  { opacity: 1; }
    90%  { opacity: 1; }
    100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
  }

  .checkout-content {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  /* Header */
  .checkout-header {
    text-align: center;
    padding: 1.5rem 0 2rem;
  }
  .checkout-headline {
    font-size: clamp(1.8rem, 5vw, 3rem);
    font-weight: 900;
    color: white;
    text-transform: uppercase;
    letter-spacing: -0.03em;
    line-height: 1.1;
    margin-bottom: 0.75rem;
  }
  .checkout-headline .onb-accent {
    color: #f97316;
  }
  .checkout-sub {
    font-size: 14px;
    color: rgba(255,255,255,0.4);
    font-weight: 500;
    max-width: 460px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* Back Link */
  .checkout-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.3);
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 14px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06);
    transition: all 0.3s ease;
  }
  .checkout-back:hover {
    color: white;
    background: rgba(249,115,22,0.1);
    border-color: rgba(249,115,22,0.2);
  }
  .checkout-back svg {
    width: 14px;
    height: 14px;
  }

  /* Layout: two columns on desktop */
  .checkout-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
    margin-top: 1.5rem;
  }
  @media (max-width: 768px) {
    .checkout-layout {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }

  /* Order Summary Card */
  .checkout-summary {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 24px;
    padding: 2rem;
    backdrop-filter: blur(8px);
  }
  .checkout-summary-title {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: #f97316;
    margin-bottom: 1.25rem;
  }
  .checkout-plan-name {
    font-size: 1.5rem;
    font-weight: 900;
    color: white;
    text-transform: uppercase;
    letter-spacing: -0.02em;
    margin-bottom: 0.25rem;
  }
  .checkout-plan-price {
    font-size: 14px;
    font-weight: 700;
    color: rgba(255,255,255,0.5);
    margin-bottom: 1.5rem;
  }
  .checkout-plan-price strong {
    font-size: 1.75rem;
    font-weight: 900;
    color: white;
  }

  .checkout-features {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .checkout-features li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.6rem 0;
    border-top: 1px solid rgba(255,255,255,0.05);
    font-size: 12px;
    font-weight: 700;
    color: rgba(255,255,255,0.55);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .checkout-features li:last-child {
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .checkout-features .feat-check {
    width: 18px;
    height: 18px;
    border-radius: 6px;
    background: rgba(34,197,94,0.15);
    border: 1px solid rgba(34,197,94,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .checkout-features .feat-check svg {
    width: 10px;
    height: 10px;
    color: #4ade80;
  }

  /* Paddle Inline Container */
  .checkout-paddle-wrap {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 24px;
    padding: 1.5rem;
    backdrop-filter: blur(8px);
    min-height: 400px;
  }
  .checkout-paddle-label {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: #f97316;
    margin-bottom: 1rem;
    text-align: center;
  }

  /* Paddle loading state */
  .checkout-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    gap: 1rem;
  }
  .checkout-loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(249,115,22,0.2);
    border-top-color: #f97316;
    border-radius: 50%;
    animation: checkoutSpin 0.8s linear infinite;
  }
  @keyframes checkoutSpin {
    to { transform: rotate(360deg); }
  }
  .checkout-loading-text {
    font-size: 11px;
    font-weight: 700;
    color: rgba(255,255,255,0.3);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* Secure badge */
  .checkout-secure {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 1.5rem;
    font-size: 10px;
    font-weight: 700;
    color: rgba(255,255,255,0.2);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .checkout-secure svg {
    width: 12px;
    height: 12px;
    color: rgba(255,255,255,0.2);
  }

  /* Footer */
  .checkout-footer {
    text-align: center;
    padding: 2rem 0;
    margin-top: 2rem;
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  .checkout-footer-text {
    font-size: 11px;
    color: rgba(255,255,255,0.2);
    font-weight: 500;
  }
</style>

<div class="checkout-page">
  <div class="checkout-bg"></div>
  <div class="checkout-grid"></div>

  <% 10.times do |i| %>
    <div class="checkout-particle" style="left:<%= rand(5..95) %>%; bottom:-2%; animation-duration:<%= rand(8..16) %>s; animation-delay:<%= (rand(0..60) / 10.0) %>s; width:<%= rand(1..3) %>px; height:<%= rand(1..3) %>px; opacity:<%= rand(2..5) / 10.0 %>;"></div>
  <% end %>

  <div class="checkout-content">
    <!-- Back Link -->
    <div style="margin-bottom: 1rem;">
      <%= link_to pricing_path, class: "checkout-back" do %>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
        </svg>
        <%= t('checkout_page.back_pricing') %>
      <% end %>
    </div>

    <!-- Header -->
    <div class="checkout-header">
      <h1 class="checkout-headline"><%= raw t('checkout_page.title_html') %></h1>
      <p class="checkout-sub"><%= t('checkout_page.subtitle') %></p>
    </div>

    <!-- Two-column layout -->
    <div class="checkout-layout">
      <!-- Left: Order Summary -->
      <div class="checkout-summary">
        <div class="checkout-summary-title"><%= t('checkout_page.order_summary') %></div>
        <div class="checkout-plan-name"><%= t('pricing_page.pro_title') %></div>
        <div class="checkout-plan-price">
          <strong><%= t('modal.pro_price') %></strong>
        </div>

        <ul class="checkout-features">
          <li>
            <span class="feat-check"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <%= t('pricing_page.feature_transcript') %> — <%= t('modal.chars', count: "10,000") %>
          </li>
          <li>
            <span class="feat-check"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <%= t('pricing_page.feature_voice') %> — <%= t('modal.seconds', count: 300) %>
          </li>
          <li>
            <span class="feat-check"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <%= t('pricing_page.feature_previews') %> &amp; <%= t('pricing_page.feature_exports') %> — <%= t('modal.unlimited') %>
          </li>
          <li>
            <span class="feat-check"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <%= t('pricing_page.feature_designs') %> — <%= t('pricing_page.all_styles') %>
          </li>
          <li>
            <span class="feat-check"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <%= t('pricing_page.feature_logo') %> &amp; <%= t('pricing_page.feature_colors') %>
          </li>
          <li>
            <span class="feat-check"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <%= t('pricing_page.feature_categories') %> &amp; <%= t('pricing_page.feature_ai') %>
          </li>
        </ul>

        <div class="checkout-secure">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <%= t('checkout_page.secure_checkout') %>
        </div>
      </div>

      <!-- Right: Paddle Inline Checkout -->
      <div class="checkout-paddle-wrap">
        <div class="checkout-paddle-label"><%= t('checkout_page.payment_details') %></div>
        <div class="paddle-checkout-container">
          <div class="checkout-loading" id="checkout-loading">
            <div class="checkout-loading-spinner"></div>
            <span class="checkout-loading-text"><%= t('checkout_page.loading') %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="checkout-footer">
      <p class="checkout-footer-text">TalkInvoice &copy; <%= Date.today.year %></p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof Paddle === 'undefined') {
      console.error('Paddle.js not loaded');
      return;
    }

    var priceId = '<%= ENV["PADDLE_PRICE_ID"] || "pri_01kh7aq09r0kyg8dvgwp6bk0dz" %>';
    var successUrl = '<%= (ENV["PADDLE_SUCCESS_URL"].presence || root_url).to_s %>';

    var settings = {
      items: [{ priceId: priceId, quantity: 1 }],
      settings: {
        displayMode: 'inline',
        frameTarget: 'paddle-checkout-container',
        frameInitialHeight: 450,
        frameStyle: 'width: 100%; min-width: 312px; background-color: transparent; border: none;'
      },
      successUrl: successUrl
    };

    <% if user_signed_in? && current_user.email.present? %>
      settings.customer = { email: '<%= current_user.email %>' };
    <% end %>

    Paddle.Checkout.open(settings);

    // Hide loading spinner once Paddle iframe appears
    var checkInterval = setInterval(function() {
      var iframe = document.querySelector('.paddle-checkout-container iframe');
      if (iframe) {
        var loader = document.getElementById('checkout-loading');
        if (loader) loader.style.display = 'none';
        clearInterval(checkInterval);
      }
    }, 300);

    // Fallback: hide spinner after 8s regardless
    setTimeout(function() {
      var loader = document.getElementById('checkout-loading');
      if (loader) loader.style.display = 'none';
    }, 8000);
  });
</script>
